import{r as l,a5 as Ie,j as e,bk as Te,bM as As,bu as ve,c1 as Fs,c2 as He,c3 as Ds,bz as Ve,c4 as ns,c5 as Ps,c6 as Ts,ab as Ne,aJ as Ge,bg as J,be as ls,bh as Vs,bb as cs,aa as we,c7 as zs,ap as ue,bC as Rs,a9 as _e,c8 as Ms,c9 as es,ca as Ls,cb as $s,cc as qs,cd as Os,ce as Bs,cf as Us,bK as Hs,bq as Gs,z as Js,$ as os,b4 as Ks,cg as Ys,bi as ss,ch as Ws,aK as ae,ah as me,ci as ds,cj as us,ck as Zs,ac as ze,bc as Ce,cl as Qs,cm as Xs,S as et,cn as st,co as tt,cp as Re,bd as rt,br as Se,ae as at,bL as it,ad as nt,af as lt,bP as ct,bN as ot,bO as dt,bQ as ut,b9 as mt,a$ as ts}from"./react-vendor-CPmH2tz8.js";import{u as se,s as I,l as f,t as T,C as M,a as D,e as q,B as _,c as X,W as De,i as ht,a6 as Pe,X as Me,w as W,x as Z,b as G,d as Y,a7 as Le,a8 as $e,a9 as qe,aa as Oe,ab as re,T as ms,y as hs,z as ie,E as fe,ac as xs,ad as ps,D as Je,h as Ke,K as Ye,L as We,M as Ze,ae as fs,af as gs,Z as Be,j as Qe,ag as Ue,ah as xt,ai as ne,aj as js,_ as be,ak as pt,g as ft,al as rs,am as gt}from"./route-admin-B1Ip8YDE.js";import{S as jt,D as vt}from"./route-owner-C83ejxxl.js";import{O as Ee,t as ye}from"./route-agency-BEE2sWoQ.js";import{cj as O}from"./common-vendor-CK5d0rWc.js";import{c as ke}from"./animation-vendor-BJe5VoH_.js";import{t as Nt,o as bt,s as xe}from"./forms-vendor-DqOZ4YtP.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};s.SENTRY_RELEASE={id:"b65e2d84341e79b518aed72b6e71dcc77eba934a"}}catch{}})();try{(function(){var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},r=new s.Error().stack;r&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[r]="eec01ad7-1e8d-4140-949c-d5b91d5014ce",s._sentryDebugIdIdentifier="sentry-dbid-eec01ad7-1e8d-4140-949c-d5b91d5014ce")})()}catch{}const yt=()=>{const{user:s}=se(),[r,n]=l.useState([]),[i,a]=l.useState(!0);l.useEffect(()=>{s?o():(n([]),a(!1))},[s]);const o=async()=>{if(s)try{const{data:c,error:u}=await I.from("user_favorites").select("property_id").eq("user_id",s.id);if(u){f.error("Error fetching favorites",{error:u,userId:s.id});const p=localStorage.getItem(`favorites_${s.id}`);n(p?JSON.parse(p):[])}else n((c==null?void 0:c.map(p=>p.property_id))||[])}catch(c){f.error("Exception fetching favorites",{error:c,userId:s.id});const u=localStorage.getItem(`favorites_${s.id}`);n(u?JSON.parse(u):[])}finally{a(!1)}};return{favorites:r,loading:i,toggleFavorite:async c=>{if(!s){T({title:"Connexion requise",description:"Veuillez vous connecter pour ajouter des favoris",variant:"destructive"});return}const u=r.includes(c);try{if(u){const{error:p}=await I.from("user_favorites").delete().eq("user_id",s.id).eq("property_id",c);if(p)throw p;n(r.filter(x=>x!==c)),T({title:"Favori retiré",description:"Le bien a été retiré de vos favoris"})}else{const{error:p}=await I.from("user_favorites").insert({user_id:s.id,property_id:c});if(p)throw p;n([...r,c]),T({title:"Favori ajouté",description:"Le bien a été ajouté à vos favoris"})}localStorage.setItem(`favorites_${s.id}`,JSON.stringify(u?r.filter(p=>p!==c):[...r,c]))}catch(p){f.error("Error toggling favorite",{error:p,propertyId:c,userId:s.id}),T({title:"Erreur",description:"Impossible de mettre à jour vos favoris",variant:"destructive"})}},isFavorite:c=>r.includes(c),refetch:o}},vs=({type:s,propertyId:r,limit:n=10,autoFetch:i=!0})=>{const{user:a}=se(),[o,t]=l.useState([]),[d,c]=l.useState(!1),[u,p]=l.useState(null),x=l.useRef(!1),y=l.useCallback(async()=>{if(!a||x.current){t([]);return}x.current=!0,c(!0),p(null);try{const{data:b,error:j}=await I.functions.invoke("generate-recommendations",{body:{userId:a.id,type:s,propertyId:r,limit:n}});if(j)throw j;t(b||[])}catch(b){const j=b instanceof Error?b:new Error("Failed to fetch recommendations");p(j),f.error("Error fetching recommendations",{error:b,userId:a==null?void 0:a.id,type:s,propertyId:r,limit:n}),T({title:"Erreur",description:"Impossible de charger les recommandations",variant:"destructive"})}finally{c(!1)}},[a,s,r,n]),v=l.useCallback(async b=>{if(a){c(!0);try{const{data:j,error:F}=await I.functions.invoke("update-preferences",{body:{userId:a.id,preferences:b}});if(F)throw F;return j!=null&&j.recommendations&&t(j.recommendations),T({title:"Préférences mises à jour",description:"Vos recommandations ont été actualisées"}),j}catch(j){throw f.error("Error updating preferences",{error:j,userId:a==null?void 0:a.id,preferences:b}),T({title:"Erreur",description:"Impossible de mettre à jour vos préférences",variant:"destructive"}),j}finally{c(!1)}}},[a]),m=l.useCallback(async(b,j,F)=>{if(a)try{await I.functions.invoke("track-search",{body:{userId:a.id,searchFilters:b,resultCount:j,clickedProperties:F}})}catch(C){f.error("Error tracking search",{error:C,userId:a==null?void 0:a.id,searchFilters:b,resultCount:j})}},[a]);return l.useEffect(()=>{if(i&&(a!=null&&a.id)){const b=setTimeout(()=>{y()},100);return()=>clearTimeout(b)}},[i,a==null?void 0:a.id]),{recommendations:o,loading:d,error:u,refetch:y,updatePreferences:v,trackSearch:m}},wt=({item:s,type:r,score:n,reasons:i})=>{var c,u,p;const a=Ie(),o=x=>x>=80?"bg-green-600 text-white":x>=60?"bg-yellow-600 text-white":"bg-gray-600 text-white",t=()=>{var x;a(r==="property"?`/property/${((x=s.data)==null?void 0:x.id)||s.id}`:"/applications")};if(r==="property"){const x=s.data||s;return e.jsxs(M,{className:"overflow-hidden hover:shadow-lg transition-shadow cursor-pointer",onClick:t,children:[e.jsxs("div",{className:"relative h-48",children:[e.jsx("img",{src:x.main_image||((c=x.images)==null?void 0:c[0])||"/placeholder.svg",alt:x.title,className:"w-full h-full object-cover"}),e.jsxs("div",{className:"absolute top-2 right-2 flex flex-col gap-2",children:[e.jsxs(D,{className:o(n),children:[e.jsx(Te,{className:"h-3 w-3 mr-1"}),n,"% Match"]}),x.work_status&&x.work_status!=="aucun_travail"&&e.jsxs(D,{variant:"secondary",className:"bg-orange-600 hover:bg-orange-700 text-white",children:[e.jsx(As,{className:"h-3 w-3 mr-1"}),"Travaux"]})]})]}),e.jsxs(q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold text-lg line-clamp-1 flex-1",children:x.title}),x.status&&e.jsx(jt,{status:x.status,variant:"compact"})]}),e.jsxs("div",{className:"flex items-center text-muted-foreground text-sm mb-2",children:[e.jsx(ve,{className:"h-4 w-4 mr-1"}),x.city]}),e.jsxs("div",{className:"text-2xl font-bold text-primary mb-3",children:[(u=x.monthly_rent)==null?void 0:u.toLocaleString()," FCFA/mois"]}),e.jsx("div",{className:"space-y-1 mb-4",children:i.map((y,v)=>e.jsxs("div",{className:"flex items-start text-sm",children:[e.jsx("span",{className:"text-green-600 mr-2",children:"✓"}),e.jsx("span",{className:"text-muted-foreground",children:y})]},v))}),e.jsx(_,{className:"w-full",onClick:y=>{y.stopPropagation(),t()},children:"Voir les détails"})]})]})}const d=s.profile||((p=s.data)==null?void 0:p.profile);return e.jsx(M,{className:"overflow-hidden hover:shadow-lg transition-shadow",children:e.jsxs(q,{className:"p-4",children:[e.jsxs("div",{className:"flex items-start gap-4 mb-4",children:[e.jsx("img",{src:(d==null?void 0:d.avatar_url)||"/placeholder.svg",alt:d==null?void 0:d.full_name,className:"w-16 h-16 rounded-full object-cover"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-lg",children:d==null?void 0:d.full_name}),e.jsxs(D,{className:`${o(n)} mt-1`,children:[e.jsx(Te,{className:"h-3 w-3 mr-1"}),n,"% Match"]})]})]}),e.jsx("div",{className:"space-y-1 mb-4",children:i.map((x,y)=>e.jsxs("div",{className:"flex items-start text-sm",children:[e.jsx("span",{className:"text-green-600 mr-2",children:"✓"}),e.jsx("span",{className:"text-muted-foreground",children:x})]},y))}),e.jsx(_,{className:"w-full",variant:"outline",children:"Voir le profil"})]})})},Ns=l.createContext(null);function Ae(){const s=l.useContext(Ns);if(!s)throw new Error("useCarousel must be used within a <Carousel />");return s}const bs=l.forwardRef(({orientation:s="horizontal",opts:r,setApi:n,plugins:i,className:a,children:o,...t},d)=>{const[c,u]=Fs({...r,axis:s==="horizontal"?"x":"y"},i),[p,x]=l.useState(!1),[y,v]=l.useState(!1),m=l.useCallback(C=>{C&&(x(C.canScrollPrev()),v(C.canScrollNext()))},[]),b=l.useCallback(()=>{u==null||u.scrollPrev()},[u]),j=l.useCallback(()=>{u==null||u.scrollNext()},[u]),F=l.useCallback(C=>{C.key==="ArrowLeft"?(C.preventDefault(),b()):C.key==="ArrowRight"&&(C.preventDefault(),j())},[b,j]);return l.useEffect(()=>{!u||!n||n(u)},[u,n]),l.useEffect(()=>{if(u)return m(u),u.on("reInit",m),u.on("select",m),()=>{u==null||u.off("select",m)}},[u,m]),e.jsx(Ns.Provider,{value:{carouselRef:c,api:u,opts:r,orientation:s||((r==null?void 0:r.axis)==="y"?"vertical":"horizontal"),scrollPrev:b,scrollNext:j,canScrollPrev:p,canScrollNext:y},children:e.jsx("div",{ref:d,onKeyDownCapture:F,className:X("relative",a),role:"region","aria-roledescription":"carousel",...t,children:o})})});bs.displayName="Carousel";const ys=l.forwardRef(({className:s,...r},n)=>{const{carouselRef:i,orientation:a}=Ae();return e.jsx("div",{ref:i,className:"overflow-hidden",children:e.jsx("div",{ref:n,className:X("flex",a==="horizontal"?"-ml-4":"-mt-4 flex-col",s),...r})})});ys.displayName="CarouselContent";const ws=l.forwardRef(({className:s,...r},n)=>{const{orientation:i}=Ae();return e.jsx("div",{ref:n,role:"group","aria-roledescription":"slide",className:X("min-w-0 shrink-0 grow-0 basis-full",i==="horizontal"?"pl-4":"pt-4",s),...r})});ws.displayName="CarouselItem";const _s=l.forwardRef(({className:s,variant:r="outline",size:n="icon",...i},a)=>{const{orientation:o,scrollPrev:t,canScrollPrev:d}=Ae();return e.jsxs(_,{ref:a,variant:r,size:n,className:X("absolute h-8 w-8 rounded-full",o==="horizontal"?"-left-12 top-1/2 -translate-y-1/2":"-top-12 left-1/2 -translate-x-1/2 rotate-90",s),disabled:!d,onClick:t,...i,children:[e.jsx(He,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Previous slide"})]})});_s.displayName="CarouselPrevious";const Cs=l.forwardRef(({className:s,variant:r="outline",size:n="icon",...i},a)=>{const{orientation:o,scrollNext:t,canScrollNext:d}=Ae();return e.jsxs(_,{ref:a,variant:r,size:n,className:X("absolute h-8 w-8 rounded-full",o==="horizontal"?"-right-12 top-1/2 -translate-y-1/2":"-bottom-12 left-1/2 -translate-x-1/2 rotate-90",s),disabled:!d,onClick:t,...i,children:[e.jsx(Ds,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Next slide"})]})});Cs.displayName="CarouselNext";const _t=({userId:s,type:r,propertyId:n,limit:i=5,title:a})=>{const{recommendations:o,loading:t,refetch:d}=vs({type:r,propertyId:n,limit:i});return t?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(De,{className:"h-8 w-64"}),e.jsx(De,{className:"h-10 w-32"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[...Array(i)].map((c,u)=>e.jsx(De,{className:"h-96"},u))})]}):o.length?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold",children:a||(r==="properties"?"🎯 Recommandations pour vous":"⭐ Locataires recommandés")}),e.jsxs(_,{variant:"outline",onClick:d,disabled:t,children:[e.jsx(Ve,{className:`h-4 w-4 mr-2 ${t?"animate-spin":""}`}),"Actualiser"]})]}),e.jsxs(bs,{opts:{align:"start",loop:!1,watchDrag:!0,skipSnaps:!1},plugins:[],className:"w-full",children:[e.jsx(ys,{className:"-ml-4",children:o.map(c=>e.jsx(ws,{className:"pl-4 md:basis-1/2 lg:basis-1/3",children:e.jsx(wt,{item:c,type:r==="properties"?"property":"tenant",score:c.score,reasons:c.reasons})},c.id))}),e.jsx(_s,{className:"hidden md:flex"}),e.jsx(Cs,{className:"hidden md:flex"})]})]}):null},Ct=()=>{const{user:s,profile:r,roles:n}=se(),{activeMandates:i,asAgency:a}=ht(),o=()=>!s||!r?!1:r.user_type==="proprietaire"||r.user_type==="agence",t=(u,p)=>!s||!r?!1:s.id===u?!0:r.user_type==="agence"?a.some(y=>y.status==="active"&&(y.property_id===p||y.property_id===null)&&y.owner_id===u&&y.permissions.can_edit_properties===!0):!1,d=(u,p,x)=>{if(!s||(r==null?void 0:r.user_type)!=="agence")return!1;const y=a.find(v=>v.status==="active"&&(v.property_id===u||v.property_id===null)&&v.owner_id===p);return(y==null?void 0:y.permissions[x])===!0},c=()=>s?r?o()?{hasAccess:!0}:{hasAccess:!1,error:Pe.UNAUTHORIZED}:{hasAccess:!1,error:Pe.SERVER_ERROR}:{hasAccess:!1,error:Pe.AUTH_REQUIRED};return{canManageProperties:o(),canEditProperty:t,hasAgencyPermission:d,requireOwnerAccess:c,activeMandates:i,asAgency:a,user:s,profile:r}},St=s=>{const[r,n]=l.useState(null),[i,a]=l.useState(!1);return l.useEffect(()=>{if(!s){n(null);return}(async()=>{a(!0);try{const{data:t,error:d}=await I.rpc("get_user_phone",{target_user_id:s});d?(f.error("Error fetching user phone",{error:d,userId:s}),n(null)):n(t)}catch(t){f.error("Exception fetching user phone",{error:t,userId:s}),n(null)}finally{a(!1)}})()},[s]),{phone:r,loading:i}},Et=({applicantId:s})=>{const{phone:r,loading:n}=St(s);return n?e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"📞 Chargement..."}):r?e.jsxs("p",{className:"text-sm text-muted-foreground mb-2",children:["📞 ",r]}):null},ar=()=>{const{propertyId:s}=ns(),{user:r}=se(),n=Ie(),{hasAgencyPermission:i}=Ct(),[a,o]=l.useState(null),[t,d]=l.useState([]),[c,u]=l.useState(!0),[p,x]=l.useState(!1),[y,v]=l.useState(null),[m,b]=l.useState(""),[j,F]=l.useState("score"),[C,K]=l.useState("all"),[N,k]=l.useState(!1),[P,B]=l.useState(!1),{recommendations:L}=vs({type:"tenants",propertyId:s||void 0,autoFetch:!0});l.useEffect(()=>{s&&w()},[s]);const w=async()=>{try{const{data:S,error:$}=await I.from("properties").select("id, title, city, monthly_rent, owner_id").eq("id",s).single();if($)throw $;const h=S.owner_id===(r==null?void 0:r.id),A=i(s,S.owner_id,"can_view_applications"),V=i(s,S.owner_id,"can_manage_applications");if(!h&&!A){T({title:"Accès refusé",description:"Vous n'avez pas accès aux candidatures de ce bien",variant:"destructive"}),n("/");return}k(!h&&A),B(h||V),o(S);const{data:Q,error:te}=await I.from("rental_applications").select(`
          *,
          profiles (
            full_name,
            phone,
            oneci_verified,
            cnam_verified,
            face_verified,
            avatar_url
          )
        `).eq("property_id",s).order("created_at",{ascending:!1});if(te)throw te;const ks=(Q||[]).map(Xe=>{const ce=L.find(Is=>Is.id===Xe.applicant_id);return{...Xe,recommendation_score:(ce==null?void 0:ce.score)||0,recommendation_reasons:(ce==null?void 0:ce.reasons)||[]}});d(ks)}catch(S){f.logError(S,{context:"PropertyApplications",action:"fetchData",propertyId:s}),T({title:"Erreur",description:"Impossible de charger les données",variant:"destructive"})}finally{u(!1)}},g=async(S,$,h)=>{try{const{error:A}=await I.from("rental_applications").update({status:$,reviewed_at:new Date().toISOString()}).eq("id",S);if(A)throw A;const V=t.find(Q=>Q.id===S);V&&await I.from("notifications").insert({user_id:V.applicant_id,type:$==="approved"?"application_approved":"application_rejected",title:$==="approved"?"Candidature approuvée !":"Candidature rejetée",message:$==="approved"?`Votre candidature pour "${a==null?void 0:a.title}" a été approuvée !`:`Votre candidature pour "${a==null?void 0:a.title}" a été rejetée. ${h||""}`,link:"/candidatures"}),T({title:"Mise à jour effectuée",description:`Candidature ${$==="approved"?"approuvée":"rejetée"}`}),w(),x(!1),b(""),v(null)}catch(A){f.logError(A,{context:"PropertyApplications",action:"updateApplication",applicationId:S}),T({title:"Erreur",description:A.message,variant:"destructive"})}},E=S=>{v(S),x(!0)},z=S=>{const $={pending:"outline",approved:"default",rejected:"destructive"},h={pending:"En attente",approved:"Approuvée",rejected:"Rejetée"};return e.jsx(D,{variant:$[S],children:h[S]})},U=S=>S>=70?e.jsx(D,{className:"bg-green-500 text-white",children:"Excellent"}):S>=50?e.jsx(D,{variant:"secondary",children:"Bon"}):e.jsx(D,{variant:"destructive",children:"Faible"}),R=S=>S>=80?e.jsxs(D,{className:"bg-gradient-to-r from-yellow-400 to-orange-500 text-white gap-1",children:[e.jsx(zs,{className:"h-3 w-3"}),"Highly Recommended"]}):S>=60?e.jsxs(D,{variant:"secondary",className:"gap-1",children:[e.jsx(J,{className:"h-3 w-3"}),"Good Match"]}):null,H=[...t].filter(S=>C==="all"?!0:C==="high"?(S.recommendation_score||0)>=80:C==="good"?(S.recommendation_score||0)>=60:!0).sort((S,$)=>j==="score"?($.recommendation_score||0)-(S.recommendation_score||0):new Date($.created_at).getTime()-new Date(S.created_at).getTime());if(c)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})});if(!a)return e.jsx("div",{children:"Bien non trouvé"});const ee=H.filter(S=>S.status==="pending"),le=H.filter(S=>S.status==="approved"),he=H.filter(S=>S.status==="rejected");return e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(Me,{}),e.jsxs("main",{className:"flex-1 container mx-auto px-4 py-8 pt-24 max-w-7xl",children:[e.jsx(vt,{}),e.jsxs("div",{className:"mb-8",children:[N&&e.jsxs(W,{className:"mb-4",children:[e.jsx(Ps,{className:"h-4 w-4"}),e.jsxs(Z,{children:[e.jsx("strong",{children:"Vue Agence"})," - Vous consultez les candidatures pour le compte du propriétaire.",P?" Vous pouvez gérer ces candidatures.":" Accès en lecture seule."]})]}),e.jsxs(_,{variant:"ghost",onClick:()=>n(`/property/${s}`),className:"mb-4 -ml-2",children:[e.jsx(He,{className:"h-4 w-4 mr-2"}),"Retour au bien"]}),e.jsxs("h1",{className:"text-4xl font-bold mb-3 flex items-center gap-3",children:[e.jsx(Ts,{className:"h-8 w-8 text-primary"}),"Candidatures"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center gap-2",children:[e.jsx("p",{className:"text-lg text-muted-foreground",children:a.title}),e.jsx("span",{className:"text-muted-foreground hidden sm:inline",children:"•"}),e.jsx("p",{className:"text-lg text-muted-foreground",children:a.city})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-8",children:[e.jsxs(M,{className:"border-2",children:[e.jsx(G,{className:"pb-3",children:e.jsx(Y,{className:"text-sm font-medium text-muted-foreground",children:"Total"})}),e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ne,{className:"h-8 w-8 text-primary"}),e.jsx("span",{className:"text-3xl font-bold",children:t.length})]})})]}),e.jsxs(M,{className:"border-2",children:[e.jsx(G,{className:"pb-3",children:e.jsx(Y,{className:"text-sm font-medium text-muted-foreground",children:"En attente"})}),e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ge,{className:"h-8 w-8 text-orange-500"}),e.jsx("span",{className:"text-3xl font-bold",children:ee.length})]})})]}),e.jsxs(M,{className:"border-2",children:[e.jsx(G,{className:"pb-3",children:e.jsx(Y,{className:"text-sm font-medium text-muted-foreground",children:"Approuvées"})}),e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(J,{className:"h-8 w-8 text-green-500"}),e.jsx("span",{className:"text-3xl font-bold",children:le.length})]})})]})]}),e.jsx(M,{className:"mb-6",children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Trier par"}),e.jsxs(Le,{value:j,onValueChange:S=>F(S),children:[e.jsx($e,{children:e.jsx(qe,{})}),e.jsxs(Oe,{children:[e.jsx(re,{value:"score",children:"Score de compatibilité"}),e.jsx(re,{value:"date",children:"Date de candidature"})]})]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"text-sm font-medium mb-2 block",children:"Filtrer par matching"}),e.jsxs(Le,{value:C,onValueChange:S=>K(S),children:[e.jsx($e,{children:e.jsx(qe,{})}),e.jsxs(Oe,{children:[e.jsx(re,{value:"all",children:"Tous les candidats"}),e.jsx(re,{value:"high",children:"Highly Recommended (80%+)"}),e.jsx(re,{value:"good",children:"Good Match (60%+)"})]})]})]})]})})}),e.jsxs(ms,{defaultValue:"all",className:"w-full",children:[e.jsxs(hs,{className:"mb-6",children:[e.jsxs(ie,{value:"all",children:["Toutes (",H.length,")"]}),e.jsxs(ie,{value:"pending",children:["En attente (",ee.length,")"]}),e.jsxs(ie,{value:"approved",children:["Approuvées (",le.length,")"]}),e.jsxs(ie,{value:"rejected",children:["Rejetées (",he.length,")"]})]}),[{value:"all",apps:t},{value:"pending",apps:ee},{value:"approved",apps:le},{value:"rejected",apps:he}].map(({value:S,apps:$})=>e.jsx(fe,{value:S,className:"space-y-4",children:$.length===0?e.jsxs(M,{className:"p-12 text-center border-2",children:[e.jsx(Ne,{className:"h-16 w-16 mx-auto text-muted-foreground mb-4 opacity-50"}),e.jsx("p",{className:"text-muted-foreground text-lg",children:"Aucune candidature"})]}):$.map(h=>e.jsx(M,{className:"border-2 hover:shadow-lg transition-shadow",children:e.jsx(q,{className:"pt-6",children:e.jsxs("div",{className:"grid md:grid-cols-[1fr,auto] gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(xs,{className:"h-14 w-14",children:e.jsx(ps,{className:"bg-primary/10 text-primary text-lg font-semibold",children:h.profiles.full_name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2 flex-wrap",children:[e.jsx("h3",{className:"text-xl font-semibold",children:h.profiles.full_name}),z(h.status),h.recommendation_score&&R(h.recommendation_score)]}),e.jsx(Et,{applicantId:h.applicant_id}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Candidature du ",new Date(h.created_at).toLocaleDateString("fr-FR")]})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[h.profiles.oneci_verified&&e.jsxs(D,{variant:"outline",className:"rounded-full",children:[e.jsx(J,{className:"h-3 w-3 mr-1 text-green-600"}),"ONECI"]}),h.profiles.cnam_verified&&e.jsxs(D,{variant:"outline",className:"rounded-full",children:[e.jsx(J,{className:"h-3 w-3 mr-1 text-green-600"}),"CNAM"]}),h.profiles.face_verified&&e.jsxs(D,{variant:"outline",className:"rounded-full",children:[e.jsx(J,{className:"h-3 w-3 mr-1 text-green-600"}),"Visage"]})]}),e.jsxs("div",{className:"space-y-2",children:[h.application_score>0&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-muted/50 rounded-xl",children:[e.jsx(ls,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Score locataire:"}),e.jsxs(D,{variant:"default",className:"rounded-xl",children:[h.application_score,"/100"]}),U(h.application_score)]}),h.recommendation_score&&h.recommendation_score>0&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-primary/5 rounded-xl border border-primary/20",children:[e.jsx(Vs,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Compatibilité:"}),e.jsxs(D,{variant:"default",className:"rounded-xl bg-primary",children:[Math.round(h.recommendation_score),"%"]})]}),h.recommendation_reasons&&h.recommendation_reasons.length>0&&e.jsxs("div",{className:"p-3 bg-primary/5 rounded-xl border border-primary/10",children:[e.jsx("p",{className:"text-xs font-medium text-primary mb-2",children:"POURQUOI CE CANDIDAT ?"}),e.jsx("ul",{className:"text-sm space-y-1",children:h.recommendation_reasons.map((A,V)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(J,{className:"h-3 w-3 text-primary mt-0.5 flex-shrink-0"}),e.jsx("span",{children:A})]},V))})]})]}),h.cover_letter&&e.jsxs("div",{className:"p-4 bg-muted/30 rounded-xl",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground mb-2",children:"LETTRE DE MOTIVATION"}),e.jsx("p",{className:"text-sm line-clamp-3",children:h.cover_letter})]})]}),e.jsxs("div",{className:"flex flex-col gap-3 md:min-w-[200px]",children:[e.jsxs(_,{variant:"outline",onClick:()=>n(`/candidatures?view=${h.id}`),className:"rounded-xl h-11",children:[e.jsx(cs,{className:"h-4 w-4 mr-2"}),"Voir détails"]}),h.status==="pending"&&P&&e.jsxs(e.Fragment,{children:[e.jsxs(_,{onClick:()=>g(h.id,"approved"),className:"rounded-xl h-11 bg-green-600 hover:bg-green-700",children:[e.jsx(J,{className:"h-4 w-4 mr-2"}),"Approuver"]}),e.jsxs(_,{variant:"destructive",onClick:()=>E(h),className:"rounded-xl h-11",children:[e.jsx(we,{className:"h-4 w-4 mr-2"}),"Rejeter"]})]}),h.status==="approved"&&e.jsx(_,{variant:"outline",onClick:async()=>{try{const A=new Date,V=new Date;V.setFullYear(V.getFullYear()+1);const{error:Q}=await I.from("leases").insert({property_id:h.property_id,landlord_id:a.owner_id,tenant_id:h.applicant_id,monthly_rent:a.monthly_rent,lease_type:"location_meublee",start_date:A.toISOString().split("T")[0],end_date:V.toISOString().split("T")[0],status:"draft"});if(Q)throw Q;T({title:"Bail créé",description:"Le bail a été créé avec succès"}),n("/baux")}catch(A){T({title:"Erreur",description:A.message,variant:"destructive"})}},className:"rounded-xl h-11",children:"📄 Créer le bail"})]})]})})},h.id))},S))]})]}),e.jsx(Je,{open:p,onOpenChange:x,children:e.jsxs(Ke,{className:"rounded-xl",children:[e.jsxs(Ye,{children:[e.jsx(We,{children:"Rejeter la candidature"}),e.jsx(Ze,{children:"Vous pouvez ajouter une note pour expliquer le rejet au candidat (optionnel)."})]}),e.jsx(fs,{placeholder:"Raison du rejet (optionnel)...",value:m,onChange:S=>b(S.target.value),className:"min-h-[120px] rounded-xl"}),e.jsxs(gs,{children:[e.jsx(_,{variant:"outline",onClick:()=>x(!1),className:"rounded-xl",children:"Annuler"}),e.jsx(_,{variant:"destructive",onClick:()=>y&&g(y.id,"rejected",m),className:"rounded-xl",children:"Confirmer le rejet"})]})]})}),e.jsx(Be,{})]})},kt=()=>{const r=Date.now()+3e3,n={startVelocity:30,spread:360,ticks:60,zIndex:9999},i=(o,t)=>Math.random()*(t-o)+o,a=setInterval(()=>{const o=r-Date.now();if(o<=0)return clearInterval(a);const t=50*(o/3e3);ke({...n,particleCount:t,origin:{x:i(.1,.3),y:Math.random()-.2},colors:["#FFD700","#FF8F00","#FFA500","#FFB700"]}),ke({...n,particleCount:t,origin:{x:i(.7,.9),y:Math.random()-.2},colors:["#FFD700","#FF8F00","#FFA500","#FFB700"]})},250)},ir=()=>{ke({particleCount:100,spread:70,origin:{y:.6},colors:["#2563eb","#7c3aed","#3b82f6","#8b5cf6"],zIndex:9999})},nr=()=>{const r={origin:{y:.7},zIndex:9999},n=(i,a)=>{ke({...r,...a,particleCount:Math.floor(200*i),colors:["#22c55e","#16a34a","#4ade80","#86efac"]})};n(.25,{spread:26,startVelocity:55}),n(.2,{spread:60}),n(.35,{spread:100,decay:.91,scalar:.8}),n(.1,{spread:120,startVelocity:25,decay:.92,scalar:1.2}),n(.1,{spread:120,startVelocity:45})},as=5*1024*1024,It=["image/jpeg","image/png","image/jpg"],At=.85,Ft=1920,is=({value:s,className:r})=>e.jsx("div",{className:`relative h-2 w-full overflow-hidden rounded-full bg-secondary ${r}`,children:e.jsx("div",{className:"h-full bg-primary transition-all duration-300 ease-in-out",style:{width:`${Math.min(100,Math.max(0,s))}%`},role:"progressbar","aria-valuenow":s,"aria-valuemin":0,"aria-valuemax":100})}),Dt=async(s,r=Ft,n=At)=>(f.debug("Compression image démarrée"),new Promise((i,a)=>{const o=new Image;o.onload=()=>{const t=document.createElement("canvas");let{width:d,height:c}=o;f.debug("Dimensions originales image",{width:d,height:c}),(d>r||c>r)&&(d>c?(c=c/d*r,d=r):(d=d/c*r,c=r),f.debug("Nouvelles dimensions",{width:d,height:c})),t.width=d,t.height=c;const u=t.getContext("2d");if(!u){a(new Error("Impossible de créer le contexte canvas"));return}u.imageSmoothingEnabled=!0,u.imageSmoothingQuality="high",u.drawImage(o,0,0,d,c);const p=t.toDataURL("image/jpeg",n),x=s.length*3/4/1024/1024,y=p.length*3/4/1024/1024,v=((1-y/x)*100).toFixed(1);f.debug("Compression terminée",{original:`${x.toFixed(2)}MB`,compressed:`${y.toFixed(2)}MB`,reduction:`${v}%`}),i(p)},o.onerror=()=>{f.error("Erreur chargement image pour compression"),a(new Error("Erreur de chargement de l'image"))},o.src=s})),Pt=s=>(f.debug("Validation fichier",{name:s.name,type:s.type,size:`${(s.size/1024/1024).toFixed(2)}MB`}),It.includes(s.type)?s.size>as?{valid:!1,error:`Taille maximale: ${as/1024/1024}MB`}:{valid:!0}:{valid:!1,error:"Format non supporté. Utilisez JPG ou PNG."}),Tt=({onSubmit:s}={})=>{const{user:r}=se(),[n,i]=l.useState(null),[a,o]=l.useState(null),[t,d]=l.useState(!1),[c,u]=l.useState(!1),[p,x]=l.useState(!1),[y,v]=l.useState(0),[m,b]=l.useState(null),j=l.useRef(null),F=l.useRef(null),C=l.useRef(null);l.useEffect(()=>()=>{f.debug("Nettoyage composant ONECIForm"),C.current&&(C.current.getTracks().forEach(w=>{w.stop(),f.debug("Track arrêté",{label:w.label})}),C.current=null)},[]);const K=async()=>{try{if(f.info("Démarrage de la caméra"),u(!0),!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("L'API MediaDevices n'est pas supportée par ce navigateur");const w=await navigator.mediaDevices.getUserMedia({video:{facingMode:"user",width:{ideal:1280},height:{ideal:720}}});if(f.debug("Stream vidéo obtenu",{settings:w.getVideoTracks()[0].getSettings()}),!j.current)throw new Error("Référence vidéo non disponible");const g=j.current;C.current=w;const E=new Promise((z,U)=>{const R=()=>{f.debug("Vidéo prête (canplay)",{width:g.videoWidth,height:g.videoHeight,readyState:g.readyState}),g.videoWidth>0&&g.videoHeight>0&&(d(!0),u(!1),f.info("Caméra prête à capturer"),O.success("Caméra activée !",{description:"Positionnez votre visage au centre"}),z())},H=ee=>{f.error("Erreur vidéo",{error:ee}),U(new Error("Erreur de chargement de la vidéo"))};g.addEventListener("canplay",R,{once:!0}),g.addEventListener("error",H,{once:!0}),setTimeout(()=>{g.removeEventListener("canplay",R),g.removeEventListener("error",H),g.readyState>=2&&g.videoWidth>0?(f.debug("Timeout mais vidéo prête",{readyState:g.readyState,width:g.videoWidth,height:g.videoHeight}),d(!0),u(!1),O.success("Caméra activée !"),z()):(f.error("Timeout: vidéo non prête",{readyState:g.readyState,width:g.videoWidth,height:g.videoHeight}),U(new Error("La vidéo n'a pas pu se charger")))},5e3)});g.srcObject=w;try{await g.play(),f.debug("video.play() appelé avec succès")}catch(z){f.warn("video.play() a échoué (peut-être déjà en lecture)",{error:z})}await E}catch(w){f.error("Error accessing camera",{error:w}),u(!1),d(!1);let g="Impossible d'accéder à la caméra",E="Vérifiez vos permissions et réessayez";w instanceof Error&&(w.name==="NotAllowedError"?(g="Autorisation caméra refusée",E="Autorisez l'accès à la caméra dans les paramètres de votre navigateur"):w.name==="NotFoundError"?(g="Aucune caméra trouvée",E="Vérifiez qu'une caméra est connectée à votre appareil"):w.name==="NotReadableError"?(g="La caméra est déjà utilisée",E="Fermez les autres applications utilisant la caméra"):(w.message.includes("Timeout")||w.message.includes("charger"))&&(g="La caméra n'a pas pu se charger",E="Réessayez ou rechargez la page")),O.error(g,{description:E}),C.current&&(C.current.getTracks().forEach(z=>{z.stop(),f.debug("Track arrêté (erreur)",{label:z.label})}),C.current=null)}},N=l.useCallback(()=>{f.debug("Arrêt de la caméra"),C.current&&(C.current.getTracks().forEach(w=>w.stop()),C.current=null),d(!1),u(!1)},[]),k=()=>{if(f.debug("Tentative de capture du selfie"),!j.current||!F.current){O.error("Erreur de capture",{description:"Références vidéo manquantes"});return}const w=j.current,g=F.current;if(w.videoWidth===0||w.videoHeight===0){f.error("Dimensions vidéo invalides",{width:w.videoWidth,height:w.videoHeight}),O.error("Vidéo non prête",{description:"Attendez que la caméra charge complètement"});return}if(!C.current||C.current.getTracks().length===0){f.error("Aucun stream actif"),O.error("Caméra inactive",{description:"Relancez la caméra et réessayez"});return}f.debug("Capture du selfie",{width:w.videoWidth,height:w.videoHeight}),g.width=w.videoWidth,g.height=w.videoHeight;const E=g.getContext("2d");if(E){E.drawImage(w,0,0);const z=g.toDataURL("image/jpeg",.8);o(z),N(),f.info("Selfie capturé avec succès"),O.success("Selfie capturé !")}else f.error("Impossible d'obtenir le contexte canvas"),O.error("Erreur de capture",{description:"Impossible de traiter l'image"})},P=l.useCallback(async w=>{var z;const g=(z=w.target.files)==null?void 0:z[0];if(!g){f.debug("Aucun fichier sélectionné");return}f.debug("Fichier sélectionné",{name:g.name,type:g.type,size:`${(g.size/1024/1024).toFixed(2)}MB`});const E=Pt(g);if(!E.valid){f.error("Validation échouée",{error:E.error}),O.error("Fichier invalide",{description:E.error}),w.target.value="";return}f.debug("Validation réussie, début de la lecture"),v(0);try{const U=new FileReader;U.onprogress=R=>{if(R.lengthComputable){const H=R.loaded/R.total*100;v(H),f.debug(`Progression upload: ${H.toFixed(1)}%`)}},U.onloadend=async()=>{try{f.debug("Fichier chargé, début de la compression");let R=U.result;const H=R.length*3/4/1024/1024;f.debug(`Taille originale: ${H.toFixed(2)}MB`),R=await Dt(R);const ee=R.length*3/4/1024/1024;f.debug(`Taille compressée: ${ee.toFixed(2)}MB`),f.debug("setCniImage appelé avec image compressée"),i(R),v(100),O.success("Photo de CNI chargée !",{description:`Taille: ${ee.toFixed(2)}MB`}),setTimeout(()=>{v(0),f.debug("Progress bar réinitialisée")},1e3)}catch(R){f.error("Erreur de compression",{error:R}),O.error("Erreur de traitement",{description:"Impossible de traiter l'image"}),v(0)}},U.onerror=R=>{f.error("Erreur de lecture du fichier",{error:R}),O.error("Erreur de lecture",{description:"Impossible de lire le fichier"}),v(0)},U.readAsDataURL(g)}catch(U){f.error("Erreur lors du chargement",{error:U}),O.error("Erreur",{description:"Impossible de charger le fichier"}),v(0)}w.target.value=""},[]),B=async()=>{if(!n||!a){O.error("Veuillez fournir les deux images");return}x(!0),b(null);try{const{data:w,error:g}=await I.functions.invoke("smile-id-verification",{body:{cniImageBase64:n,selfieBase64:a}});if(g)throw g;b(w),w.verified?(await I.from("profiles").update({oneci_verified:!0}).eq("id",r==null?void 0:r.id),kt(),O.success("🎉 Certification ANSUT réussie !",{description:`Score de similarité : ${w.similarityScore}% • Vous êtes maintenant certifié ANSUT`,duration:5e3}),s==null||s()):O.error("Vérification échouée",{description:w.message||w.resultText})}catch(w){f.error("ONECI Smile ID verification error",{error:w}),O.error("Erreur lors de la vérification",{description:w instanceof Error?w.message:"Une erreur est survenue"})}finally{x(!1)}},L=()=>{i(null),o(null),b(null),N()};return e.jsxs(M,{children:[e.jsxs(G,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(ue,{className:"h-6 w-6 text-primary"}),"Vérification d'Identité ONECI"]}),e.jsx(Qe,{children:"Vérification sécurisée via Smile ID pour ressortissants ivoiriens"})]}),e.jsxs(q,{className:"space-y-6",children:[e.jsxs(W,{children:[e.jsx(Rs,{className:"h-4 w-4"}),e.jsxs(Z,{children:[e.jsx("strong",{children:"Instructions importantes :"}),e.jsxs("ul",{className:"mt-2 space-y-1 text-sm list-disc list-inside",children:[e.jsxs("li",{children:["Téléchargez une photo ",e.jsx("strong",{children:"claire et nette"})," de votre CNI ivoirienne"]}),e.jsxs("li",{children:["Assurez-vous que ",e.jsx("strong",{children:"toutes les informations"})," sur la CNI sont lisibles"]}),e.jsxs("li",{children:["Prenez un selfie avec un ",e.jsx("strong",{children:"bon éclairage"})," (lumière naturelle de préférence)"]}),e.jsxs("li",{children:["Regardez ",e.jsx("strong",{children:"directement la caméra"}),", expression neutre"]}),e.jsxs("li",{children:["Retirez ",e.jsx("strong",{children:"lunettes, masque, chapeau"})," ou tout accessoire"]})]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ue,{htmlFor:"cni-upload",className:"text-base font-semibold",children:"1. Photo de votre Carte Nationale d'Identité"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Téléchargez une photo claire du recto de votre CNI"}),n?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:n,alt:"Carte Nationale d'Identité",className:"w-full h-48 object-cover rounded-lg border-2 border-primary shadow-sm"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center",children:e.jsxs(_,{size:"sm",variant:"destructive",onClick:()=>{i(null),b(null)},children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Retirer"]})}),e.jsxs("div",{className:"absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(_e,{className:"h-3 w-3"}),"Chargée"]})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{htmlFor:"cni-upload",className:"flex flex-col items-center justify-center h-48 border-2 border-dashed rounded-lg cursor-pointer hover:border-primary hover:bg-primary/5 transition-all bg-muted/30",children:[e.jsx(Ms,{className:"h-10 w-10 mb-3 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Cliquez pour télécharger"}),e.jsx("span",{className:"text-xs text-muted-foreground mt-1",children:"JPG, PNG (max 5MB)"}),e.jsx("input",{id:"cni-upload",type:"file",accept:"image/jpeg,image/jpg,image/png",className:"hidden",onChange:P,"aria-label":"Télécharger photo de CNI"})]}),y>0&&y<100&&e.jsx(is,{value:y})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ue,{className:"text-base font-semibold",children:"2. Selfie de vérification"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Prenez une photo de votre visage pour vérification biométrique"}),a?e.jsxs("div",{className:"relative group",children:[e.jsx("img",{src:a,alt:"Selfie de vérification",className:"w-full h-48 object-cover rounded-lg border-2 border-primary shadow-sm"}),e.jsx("div",{className:"absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity rounded-lg flex items-center justify-center",children:e.jsxs(_,{size:"sm",variant:"destructive",onClick:()=>{o(null),b(null),N()},children:[e.jsx(we,{className:"mr-2 h-4 w-4"}),"Retirer"]})}),e.jsxs("div",{className:"absolute top-2 right-2 bg-green-500 text-white px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1",children:[e.jsx(_e,{className:"h-3 w-3"}),"Capturé"]})]}):t||c?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx("video",{ref:j,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-48 object-cover rounded-lg border-2 border-primary"}),c&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center bg-black/70 rounded-lg",children:e.jsxs("div",{className:"text-center text-white",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-4 border-white border-t-transparent mx-auto mb-3"}),e.jsx("p",{className:"text-sm font-medium",children:"Chargement de la caméra..."}),e.jsx("p",{className:"text-xs text-white/70 mt-1",children:"Patientez quelques secondes"})]})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(_,{onClick:k,className:"flex-1",disabled:c,children:c?"Chargement...":e.jsxs(e.Fragment,{children:[e.jsx(es,{className:"mr-2 h-4 w-4"}),"Capturer"]})}),e.jsx(_,{onClick:N,variant:"outline",children:"Annuler"})]})]}):e.jsxs(_,{onClick:K,className:"w-full h-48 flex flex-col gap-3 bg-muted/30",variant:"outline",children:[e.jsx(es,{className:"h-10 w-10 text-primary"}),e.jsx("span",{className:"font-medium",children:"Ouvrir la caméra"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Selfie en direct"})]})]})]}),e.jsx("canvas",{ref:F,className:"hidden"}),m&&e.jsxs(W,{variant:m.verified?"default":"destructive",children:[m.verified?e.jsx(_e,{className:"h-4 w-4"}):e.jsx(we,{className:"h-4 w-4"}),e.jsx(Z,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium",children:m.message}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm",children:"Score de similarité :"}),e.jsx(is,{value:parseFloat(m.similarityScore),className:"flex-1"}),e.jsxs("span",{className:"text-sm font-bold",children:[m.similarityScore,"%"]})]}),!m.verified&&m.canRetry&&e.jsx("p",{className:"text-sm",children:"Vous pouvez réessayer avec de meilleures conditions."})]})})]}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(_,{onClick:B,disabled:!n||!a||p||y>0,size:"lg",className:"w-full",children:p?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{className:"mr-2 h-5 w-5 animate-spin"}),"Vérification en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"mr-2 h-5 w-5"}),"Vérifier mon identité ONECI"]})}),(n||a||m)&&e.jsxs(_,{onClick:L,variant:"outline",size:"lg",className:"w-full",disabled:p,children:[e.jsx(Ve,{className:"mr-2 h-4 w-4"}),"Recommencer la vérification"]})]}),e.jsxs(W,{className:"bg-muted",children:[e.jsx(ue,{className:"h-4 w-4"}),e.jsxs(Z,{className:"text-xs",children:[e.jsx("strong",{children:"Sécurité et confidentialité :"})," Vos images sont transmises de manière sécurisée à Smile ID pour vérification biométrique. Elles ne sont ",e.jsx("strong",{children:"jamais stockées"})," sur nos serveurs. Seul le résultat de vérification (score de correspondance) est conservé dans votre profil."]})]})]})]})},Vt=s=>{l.useEffect(()=>{const r=document.title,n=[];s.title&&(document.title=s.title);const i=(a,o,t=!1)=>{const d=t?"property":"name";let c=document.querySelector(`meta[${d}="${a}"]`);c||(c=document.createElement("meta"),c.setAttribute(d,a),document.head.appendChild(c),n.push(c)),c.content=o};return s.description&&i("description",s.description),s.ogTitle&&i("og:title",s.ogTitle,!0),s.ogDescription&&i("og:description",s.ogDescription,!0),s.ogImage&&i("og:image",s.ogImage,!0),s.ogUrl&&i("og:url",s.ogUrl,!0),s.twitterCard&&i("twitter:card",s.twitterCard),s.ogTitle&&i("twitter:title",s.ogTitle),s.ogDescription&&i("twitter:description",s.ogDescription),s.ogImage&&i("twitter:image",s.ogImage),s.structuredData&&s.structuredData.forEach(a=>{const o=document.createElement("script");o.type="application/ld+json",o.textContent=JSON.stringify(a),document.head.appendChild(o),n.push(o)}),()=>{document.title=r,n.forEach(a=>{a.parentNode&&a.parentNode.removeChild(a)})}},[s.title,s.description,s.ogTitle,s.ogDescription,s.ogImage,s.ogUrl,s.twitterCard,JSON.stringify(s.structuredData)])},zt=({url:s,thumbnail:r})=>{var t,d,c;const[n,i]=l.useState(!1);if(!n)return e.jsxs("div",{className:"relative w-full aspect-video bg-muted rounded-lg overflow-hidden group cursor-pointer",children:[r&&e.jsx("img",{src:r,alt:"Video thumbnail",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black/40 flex items-center justify-center group-hover:bg-black/50 transition-colors",children:e.jsx(_,{size:"lg",onClick:()=>i(!0),className:"rounded-full w-20 h-20",children:e.jsx(Ls,{className:"h-8 w-8 fill-current"})})})]});const a=s.includes("youtube.com")||s.includes("youtu.be"),o=s.includes("vimeo.com");if(a||o){let u=s;return a?u=`https://www.youtube.com/embed/${s.includes("youtu.be")?(t=s.split("youtu.be/")[1])==null?void 0:t.split("?")[0]:(d=s.split("v=")[1])==null?void 0:d.split("&")[0]}?autoplay=1`:o&&(u=`https://player.vimeo.com/video/${(c=s.split("vimeo.com/")[1])==null?void 0:c.split("?")[0]}?autoplay=1`),e.jsx("div",{className:"relative w-full aspect-video bg-black rounded-lg overflow-hidden",children:e.jsx("iframe",{src:u,className:"w-full h-full",allow:"autoplay; fullscreen; picture-in-picture",allowFullScreen:!0})})}return e.jsx("div",{className:"relative w-full aspect-video bg-black rounded-lg overflow-hidden",children:e.jsx("video",{src:s,className:"w-full h-full",controls:!0,autoPlay:!0})})},Rt=({plans:s})=>{const[r,n]=l.useState(0),i=s[r];return e.jsxs("div",{className:"space-y-4",children:[s.length>1&&e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2",children:s.map((a,o)=>e.jsx(_,{variant:o===r?"default":"outline",size:"sm",onClick:()=>n(o),className:"whitespace-nowrap",children:a.title},o))}),e.jsx($s,{initialScale:1,minScale:.5,maxScale:4,centerOnInit:!0,children:({zoomIn:a,zoomOut:o,resetTransform:t})=>e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"absolute top-4 right-4 z-10 flex gap-2",children:[e.jsx(_,{size:"icon",variant:"secondary",onClick:()=>a(),className:"bg-background/80 backdrop-blur-sm",children:e.jsx(qs,{className:"h-4 w-4"})}),e.jsx(_,{size:"icon",variant:"secondary",onClick:()=>o(),className:"bg-background/80 backdrop-blur-sm",children:e.jsx(Os,{className:"h-4 w-4"})}),e.jsx(_,{size:"icon",variant:"secondary",onClick:()=>t(),className:"bg-background/80 backdrop-blur-sm",children:e.jsx(Bs,{className:"h-4 w-4"})})]}),e.jsx(Us,{wrapperClass:"!w-full !h-[600px] bg-muted rounded-lg overflow-hidden",contentClass:"!w-full !h-full flex items-center justify-center",children:e.jsx(Ee,{src:i.url,alt:i.title,className:"max-w-full max-h-full object-contain"})}),e.jsxs("div",{className:"absolute bottom-4 left-4 bg-background/90 backdrop-blur-sm px-4 py-2 rounded-md",children:[e.jsx("h3",{className:"font-semibold",children:i.title}),i.floor&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Étage: ",i.floor]}),i.surface&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Surface: ",i.surface," m²"]})]})]})})]})},Mt=({images:s,onImageChange:r,className:n})=>{const[i,a]=l.useState(0),[o,t]=l.useState(1),[d,c]=l.useState({x:0,y:0}),[u,p]=l.useState(0);l.useEffect(()=>{[i-1,i+1,i+2].forEach(N=>{if(N>=0&&N<s.length){const k=new Image;k.src=s[N]}})},[i,s]),l.useMemo(()=>{const N=Math.max(0,i-2),k=Math.min(s.length,i+3);return{start:N,end:k,images:s.slice(N,k)}},[i,s]);const x=()=>{if(i<s.length-1){ye("medium");const N=i+1;a(N),r==null||r(N)}},y=()=>{if(i>0){ye("medium");const N=i-1;a(N),r==null||r(N)}},v=Hs({onSwipedLeft:x,onSwipedRight:y,trackMouse:!1,delta:50,preventScrollOnSwipe:!0}),m=()=>{const N=Date.now();N-u<300&&(ye("light"),t(o===1?2:1),o!==1&&c({x:0,y:0})),p(N)},b=l.useRef(null),j=N=>{const k=N[0].clientX-N[1].clientX,P=N[0].clientY-N[1].clientY;return Math.sqrt(k*k+P*P)},F=N=>{N.touches.length===2&&(b.current={distance:j(N.touches),scale:o})},C=N=>{if(N.touches.length===2&&b.current){const P=j(N.touches)/b.current.distance,B=Math.max(1,Math.min(3,b.current.scale*P));t(B),B===1&&c({x:0,y:0})}},K=()=>{b.current=null};return e.jsxs("div",{className:"relative w-full",role:"region","aria-label":"Galerie de photos du bien","aria-live":"polite","aria-atomic":"true",children:[e.jsxs("span",{className:"sr-only",children:["Image ",i+1," sur ",s.length]}),e.jsxs("div",{...v,onTouchStart:F,onTouchMove:C,onTouchEnd:K,onClick:m,className:`relative aspect-video w-full overflow-hidden rounded-lg bg-muted touch-none ${n||""}`,children:[e.jsx("div",{className:"w-full h-full transition-transform duration-200",style:{transform:`scale(${o}) translate(${d.x}px, ${d.y}px)`},children:e.jsx(Ee,{src:s[i],alt:`Image ${i+1}`,className:"w-full h-full object-cover",priority:i===0})}),e.jsxs("div",{className:"absolute top-3 right-3 bg-black/60 backdrop-blur-sm text-white px-3 py-1 rounded-full text-sm font-medium",children:[i+1,"/",s.length]}),i>0&&e.jsx(_,{variant:"secondary",size:"icon",className:"absolute left-3 top-1/2 -translate-y-1/2 rounded-full bg-background/80 backdrop-blur-sm",onClick:N=>{N.stopPropagation(),y()},children:e.jsx(Gs,{className:"h-5 w-5"})}),i<s.length-1&&e.jsx(_,{variant:"secondary",size:"icon",className:"absolute right-3 top-1/2 -translate-y-1/2 rounded-full bg-background/80 backdrop-blur-sm",onClick:N=>{N.stopPropagation(),x()},children:e.jsx(Js,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"flex justify-center gap-1.5 mt-3",children:s.map((N,k)=>e.jsx("button",{onClick:()=>{ye("light"),a(k),r==null||r(k),t(1),c({x:0,y:0})},className:`h-2 rounded-full transition-all ${k===i?"w-6 bg-primary":"w-2 bg-muted-foreground/30"}`,"aria-label":`Voir image ${k+1}`},k))}),o===1&&e.jsx("p",{className:"text-xs text-muted-foreground text-center mt-2",children:"Double tap pour zoomer • Pincer pour zoomer"})]})},Lt=s=>{const{user:r}=se(),{data:n=!1}=os({queryKey:["validated-dossier",s,r==null?void 0:r.id],queryFn:async()=>{if(!r||!s)return!1;const{data:i,error:a}=await I.from("rental_applications").select("status").eq("property_id",s).eq("applicant_id",r.id).maybeSingle();return a?(f.error("Failed to check dossier status",{userId:r.id,propertyId:s}),!1):(i==null?void 0:i.status)==="approved"},enabled:!!r&&!!s});return{maxImages:r?n?1/0:6:4,showBlur:!r,showHDPhotos:n,show3DTour:n,showFloorPlans:n,hasValidatedDossier:n}},$t=(s,r={})=>{const{enabled:n=!0,priority:i="low"}=r,a=l.useRef(new Set);return l.useEffect(()=>{if(!n||s.length===0)return;const t=c=>{if(a.current.has(c))return;const u=document.createElement("link");return u.rel="prefetch",u.href=c,u.as="image",i!=="auto"&&u.setAttribute("fetchpriority",i),document.head.appendChild(u),a.current.add(c),()=>{document.head.removeChild(u)}},d=s.map(t);return()=>{d.forEach(c=>c==null?void 0:c())}},[s,n,i]),{prefetchOnHover:t=>{if(a.current.has(t))return;const d=new Image;d.src=t,a.current.add(t)}}},qt=({propertyId:s,images:r=[],videoUrl:n,virtualTourUrl:i,panoramicImages:a=[],floorPlans:o=[]})=>{const[t,d]=l.useState(!1),[c,u]=l.useState(0),[p,x]=l.useState(0),y=xt(),{maxImages:v,showBlur:m,showHDPhotos:b,show3DTour:j,showFloorPlans:F}=Lt(s),C=a.map(g=>g.url),{prefetchOnHover:K}=$t(C,{enabled:j&&C.length>0,priority:"low"}),N=r.slice(0,v),k=r.length-N.length,P=!!n,B=a.length>0,L=o.length>0,w=g=>{u(g),d(!0)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(ms,{defaultValue:"photos",className:"w-full",children:[e.jsxs(hs,{className:"w-full justify-start",children:[e.jsxs(ie,{value:"photos",className:"gap-2",children:[e.jsx(Ks,{className:"h-4 w-4"}),"Photos (",N.length,"/",r.length,")"]}),P&&e.jsxs(ie,{value:"video",className:"gap-2",children:[e.jsx(Ys,{className:"h-4 w-4"}),"Vidéo",e.jsx(D,{variant:"secondary",className:"ml-1",children:"Nouveau"})]}),B&&j&&e.jsxs(ie,{value:"360",className:"gap-2",onMouseEnter:()=>{C.forEach(g=>K(g))},children:[e.jsx(ss,{className:"h-4 w-4"}),"Vue 360°",e.jsx(D,{variant:"secondary",className:"ml-1",children:a.length})]}),L&&F&&e.jsxs(ie,{value:"plans",className:"gap-2",children:[e.jsx(Ws,{className:"h-4 w-4"}),"Plans"]})]}),e.jsxs(fe,{value:"photos",className:"space-y-4",children:[!b&&e.jsxs(W,{className:"border-2 border-primary/20 bg-gradient-to-r from-primary/5 to-accent/5",children:[e.jsx(ae,{className:"h-5 w-5 text-primary"}),e.jsx(ne,{className:"text-lg font-semibold",children:m?"🔒 Aperçu limité - Créez un compte gratuit":"🎯 Débloquez tout le contenu premium"}),e.jsxs(Z,{className:"space-y-3 mt-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium",children:m?"Sans compte, vous voyez seulement 4 photos (floues).":"Votre dossier n'est pas encore validé. Débloquez :"}),!m&&k>0&&e.jsxs("ul",{className:"list-disc list-inside text-sm space-y-1 ml-2",children:[e.jsxs("li",{children:[e.jsxs("strong",{children:[k," photos HD"]})," supplémentaires"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Visite virtuelle 3D"})," interactive"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Plans détaillés"})," du bien"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Vidéos"})," de présentation"]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 pt-2",children:[e.jsx(_,{asChild:!0,size:"sm",className:"font-semibold",children:e.jsxs(me,{to:m?"/auth":"/verification",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),m?"Créer un compte gratuit":"Valider mon dossier"]})}),!m&&e.jsx(_,{asChild:!0,size:"sm",variant:"outline",children:e.jsx(me,{to:"/guide#dossier-locataire",children:"Comment ça marche ?"})})]})]})]}),y?e.jsx(Mt,{images:N,onImageChange:g=>u(g),className:X(m&&"blur-sm")}):e.jsxs(e.Fragment,{children:[N.length>0&&e.jsxs("div",{className:X("relative aspect-video w-full overflow-hidden rounded-lg cursor-pointer group",m&&"blur-sm"),onClick:()=>!m&&w(0),children:[e.jsx(Ee,{src:N[0],alt:"Photo principale",priority:!0,className:"w-full h-full object-cover transition-transform group-hover:scale-105"}),m&&e.jsx("div",{className:"absolute inset-0 bg-black/20 flex items-center justify-center",children:e.jsx(ae,{className:"h-12 w-12 text-white"})})]}),N.length>1&&e.jsx("div",{className:"grid grid-cols-4 gap-2",children:N.slice(1,5).map((g,E)=>e.jsxs("div",{className:X("relative aspect-video overflow-hidden rounded-md cursor-pointer group",m&&"blur-sm"),onClick:()=>!m&&w(E+1),children:[e.jsx(Ee,{src:g,alt:`Photo ${E+2}`,className:"w-full h-full object-cover transition-transform group-hover:scale-105"}),E===3&&k>0&&e.jsxs("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center text-white font-semibold",children:[e.jsx(ae,{className:"h-6 w-6 mr-2"}),"+",k]})]},E+1))})]})]}),P&&e.jsx(fe,{value:"video",children:e.jsx(zt,{url:n,thumbnail:r[0]})}),B&&e.jsx(fe,{value:"360",children:e.jsx("div",{className:"space-y-4",children:e.jsxs(W,{children:[e.jsx(ss,{className:"h-4 w-4"}),e.jsx(ne,{children:"Visite 360° Temporairement Indisponible"}),e.jsx(Z,{children:"La fonctionnalité de visite panoramique est en cours de maintenance."})]})})}),L&&e.jsx(fe,{value:"plans",children:e.jsx(Rt,{plans:o})})]}),e.jsx(ds,{open:t,close:()=>d(!1),index:c,slides:r.map(g=>({src:g})),plugins:[us,Zs],zoom:{maxZoomPixelRatio:3,scrollToZoom:!0}})]})},Ot=({propertyId:s,latitude:r,longitude:n,city:i,address:a})=>{const{user:o}=se(),{data:t=!1}=os({queryKey:["can-view-map",s,o==null?void 0:o.id],queryFn:async()=>{if(!o||!s)return!1;const{data:d,error:c}=await I.from("rental_applications").select("status").eq("property_id",s).eq("applicant_id",o.id).maybeSingle();return c?!1:(d==null?void 0:d.status)==="approved"},enabled:!!o&&!!s});return t?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-2 mb-4",children:[e.jsx(ve,{className:"h-5 w-5 text-primary mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:i}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:a})]})]}),e.jsx("div",{className:"aspect-video bg-muted rounded-lg overflow-hidden",children:e.jsx("iframe",{width:"100%",height:"100%",frameBorder:"0",src:`https://www.openstreetmap.org/export/embed.html?bbox=${n-.01},${r-.01},${n+.01},${r+.01}&layer=mapnik&marker=${r},${n}`,style:{border:0}})}),e.jsx(_,{asChild:!0,className:"w-full",variant:"outline",children:e.jsxs("a",{href:`https://www.google.com/maps/search/?api=1&query=${r},${n}`,target:"_blank",rel:"noopener noreferrer",children:[e.jsx(ve,{className:"mr-2 h-4 w-4"}),"Ouvrir dans Google Maps"]})})]}):e.jsxs(W,{children:[e.jsx(ae,{className:"h-4 w-4"}),e.jsx(ne,{children:"Localisation précise"}),e.jsxs(Z,{className:"space-y-2",children:[e.jsx("p",{children:"La carte interactive et la localisation exacte (GPS) sont disponibles après validation de votre dossier locataire."}),e.jsxs("div",{className:"flex items-start gap-2 mb-3 pt-2",children:[e.jsx(ve,{className:"h-5 w-5 text-muted-foreground mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:i}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Quartier: ",a.split(",")[0]]})]})]}),o?e.jsx(_,{asChild:!0,size:"sm",variant:"outline",children:e.jsxs(me,{to:"/verification",children:[e.jsx(ae,{className:"mr-2 h-4 w-4"}),"Valider mon dossier"]})}):e.jsx(_,{asChild:!0,size:"sm",children:e.jsx(me,{to:"/auth",children:"Créer un compte"})})]})]})},Bt=({propertyId:s,onVerified:r,children:n})=>{const{user:i,profile:a}=se(),o=Ie(),[t,d]=l.useState(!1),[c,u]=l.useState(null),[p,x]=l.useState(!0),[y,v]=l.useState(!1),[m,b]=l.useState(!1),[j,F]=l.useState(null),C=l.useMemo(()=>p?"loading":j?"error":a!=null&&a.oneci_verified||a!=null&&a.passport_verified||(c==null?void 0:c.oneci_status)==="verified"?"verified":(c==null?void 0:c.oneci_status)==="pending"||(c==null?void 0:c.oneci_status)==="pending_review"?"pending":"not_verified",[p,j,a==null?void 0:a.oneci_verified,a==null?void 0:a.passport_verified,c==null?void 0:c.oneci_status]),K=C==="verified",N=C==="pending",k=l.useCallback(async()=>{if(i!=null&&i.id)try{F(null);const{data:E,error:z}=await I.from("user_verifications").select("oneci_status, oneci_verified_at").eq("user_id",i.id).maybeSingle();if(z)throw z;u(E)}catch(E){const z=E instanceof Error?E.message:"Erreur de chargement";f.logError(E,{context:"VerificationGuard",action:"checkVerificationStatus"}),F(z),T({title:"Erreur",description:"Impossible de vérifier votre statut. Veuillez réessayer.",variant:"destructive"})}finally{x(!1)}},[i==null?void 0:i.id]);l.useEffect(()=>{i?k():x(!1)},[i,k]);const P=l.useCallback(()=>{r?r():o(`/application/${s}`)},[r,o,s]),B=l.useCallback(()=>{if(!i){T({title:"Connexion requise",description:"Veuillez vous connecter pour continuer",variant:"destructive"}),o("/auth");return}!K&&!N?d(!0):P()},[i,K,N,o,P]),L=l.useCallback(()=>{b(!0)},[]),w=l.useCallback(async()=>{if(!m){T({title:"Attention",description:"Veuillez d'abord compléter le formulaire de vérification",variant:"destructive"});return}v(!0);try{await k(),T({title:"Vérification soumise !",description:"Votre demande de vérification a été envoyée. Vous pouvez maintenant continuer votre candidature."}),d(!1),P()}catch{T({title:"Erreur",description:"Impossible de valider la vérification. Veuillez réessayer.",variant:"destructive"})}finally{v(!1)}},[m,k,P]),g=l.useCallback(E=>{(E.key==="Enter"||E.key===" ")&&(E.preventDefault(),B())},[B]);return e.jsxs(e.Fragment,{children:[e.jsx("div",{onClick:B,onKeyDown:g,role:"button",tabIndex:0,style:{cursor:"pointer"},children:n}),e.jsx(Je,{open:t,onOpenChange:d,children:e.jsxs(Ke,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ye,{children:[e.jsxs(We,{className:"flex items-center gap-2 text-2xl",children:[e.jsx(ue,{className:"h-6 w-6 text-primary"}),"Vérification d'identité requise"]}),e.jsx(Ze,{children:"Pour postuler à ce bien, vous devez d'abord vérifier votre identité via ONECI"})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsxs(W,{children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsx(ne,{children:"Pourquoi cette vérification ?"}),e.jsx(Z,{children:"La vérification ONECI permet aux propriétaires de confirmer votre identité et d'augmenter la confiance dans votre candidature. C'est une étape rapide et sécurisée."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"flex flex-col items-center text-center p-4 rounded-lg bg-muted/50",children:[e.jsx(ue,{className:"h-8 w-8 text-primary mb-2"}),e.jsx("h4",{className:"font-semibold mb-1",children:"Sécurisé"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Vos données sont protégées"})]}),e.jsxs("div",{className:"flex flex-col items-center text-center p-4 rounded-lg bg-muted/50",children:[e.jsx(J,{className:"h-8 w-8 text-green-600 mb-2"}),e.jsx("h4",{className:"font-semibold mb-1",children:"Rapide"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Seulement quelques minutes"})]}),e.jsxs("div",{className:"flex flex-col items-center text-center p-4 rounded-lg bg-muted/50",children:[e.jsx(Ne,{className:"h-8 w-8 text-blue-600 mb-2"}),e.jsx("h4",{className:"font-semibold mb-1",children:"Une seule fois"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Valable pour toutes vos candidatures"})]})]}),N&&e.jsxs(W,{children:[e.jsx(J,{className:"h-4 w-4"}),e.jsx(ne,{children:"Vérification en cours"}),e.jsx(Z,{children:"Votre demande de vérification est en cours de traitement. Vous pouvez continuer votre candidature pendant ce temps."})]}),(c==null?void 0:c.oneci_status)==="rejected"&&e.jsxs(W,{variant:"destructive",children:[e.jsx(ze,{className:"h-4 w-4"}),e.jsx(ne,{children:"Vérification refusée"}),e.jsx(Z,{children:"Votre vérification a été refusée. Veuillez soumettre à nouveau avec des informations correctes."})]}),!K&&!N&&e.jsxs("div",{className:"border rounded-lg p-6 bg-muted/20",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(ue,{className:"h-5 w-5"}),"Vérification ONECI"]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Complétez le formulaire ci-dessous pour vérifier votre identité. Une fois validé, vous pourrez continuer votre candidature."}),e.jsx(Tt,{onSubmit:L}),e.jsxs("div",{className:"mt-4",children:[e.jsx(_,{onClick:w,className:"w-full",disabled:y||!m,children:y?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"mr-2 h-4 w-4 animate-spin"}),"Traitement en cours..."]}):"J'ai soumis ma vérification"}),!m&&e.jsx("p",{className:"text-xs text-muted-foreground mt-2 text-center",children:"Veuillez d'abord compléter le formulaire ci-dessus"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-4",children:[e.jsx(_,{variant:"outline",onClick:()=>d(!1),className:"flex-1",children:"Annuler"}),N&&e.jsx(_,{onClick:()=>{d(!1),P()},className:"flex-1",children:"Continuer la candidature"})]})]})]})})]})},Ut=Qs,Ss=l.createContext({}),pe=({...s})=>e.jsx(Ss.Provider,{value:{name:s.name},children:e.jsx(Xs,{...s})}),Fe=()=>{const s=l.useContext(Ss),r=l.useContext(Es),{getFieldState:n,formState:i}=st(),a=n(s.name,i);if(!s)throw new Error("useFormField should be used within <FormField>");const{id:o}=r;return{id:o,name:s.name,formItemId:`${o}-form-item`,formDescriptionId:`${o}-form-item-description`,formMessageId:`${o}-form-item-message`,...a}},Es=l.createContext({}),oe=l.forwardRef(({className:s,...r},n)=>{const i=l.useId();return e.jsx(Es.Provider,{value:{id:i},children:e.jsx("div",{ref:n,className:X("space-y-2",s),...r})})});oe.displayName="FormItem";const ge=l.forwardRef(({className:s,...r},n)=>{const{error:i,formItemId:a}=Fe();return e.jsx(Ue,{ref:n,className:X(i&&"text-destructive",s),htmlFor:a,...r})});ge.displayName="FormLabel";const de=l.forwardRef(({...s},r)=>{const{error:n,formItemId:i,formDescriptionId:a,formMessageId:o}=Fe();return e.jsx(et,{ref:r,id:i,"aria-describedby":n?`${a} ${o}`:`${a}`,"aria-invalid":!!n,...s})});de.displayName="FormControl";const Ht=l.forwardRef(({className:s,...r},n)=>{const{formDescriptionId:i}=Fe();return e.jsx("p",{ref:n,id:i,className:X("text-sm text-muted-foreground",s),...r})});Ht.displayName="FormDescription";const je=l.forwardRef(({className:s,children:r,...n},i)=>{const{error:a,formMessageId:o}=Fe(),t=a?String(a==null?void 0:a.message):r;return t?e.jsx("p",{ref:i,id:o,className:X("text-sm font-medium text-destructive",s),...n,children:t}):null});je.displayName="FormMessage";const Gt=bt({guestName:xe().min(2,"Le nom doit contenir au moins 2 caractères").max(100),guestEmail:xe().email("Email invalide").max(255),guestPhone:xe().optional(),message:xe().min(10,"Le message doit contenir au moins 10 caractères").max(1e3,"Le message ne doit pas dépasser 1000 caractères"),honeypot:xe().optional()}),Jt=({propertyId:s,ownerId:r,propertyTitle:n})=>{const[i,a]=l.useState(!1),[o,t]=l.useState(!1),[d,c]=l.useState(0),{toast:u}=js(),p=tt({resolver:Nt(Gt),defaultValues:{guestName:"",guestEmail:"",guestPhone:"",message:"",honeypot:""}});l.useEffect(()=>{const v=`guest_message_${s}`,m=localStorage.getItem(v);if(m){const b=Date.now()-parseInt(m),j=6e4;if(b<j){const F=Math.ceil((j-b)/1e3);c(F)}}},[s]),l.useEffect(()=>{if(d>0){const v=setTimeout(()=>{c(d-1)},1e3);return()=>clearTimeout(v)}},[d]);const x=async v=>{if(v.honeypot){f.warn("Bot detected in guest contact form",{propertyId:s});return}a(!0);try{const{data:m,error:b}=await I.functions.invoke("send-guest-message",{body:{propertyId:s,ownerId:r,guestName:v.guestName,guestEmail:v.guestEmail,guestPhone:v.guestPhone,message:v.message,honeypot:v.honeypot}});if(b)throw b;if(m!=null&&m.error){if(u({title:"Impossible d'envoyer le message",description:m.error,variant:"destructive"}),m.retryAfter){const F=new Date(m.retryAfter),C=Math.ceil((F.getTime()-Date.now())/1e3);c(C)}return}t(!0),p.reset();const j=`guest_message_${s}`;localStorage.setItem(j,Date.now().toString()),c(60),u({title:"Message envoyé !",description:"Le propriétaire vous répondra par email.",variant:"default"}),setTimeout(()=>{t(!1)},5e3)}catch(m){f.logError(m,{context:"GuestContactForm",action:"submit",propertyId:s}),u({title:"Erreur",description:m.message||"Une erreur est survenue lors de l'envoi du message",variant:"destructive"})}finally{a(!1)}},y=i||d>0||o;return e.jsxs("div",{className:"bg-card border border-border rounded-lg p-6 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(Re,{className:"h-5 w-5 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Contacter le propriétaire"})]}),o?e.jsxs("div",{className:"flex flex-col items-center justify-center py-8 text-center",children:[e.jsx(J,{className:"h-12 w-12 text-green-500 mb-4"}),e.jsx("p",{className:"text-lg font-medium text-foreground mb-2",children:"Message envoyé !"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Le propriétaire vous répondra par email dans les plus brefs délais."})]}):e.jsx(Ut,{...p,children:e.jsxs("form",{onSubmit:p.handleSubmit(x),className:"space-y-4",children:[e.jsx(pe,{control:p.control,name:"guestName",render:({field:v})=>e.jsxs(oe,{children:[e.jsx(ge,{children:"Votre nom *"}),e.jsx(de,{children:e.jsx(be,{placeholder:"Jean Dupont",...v})}),e.jsx(je,{})]})}),e.jsx(pe,{control:p.control,name:"guestEmail",render:({field:v})=>e.jsxs(oe,{children:[e.jsx(ge,{children:"Votre email *"}),e.jsx(de,{children:e.jsx(be,{type:"email",placeholder:"jean@example.com",...v})}),e.jsx(je,{})]})}),e.jsx(pe,{control:p.control,name:"guestPhone",render:({field:v})=>e.jsxs(oe,{children:[e.jsx(ge,{children:"Votre téléphone (optionnel)"}),e.jsx(de,{children:e.jsx(be,{type:"tel",placeholder:"+225 01 23 45 67 89",...v})}),e.jsx(je,{})]})}),e.jsx(pe,{control:p.control,name:"message",render:({field:v})=>{var m;return e.jsxs(oe,{children:[e.jsx(ge,{children:"Votre message *"}),e.jsx(de,{children:e.jsx(fs,{placeholder:`Bonjour, je suis intéressé(e) par "${n}". Pourriez-vous me donner plus d'informations ?`,className:"min-h-[120px]",...v})}),e.jsx(je,{}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[((m=v.value)==null?void 0:m.length)||0," / 1000 caractères"]})]})}}),e.jsx(pe,{control:p.control,name:"honeypot",render:({field:v})=>e.jsx(oe,{className:"hidden",children:e.jsx(de,{children:e.jsx(be,{tabIndex:-1,autoComplete:"off",...v})})})}),e.jsx("div",{className:"pt-2",children:e.jsx(_,{type:"submit",className:"w-full",disabled:y,children:i?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"mr-2 h-4 w-4 animate-spin"}),"Envoi en cours..."]}):d>0?e.jsxs(e.Fragment,{children:["Réessayer dans ",d,"s"]}):e.jsxs(e.Fragment,{children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Envoyer le message"]})})}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"En envoyant ce message, vous acceptez que vos données soient utilisées pour vous recontacter."})]})})]})},Kt=({propertyId:s,titleDeedUrl:r,ownerId:n})=>{const{user:i}=se(),{toast:a}=js(),[o,t]=l.useState(!0),[d,c]=l.useState(!1),[u,p]=l.useState(!1),[x,y]=l.useState("");l.useEffect(()=>{(async()=>{if(!i||!r){t(!1);return}try{if(i.id===n){p(!0),y("owner"),t(!1);return}const{data:b}=await I.from("user_roles").select("role").eq("user_id",i.id).in("role",["admin","super_admin"]);if(b&&b.length>0){p(!0),y("admin"),t(!1);return}const{data:j,error:F}=await I.from("leases").select("id, status").eq("property_id",s).eq("tenant_id",i.id).eq("status","active").maybeSingle();if(F)throw F;j&&(p(!0),y("tenant"))}catch(b){f.logError(b,{context:"TitleDeedSection",action:"checkAccess",propertyId:s})}finally{t(!1)}})()},[i,r,s,n]);const v=async()=>{var m,b;if(!(!r||!u)){c(!0);try{if(await I.from("title_deed_access_log").insert({property_id:s,requester_id:i==null?void 0:i.id,access_granted:!0,access_reason:x}),await I.from("admin_audit_logs").insert({admin_id:i==null?void 0:i.id,action_type:"title_deed_accessed",target_type:"property",target_id:s,notes:`Accès titre de propriété (raison: ${x})`}),r.includes("property-documents")){const j=r.split("/property-documents/")[1],{data:F,error:C}=await I.storage.from("property-documents").createSignedUrl(j,60);if(C)throw C;window.open(F.signedUrl,"_blank")}else window.open(r,"_blank");a({title:"✅ Accès autorisé",description:"Le titre de propriété s'ouvrira dans un nouvel onglet"})}catch(j){f.logError(j,{context:"TitleDeedSection",action:"download",propertyId:s}),await I.from("title_deed_access_log").insert({property_id:s,requester_id:i==null?void 0:i.id,access_granted:!1,access_reason:`denied: ${j.message}`}),(m=j.message)!=null&&m.includes("RLS")||(b=j.message)!=null&&b.includes("policy")?a({title:"🔒 Accès refusé",description:"Vous n'avez pas les droits pour accéder à ce document",variant:"destructive"}):a({title:"❌ Erreur",description:"Impossible de télécharger le titre de propriété",variant:"destructive"})}finally{c(!1)}}};return r?e.jsxs(M,{children:[e.jsxs(G,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-5 w-5 text-primary"}),"Titre de propriété"]}),e.jsx(Qe,{children:"Document officiel attestant de la propriété du bien"})]}),e.jsx(q,{children:o?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(Ce,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):u?e.jsxs("div",{className:"space-y-4",children:[e.jsxs(W,{className:"border-success bg-success/10",children:[e.jsx(_e,{className:"h-4 w-4 text-success"}),e.jsx(Z,{children:x==="tenant"?"En tant que locataire actif, vous avez accès au titre de propriété":x==="admin"?"En tant qu'administrateur, vous avez accès au titre de propriété":"En tant que propriétaire, vous avez accès au titre de propriété"})]}),e.jsx(_,{onClick:v,disabled:d,className:"w-full",children:d?e.jsxs(e.Fragment,{children:[e.jsx(Ce,{className:"h-4 w-4 mr-2 animate-spin"}),"Chargement..."]}):e.jsxs(e.Fragment,{children:[e.jsx(rt,{className:"h-4 w-4 mr-2"}),"Télécharger le titre de propriété"]})})]}):e.jsxs(W,{children:[e.jsx(ae,{className:"h-4 w-4"}),e.jsxs(Z,{children:["Le titre de propriété est accessible uniquement :",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1 text-sm",children:[e.jsx("li",{children:"Au propriétaire du bien"}),e.jsx("li",{children:"Aux locataires ayant un bail actif"}),e.jsx("li",{children:"Aux administrateurs de la plateforme"})]})]})]})})]}):null},Yt=({workStatus:s,workDescription:r,workImages:n=[],workEstimatedCost:i,workEstimatedDuration:a,workStartDate:o})=>{const[t,d]=l.useState(!1),[c,u]=l.useState(0);if(s!=="travaux_a_effectuer")return null;const p=n.map(x=>({src:x}));return e.jsxs(M,{className:"border-orange-200 bg-orange-50/50",children:[e.jsxs(G,{children:[e.jsx("div",{className:"flex items-center gap-3",children:e.jsxs(D,{className:"bg-orange-600 hover:bg-orange-700 text-white text-base px-4 py-2",children:[e.jsx(ze,{className:"h-5 w-5 mr-2"}),"⚠️ Travaux à prévoir"]})}),e.jsx(Y,{className:"text-xl mt-4",children:"État des travaux"})]}),e.jsxs(q,{className:"space-y-6",children:[r&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold mb-2 text-orange-800",children:"Description des travaux"}),e.jsx("p",{className:"text-muted-foreground whitespace-pre-line bg-white p-4 rounded-lg border",children:r})]}),n.length>0&&e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold mb-3 text-orange-800",children:["Photos de l'état actuel (",n.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:n.map((x,y)=>e.jsxs("div",{className:"relative aspect-video cursor-pointer group overflow-hidden rounded-lg border-2 border-orange-200 hover:border-orange-400 transition-colors",onClick:()=>{u(y),d(!0)},children:[e.jsx("img",{src:x,alt:`Travaux ${y+1}`,className:"w-full h-full object-cover transition-transform group-hover:scale-105"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center",children:e.jsx("span",{className:"text-white opacity-0 group-hover:opacity-100 text-sm font-semibold",children:"Agrandir"})})]},y))}),e.jsx(ds,{open:t,close:()=>d(!1),index:c,slides:p,plugins:[us]})]}),(i||a||o)&&e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-orange-200",children:[e.jsxs("h4",{className:"font-semibold mb-3 text-orange-800 flex items-center gap-2",children:[e.jsx(Se,{className:"h-5 w-5"}),"Informations complémentaires"]}),e.jsxs("div",{className:"space-y-2 text-sm",children:[i&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(at,{className:"h-4 w-4 text-orange-600"}),e.jsx("span",{className:"text-muted-foreground",children:"Coût estimé :"}),e.jsxs("span",{className:"font-semibold",children:[i.toLocaleString("fr-FR")," FCFA"]})]}),a&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4 text-orange-600"}),e.jsx("span",{className:"text-muted-foreground",children:"Durée estimée :"}),e.jsx("span",{className:"font-semibold",children:a})]}),o&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-4 w-4 text-orange-600"}),e.jsx("span",{className:"text-muted-foreground",children:"Début prévu :"}),e.jsx("span",{className:"font-semibold",children:new Date(o).toLocaleDateString("fr-FR")})]})]})]}),e.jsx("div",{className:"bg-orange-100 border border-orange-200 p-4 rounded-lg",children:e.jsxs("p",{className:"text-sm text-orange-800",children:[e.jsx("strong",{children:"ℹ️ Information importante :"})," Les travaux seront effectués par le propriétaire avant votre emménagement. Le loyer indiqué s'appliquera une fois les travaux terminés."]})})]})]})},Wt=()=>{var le,he,S,$;const{id:s}=ns(),r=Ie(),{user:n}=se(),{canAccessAdminDashboard:i}=pt(),{toggleFavorite:a,isFavorite:o}=yt(),[t,d]=l.useState(null),[c,u]=l.useState(null),[p,x]=l.useState(!0),[y,v]=l.useState(null),[m,b]=l.useState([]),[j,F]=l.useState(null),[C,K]=l.useState(""),[N,k]=l.useState(!1),[P,B]=l.useState(null),L=(n==null?void 0:n.id)===(t==null?void 0:t.owner_id);l.useEffect(()=>{s&&(g(),w(),L&&(E(),z()))},[s,L]);const w=async()=>{if(!s)return;const{data:h}=await I.from("agency_mandates").select("*, profiles!agency_mandates_agency_id_fkey(full_name, phone)").eq("property_id",s).eq("status","active").maybeSingle();B(h)},g=async()=>{if(!s||!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(s)){x(!1);return}try{const{data:A,error:V}=await I.from("properties").select("*").eq("id",s).maybeSingle();if(V)throw V;if(!A){x(!1);return}if(A.status==="loué"&&A.owner_id!==(n==null?void 0:n.id)&&!i){T({title:"Bien non disponible",description:"Ce bien n'est plus disponible à la location.",variant:"destructive"}),r("/recherche");return}d(A),v(A.main_image);const{data:Q,error:te}=await I.from("profiles").select("id, full_name, user_type, phone").eq("id",A.owner_id).maybeSingle();if(te)throw te;Q&&u(Q)}catch(A){f.error("Error fetching property details",{error:A,propertyId:s}),T({title:"Erreur technique",description:"Impossible de charger les détails du bien. Veuillez réessayer plus tard.",variant:"destructive"})}finally{x(!1)}},E=async()=>{try{const{data:h,error:A}=await I.from("rental_applications").select(`
          id,
          applicant_id,
          status,
          created_at,
          application_score,
          profiles:applicant_id(full_name, phone)
        `).eq("property_id",s).order("created_at",{ascending:!1});if(A)throw A;if(h){const V=await Promise.all(h.map(async Q=>{const{data:te}=await I.from("user_verifications").select("tenant_score, oneci_status, cnam_status").eq("user_id",Q.applicant_id).single();return{...Q,user_verifications:te?[te]:[]}}));b(V)}}catch(h){f.error("Error fetching applications",{error:h,propertyId:s})}},z=async()=>{try{const{count:h}=await I.from("user_favorites").select("*",{count:"exact",head:!0}).eq("property_id",s),{count:A}=await I.from("rental_applications").select("*",{count:"exact",head:!0}).eq("property_id",s),{data:V}=await I.from("properties").select("view_count").eq("id",s).single();F({views:(V==null?void 0:V.view_count)||0,favorites:h||0,applications:A||0,conversionRate:0,view_count:(V==null?void 0:V.view_count)||0,favorites_count:h||0,applications_count:A||0})}catch(h){f.error("Error fetching property stats",{error:h,propertyId:s})}},U=async()=>{if(!(!C||!t))try{const{error:h}=await I.from("properties").update({status:C}).eq("id",t.id);if(h)throw h;d({...t,status:C}),k(!1),T({title:"Succès",description:"Statut mis à jour avec succès"})}catch(h){f.error("Error updating property status",{error:h,propertyId:t.id,newStatus:C}),T({title:"Erreur",description:"Erreur lors de la mise à jour du statut",variant:"destructive"})}},R=()=>{if(!n){T({title:"Connexion requise",description:"Veuillez vous connecter pour contacter le propriétaire",variant:"destructive"}),r("/auth");return}r(`/messages?recipient=${t==null?void 0:t.owner_id}`)};if(p)return e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})});if(!t)return e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(Me,{}),e.jsxs("main",{className:"flex-1 container mx-auto px-4 py-16 text-center",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Bien introuvable"}),e.jsx(_,{asChild:!0,children:e.jsx(me,{to:"/recherche",children:"Retour à la recherche"})})]}),e.jsx(Be,{})]});const H=[t.main_image,...t.images||[]].filter(Boolean),ee=o(t.id);return Vt({title:`${t.title} - ${t.city} | Mon Toit`,description:((le=t.description)==null?void 0:le.substring(0,155))||`${t.property_type} à ${t.city} - ${(he=t.monthly_rent)==null?void 0:he.toLocaleString()} FCFA/mois`,ogTitle:`${t.title} - ${t.city}`,ogDescription:(S=t.description)==null?void 0:S.substring(0,200),ogImage:t.main_image||(($=t.images)==null?void 0:$[0])||"https://mon-toit.lovable.app/placeholder.svg",ogUrl:`https://mon-toit.lovable.app/properties/${t.id}`,twitterCard:"summary_large_image"}),e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(Me,{}),e.jsx("main",{className:"flex-1 container mx-auto px-4 py-8 pt-24",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs(_,{variant:"ghost",className:"mb-4",onClick:()=>r(-1),children:[e.jsx(He,{className:"h-4 w-4 mr-2"}),"Retour"]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx(qt,{propertyId:t.id,images:H,videoUrl:t.video_url||void 0,virtualTourUrl:t.virtual_tour_url||void 0,panoramicImages:Array.isArray(t.panoramic_images)?t.panoramic_images:[],floorPlans:Array.isArray(t.floor_plans)?t.floor_plans:[]}),e.jsx(_,{size:"icon",variant:"secondary",className:"absolute top-4 right-4 z-10",onClick:()=>a(t.id),children:e.jsx(it,{className:`h-5 w-5 ${ee?"fill-current text-destructive":""}`})}),e.jsxs(D,{className:`absolute top-4 left-4 z-10 flex items-center gap-1 ${t.status==="disponible"?"bg-green-500 hover:bg-green-600 text-white":t.status==="en_negociation"?"bg-orange-500 hover:bg-orange-600 text-white":"bg-gray-400 hover:bg-gray-500 text-white"}`,children:[t.status==="en_negociation"&&e.jsx(Ge,{className:"h-3 w-3"}),t.status==="loué"&&e.jsx(ae,{className:"h-3 w-3"}),ft(t.status)]})]}),P&&e.jsxs(W,{children:[e.jsx(nt,{className:"h-4 w-4"}),e.jsx(ne,{children:"Géré par une agence"}),e.jsxs(Z,{children:[e.jsx("p",{className:"mb-2",children:"Ce bien est actuellement géré par une agence immobilière"}),e.jsxs("div",{className:"flex flex-wrap gap-2 mt-3",children:[e.jsx(D,{variant:"secondary",children:P.mandate_type==="location"?"Location":P.mandate_type==="gestion_complete"?"Gestion complète":"Vente"}),P.commission_rate&&e.jsxs(D,{variant:"outline",children:["Commission: ",P.commission_rate,"%"]})]})]})]}),e.jsxs(M,{children:[e.jsx(G,{children:e.jsx(Y,{children:"Description"})}),e.jsx(q,{children:e.jsx("p",{className:"text-muted-foreground whitespace-pre-line",children:t.description||"Aucune description disponible."})})]}),e.jsxs(M,{children:[e.jsx(G,{children:e.jsx(Y,{children:"Caractéristiques"})}),e.jsxs(q,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Type"}),e.jsx("p",{className:"font-medium",children:t.property_type})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ct,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Surface"}),e.jsxs("p",{className:"font-medium",children:[t.surface_area||"N/A"," m²"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ot,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Chambres"}),e.jsx("p",{className:"font-medium",children:t.bedrooms===0?"Studio (0 chambre séparée)":t.bedrooms})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(dt,{className:"h-5 w-5 text-primary"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Salles de bain"}),e.jsx("p",{className:"font-medium",children:t.bathrooms})]})]})]}),e.jsx(rs,{className:"my-4"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.is_furnished&&e.jsxs(D,{variant:"secondary",className:"gap-1",children:[e.jsx(J,{className:"h-3 w-3"}),"Meublé"]}),t.has_ac&&e.jsxs(D,{variant:"secondary",className:"gap-1",children:[e.jsx(J,{className:"h-3 w-3"}),"Climatisation"]}),t.has_parking&&e.jsxs(D,{variant:"secondary",className:"gap-1",children:[e.jsx(J,{className:"h-3 w-3"}),"Parking"]}),t.has_garden&&e.jsxs(D,{variant:"secondary",className:"gap-1",children:[e.jsx(J,{className:"h-3 w-3"}),"Jardin"]})]})]})]}),t.latitude&&t.longitude&&e.jsxs(M,{children:[e.jsx(G,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-5 w-5"}),"Localisation"]}),e.jsx(_,{variant:"outline",size:"sm",asChild:!0,children:e.jsxs("a",{href:`https://maps.google.com/?q=${t.latitude},${t.longitude}`,target:"_blank",rel:"noopener noreferrer",className:"gap-2",children:[e.jsx(ut,{className:"h-4 w-4"}),"Google Maps"]})})]})}),e.jsx(q,{children:e.jsx(Ot,{propertyId:t.id,latitude:t.latitude,longitude:t.longitude,city:t.city,address:t.address})})]}),e.jsx(Yt,{workStatus:t.work_status||"aucun_travail",workDescription:t.work_description,workImages:Array.isArray(t.work_images)?t.work_images:[],workEstimatedCost:t.work_estimated_cost,workEstimatedDuration:t.work_estimated_duration,workStartDate:t.work_start_date}),e.jsx(Kt,{propertyId:t.id,titleDeedUrl:t.title_deed_url,ownerId:t.owner_id})]}),e.jsxs("div",{className:"space-y-6",children:[L&&e.jsxs(M,{className:"border-primary",children:[e.jsx(G,{children:e.jsx(Y,{children:"Actions propriétaire"})}),e.jsxs(q,{className:"space-y-2",children:[e.jsxs(_,{variant:"outline",className:"w-full gap-2",onClick:()=>r(`/biens/${t.id}/modifier`),children:[e.jsx(mt,{className:"h-4 w-4"}),"Modifier ce bien"]}),e.jsxs(Je,{open:N,onOpenChange:k,children:[e.jsx(gt,{asChild:!0,children:e.jsxs(_,{variant:"outline",className:"w-full gap-2",children:[e.jsx(ls,{className:"h-4 w-4"}),"Changer le statut"]})}),e.jsxs(Ke,{children:[e.jsxs(Ye,{children:[e.jsx(We,{children:"Changer le statut du bien"}),e.jsx(Ze,{children:"Sélectionnez le nouveau statut pour ce bien"})]}),e.jsxs(Le,{value:C,onValueChange:K,children:[e.jsx($e,{children:e.jsx(qe,{placeholder:"Sélectionner un statut"})}),e.jsxs(Oe,{children:[e.jsx(re,{value:"disponible",children:"Disponible"}),e.jsx(re,{value:"loué",children:"Loué"}),e.jsx(re,{value:"retiré",children:"Retiré"})]})]}),e.jsxs(gs,{children:[e.jsx(_,{variant:"outline",onClick:()=>k(!1),children:"Annuler"}),e.jsx(_,{onClick:U,children:"Confirmer"})]})]})]})]})]}),L&&j&&e.jsxs(M,{children:[e.jsx(G,{children:e.jsx(Y,{children:"Statistiques"})}),e.jsxs(q,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(cs,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Vues"})]}),e.jsx("span",{className:"font-semibold",children:j.view_count})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Te,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Favoris"})]}),e.jsx("span",{className:"font-semibold",children:j.favorites_count})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx("span",{className:"text-sm",children:"Candidatures"})]}),e.jsx("span",{className:"font-semibold",children:j.applications_count})]})]})]}),e.jsxs(M,{children:[e.jsxs(G,{children:[e.jsx("h1",{className:"text-3xl font-bold",children:t.title}),e.jsxs("p",{className:"text-3xl font-bold text-primary mt-2",children:[t.monthly_rent.toLocaleString()," FCFA",e.jsx("span",{className:"text-sm text-muted-foreground font-normal",children:"/mois"})]})]}),e.jsxs(q,{className:"space-y-4",children:[t.deposit_amount&&e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Caution"}),e.jsxs("span",{className:"font-medium",children:[t.deposit_amount.toLocaleString()," FCFA"]})]}),e.jsx(rs,{}),!L&&!n&&t.status==="disponible"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(_,{asChild:!0,size:"lg",className:"w-full gap-2",children:e.jsxs(me,{to:"/auth",children:[e.jsx(ts,{className:"h-5 w-5"}),"Créer un compte pour postuler"]})}),e.jsx("p",{className:"text-xs text-center text-muted-foreground",children:"Inscription gratuite en 2 minutes"})]}),!L&&n&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs(_,{className:"w-full gap-2",onClick:R,children:[e.jsx(Re,{className:"h-4 w-4"}),"Contacter le propriétaire"]}),t.status==="disponible"&&e.jsx(Bt,{propertyId:t.id,children:e.jsxs(_,{variant:"outline",className:"w-full gap-2",children:[e.jsx(Se,{className:"h-4 w-4"}),"Postuler"]})})]})]})]}),!L&&!n&&t.status==="disponible"&&c&&e.jsx(Jt,{propertyId:t.id,ownerId:c.id,propertyTitle:t.title}),c&&!L&&e.jsxs(M,{children:[e.jsx(G,{children:e.jsx(Y,{children:"Propriétaire"})}),e.jsx(q,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xs,{className:"h-12 w-12",children:e.jsx(ps,{children:c.full_name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:c.full_name}),e.jsx("p",{className:"text-sm text-muted-foreground capitalize",children:c.user_type})]})]})})]}),L&&m.length>0&&e.jsxs(M,{children:[e.jsxs(G,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(ts,{className:"h-5 w-5"}),"Candidatures (",m.length,")"]}),e.jsx(Qe,{children:"Liste des candidats pour ce bien"})]}),e.jsx(q,{children:e.jsxs("div",{className:"space-y-3",children:[m.slice(0,5).map(h=>{var A;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:h.profiles.full_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(D,{variant:h.status==="pending"?"secondary":h.status==="approved"?"default":"destructive",children:h.status==="pending"?"En attente":h.status==="approved"?"Approuvé":"Rejeté"}),((A=h.user_verifications[0])==null?void 0:A.tenant_score)&&e.jsxs(D,{variant:"outline",children:["Score: ",h.user_verifications[0].tenant_score,"/100"]})]})]}),e.jsx(_,{size:"sm",variant:"ghost",onClick:()=>r("/candidatures"),children:"Voir"})]},h.id)}),m.length>5&&e.jsx(_,{variant:"outline",className:"w-full",onClick:()=>r("/candidatures"),children:"Voir toutes les candidatures"})]})})]}),e.jsx(M,{children:e.jsx(q,{className:"pt-6",children:e.jsx("div",{className:"space-y-2 text-sm text-muted-foreground",children:e.jsxs("p",{className:"flex items-center gap-2",children:[e.jsx(Se,{className:"h-4 w-4"}),"Publié le ",new Date(t.created_at).toLocaleDateString("fr-FR")]})})})})]})]}),!L&&n&&e.jsx("div",{className:"mt-12",children:e.jsx(_t,{userId:n.id,type:"properties",limit:4,title:"Biens similaires"})})]})}),e.jsx(Be,{})]})},lr=Object.freeze(Object.defineProperty({__proto__:null,default:Wt},Symbol.toStringTag,{value:"Module"}));export{bs as C,Ut as F,Tt as O,ar as P,_t as R,yt as a,ys as b,ws as c,_s as d,Cs as e,nr as f,pe as g,oe as h,ge as i,de as j,Ht as k,je as l,Ct as m,ir as n,St as o,lr as p,vs as u};
//# sourceMappingURL=route-property-b6Ka_7KN.js.map
