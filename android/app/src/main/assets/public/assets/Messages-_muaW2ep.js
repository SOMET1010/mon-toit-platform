import{r as o,j as e,ab as D,bw as Z,b9 as G,bx as Q,X as ee,dt as se,b4 as O,du as K,cV as te,cp as U,bd as ae,bI as re}from"./react-vendor-CPmH2tz8.js";import{u as R,s as f,l as E,D as ie,am as ne,B as M,h as ce,K as le,L as oe,_ as J,ae as de,aE as q,C as F,e as $,t as x,X as me,b as L,d as V,ac as ue,ad as pe,Z as fe,a as he}from"./route-admin-B1Ip8YDE.js";import{D as xe}from"./route-owner-C83ejxxl.js";import"./query-vendor-ByjIuei6.js";import"./monitoring-vendor-C7yD_Gmu.js";import"./ui-vendor-Dua12RDV.js";import"./common-vendor-CK5d0rWc.js";import"./charts-vendor-16YcNskv.js";import"./supabase-vendor-CzsKfTY-.js";import"./route-agency-BEE2sWoQ.js";import"./animation-vendor-BJe5VoH_.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};s.SENTRY_RELEASE={id:"b65e2d84341e79b518aed72b6e71dcc77eba934a"}}catch{}})();try{(function(){var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},u=new s.Error().stack;u&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[u]="f97aaa7b-97e9-4cda-bc9b-de5a63e8130f",s._sentryDebugIdIdentifier="sentry-dbid-f97aaa7b-97e9-4cda-bc9b-de5a63e8130f")})()}catch{}const ge=({onUseTemplate:s})=>{const{user:u}=R(),[g,N]=o.useState([]),[S,l]=o.useState(!1),[y,T]=o.useState(null),[w,i]=o.useState(""),[p,d]=o.useState("");o.useEffect(()=>{u&&h()},[u]);const h=async()=>{if(!u)return;const{data:a,error:k}=await f.from("message_templates").select("*").eq("user_id",u.id).order("created_at",{ascending:!1});k?E.logError(k,{context:"MessageTemplates",action:"fetch"}):N(a||[])},C=async()=>{if(!u||!w.trim()||!p.trim()){x({title:"Erreur",description:"Veuillez remplir tous les champs",variant:"destructive"});return}try{if(y){const{error:a}=await f.from("message_templates").update({name:w,content:p}).eq("id",y.id);if(a)throw a;x({title:"Modèle mis à jour",description:"Votre modèle a été mis à jour avec succès"})}else{const{error:a}=await f.from("message_templates").insert({user_id:u.id,name:w,content:p});if(a)throw a;x({title:"Modèle créé",description:"Votre modèle a été créé avec succès"})}h(),v(),l(!1)}catch(a){E.logError(a,{context:"MessageTemplates",action:"save"}),x({title:"Erreur",description:"Impossible de sauvegarder le modèle",variant:"destructive"})}},b=async a=>{const{error:k}=await f.from("message_templates").delete().eq("id",a);k?x({title:"Erreur",description:"Impossible de supprimer le modèle",variant:"destructive"}):(x({title:"Modèle supprimé",description:"Le modèle a été supprimé avec succès"}),h())},v=()=>{i(""),d(""),T(null)},I=a=>{T(a),i(a.name),d(a.content),l(!0)};return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-semibold flex items-center gap-2",children:[e.jsx(D,{className:"h-4 w-4"}),"Modèles de messages"]}),e.jsxs(ie,{open:S,onOpenChange:a=>{l(a),a||v()},children:[e.jsx(ne,{asChild:!0,children:e.jsxs(M,{size:"sm",variant:"outline",children:[e.jsx(Z,{className:"h-4 w-4 mr-1"}),"Nouveau"]})}),e.jsxs(ce,{children:[e.jsx(le,{children:e.jsx(oe,{children:y?"Modifier le modèle":"Nouveau modèle"})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Nom du modèle"}),e.jsx(J,{value:w,onChange:a=>i(a.target.value),placeholder:"Ex: Demande de visite"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium",children:"Contenu"}),e.jsx(de,{value:p,onChange:a=>d(a.target.value),placeholder:"Tapez votre message...",rows:5})]}),e.jsx(M,{onClick:C,className:"w-full",children:y?"Mettre à jour":"Créer"})]})]})]})]}),e.jsx(q,{className:"h-40",children:g.length===0?e.jsx("p",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucun modèle enregistré"}):e.jsx("div",{className:"space-y-2",children:g.map(a=>e.jsx(F,{className:"hover:bg-muted/50 transition-colors",children:e.jsx($,{className:"p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("button",{onClick:()=>s(a.content),className:"text-left w-full",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:a.name}),e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2",children:a.content})]})}),e.jsxs("div",{className:"flex gap-1 flex-shrink-0",children:[e.jsx(M,{size:"icon",variant:"ghost",onClick:()=>I(a),className:"h-7 w-7",children:e.jsx(G,{className:"h-3 w-3"})}),e.jsx(M,{size:"icon",variant:"ghost",onClick:()=>b(a.id),className:"h-7 w-7 text-destructive hover:text-destructive",children:e.jsx(Q,{className:"h-3 w-3"})})]})]})})},a.id))})})]})},je=({attachments:s,onAttachmentsChange:u})=>{const{user:g}=R(),[N,S]=o.useState(!1),l=async i=>{const p=Array.from(i.target.files||[]);if(p.length+s.length>5){x({title:"Limite atteinte",description:"Vous ne pouvez ajouter que 5 pièces jointes maximum",variant:"destructive"});return}S(!0);try{const d=[];for(const h of p){if(h.size>10*1024*1024){x({title:"Fichier trop volumineux",description:`${h.name} dépasse la limite de 10MB`,variant:"destructive"});continue}const C=h.name.split(".").pop(),b=`${g.id}/${Date.now()}_${Math.random()}.${C}`,{error:v}=await f.storage.from("user-documents").upload(b,h);if(v)throw v;const{data:{publicUrl:I}}=f.storage.from("user-documents").getPublicUrl(b);d.push({name:h.name,url:I,type:h.type,size:h.size})}u([...s,...d]),x({title:"Fichiers ajoutés",description:`${d.length} fichier(s) ajouté(s) avec succès`})}catch(d){E.logError(d,{context:"AttachmentUpload",action:"upload"}),x({title:"Erreur",description:"Impossible de télécharger les fichiers",variant:"destructive"})}finally{S(!1)}},y=i=>{u(s.filter((p,d)=>d!==i))},T=i=>i.startsWith("image/")?e.jsx(O,{className:"h-4 w-4"}):i.includes("pdf")?e.jsx(D,{className:"h-4 w-4"}):e.jsx(K,{className:"h-4 w-4"}),w=i=>i<1024?i+" B":i<1024*1024?(i/1024).toFixed(1)+" KB":(i/(1024*1024)).toFixed(1)+" MB";return e.jsxs("div",{className:"space-y-2",children:[s.length>0&&e.jsx("div",{className:"space-y-2",children:s.map((i,p)=>e.jsx(F,{className:"p-2",children:e.jsxs("div",{className:"flex items-center gap-2",children:[T(i.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:w(i.size)})]}),e.jsx(M,{size:"icon",variant:"ghost",onClick:()=>y(p),className:"h-7 w-7",children:e.jsx(ee,{className:"h-4 w-4"})})]})},p))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"file",id:"file-upload",multiple:!0,className:"hidden",onChange:l,accept:"image/*,.pdf,.doc,.docx,.txt"}),e.jsxs(M,{type:"button",variant:"outline",size:"sm",onClick:()=>{var i;return(i=document.getElementById("file-upload"))==null?void 0:i.click()},disabled:N||s.length>=5,children:[e.jsx(se,{className:"h-4 w-4 mr-1"}),N?"Téléchargement...":"Joindre fichier"]}),s.length>0&&e.jsxs("span",{className:"text-xs text-muted-foreground self-center",children:[s.length,"/5"]})]})]})},Me=()=>{const{user:s}=R(),[u]=te(),g=u.get("recipient"),[N,S]=o.useState([]),[l,y]=o.useState(g),[T,w]=o.useState([]),[i,p]=o.useState(""),[d,h]=o.useState([]),[C,b]=o.useState(!0),[v,I]=o.useState({}),a=o.useRef(null),k=o.useRef(!1);o.useEffect(()=>{if(!s){b(!1);return}},[s]),o.useEffect(()=>{if(s){z();const t=setTimeout(()=>{k.current||(b(!1),x({title:"Chargement lent",description:"Le chargement prend plus de temps que prévu. Vérifiez votre connexion.",variant:"destructive"}))},1e4);return()=>clearTimeout(t)}},[s]),o.useEffect(()=>{l&&(A(l),H(l))},[l]),o.useEffect(()=>{s&&g&&!C&&!N.find(c=>c.id===g)&&!v[g]&&(async()=>{const{data:n}=await f.from("profiles").select("id, full_name").eq("id",g).maybeSingle();n&&(S(_=>[{id:n.id,user_id:n.id,user_name:n.full_name||"Utilisateur",last_message:"",last_message_time:new Date().toISOString(),unread_count:0,conversation_type:"prospect"},..._]),I(_=>({..._,[n.id]:n})))})()},[g,s,N,C,v]),o.useEffect(()=>{a.current&&a.current.scrollIntoView({behavior:"smooth"})},[T]),o.useEffect(()=>{if(!s)return;const t=f.channel("messages-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver_id=eq.${s.id}`},c=>{const n=c.new;z(),n.sender_id===l&&A(l)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`sender_id=eq.${s.id}`},c=>{const n=c.new;z(),n.receiver_id===l&&A(l)}).subscribe();return()=>{f.removeChannel(t)}},[s,l]);const z=async()=>{if(!s){b(!1);return}try{const{data:t,error:c}=await f.from("messages").select("*").or(`sender_id.eq.${s.id},receiver_id.eq.${s.id}`).order("created_at",{ascending:!1});if(c)throw c;const n=new Map,_=new Set;if(t==null||t.forEach(r=>{const m=r.sender_id===s.id?r.receiver_id:r.sender_id;if(_.add(m),!n.has(m))n.set(m,{id:m,user_id:m,user_name:"",last_message:r.content,last_message_time:r.created_at,unread_count:r.receiver_id===s.id&&!r.is_read?1:0,conversation_type:r.conversation_type||"prospect"});else{const j=n.get(m);r.receiver_id===s.id&&!r.is_read&&j.unread_count++}}),_.size>0){const{data:r}=await f.from("profiles").select("id, full_name").in("id",Array.from(_)),m={};r==null||r.forEach(j=>{m[j.id]=j}),I(m),n.forEach((j,Y)=>{var B;j.user_name=((B=m[Y])==null?void 0:B.full_name)||"Utilisateur inconnu"})}for(const[r,m]of n){const{data:j}=await f.rpc("get_conversation_type",{p_sender_id:s.id,p_receiver_id:r,p_property_id:null});j&&(m.conversation_type=j)}S(Array.from(n.values()))}catch(t){E.error("Failed to fetch conversations",{error:t,userId:s==null?void 0:s.id}),x({title:"Erreur",description:"Impossible de charger les conversations. Réessayez.",variant:"destructive"})}finally{b(!1),k.current=!0}},A=async t=>{if(s)try{const{data:c,error:n}=await f.from("messages").select("*").or(`and(sender_id.eq.${s.id},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${s.id})`).order("created_at",{ascending:!0});if(n)throw n;const _=(c||[]).map(r=>{let m=[];if(r.attachments)try{typeof r.attachments=="string"?m=JSON.parse(r.attachments):Array.isArray(r.attachments)&&(m=r.attachments)}catch(j){E.error("Failed to parse message attachments",{error:j,messageId:r.id})}return{id:r.id,sender_id:r.sender_id,receiver_id:r.receiver_id,content:r.content,is_read:r.is_read,created_at:r.created_at,attachments:m}});w(_)}catch(c){E.error("Failed to fetch messages",{error:c,partnerId:t})}},H=async t=>{if(s)try{await f.from("messages").update({is_read:!0}).eq("sender_id",t).eq("receiver_id",s.id).eq("is_read",!1)}catch(c){E.error("Failed to mark messages as read",{error:c,partnerId:t})}},P=async()=>{if(!(!s||!l||!i.trim()&&d.length===0))try{const t={sender_id:s.id,receiver_id:l,content:i.trim()||"(Pièce(s) jointe(s))"};d.length>0&&(t.attachments=JSON.stringify(d));const{error:c}=await f.from("messages").insert([t]);if(c)throw c;p(""),h([]),x({title:"Message envoyé",description:"Votre message a été envoyé avec succès"})}catch(t){E.error("Failed to send message",{error:t,receiverId:l}),x({title:"Erreur",description:"Impossible d'envoyer le message",variant:"destructive"})}},W=t=>t.startsWith("image/")?e.jsx(O,{className:"h-4 w-4"}):t.includes("pdf")?e.jsx(D,{className:"h-4 w-4"}):e.jsx(K,{className:"h-4 w-4"}),X=t=>{const n={prospect:{emoji:"🟡",label:"Prospect",className:"bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-400"},applicant:{emoji:"🟠",label:"Candidat",className:"bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400"},tenant:{emoji:"🟢",label:"Locataire",className:"bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400"},landlord_support:{emoji:"🔵",label:"Support",className:"bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400"}}[t];return e.jsxs(he,{className:`${n.className} text-xs`,children:[e.jsx("span",{className:"mr-1",children:n.emoji}),n.label]})};return C?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(me,{}),e.jsx("main",{className:"flex-1 container mx-auto px-4 py-8 pt-24",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsx(xe,{}),e.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Messages"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 h-[600px]",children:[e.jsxs(F,{className:"md:col-span-1",children:[e.jsx(L,{children:e.jsx(V,{children:"Conversations"})}),e.jsx($,{className:"p-0",children:e.jsx(q,{className:"h-[500px]",children:C?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto mb-2"}),e.jsx("p",{children:"Chargement des conversations..."})]}):N.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(U,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucune conversation"}),e.jsx("p",{className:"text-xs mt-2",children:"Commencez à discuter avec un propriétaire"})]}):e.jsx("div",{className:"space-y-1",children:N.map(t=>e.jsx("button",{onClick:()=>y(t.id),className:`w-full p-4 text-left hover:bg-muted/50 transition-colors border-l-4 ${l===t.id?"border-primary bg-muted/50":"border-transparent"}`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{children:e.jsx(pe,{children:t.user_name.charAt(0).toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1 min-w-0",children:[e.jsx("p",{className:"font-medium truncate",children:t.user_name}),X(t.conversation_type)]}),t.unread_count>0&&e.jsx("span",{className:"bg-primary text-primary-foreground text-xs px-2 py-0.5 rounded-full flex-shrink-0",children:t.unread_count})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:t.last_message})]})]})},t.id))})})})]}),e.jsx(F,{className:"md:col-span-2",children:l&&v[l]?e.jsxs(e.Fragment,{children:[e.jsx(L,{children:e.jsx(V,{children:v[l].full_name})}),e.jsxs($,{className:"space-y-4",children:[e.jsx(q,{className:"h-[320px] pr-4",children:e.jsxs("div",{className:"space-y-4",children:[T.map(t=>e.jsx("div",{className:`flex ${t.sender_id===(s==null?void 0:s.id)?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg p-3 ${t.sender_id===(s==null?void 0:s.id)?"bg-primary text-primary-foreground":"bg-muted"}`,children:[e.jsx("p",{className:"text-sm",children:t.content}),t.attachments&&t.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:t.attachments.map((c,n)=>e.jsxs("a",{href:c.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 text-xs hover:underline p-2 rounded bg-background/10",children:[W(c.type),e.jsx("span",{className:"truncate",children:c.name}),e.jsx(ae,{className:"h-3 w-3 ml-auto flex-shrink-0"})]},n))}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:new Date(t.created_at).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})})]})},t.id)),e.jsx("div",{ref:a})]})}),e.jsxs("div",{className:"space-y-3 border-t pt-3",children:[e.jsx(ge,{onUseTemplate:t=>p(t)}),e.jsx(je,{attachments:d,onAttachmentsChange:h}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(J,{placeholder:"Écrivez votre message...",value:i,onChange:t=>p(t.target.value),onKeyPress:t=>t.key==="Enter"&&!t.shiftKey&&P()}),e.jsx(M,{onClick:P,size:"icon",children:e.jsx(re,{className:"h-4 w-4"})})]})]})]})]}):e.jsx("div",{className:"h-full flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(U,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Sélectionnez une conversation"})]})})})]})]})}),e.jsx(fe,{})]})};export{Me as default};
//# sourceMappingURL=Messages-_muaW2ep.js.map
