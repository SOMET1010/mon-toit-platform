import{r as x,j as e,c2 as K,a9 as R,aa as E,ab as Y,bd as O,aJ as F,bC as B,br as $,af as W,bb as X}from"./react-vendor-CPmH2tz8.js";import{s as j,l as z,t as D,X as G,B as w,C as p,b as T,d as A,j as J,a as m,e as f,Z as Q,N as ee,O as se,Q as H,R as N,U as re,V as y,u as te,T as ae,y as ne,z as M,D as ie,h as de}from"./route-admin-B1Ip8YDE.js";import{D as le,V as ce}from"./route-owner-C83ejxxl.js";import{T as oe}from"./index-LMib0YFl.js";import{o as me}from"./route-property-b6Ka_7KN.js";import{ce as U,cf as P}from"./common-vendor-CK5d0rWc.js";import"./query-vendor-ByjIuei6.js";import"./monitoring-vendor-C7yD_Gmu.js";import"./ui-vendor-Dua12RDV.js";import"./charts-vendor-16YcNskv.js";import"./supabase-vendor-CzsKfTY-.js";import"./route-agency-BEE2sWoQ.js";import"./animation-vendor-BJe5VoH_.js";import"./route-tenant-DNBKfVUX.js";import"./forms-vendor-DqOZ4YtP.js";import"./maps-vendor-B7X9GnXQ.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};s.SENTRY_RELEASE={id:"b65e2d84341e79b518aed72b6e71dcc77eba934a"}}catch{}})();try{(function(){var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},n=new s.Error().stack;n&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[n]="323223d0-061b-412a-97fd-e17dfc6bc919",s._sentryDebugIdIdentifier="sentry-dbid-323223d0-061b-412a-97fd-e17dfc6bc919")})()}catch{}const ue=({application:s,onClose:n,onStatusUpdate:d,isOwner:t})=>{const[r,o]=x.useState(null),[_,l]=x.useState(!1),{phone:u}=me(s.applicant_id);x.useEffect(()=>{t&&s.status==="pending"&&g()},[s.id]);const g=async()=>{l(!0);try{const{data:i,error:c}=await j.functions.invoke("tenant-scoring",{body:{applicantId:s.applicant_id,propertyId:s.property_id,monthlyRent:s.properties.monthly_rent}});if(c)throw c;o(i),await j.from("rental_applications").update({application_score:i.score}).eq("id",s.id)}catch(i){z.error("Error calculating tenant score",{error:i,applicationId:s.id}),D({title:"Erreur",description:"Impossible de calculer le score",variant:"destructive"})}finally{l(!1)}};return e.jsxs("div",{className:"min-h-screen flex flex-col bg-background",children:[e.jsx(G,{}),e.jsxs("main",{className:"flex-1 container mx-auto px-4 py-8 max-w-5xl",children:[e.jsxs(w,{variant:"ghost",onClick:n,className:"mb-6",children:[e.jsx(K,{className:"h-4 w-4 mr-2"}),"Retour"]}),e.jsxs("div",{className:"grid gap-6",children:[e.jsxs(p,{children:[e.jsx(T,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx(A,{className:"text-2xl",children:s.properties.title}),e.jsxs(J,{className:"mt-2",children:["Candidature de ",s.profiles.full_name]})]}),e.jsx(m,{variant:s.status==="approved"?"default":"secondary",children:s.status==="pending"?"En attente":s.status==="approved"?"Approuvée":"Rejetée"})]})}),e.jsx(f,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Loyer mensuel"}),e.jsxs("p",{className:"font-medium",children:[s.properties.monthly_rent.toLocaleString()," FCFA"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Date de candidature"}),e.jsx("p",{className:"font-medium",children:new Date(s.created_at).toLocaleDateString("fr-FR")})]}),u&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Téléphone"}),e.jsx("p",{className:"font-medium",children:u})]})]})})]}),e.jsxs(p,{children:[e.jsx(T,{children:e.jsx(A,{children:"Vérifications"})}),e.jsxs(f,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.profiles.oneci_verified?e.jsx(R,{className:"h-5 w-5 text-green-600"}):e.jsx(E,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("span",{children:"Identité ONECI"})]}),e.jsx(m,{variant:s.profiles.oneci_verified?"default":"secondary",children:s.profiles.oneci_verified?"Vérifiée":"Non vérifiée"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[s.profiles.cnam_verified?e.jsx(R,{className:"h-5 w-5 text-green-600"}):e.jsx(E,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("span",{children:"Employeur CNAM"})]}),e.jsx(m,{variant:s.profiles.cnam_verified?"default":"secondary",children:s.profiles.cnam_verified?"Vérifiée":"Non vérifiée"})]})]})]}),t&&(r||s.application_score>0)&&e.jsx(oe,{score:(r==null?void 0:r.score)||s.application_score,breakdown:r==null?void 0:r.breakdown,recommendation:r==null?void 0:r.recommendation}),s.cover_letter&&e.jsxs(p,{children:[e.jsx(T,{children:e.jsx(A,{children:"Lettre de motivation"})}),e.jsx(f,{children:e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.cover_letter})})]}),s.documents&&s.documents.length>0&&e.jsxs(p,{children:[e.jsx(T,{children:e.jsxs(A,{children:["Documents justificatifs (",s.documents.length,")"]})}),e.jsx(f,{children:e.jsx("div",{className:"space-y-2",children:s.documents.map((i,c)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Y,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:i.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.type})]})]}),e.jsx(w,{variant:"ghost",size:"sm",asChild:!0,children:e.jsx("a",{href:i.url,target:"_blank",rel:"noopener noreferrer",children:e.jsx(O,{className:"h-4 w-4"})})})]},c))})})]}),t&&s.status==="pending"&&e.jsx(p,{children:e.jsx(f,{className:"pt-6",children:e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(w,{variant:"destructive",onClick:()=>d(s.id,"rejected"),className:"flex-1",children:[e.jsx(E,{className:"h-4 w-4 mr-2"}),"Rejeter"]}),e.jsxs(w,{onClick:()=>d(s.id,"approved"),className:"flex-1",children:[e.jsx(R,{className:"h-4 w-4 mr-2"}),"Approuver"]})]})})}),t&&s.status==="approved"&&e.jsx(p,{children:e.jsx(f,{className:"pt-6",children:e.jsx(w,{onClick:async()=>{try{const i=new Date,c=new Date;c.setFullYear(c.getFullYear()+1);const{error:v}=await j.from("leases").insert({property_id:s.property_id,landlord_id:s.properties.owner_id,tenant_id:s.applicant_id,monthly_rent:s.properties.monthly_rent,deposit_amount:s.properties.deposit_amount,charges_amount:s.properties.charges_amount,lease_type:"location_meublee",start_date:i.toISOString().split("T")[0],end_date:c.toISOString().split("T")[0],status:"draft"});if(v)throw v;D({title:"Bail créé",description:"Le bail a été créé avec succès. Rendez-vous dans 'Baux' pour le signer."})}catch(i){D({title:"Erreur",description:i.message,variant:"destructive"})}},className:"w-full",children:"Créer le bail"})})})]})]}),e.jsx(Q,{})]})},xe=({status:s,createdAt:n,reviewedAt:d,processingDeadline:t,isOverdue:r,autoProcessed:o})=>{const l=(()=>{switch(s){case"pending":return r?{icon:B,color:"text-orange-600",bgColor:"bg-orange-50 dark:bg-orange-950",borderColor:"border-orange-200 dark:border-orange-800",label:"En cours d'examen",description:"Votre dossier est actuellement en cours de traitement approfondi."}:{icon:F,color:"text-blue-600",bgColor:"bg-blue-50 dark:bg-blue-950",borderColor:"border-blue-200 dark:border-blue-800",label:"En attente de traitement",description:"Votre candidature sera traitée sous 48-72h."};case"approved":return{icon:R,color:"text-green-600",bgColor:"bg-green-50 dark:bg-green-950",borderColor:"border-green-200 dark:border-green-800",label:"Candidature approuvée",description:o?"Votre candidature a été approuvée automatiquement après le délai de traitement.":"Félicitations ! Le propriétaire a accepté votre candidature."};case"rejected":return{icon:E,color:"text-red-600",bgColor:"bg-red-50 dark:bg-red-950",borderColor:"border-red-200 dark:border-red-800",label:"Candidature non retenue",description:o?"Votre candidature n'a pas été retenue dans le délai imparti.":"Le propriétaire a choisi un autre candidat pour ce bien."};case"withdrawn":return{icon:E,color:"text-gray-600",bgColor:"bg-gray-50 dark:bg-gray-950",borderColor:"border-gray-200 dark:border-gray-800",label:"Candidature retirée",description:"Vous avez retiré votre candidature pour ce bien."};default:return{icon:F,color:"text-gray-600",bgColor:"bg-gray-50 dark:bg-gray-950",borderColor:"border-gray-200 dark:border-gray-800",label:"Statut inconnu",description:""}}})(),u=l.icon,i=(()=>{if(!t||s!=="pending")return null;const c=new Date(t),v=new Date,L=c.getTime()-v.getTime(),k=Math.floor(L/(1e3*60*60));return r?null:k<24?"Moins de 24h":k<48?"Moins de 48h":`${Math.ceil(k/24)} jours`})();return e.jsxs(p,{className:`${l.bgColor} ${l.borderColor} border-2`,children:[e.jsx(T,{className:"pb-4",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-full ${l.bgColor}`,children:e.jsx(u,{className:`h-6 w-6 ${l.color}`})}),e.jsxs("div",{children:[e.jsx(A,{className:`text-xl ${l.color}`,children:l.label}),o&&e.jsx(m,{variant:"outline",className:"mt-1 text-xs",children:"Traité automatiquement"})]})]}),e.jsx(m,{variant:s==="approved"?"default":s==="rejected"?"destructive":"secondary",children:s==="pending"?"En cours":s==="approved"?"Approuvé":s==="rejected"?"Rejeté":"Retiré"})]})}),e.jsxs(f,{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:l.description}),s==="pending"&&!r&&e.jsxs("div",{className:"p-4 rounded-lg bg-background/60 border",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(F,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"font-medium text-sm",children:"Délai indicatif de traitement"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Votre dossier sera traité sous 48-72 heures"}),i&&t&&e.jsxs("div",{className:"mt-3 flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(B,{className:"h-3 w-3"}),e.jsxs("span",{children:["Temps restant estimé : ",i]})]})]}),s==="pending"&&r&&e.jsxs("div",{className:"p-4 rounded-lg bg-background/60 border border-orange-200 dark:border-orange-800",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(B,{className:"h-4 w-4 text-orange-600"}),e.jsx("span",{className:"font-medium text-sm",children:"Examen approfondi en cours"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Votre dossier nécessite une analyse plus détaillée. Nous vous tiendrons informé(e) prochainement."})]}),e.jsxs("div",{className:"space-y-2 pt-2 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:"Soumise :"}),e.jsx("span",{className:"font-medium",children:new Date(n).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",U(new Date(n),{addSuffix:!0,locale:P}),")"]})]}),d&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx($,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{className:"text-muted-foreground",children:"Traitée :"}),e.jsx("span",{className:"font-medium",children:new Date(d).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",U(new Date(d),{addSuffix:!0,locale:P}),")"]})]})]})]})]})},he={pending:"secondary",approved:"default",rejected:"destructive",withdrawn:"outline"},pe={pending:"En attente",approved:"Approuvée",rejected:"Rejetée",withdrawn:"Retirée"},fe=({applications:s,onSelect:n,isOwner:d})=>e.jsx("div",{className:"rounded-md border",children:e.jsxs(ee,{children:[e.jsx(se,{children:e.jsxs(H,{children:[e.jsx(N,{children:"Bien"}),e.jsx(N,{children:d?"Candidat":"Ville"}),e.jsx(N,{className:"w-32",children:"Loyer"}),e.jsx(N,{className:"text-center w-20",children:"Score"}),e.jsx(N,{className:"w-32",children:"Statut"}),e.jsx(N,{className:"w-28",children:"Déposée le"}),e.jsx(N,{className:"w-20 text-right",children:"Actions"})]})}),e.jsx(re,{children:s.map(t=>e.jsxs(H,{className:"hover:bg-muted/50",children:[e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(W,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"}),e.jsx("span",{className:"truncate max-w-[200px] font-medium",children:t.properties.title})]})}),e.jsx(y,{children:d?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{children:t.profiles.full_name}),t.profiles.oneci_verified&&e.jsx(m,{variant:"outline",className:"text-xs",children:"ONECI"})]}):t.properties.city}),e.jsxs(y,{className:"font-medium",children:[t.properties.monthly_rent.toLocaleString()," FCFA"]}),e.jsx(y,{className:"text-center",children:t.application_score>0?e.jsxs(m,{variant:"default",className:"text-xs",children:[t.application_score,"/100"]}):"-"}),e.jsx(y,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(m,{variant:he[t.status]||"outline",children:pe[t.status]||t.status}),t.is_overdue&&e.jsx(m,{variant:"destructive",className:"text-xs",children:"En retard"})]})}),e.jsx(y,{className:"text-sm text-muted-foreground",children:new Date(t.created_at).toLocaleDateString("fr-FR")}),e.jsx(y,{className:"text-right",children:e.jsx(w,{variant:"ghost",size:"sm",onClick:()=>n(t),children:e.jsx(X,{className:"h-4 w-4"})})})]},t.id))})]})}),Ie=()=>{const{user:s,profile:n}=te(),[d,t]=x.useState([]),[r,o]=x.useState(null),[_,l]=x.useState(!0),[u,g]=x.useState("table"),[i,c]=x.useState("all");x.useEffect(()=>{s&&v()},[s]);const v=async()=>{if(s)try{let a=j.from("rental_applications").select("*, processing_deadline, is_overdue, auto_processed, auto_action_type").order("created_at",{ascending:!1});if((n==null?void 0:n.user_type)==="proprietaire"||(n==null?void 0:n.user_type)==="agence"){const{data:b}=await j.from("properties").select("id").eq("owner_id",s.id),I=(b==null?void 0:b.map(V=>V.id))||[];a=a.in("property_id",I)}else a=a.eq("applicant_id",s.id);const{data:S,error:h}=await a;if(h)throw h;const Z=await Promise.all((S||[]).map(async b=>{const{data:I}=await j.from("properties").select("title, monthly_rent, city, owner_id, deposit_amount, charges_amount").eq("id",b.property_id).maybeSingle(),{data:V}=await j.from("profiles").select("full_name, phone, oneci_verified, cnam_verified").eq("id",b.applicant_id).maybeSingle();return{...b,properties:I||{title:"Propriété supprimée",monthly_rent:0,city:"N/A",owner_id:"",deposit_amount:null,charges_amount:null},profiles:V||{full_name:"Utilisateur supprimé",phone:null,oneci_verified:!1,cnam_verified:!1}}}));t(Z)}catch(a){z.logError(a,{context:"Applications",action:"fetchApplications"}),D({title:"Erreur",description:"Impossible de charger les candidatures",variant:"destructive"})}finally{l(!1)}},L=async(a,S)=>{try{const{error:h}=await j.from("rental_applications").update({status:S,reviewed_at:new Date().toISOString()}).eq("id",a);if(h)throw h;D({title:"Statut mis à jour",description:`Candidature ${S==="approved"?"approuvée":"rejetée"}`}),v(),o(null)}catch(h){z.logError(h,{context:"Applications",action:"updateStatus",applicationId:a}),D({title:"Erreur",description:"Impossible de mettre à jour la candidature",variant:"destructive"})}},k=a=>{const S={pending:"secondary",approved:"default",rejected:"destructive",withdrawn:"outline"},h={pending:"En attente",approved:"Approuvée",rejected:"Rejetée",withdrawn:"Retirée"};return e.jsx(m,{variant:S[a]||"outline",children:h[a]||a})},C=(n==null?void 0:n.user_type)==="proprietaire"||(n==null?void 0:n.user_type)==="agence",q=x.useMemo(()=>i==="all"?d:d.filter(a=>a.status===i),[d,i]);return _?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(G,{}),e.jsxs("main",{className:"flex-1 container mx-auto px-4 py-6 pt-24",children:[e.jsxs("div",{className:"mb-10",children:[e.jsx(le,{}),e.jsxs("h1",{className:"text-4xl font-bold mb-3 mt-6 flex items-center gap-3",children:[e.jsx(Y,{className:"h-8 w-8 text-primary"}),C?"Candidatures reçues":"Mes candidatures"]}),e.jsx("p",{className:"text-lg text-muted-foreground",children:C?"Gérez les candidatures pour vos biens immobiliers":"Suivez l'état de vos candidatures locatives"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(ae,{value:i,onValueChange:c,className:"w-auto",children:e.jsxs(ne,{children:[e.jsxs(M,{value:"all",children:["Toutes (",d.length,")"]}),e.jsxs(M,{value:"pending",children:["En attente (",d.filter(a=>a.status==="pending").length,")"]}),e.jsxs(M,{value:"approved",children:["Approuvées (",d.filter(a=>a.status==="approved").length,")"]})]})}),e.jsx(ce,{view:u==="cards"?"list":"table",onViewChange:a=>g(a==="list"?"cards":"table"),options:["list","table"]})]}),u==="table"?e.jsx(fe,{applications:q,onSelect:a=>o(a),isOwner:C}):e.jsx(je,{applications:q,onSelect:a=>o(a),getStatusBadge:k,isOwner:C})]}),e.jsx(ie,{open:!!r,onOpenChange:()=>o(null),children:e.jsx(de,{className:"max-w-4xl max-h-[90vh] overflow-auto",children:r&&e.jsx(ue,{application:r,onClose:()=>o(null),onStatusUpdate:L,isOwner:C})})})]}),e.jsx(Q,{})]})},je=({applications:s,onSelect:n,getStatusBadge:d,isOwner:t})=>s.length===0?e.jsx(p,{children:e.jsx(f,{className:"py-12 text-center",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-muted-foreground text-lg",children:"Aucune candidature pour le moment"}),!t&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Parcourez nos annonces et déposez votre première candidature !"})]})})}):e.jsx("div",{className:"grid gap-4",children:s.map(r=>{var o,_,l,u,g,i,c;return e.jsxs("div",{className:"space-y-4",children:[!t&&e.jsx(xe,{status:r.status,createdAt:r.created_at,reviewedAt:r.reviewed_at,processingDeadline:r.processing_deadline,isOverdue:r.is_overdue,autoProcessed:r.auto_processed}),e.jsxs(p,{className:"hover:shadow-md transition-shadow",children:[e.jsx(T,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(A,{className:"text-lg",children:((o=r.properties)==null?void 0:o.title)||"Propriété non disponible"}),e.jsx(J,{children:t?`Candidat: ${((_=r.profiles)==null?void 0:_.full_name)||"Inconnu"}`:((l=r.properties)==null?void 0:l.city)||"N/A"})]}),d(r.status)]})}),e.jsx(f,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Loyer: ",((g=(u=r.properties)==null?void 0:u.monthly_rent)==null?void 0:g.toLocaleString())||"0"," FCFA"]}),t&&e.jsxs("div",{className:"flex gap-2",children:[((i=r.profiles)==null?void 0:i.oneci_verified)&&e.jsx(m,{variant:"outline",className:"text-xs",children:"ONECI ✓"}),((c=r.profiles)==null?void 0:c.cnam_verified)&&e.jsx(m,{variant:"outline",className:"text-xs",children:"CNAM ✓"})]})]}),e.jsxs("div",{className:"text-muted-foreground",children:["Déposée le ",new Date(r.created_at).toLocaleDateString("fr-FR")]}),r.application_score>0&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Score:"}),e.jsxs(m,{variant:"default",children:[r.application_score,"/100"]})]})]}),e.jsxs(w,{variant:"outline",size:"sm",onClick:()=>n(r),children:[e.jsx(X,{className:"h-4 w-4 mr-2"}),"Voir détails"]})]})})]})]},r.id)})});export{Ie as default};
//# sourceMappingURL=Applications-RUk__IqI.js.map
