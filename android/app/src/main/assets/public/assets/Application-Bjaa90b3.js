import{r as u,j as e,ab as U,X as T,c4 as O,a5 as M,ap as X,a9 as F,aa as R,c8 as H}from"./react-vendor-CPmH2tz8.js";import{ag as Y,_ as Z,a as L,B as y,t as f,s as m,l as S,u as G,X as J,w as K,ai as Q,x as W,C as k,b as I,d as V,j as B,e as z,Z as ee}from"./route-admin-B1Ip8YDE.js";import{D as te}from"./route-owner-C83ejxxl.js";import{F as se}from"./FormProgressIndicator-BFIH4d_g.js";import{F as ae}from"./FormStepper-CogL4h-a.js";import{n as ie}from"./route-property-b6Ka_7KN.js";import"./query-vendor-ByjIuei6.js";import"./monitoring-vendor-C7yD_Gmu.js";import"./ui-vendor-Dua12RDV.js";import"./common-vendor-CK5d0rWc.js";import"./charts-vendor-16YcNskv.js";import"./supabase-vendor-CzsKfTY-.js";import"./route-agency-BEE2sWoQ.js";import"./animation-vendor-BJe5VoH_.js";import"./forms-vendor-DqOZ4YtP.js";(function(){try{var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};t.SENTRY_RELEASE={id:"b65e2d84341e79b518aed72b6e71dcc77eba934a"}}catch{}})();try{(function(){var t=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},i=new t.Error().stack;i&&(t._sentryDebugIds=t._sentryDebugIds||{},t._sentryDebugIds[i]="5966ed25-453c-4cb1-9109-cccf6f9cbd70",t._sentryDebugIdIdentifier="sentry-dbid-5966ed25-453c-4cb1-9109-cccf6f9cbd70")})()}catch{}const re=({documents:t,onDocumentsChange:i,userId:s})=>{const[p,l]=u.useState(!1),_=[{value:"id_card",label:"Pièce d'identité"},{value:"pay_slip",label:"Bulletin de salaire"},{value:"tax_notice",label:"Avis d'imposition"},{value:"employment_contract",label:"Contrat de travail"},{value:"bank_statement",label:"Relevé bancaire"},{value:"other",label:"Autre"}],o=async(a,r)=>{var v;const c=(v=a.target.files)==null?void 0:v[0];if(!c)return;const g=5*1024*1024;if(c.size>g){f({title:"Fichier trop volumineux",description:"La taille maximale est de 5MB",variant:"destructive"});return}l(!0);try{const h=c.name.split(".").pop(),j=`${s}/${r}_${Date.now()}.${h}`,{error:C}=await m.storage.from("user-documents").upload(j,c);if(C)throw C;const{data:{publicUrl:E}}=m.storage.from("user-documents").getPublicUrl(j),x={type:r,url:E,name:c.name,uploaded_at:new Date().toISOString()};i([...t,x]),f({title:"Document uploadé",description:"Le fichier a été ajouté à votre dossier"})}catch(h){S.logError(h,{context:"DocumentUpload",action:"upload"}),f({title:"Erreur d'upload",description:h.message||"Impossible d'uploader le fichier",variant:"destructive"})}finally{l(!1)}},D=a=>{const r=t.filter((c,g)=>g!==a);i(r)},n=a=>{var r;return((r=_.find(c=>c.value===a))==null?void 0:r.label)||a};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:_.map(a=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{htmlFor:`upload-${a.value}`,children:a.label}),e.jsx("div",{className:"flex gap-2",children:e.jsx(Z,{id:`upload-${a.value}`,type:"file",accept:".pdf,.jpg,.jpeg,.png",onChange:r=>o(r,a.value),disabled:p,className:"flex-1"})})]},a.value))}),t.length>0&&e.jsxs("div",{className:"mt-6",children:[e.jsxs("h3",{className:"text-sm font-medium mb-3",children:["Documents ajoutés (",t.length,")"]}),e.jsx("div",{className:"space-y-2",children:t.map((a,r)=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(U,{className:"h-5 w-5 text-muted-foreground"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:a.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:n(a.type)})]}),e.jsx(L,{variant:"secondary",children:new Date(a.uploaded_at).toLocaleDateString("fr-FR")})]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>D(r),children:e.jsx(T,{className:"h-4 w-4"})})]},r))})]}),p&&e.jsx("div",{className:"text-center text-sm text-muted-foreground",children:"Upload en cours..."})]})},q=[{id:"verification",label:"Vérification d'identité"},{id:"documents",label:"Documents justificatifs"},{id:"review",label:"Révision du dossier"},{id:"submit",label:"Soumission finale"}],Ne=()=>{const{propertyId:t}=O(),{user:i,profile:s}=G(),p=M(),[l,_]=u.useState(null),[o,D]=u.useState([]),[n,a]=u.useState(null),[r,c]=u.useState(!0),[g,v]=u.useState(!1),[h,j]=u.useState(0);u.useEffect(()=>{t&&C()},[t]);const C=async()=>{try{const{data:x,error:w}=await m.from("properties").select("id, title, monthly_rent, deposit_amount, city").eq("id",t).single();if(w)throw w;if(_(x),i){const{data:d}=await m.from("user_verifications").select("*").eq("user_id",i.id).single();a(d)}}catch(x){S.logError(x,{context:"Application",action:"fetchData",propertyId:t}),f({title:"Erreur",description:"Impossible de charger les informations",variant:"destructive"})}finally{c(!1)}},E=async()=>{var x,w;if(!(!i||!t)){if(o.length===0){f({title:"Documents requis",description:"Veuillez ajouter au moins un document justificatif pour soumettre votre candidature",variant:"destructive"});return}v(!0);try{const{data:d}=await m.from("rental_applications").select("id, status").eq("property_id",t).eq("applicant_id",i.id).maybeSingle();if(d){f({title:"Candidature déjà soumise",description:`Vous avez déjà soumis une candidature pour ce logement (statut: ${d.status}). Vous ne pouvez pas soumettre une nouvelle candidature.`,variant:"destructive"}),v(!1);return}const{data:b,error:$}=await m.from("rental_applications").insert({property_id:t,applicant_id:i.id,documents:o,status:"pending"}).select().single();if($)throw $;try{const{data:N}=await m.functions.invoke("tenant-scoring",{body:{applicantId:i.id,propertyId:t,monthlyRent:l.monthly_rent}});N!=null&&N.score&&await m.from("rental_applications").update({application_score:N.score}).eq("id",b.id)}catch(N){S.logError(N,{context:"Application",action:"calculateScore",propertyId:t})}const{count:P}=await m.from("rental_applications").select("id",{count:"exact",head:!0}).eq("applicant_id",i.id),A=P===1;A&&ie(),f({title:A?"🎉 Première candidature envoyée !":"Candidature soumise avec succès !",description:A?"Félicitations ! Vous venez de faire le premier pas vers votre nouveau logement":"Votre dossier a été envoyé au propriétaire"}),p(`/property/${t}`)}catch(d){S.logError(d,{context:"Application",action:"submitApplication",propertyId:t});let b="Impossible de soumettre la candidature";(x=d.message)!=null&&x.includes("duplicate key")?b="Vous avez déjà soumis une candidature pour ce logement.":(w=d.message)!=null&&w.includes("network")?b="Erreur de connexion. Vérifiez votre connexion internet et réessayez.":d.message&&(b=d.message),f({title:"Erreur de soumission",description:b,variant:"destructive"})}finally{v(!1)}}};return r?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):l?(u.useEffect(()=>{s!=null&&s.oneci_verified||(n==null?void 0:n.oneci_status)==="verified"?o.length>0?j(2):j(1):j(0)},[s,n,o]),e.jsxs("div",{className:"min-h-screen flex flex-col bg-gradient-to-br from-background via-background to-primary/5",children:[e.jsx(J,{}),e.jsxs("main",{className:"flex-1 container mx-auto px-4 py-6 pt-24 max-w-4xl",children:[e.jsx(te,{}),e.jsxs("div",{className:"mb-8",children:[e.jsx(y,{variant:"ghost",onClick:()=>p(`/property/${t}`),className:"mb-4 -ml-2",children:"← Retour au bien"}),e.jsxs("h1",{className:"text-4xl font-bold text-foreground mb-3",children:["Postuler pour ",l.title]}),e.jsxs("p",{className:"text-lg text-muted-foreground",children:[l.city," • ",l.monthly_rent.toLocaleString()," FCFA/mois"]})]}),e.jsx(ae,{steps:q,currentStep:h}),e.jsx(se,{steps:q,currentStep:h,className:"mt-6"}),e.jsxs("div",{className:"space-y-6",children:[!(s!=null&&s.oneci_verified)&&(n==null?void 0:n.oneci_status)!=="verified"&&e.jsxs(K,{className:"border-primary/50 bg-primary/5",children:[e.jsx(X,{className:"h-4 w-4"}),e.jsx(Q,{children:"Vérification ONECI recommandée"}),e.jsx(W,{children:"Complétez votre vérification d'identité ONECI pour renforcer votre candidature. Les propriétaires accordent plus de confiance aux profils vérifiés."})]}),e.jsxs(k,{className:"border-2 shadow-lg",children:[e.jsxs(I,{className:"pb-4",children:[e.jsxs(V,{className:"flex items-center gap-2 text-xl",children:[e.jsx(F,{className:"h-5 w-5 text-primary"}),"Votre profil de vérification"]}),e.jsx(B,{children:"Ces informations renforceront votre candidature auprès du propriétaire"})]}),e.jsxs(z,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50 hover:bg-muted transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[s!=null&&s.oneci_verified?e.jsx("div",{className:"p-2 rounded-full bg-green-500/10",children:e.jsx(F,{className:"h-5 w-5 text-green-600"})}):e.jsx("div",{className:"p-2 rounded-full bg-muted",children:e.jsx(R,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Vérification ONECI"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Carte d'identité nationale"})]})]}),!(s!=null&&s.oneci_verified)&&e.jsx(y,{variant:"outline",size:"sm",onClick:()=>p("/verification"),className:"rounded-xl",children:"Vérifier"})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-xl bg-muted/50 hover:bg-muted transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[s!=null&&s.cnam_verified?e.jsx("div",{className:"p-2 rounded-full bg-green-500/10",children:e.jsx(F,{className:"h-5 w-5 text-green-600"})}):e.jsx("div",{className:"p-2 rounded-full bg-muted",children:e.jsx(R,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:"Vérification CNAM"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Situation professionnelle"})]})]}),!(s!=null&&s.cnam_verified)&&e.jsx(y,{variant:"outline",size:"sm",onClick:()=>p("/verification"),className:"rounded-xl",children:"Vérifier"})]}),n&&n.tenant_score>0&&e.jsx("div",{className:"mt-4 p-5 bg-gradient-to-br from-primary/10 to-primary/5 rounded-xl border border-primary/20",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-lg",children:"Score locataire"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Basé sur vos vérifications"})]}),e.jsxs(L,{variant:"default",className:"text-lg px-4 py-2 rounded-xl",children:[n.tenant_score,"/100"]})]})})]})]}),e.jsxs(k,{className:"border-2 shadow-lg",children:[e.jsxs(I,{className:"pb-4",children:[e.jsxs(V,{className:"flex items-center gap-2 text-xl",children:[e.jsx(H,{className:"h-5 w-5 text-primary"}),"Documents justificatifs"]}),e.jsx(B,{children:"Ajoutez vos documents pour compléter votre dossier (CNI, fiches de paie, etc.)"})]}),e.jsx(z,{children:e.jsx(re,{documents:o,onDocumentsChange:D,userId:(i==null?void 0:i.id)||""})})]}),e.jsxs(k,{className:"border-2 shadow-lg bg-gradient-to-br from-background to-muted/20",children:[e.jsx(I,{className:"pb-4",children:e.jsx(V,{className:"text-xl",children:"Récapitulatif de votre candidature"})}),e.jsxs(z,{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 rounded-xl bg-background",children:[e.jsx("span",{className:"text-muted-foreground",children:"Loyer mensuel"}),e.jsxs("span",{className:"font-bold text-lg",children:[l.monthly_rent.toLocaleString()," FCFA"]})]}),l.deposit_amount&&e.jsxs("div",{className:"flex justify-between items-center p-3 rounded-xl bg-background",children:[e.jsx("span",{className:"text-muted-foreground",children:"Caution"}),e.jsxs("span",{className:"font-bold text-lg",children:[l.deposit_amount.toLocaleString()," FCFA"]})]}),e.jsxs("div",{className:"flex justify-between items-center p-3 rounded-xl bg-background",children:[e.jsx("span",{className:"text-muted-foreground",children:"Documents joints"}),e.jsx(L,{variant:o.length>0?"default":"destructive",className:"rounded-xl",children:o.length>0?`${o.length} fichier${o.length>1?"s":""}`:"Requis"})]})]})]}),e.jsxs("div",{className:"flex gap-4 pt-4",children:[e.jsx(y,{variant:"outline",onClick:()=>p(`/property/${t}`),className:"flex-1 h-14 rounded-xl text-base",children:"Annuler"}),e.jsx(y,{onClick:E,disabled:g,className:"flex-1 h-14 rounded-xl text-base font-semibold shadow-lg",children:g?"Envoi en cours...":"📤 Soumettre ma candidature"})]})]})]}),e.jsx(ee,{})]})):e.jsx("div",{children:"Bien non trouvé"})};export{Ne as default};
//# sourceMappingURL=Application-Bjaa90b3.js.map
