import{r as t,a5 as W,c4 as ae,j as e,bc as I,bx as ne,c5 as oe}from"./react-vendor-CPmH2tz8.js";import{a as G,u as le,P as ce,b as de,L as me,c as ue,d as pe,e as fe,M as xe}from"./LocationPicker-C-a9Wq3S.js";import{s as N,l as w,aV as _,aW as he,aX as ge,a6 as je,X as U,C as O,b as V,d as k,j as q,Z as B,A as be,k as ye,B as E,m as ve,n as Pe,o as we,p as _e,q as Ee,r as Ne,v as De,w as Se,x as Ae,e as Re,t as Y}from"./route-admin-B1Ip8YDE.js";import{m as Ce,F as Te}from"./route-property-b6Ka_7KN.js";import{D as Fe}from"./route-owner-C83ejxxl.js";import{F as Me}from"./FormProgressIndicator-BFIH4d_g.js";import{F as Le}from"./FormStepper-CogL4h-a.js";import"./query-vendor-ByjIuei6.js";import"./monitoring-vendor-C7yD_Gmu.js";import"./ui-vendor-Dua12RDV.js";import"./common-vendor-CK5d0rWc.js";import"./forms-vendor-DqOZ4YtP.js";import"./maps-vendor-B7X9GnXQ.js";import"./charts-vendor-16YcNskv.js";import"./supabase-vendor-CzsKfTY-.js";import"./route-agency-BEE2sWoQ.js";import"./animation-vendor-BJe5VoH_.js";(function(){try{var r=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};r.SENTRY_RELEASE={id:"b65e2d84341e79b518aed72b6e71dcc77eba934a"}}catch{}})();try{(function(){var r=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},a=new r.Error().stack;a&&(r._sentryDebugIds=r._sentryDebugIds||{},r._sentryDebugIds[a]="b67c6e01-5092-4a11-b632-5c6addea8217",r._sentryDebugIdIdentifier="sentry-dbid-b67c6e01-5092-4a11-b632-5c6addea8217")})()}catch{}const Ie=()=>{const[r,a]=t.useState(!1),n=W(),{deleteMedia:g}=G();return{deleting:r,deleteProperty:async(l,j,o)=>{a(!0);try{const{data:d,error:m}=await N.from("properties").select("owner_id").eq("id",l).single();if(m||!d)throw w.error("Property not found",{error:m,propertyId:l}),new _("PROPERTY_NOT_FOUND");if(d.owner_id!==j)throw w.error("Unauthorized delete attempt",{propertyId:l,userId:j}),new _("OWNER_ONLY");await g(o);const{error:b}=await N.from("properties").delete().eq("id",l);if(b)throw w.error("Failed to delete property",{error:b,propertyId:l}),new _("PROPERTY_DELETE_FAILED");he("PROPERTY_DELETED"),n("/mes-biens")}catch(d){ge(d,je.PROPERTY_DELETE_FAILED)}finally{a(!1)}}}},z=[{id:"basic",label:"Type de bien"},{id:"location",label:"Informations générales"},{id:"characteristics",label:"Photos et description"},{id:"pricing",label:"Prix et disponibilité"},{id:"media",label:"Vérification"}],es=()=>{const{id:r}=ae(),a=W(),{user:n,canEditProperty:g,requireOwnerAccess:D,hasAgencyPermission:l,activeMandates:j}=Ce(),{form:o,loading:d,submitting:m,submitProperty:b}=le(r),{uploading:y,uploadMedia:H}=G(),{deleting:X,deleteProperty:Z}=Ie(),[v,J]=t.useState(null),[u,K]=t.useState(null),[S,Q]=t.useState(0),A=t.useRef(null),R=t.useRef(null),C=t.useRef(null),T=t.useRef(null),F=t.useRef(null),[p,$]=t.useState({images:[],mainImage:null,videoUrl:null,panoramas:[],floorPlans:[]}),[M,f]=t.useState({images:[],video:null,panoramas:[],floorPlans:[],virtualTourUrl:""}),[ee,se]=t.useState(null),[x,re]=t.useState(null);t.useEffect(()=>{const i=()=>{const s=[{ref:A,step:0},{ref:R,step:1},{ref:C,step:2},{ref:T,step:3},{ref:F,step:4}];for(let h=s.length-1;h>=0;h--){const c=s[h];if(c.ref.current&&c.ref.current.getBoundingClientRect().top<=200){Q(c.step);break}}};return window.addEventListener("scroll",i),()=>window.removeEventListener("scroll",i)},[]),t.useEffect(()=>{(async()=>{if(!r)return;const{data:s,error:h}=await N.from("properties").select("*").eq("id",r).single();if(h||!s){Y({title:"Erreur",description:"Bien introuvable",variant:"destructive"}),a("/mes-biens");return}if(J(s.owner_id),!g(s.owner_id,r)){Y({title:"Accès refusé",description:"Vous ne pouvez pas modifier ce bien",variant:"destructive"}),a("/mes-biens");return}if(n!=null&&n.id&&n.id!==s.owner_id){const c=j.find(P=>P.property_id===r||!P.property_id&&P.owner_id===s.owner_id);K(c)}$({images:s.images||[],mainImage:s.main_image||null,videoUrl:s.video_url||null,panoramas:s.panoramic_images||[],floorPlans:s.floor_plans||[]}),f(c=>({...c,virtualTourUrl:s.virtual_tour_url||""})),s.latitude&&s.longitude&&re({lat:s.latitude,lng:s.longitude})})()},[r,g,a]);const ie=async i=>{if(!(!r||!n))try{const s=await H(r,M,p);await b(i,s,r,ee),a("/mes-biens")}catch{}},te=async()=>{!r||!n||await Z(r,n.id,p)},L=D();return L.hasAccess?d?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(I,{className:"h-8 w-8 animate-spin"})}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(U,{}),e.jsx("main",{className:"flex-1 container mx-auto px-4 py-6 pt-24",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx(Fe,{}),e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Modifier le bien"}),v&&l(r,v,"can_delete_properties")?e.jsxs(be,{children:[e.jsx(ye,{asChild:!0,children:e.jsxs(E,{variant:"destructive",disabled:X,children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Supprimer le bien"]})}),e.jsxs(ve,{children:[e.jsxs(Pe,{children:[e.jsx(we,{children:"Êtes-vous sûr ?"}),e.jsx(_e,{children:"Cette action est irréversible. Le bien et toutes ses images seront supprimés définitivement."})]}),e.jsxs(Ee,{children:[e.jsx(Ne,{children:"Annuler"}),e.jsx(De,{onClick:te,children:"Supprimer"})]})]})]}):null]}),u&&v&&(n==null?void 0:n.id)!==v&&e.jsxs(Se,{className:"mb-6",children:[e.jsx(oe,{className:"h-4 w-4"}),e.jsxs(Ae,{children:[e.jsx("strong",{children:"Vous gérez ce bien en tant qu'agence"}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsx("p",{className:"font-medium mb-1",children:"Permissions accordées :"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[u.permissions.can_edit_properties&&e.jsx("li",{children:"Modification du bien"}),u.permissions.can_view_applications&&e.jsx("li",{children:"Voir les candidatures"}),u.permissions.can_manage_applications&&e.jsx("li",{children:"Gérer les candidatures"}),u.permissions.can_create_leases&&e.jsx("li",{children:"Créer des baux"}),!u.permissions.can_delete_properties&&e.jsx("li",{className:"text-muted-foreground",children:"❌ Suppression non autorisée"})]})]})]})]}),e.jsx(Le,{steps:z,currentStep:S}),e.jsx(Me,{steps:z,currentStep:S,className:"mt-6"}),e.jsx(Te,{...o,children:e.jsxs("form",{onSubmit:o.handleSubmit(ie),className:"space-y-6",children:[e.jsx("div",{ref:A,className:"scroll-mt-32",children:e.jsx(ce,{form:o})}),e.jsx("div",{ref:R,className:"scroll-mt-32",children:e.jsx(de,{form:o})}),e.jsx(me,{city:o.watch("city"),initialLat:x==null?void 0:x.lat,initialLng:x==null?void 0:x.lng,onLocationSelect:(i,s)=>se({lat:i,lng:s})}),e.jsx("div",{ref:C,className:"scroll-mt-32",children:e.jsx(ue,{form:o})}),e.jsx("div",{ref:T,className:"scroll-mt-32",children:e.jsx(pe,{form:o})}),e.jsx(fe,{form:o}),e.jsxs(O,{ref:F,className:"scroll-mt-32",children:[e.jsxs(V,{children:[e.jsx(k,{children:"Médias"}),e.jsx(q,{children:"Ajoutez ou modifiez les photos, vidéos et plans"})]}),e.jsx(Re,{children:e.jsx(xe,{onImagesChange:i=>f(s=>({...s,images:i})),onVideoChange:i=>f(s=>({...s,video:i})),onPanoramaChange:i=>f(s=>({...s,panoramas:i})),onFloorPlanChange:i=>f(s=>({...s,floorPlans:i})),onVirtualTourUrlChange:i=>f(s=>({...s,virtualTourUrl:i})),uploading:y,existingImages:p.images,existingVideo:p.videoUrl,existingVirtualTourUrl:M.virtualTourUrl,existingPanoramas:p.panoramas,existingFloorPlans:p.floorPlans})})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(E,{type:"button",variant:"outline",onClick:()=>a("/mes-biens"),disabled:m||y,className:"flex-1",children:"Annuler"}),e.jsx(E,{type:"submit",disabled:m||y,className:"flex-1",children:m||y?e.jsxs(e.Fragment,{children:[e.jsx(I,{className:"mr-2 h-4 w-4 animate-spin"}),"Mise à jour en cours..."]}):"Enregistrer les modifications"})]})]})})]})}),e.jsx(B,{})]}):e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(U,{}),e.jsx("main",{className:"flex-1 container mx-auto px-4 py-12",children:e.jsx(O,{children:e.jsxs(V,{children:[e.jsx(k,{children:"Accès refusé"}),e.jsx(q,{children:L.error})]})})}),e.jsx(B,{})]})};export{es as default};
//# sourceMappingURL=EditProperty-gNlv7Mkn.js.map
