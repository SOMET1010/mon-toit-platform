const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-LMib0YFl.js","assets/react-vendor-CPmH2tz8.js","assets/query-vendor-ByjIuei6.js","assets/monitoring-vendor-C7yD_Gmu.js","assets/ui-vendor-Dua12RDV.js","assets/common-vendor-CK5d0rWc.js","assets/styles-DXEvswlz.css","assets/animation-vendor-BJe5VoH_.js","assets/route-property-b6Ka_7KN.js","assets/route-owner-C83ejxxl.js","assets/charts-vendor-16YcNskv.js","assets/route-agency-BEE2sWoQ.js","assets/forms-vendor-DqOZ4YtP.js","assets/route-tenant-DNBKfVUX.js","assets/maps-vendor-B7X9GnXQ.js","assets/styles-BKWjo1HA.css","assets/supabase-vendor-CzsKfTY-.js","assets/styles-ClL3PRTN.css"])))=>i.map(i=>d[i]);
var ti=Object.defineProperty;var ai=(s,t,a)=>t in s?ti(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a;var ia=(s,t,a)=>ai(s,typeof t!="symbol"?t+"":t,a);import{r,j as e,h as va,i as ri,k as ii,T as ni,S as ws,l as Na,V as li,m as ci,n as ya,o as oi,p as ba,I as wa,F as _a,q as Sa,O as lt,d as Aa,C as ct,t as Ca,X as Zs,v as ot,D as dt,c as Ea,w as Ra,x as di,y as Da,z as mt,B as Ta,E as mi,G as Ia,H as ka,J as Pa,K as Ma,L as Ft,M as La,N as Oa,Q as Fa,U as qa,W as ui,Y as xi,Z as hi,_ as pi,$ as fi,a0 as js,a1 as Ua,a2 as $a,a3 as za,a4 as ji,a5 as Va,a6 as rs,a7 as Ba,a8 as Ga,a9 as he,aa as de,ab as Re,ac as Ne,ad as Ha,ae as qt,af as ns,ag as gi,ah as ie,ai as Ka,aj as vi,ak as et,al as Ni,am as Fs,an as Oe,ao as Ya,ap as pe,aq as yi,ar as bi,as as wi,at as Xa,au as _i,av as Ut,aw as Wa,ax as Si,ay as Ja,az as Ai,aA as Qa,aB as Ci,aC as Za,aD as er,aE as Ei,aF as Ri,aG as sr,aH as Di,aI as Ti,aJ as xe,aK as st,aL as tr,aM as ar,aN as Ii,aO as rr,aP as ki,aQ as ir,aR as Pi,aS as nr,aT as Mi,aU as lr,aV as cr,aW as or,aX as dr,aY as mr,aZ as Li,a_ as Oi,a$ as hs,b0 as ur,b1 as Fi,b2 as qi,b3 as Ui,b4 as Pt,b5 as xr,b6 as hr,b7 as $i,b8 as zi,b9 as Mt,ba as Vi,bb as $t,bc as ke,bd as Pe,be as Me,bf as tt,bg as Ye,bh as Bi,bi as Gi,bj as pr,bk as na,bl as Hi,bm as Ki,bn as Yi,bo as fr,bp as Xi,bq as jr,br as $s,bs as bt,bt as wt,bu as Wi,bv as Ji,bw as la,bx as ca,by as Qi,bz as gr,bA as Zi,bB as oa,bC as vr,bD as _t,bE as en,bF as sn,bG as da,bH as tn,bI as an,bJ as rn}from"./react-vendor-CPmH2tz8.js";import{cc as nn,ad as ln,cd as _s,ce as cn,cf as be,bY as me,cg as on,bT as qs,ch as Ys,ci as ma,bL as St,cj as Xe}from"./common-vendor-CK5d0rWc.js";import{R as Te,B as at,C as ss,X as ts,Y as as,T as Ie,L as zs,a as rt,b as zt,c as vs,P as Vt,d as Bt,e as Gt,F as dn,f as mn,g as un,S as xn,Z as hn,h as pn}from"./charts-vendor-16YcNskv.js";import{c as fn}from"./supabase-vendor-CzsKfTY-.js";import{c as ua,b as jn}from"./monitoring-vendor-C7yD_Gmu.js";(function(){try{var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{};s.SENTRY_RELEASE={id:"b65e2d84341e79b518aed72b6e71dcc77eba934a"}}catch{}})();try{(function(){var s=typeof window<"u"?window:typeof global<"u"?global:typeof globalThis<"u"?globalThis:typeof self<"u"?self:{},t=new s.Error().stack;t&&(s._sentryDebugIds=s._sentryDebugIds||{},s._sentryDebugIds[t]="55281643-fd80-43bc-ae5e-2712e33971b1",s._sentryDebugIdIdentifier="sentry-dbid-55281643-fd80-43bc-ae5e-2712e33971b1")})()}catch{}class gn{constructor(){ia(this,"isDevelopment",!1)}formatMessage(t,a,l){return`[${new Date().toISOString()}] [${t.toUpperCase()}] ${a}`}error(t,a){const l=this.formatMessage("error",t,a);this.isDevelopment||ua(new Error(t),{level:"error",extra:a}),console.error(l,a||"")}warn(t,a){const l=this.formatMessage("warn",t,a);this.isDevelopment||jn({message:t,level:"warning",data:a}),console.warn(l,a||"")}info(t,a){const l=this.formatMessage("info",t,a);this.isDevelopment&&console.info(l,a||"")}debug(t,a){if(this.isDevelopment){const l=this.formatMessage("debug",t,a);console.debug(l,a||"")}}logError(t,a){const l=this.parseError(t);this.isDevelopment||ua(t,{level:"error",tags:{errorType:l.type,errorCode:l.code},extra:{...a,stack:l.stack,url:typeof window<"u"?window.location.href:void 0}}),this.error(l.message,{...a,stack:l.stack,code:l.code,type:l.type,url:typeof window<"u"?window.location.href:void 0})}parseError(t){if(t instanceof Error)return{message:t.message,stack:t.stack,code:t.code,type:t.name};if(typeof t=="string")return{message:t,type:"string"};if(t&&typeof t=="object"){const a=t;return{message:a.message||a.error_description||JSON.stringify(t),code:a.code||a.error,type:"object"}}return{message:"Unknown error",type:"unknown"}}}const G=new gn,vn="modulepreload",Nn=function(s){return"/"+s},xa={},yn=function(t,a,l){let o=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),x=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));o=Promise.allSettled(a.map(v=>{if(v=Nn(v),v in xa)return;xa[v]=!0;const S=v.endsWith(".css"),g=S?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${v}"]${g}`))return;const y=document.createElement("link");if(y.rel=S?"stylesheet":vn,S||(y.as="script"),y.crossOrigin="",y.href=v,x&&y.setAttribute("nonce",x),document.head.appendChild(y),S)return new Promise((n,h)=>{y.addEventListener("load",n),y.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${v}`)))})}))}function p(c){const x=new Event("vite:preloadError",{cancelable:!0});if(x.payload=c,window.dispatchEvent(x),!x.defaultPrevented)throw c}return o.then(c=>{for(const x of c||[])x.status==="rejected"&&p(x.reason);return t().catch(p)})},bn=1,wn=1e6;let At=0;function _n(){return At=(At+1)%Number.MAX_SAFE_INTEGER,At.toString()}const Ct=new Map,ha=s=>{if(Ct.has(s))return;const t=setTimeout(()=>{Ct.delete(s),Us({type:"REMOVE_TOAST",toastId:s})},wn);Ct.set(s,t)},Sn=(s,t)=>{switch(t.type){case"ADD_TOAST":return{...s,toasts:[t.toast,...s.toasts].slice(0,bn)};case"UPDATE_TOAST":return{...s,toasts:s.toasts.map(a=>a.id===t.toast.id?{...a,...t.toast}:a)};case"DISMISS_TOAST":{const{toastId:a}=t;return a?ha(a):s.toasts.forEach(l=>{ha(l.id)}),{...s,toasts:s.toasts.map(l=>l.id===a||a===void 0?{...l,open:!1}:l)}}case"REMOVE_TOAST":return t.toastId===void 0?{...s,toasts:[]}:{...s,toasts:s.toasts.filter(a=>a.id!==t.toastId)}}},Ws=[];let Js={toasts:[]};function Us(s){Js=Sn(Js,s),Ws.forEach(t=>{t(Js)})}function K({...s}){const t=_n(),a=o=>Us({type:"UPDATE_TOAST",toast:{...o,id:t}}),l=()=>Us({type:"DISMISS_TOAST",toastId:t});return Us({type:"ADD_TOAST",toast:{...s,id:t,open:!0,onOpenChange:o=>{o||l()}}}),{id:t,dismiss:l,update:a}}function os(){const[s,t]=r.useState(Js);return r.useEffect(()=>(Ws.push(t),()=>{const a=Ws.indexOf(t);a>-1&&Ws.splice(a,1)}),[s]),{...s,toast:K,dismiss:a=>Us({type:"DISMISS_TOAST",toastId:a})}}const An={"ivorian-family-house":"/src/assets/illustrations/ivorian/ivorian-family-house.png","apartment-visit":"/src/assets/illustrations/ivorian/apartment-visit.png","real-estate-agent":"/src/assets/illustrations/ivorian/real-estate-agent.png","abidjan-neighborhood":"/src/assets/illustrations/ivorian/abidjan-neighborhood.png","modern-living-room":"/src/assets/illustrations/ivorian/modern-living-room.png","abidjan-skyline":"/src/assets/illustrations/ivorian/abidjan-skyline.png","key-handover":"/src/assets/illustrations/ivorian/key-handover.png","family-moving":"/src/assets/illustrations/ivorian/family-moving.png","co-ownership-meeting":"/src/assets/illustrations/ivorian/co-ownership-meeting.png","certification-ansut-illustration":"/src/assets/illustrations/ivorian/certification-ansut-illustration.png"};function E(...s){return nn(ln(s))}function hc(s){return An[s]}const Nr=ri,yr=ii,br=ni,Ht=r.forwardRef(({className:s,sideOffset:t=4,...a},l)=>e.jsx(va,{ref:l,sideOffset:t,className:E("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...a}));Ht.displayName=va.displayName;const Cn="https://btxhuqtirylvkgvoutoc.supabase.co",En="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0eGh1cXRpcnlsdmtndm91dG9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk1ODA0MDcsImV4cCI6MjA3NTE1NjQwN30.yjG6Xp3y6ZiJLRM1AInfP84U1AAL333u80iRXGnSnc4",b=fn(Cn,En,{auth:{storage:localStorage,persistSession:!0,autoRefreshToken:!0}}),wr=r.createContext(void 0),pc=({children:s})=>{const[t,a]=r.useState(null),[l,o]=r.useState(null),[p,c]=r.useState(null),[x,v]=r.useState([]),[S,g]=r.useState(!0),y=async R=>{G.info("Fetching profile for user",{userId:R});const{data:N,error:j}=await b.from("profiles").select("*").eq("id",R).single();return j?(G.error("Error fetching profile",{error:j,userId:R}),null):(G.info("Profile fetched successfully",{userId:R}),N)},n=async R=>{G.info("Fetching roles for user",{userId:R});const{data:N,error:j}=await b.from("user_roles").select("role").eq("user_id",R);return j?(G.error("Error fetching roles",{error:j,userId:R}),[]):(G.info("Roles fetched successfully",{userId:R,roles:N}),(N==null?void 0:N.map(A=>A.role))||[])},h=async()=>{if(t){const R=await y(t.id);c(R);const N=await n(t.id);v(N)}};r.useEffect(()=>{G.info("Setting up auth listener");const{data:{subscription:R}}=b.auth.onAuthStateChange(async(N,j)=>{G.info("Auth state changed",{event:N,hasSession:!!j}),o(j),a((j==null?void 0:j.user)??null),j!=null&&j.user?setTimeout(async()=>{const A=await y(j.user.id);c(A);const O=await n(j.user.id);v(O)},0):(c(null),v([]))});return b.auth.getSession().then(({data:{session:N}})=>{G.info("Initial session check",{hasSession:!!N}),o(N),a((N==null?void 0:N.user)??null),N!=null&&N.user?setTimeout(async()=>{const j=await y(N.user.id);c(j);const A=await n(N.user.id);v(A),g(!1),G.info("Auth loading complete")},0):(g(!1),G.info("No session, loading complete"))}),()=>R.unsubscribe()},[]);const i=async(R,N,j,A)=>{const O=`${window.location.origin}/`,{error:q}=await b.auth.signUp({email:R,password:N,options:{emailRedirectTo:O,data:{full_name:j,user_type:A}}});return K(q?{title:"Erreur d'inscription",description:q.message,variant:"destructive"}:{title:"Inscription réussie",description:"Votre compte a été créé avec succès !"}),{error:q}},d=async(R,N)=>{const{error:j}=await b.auth.signInWithPassword({email:R,password:N});return K(j?{title:"Erreur de connexion",description:j.message,variant:"destructive"}:{title:"Connexion réussie",description:"Bienvenue sur Mon Toit !"}),{error:j}},f=async()=>{const{error:R}=await b.auth.signOut();if(!R){v([]);const{clearCacheOnLogout:N}=await yn(async()=>{const{clearCacheOnLogout:j}=await import("./index-LMib0YFl.js").then(A=>A.q);return{clearCacheOnLogout:j}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17]));N(),K({title:"Déconnexion",description:"À bientôt sur Mon Toit !"})}},M=R=>x.includes(R);return e.jsx(wr.Provider,{value:{user:t,session:l,profile:p,roles:x,loading:S,signUp:i,signIn:d,signOut:f,refreshProfile:h,hasRole:M},children:s})},Ke=()=>{const s=r.useContext(wr);if(s===void 0)throw new Error("useAuth must be used within an AuthProvider");return s},Rn=_s("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),ls=r.forwardRef(({className:s,variant:t,...a},l)=>e.jsx("div",{ref:l,role:"alert",className:E(Rn({variant:t}),s),...a}));ls.displayName="Alert";const Vs=r.forwardRef(({className:s,...t},a)=>e.jsx("h5",{ref:a,className:E("mb-1 font-medium leading-none tracking-tight",s),...t}));Vs.displayName="AlertTitle";const cs=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:E("text-sm [&_p]:leading-relaxed",s),...t}));cs.displayName="AlertDescription";const ys=_s("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-all duration-200 hover:scale-105 active:scale-95 cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:hover:scale-100 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90 shadow-sm",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border-2 border-primary bg-background text-primary hover:bg-primary hover:text-white",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/90",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline","primary-gradient":"bg-gradient-to-r from-secondary via-secondary-700 to-secondary bg-[length:200%_auto] text-white hover:shadow-xl transition-all duration-300 animate-gradient"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",xl:"h-14 rounded-lg px-10 text-base",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),P=r.forwardRef(({className:s,variant:t,size:a,asChild:l=!1,...o},p)=>{const c=l?ws:"button";return e.jsx(c,{className:E(ys({variant:t,size:a,className:s})),ref:p,...o})});P.displayName="Button";const Je=r.forwardRef(({className:s,type:t,...a},l)=>e.jsx("input",{type:t,className:E("flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground transition-all duration-200 focus-visible:outline-none focus-visible:border-2 focus-visible:border-primary focus-visible:ring-2 focus-visible:ring-primary/20 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",s),ref:l,...a}));Je.displayName="Input";const _r=r.forwardRef(({className:s,children:t,...a},l)=>e.jsxs(Na,{ref:l,className:E("relative overflow-hidden",s),...a,children:[e.jsx(li,{className:"h-full w-full rounded-[inherit]",children:t}),e.jsx(Sr,{}),e.jsx(ci,{})]}));_r.displayName=Na.displayName;const Sr=r.forwardRef(({className:s,orientation:t="vertical",...a},l)=>e.jsx(ya,{ref:l,orientation:t,className:E("flex touch-none select-none transition-colors",t==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",t==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",s),...a,children:e.jsx(oi,{className:"relative flex-1 rounded-full bg-border"})}));Sr.displayName=ya.displayName;const Ge=r.forwardRef(({className:s,...t},a)=>e.jsx(ba,{ref:a,className:E("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...t}));Ge.displayName=ba.displayName;const ut=r.forwardRef(({className:s,...t},a)=>e.jsx(wa,{ref:a,className:E("aspect-square h-full w-full",s),...t}));ut.displayName=wa.displayName;const Qe=r.forwardRef(({className:s,...t},a)=>e.jsx(_a,{ref:a,className:E("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...t}));Qe.displayName=_a.displayName;const Et=768;function Ar(){const[s,t]=r.useState(void 0);return r.useEffect(()=>{const a=window.matchMedia(`(max-width: ${Et-1}px)`),l=()=>{t(window.innerWidth<Et)};return a.addEventListener("change",l),t(window.innerWidth<Et),()=>a.removeEventListener("change",l)},[]),!!s}const Dn=()=>{const{user:s}=Ke(),[t,a]=r.useState([]),[l,o]=r.useState(0),[p,c]=r.useState(!0);r.useEffect(()=>{if(!s){a([]),o(0),c(!1);return}x();const n=b.channel("notifications-realtime").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${s.id}`},h=>{const i=h.new;a(d=>[i,...d]),o(d=>d+1),Notification.permission==="granted"&&new Notification(i.title,{body:i.message||"",icon:"/favicon.ico"})}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"notifications",filter:`user_id=eq.${s.id}`},h=>{const i=h.new;a(d=>d.map(f=>f.id===i.id?i:f)),v()}).subscribe();return()=>{b.removeChannel(n)}},[s]);const x=async()=>{if(s)try{const{data:n,error:h}=await b.from("notifications").select("*").eq("user_id",s.id).order("created_at",{ascending:!1}).limit(50);if(h)throw h;a(n||[]),o((n==null?void 0:n.filter(i=>!i.is_read).length)||0)}catch(n){G.logError(n,{context:"useNotifications",action:"fetch"})}finally{c(!1)}},v=async()=>{if(!s)return;const{count:n}=await b.from("notifications").select("*",{count:"exact",head:!0}).eq("user_id",s.id).eq("is_read",!1);o(n||0)};return{notifications:t,unreadCount:l,loading:p,markAsRead:async n=>{try{const{error:h}=await b.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("id",n);if(h)throw h;a(i=>i.map(d=>d.id===n?{...d,is_read:!0,read_at:new Date().toISOString()}:d)),o(i=>Math.max(0,i-1))}catch(h){G.logError(h,{context:"useNotifications",action:"markAsRead"})}},markAllAsRead:async()=>{if(s)try{const{error:n}=await b.from("notifications").update({is_read:!0,read_at:new Date().toISOString()}).eq("user_id",s.id).eq("is_read",!1);if(n)throw n;const h=new Date().toISOString();a(i=>i.map(d=>({...d,is_read:!0,read_at:h}))),o(0)}catch(n){G.logError(n,{context:"useNotifications",action:"markAllAsRead"})}},requestPermission:async()=>{"Notification"in window&&Notification.permission==="default"&&await Notification.requestPermission()},refetch:x}},Tn=()=>{const[s,t]=r.useState(!1);return r.useEffect(()=>{const a=window.matchMedia("(prefers-contrast: high)");t(a.matches);const l=o=>{t(o.matches)};return a.addEventListener("change",l),()=>a.removeEventListener("change",l)},[]),s},In=_s("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function $({className:s,variant:t,...a}){const l=Tn();return e.jsx("div",{className:E(In({variant:t}),l&&"border-2 font-bold",s),...a})}const _=r.forwardRef(({className:s,variant:t="default",...a},l)=>e.jsx("div",{ref:l,className:E("rounded-lg border bg-card text-card-foreground shadow-sm",t==="form"&&"form-card",s),...a}));_.displayName="Card";const D=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:E("flex flex-col space-y-1.5 p-6",s),...t}));D.displayName="CardHeader";const I=r.forwardRef(({className:s,...t},a)=>e.jsx("h3",{ref:a,className:E("text-2xl font-semibold leading-none tracking-tight",s),...t}));I.displayName="CardTitle";const je=r.forwardRef(({className:s,...t},a)=>e.jsx("p",{ref:a,className:E("text-sm text-muted-foreground",s),...t}));je.displayName="CardDescription";const C=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:E("p-6 pt-0",s),...t}));C.displayName="CardContent";const kn=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,className:E("flex items-center p-6 pt-0",s),...t}));kn.displayName="CardFooter";function Ce({className:s,...t}){return e.jsx("div",{className:E("animate-pulse rounded-md bg-muted",s),...t})}const xs=r.forwardRef(({className:s,orientation:t="horizontal",decorative:a=!0,...l},o)=>e.jsx(Sa,{ref:o,decorative:a,orientation:t,className:E("shrink-0 bg-border",t==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...l}));xs.displayName=Sa.displayName;const Cr=Ea,Pn=Ra,Mn=Aa,Er=r.forwardRef(({className:s,...t},a)=>e.jsx(lt,{className:E("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t,ref:a}));Er.displayName=lt.displayName;const Ln=_s("fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Kt=r.forwardRef(({side:s="right",className:t,children:a,...l},o)=>e.jsxs(Mn,{children:[e.jsx(Er,{}),e.jsxs(ct,{ref:o,className:E(Ln({side:s}),t),...l,children:[a,e.jsxs(Ca,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-secondary hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(Zs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Kt.displayName=ct.displayName;const On=({className:s,...t})=>e.jsx("div",{className:E("flex flex-col space-y-2 text-center sm:text-left",s),...t});On.displayName="SheetHeader";const Fn=r.forwardRef(({className:s,...t},a)=>e.jsx(ot,{ref:a,className:E("text-lg font-semibold text-foreground",s),...t}));Fn.displayName=ot.displayName;const qn=r.forwardRef(({className:s,...t},a)=>e.jsx(dt,{ref:a,className:E("text-sm text-muted-foreground",s),...t}));qn.displayName=dt.displayName;const Un="sidebar:state",$n=60*60*24*7,zn="16rem",Vn="18rem",Bn="3rem",Gn="b",Rr=r.createContext(null);function xt(){const s=r.useContext(Rr);if(!s)throw new Error("useSidebar must be used within a SidebarProvider.");return s}const Dr=r.forwardRef(({defaultOpen:s=!0,open:t,onOpenChange:a,className:l,style:o,children:p,...c},x)=>{const v=Ar(),[S,g]=r.useState(!1),[y,n]=r.useState(s),h=t??y,i=r.useCallback(R=>{const N=typeof R=="function"?R(h):R;a?a(N):n(N),document.cookie=`${Un}=${N}; path=/; max-age=${$n}`},[a,h]),d=r.useCallback(()=>v?g(R=>!R):i(R=>!R),[v,i,g]);r.useEffect(()=>{const R=N=>{N.key===Gn&&(N.metaKey||N.ctrlKey)&&(N.preventDefault(),d())};return window.addEventListener("keydown",R),()=>window.removeEventListener("keydown",R)},[d]);const f=h?"expanded":"collapsed",M=r.useMemo(()=>({state:f,open:h,setOpen:i,isMobile:v,openMobile:S,setOpenMobile:g,toggleSidebar:d}),[f,h,i,v,S,g,d]);return e.jsx(Rr.Provider,{value:M,children:e.jsx(Nr,{delayDuration:0,children:e.jsx("div",{style:{"--sidebar-width":zn,"--sidebar-width-icon":Bn,...o},className:E("group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar",l),ref:x,...c,children:p})})})});Dr.displayName="SidebarProvider";const Tr=r.forwardRef(({side:s="left",variant:t="sidebar",collapsible:a="offcanvas",className:l,children:o,...p},c)=>{const{isMobile:x,state:v,openMobile:S,setOpenMobile:g}=xt();return a==="none"?e.jsx("div",{className:E("flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground",l),ref:c,...p,children:o}):x?e.jsx(Cr,{open:S,onOpenChange:g,...p,children:e.jsx(Kt,{"data-sidebar":"sidebar","data-mobile":"true",className:"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden",style:{"--sidebar-width":Vn},side:s,children:e.jsx("div",{className:"flex h-full w-full flex-col",children:o})})}):e.jsxs("div",{ref:c,className:"group peer hidden text-sidebar-foreground md:block","data-state":v,"data-collapsible":v==="collapsed"?a:"","data-variant":t,"data-side":s,children:[e.jsx("div",{className:E("relative h-svh w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear","group-data-[collapsible=offcanvas]:w-0","group-data-[side=right]:rotate-180",t==="floating"||t==="inset"?"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon]")}),e.jsx("div",{className:E("fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex",s==="left"?"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]":"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",t==="floating"||t==="inset"?"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]":"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l",l),...p,children:e.jsx("div",{"data-sidebar":"sidebar",className:"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow",children:o})})]})});Tr.displayName="Sidebar";const Hn=r.forwardRef(({className:s,onClick:t,...a},l)=>{const{toggleSidebar:o}=xt();return e.jsxs(P,{ref:l,"data-sidebar":"trigger",variant:"ghost",size:"icon",className:E("h-7 w-7",s),onClick:p=>{t==null||t(p),o()},...a,children:[e.jsx(di,{}),e.jsx("span",{className:"sr-only",children:"Toggle Sidebar"})]})});Hn.displayName="SidebarTrigger";const Kn=r.forwardRef(({className:s,...t},a)=>{const{toggleSidebar:l}=xt();return e.jsx("button",{ref:a,"data-sidebar":"rail","aria-label":"Toggle Sidebar",tabIndex:-1,onClick:l,title:"Toggle Sidebar",className:E("absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] group-data-[side=left]:-right-4 group-data-[side=right]:left-0 hover:after:bg-sidebar-border sm:flex","[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize","[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize","group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar","[[data-side=left][data-collapsible=offcanvas]_&]:-right-2","[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",s),...t})});Kn.displayName="SidebarRail";const Ir=r.forwardRef(({className:s,...t},a)=>e.jsx("main",{ref:a,className:E("relative flex min-h-svh flex-1 flex-col bg-background","peer-data-[variant=inset]:min-h-[calc(100svh-theme(spacing.4))] md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow",s),...t}));Ir.displayName="SidebarInset";const Yn=r.forwardRef(({className:s,...t},a)=>e.jsx(Je,{ref:a,"data-sidebar":"input",className:E("h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring",s),...t}));Yn.displayName="SidebarInput";const Xn=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"header",className:E("flex flex-col gap-2 p-2",s),...t}));Xn.displayName="SidebarHeader";const Wn=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"footer",className:E("flex flex-col gap-2 p-2",s),...t}));Wn.displayName="SidebarFooter";const Jn=r.forwardRef(({className:s,...t},a)=>e.jsx(xs,{ref:a,"data-sidebar":"separator",className:E("mx-2 w-auto bg-sidebar-border",s),...t}));Jn.displayName="SidebarSeparator";const kr=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"content",className:E("flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",s),...t}));kr.displayName="SidebarContent";const Pr=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"group",className:E("relative flex w-full min-w-0 flex-col p-2",s),...t}));Pr.displayName="SidebarGroup";const Mr=r.forwardRef(({className:s,asChild:t=!1,...a},l)=>{const o=t?ws:"div";return e.jsx(o,{ref:l,"data-sidebar":"group-label",className:E("flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opa] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",s),...a})});Mr.displayName="SidebarGroupLabel";const Qn=r.forwardRef(({className:s,asChild:t=!1,...a},l)=>{const o=t?ws:"button";return e.jsx(o,{ref:l,"data-sidebar":"group-action",className:E("absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","group-data-[collapsible=icon]:hidden",s),...a})});Qn.displayName="SidebarGroupAction";const Lr=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"group-content",className:E("w-full text-sm",s),...t}));Lr.displayName="SidebarGroupContent";const Or=r.forwardRef(({className:s,...t},a)=>e.jsx("ul",{ref:a,"data-sidebar":"menu",className:E("flex w-full min-w-0 flex-col gap-1",s),...t}));Or.displayName="SidebarMenu";const Fr=r.forwardRef(({className:s,...t},a)=>e.jsx("li",{ref:a,"data-sidebar":"menu-item",className:E("group/menu-item relative",s),...t}));Fr.displayName="SidebarMenuItem";const Zn=_s("peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",{variants:{variant:{default:"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",outline:"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]"},size:{default:"h-8 text-sm",sm:"h-7 text-xs",lg:"h-12 text-sm group-data-[collapsible=icon]:!p-0"}},defaultVariants:{variant:"default",size:"default"}}),qr=r.forwardRef(({asChild:s=!1,isActive:t=!1,variant:a="default",size:l="default",tooltip:o,className:p,...c},x)=>{const v=s?ws:"button",{isMobile:S,state:g}=xt(),y=e.jsx(v,{ref:x,"data-sidebar":"menu-button","data-size":l,"data-active":t,className:E(Zn({variant:a,size:l}),p),...c});return o?(typeof o=="string"&&(o={children:o}),e.jsxs(yr,{children:[e.jsx(br,{asChild:!0,children:y}),e.jsx(Ht,{side:"right",align:"center",hidden:g!=="collapsed"||S,...o})]})):y});qr.displayName="SidebarMenuButton";const el=r.forwardRef(({className:s,asChild:t=!1,showOnHover:a=!1,...l},o)=>{const p=t?ws:"button";return e.jsx(p,{ref:o,"data-sidebar":"menu-action",className:E("absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform peer-hover/menu-button:text-sidebar-accent-foreground hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0","after:absolute after:-inset-2 after:md:hidden","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",a&&"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0",s),...l})});el.displayName="SidebarMenuAction";const sl=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{ref:a,"data-sidebar":"menu-badge",className:E("pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground","peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground","peer-data-[size=sm]/menu-button:top-1","peer-data-[size=default]/menu-button:top-1.5","peer-data-[size=lg]/menu-button:top-2.5","group-data-[collapsible=icon]:hidden",s),...t}));sl.displayName="SidebarMenuBadge";const tl=r.forwardRef(({className:s,showIcon:t=!1,...a},l)=>{const o=r.useMemo(()=>`${Math.floor(Math.random()*40)+50}%`,[]);return e.jsxs("div",{ref:l,"data-sidebar":"menu-skeleton",className:E("flex h-8 items-center gap-2 rounded-md px-2",s),...a,children:[t&&e.jsx(Ce,{className:"size-4 rounded-md","data-sidebar":"menu-skeleton-icon"}),e.jsx(Ce,{className:"h-4 max-w-[--skeleton-width] flex-1","data-sidebar":"menu-skeleton-text",style:{"--skeleton-width":o}})]})});tl.displayName="SidebarMenuSkeleton";const al=r.forwardRef(({className:s,...t},a)=>e.jsx("ul",{ref:a,"data-sidebar":"menu-sub",className:E("mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5","group-data-[collapsible=icon]:hidden",s),...t}));al.displayName="SidebarMenuSub";const rl=r.forwardRef(({...s},t)=>e.jsx("li",{ref:t,...s}));rl.displayName="SidebarMenuSubItem";const il=r.forwardRef(({asChild:s=!1,size:t="md",isActive:a,className:l,...o},p)=>{const c=s?ws:"a";return e.jsx(c,{ref:p,"data-sidebar":"menu-sub-button","data-size":t,"data-active":a,className:E("flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring aria-disabled:pointer-events-none aria-disabled:opacity-50 hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground","data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",t==="sm"&&"text-xs",t==="md"&&"text-sm","group-data-[collapsible=icon]:hidden",l),...o})});il.displayName="SidebarMenuSubButton";const nl=()=>{const{user:s,profile:t,roles:a,hasRole:l}=Ke(),o={canAccessAdminDashboard:l("admin")||l("super_admin"),canManageUsers:l("super_admin"),canModerateProperties:l("admin")||l("super_admin"),canCertifyLeases:l("admin")||l("super_admin"),canResolveDisputes:l("admin")||l("super_admin"),canViewAuditLogs:l("admin")||l("super_admin"),canPromoteToSuperAdmin:l("super_admin"),canAccessTiersDashboard:l("tiers_de_confiance"),canValidateDossiers:l("tiers_de_confiance"),canManageProperties:(t==null?void 0:t.user_type)==="proprietaire"||(t==null?void 0:t.user_type)==="agence",canCreateProperty:(t==null?void 0:t.user_type)==="proprietaire"||(t==null?void 0:t.user_type)==="agence",canViewApplications:(t==null?void 0:t.user_type)==="proprietaire"||(t==null?void 0:t.user_type)==="agence",canCreateLease:(t==null?void 0:t.user_type)==="proprietaire"||(t==null?void 0:t.user_type)==="agence",canApplyToProperties:(t==null?void 0:t.user_type)==="locataire",canSaveFavorites:(t==null?void 0:t.user_type)==="locataire",canViewRecommendations:(t==null?void 0:t.user_type)==="locataire",isAuthenticated:!!s,canSendMessages:!!s,canLeaveReviews:!!s,canUpdateProfile:!!s};return{...o,canEditProperty:x=>!s||!t?!1:o.canManageProperties&&s.id===x,canAccessResource:x=>s?s.id===x||o.canAccessAdminDashboard:!1,user:s,profile:t,roles:a}},Lt="/assets/mon-toit-logo-PF5VvUp4.png",ht=ui,pt=xi,pa=hi,ll=r.forwardRef(({className:s,inset:t,children:a,...l},o)=>e.jsxs(Da,{ref:o,className:E("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",t&&"pl-8",s),...l,children:[a,e.jsx(mt,{className:"ml-auto h-4 w-4"})]}));ll.displayName=Da.displayName;const cl=r.forwardRef(({className:s,...t},a)=>e.jsx(Ta,{ref:a,className:E("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...t}));cl.displayName=Ta.displayName;const Gs=r.forwardRef(({className:s,sideOffset:t=4,...a},l)=>e.jsx(mi,{children:e.jsx(Ia,{ref:l,sideOffset:t,className:E("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...a})}));Gs.displayName=Ia.displayName;const Ae=r.forwardRef(({className:s,inset:t,...a},l)=>e.jsx(ka,{ref:l,className:E("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t&&"pl-8",s),...a}));Ae.displayName=ka.displayName;const ol=r.forwardRef(({className:s,children:t,checked:a,...l},o)=>e.jsxs(Pa,{ref:o,className:E("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s),checked:a,...l,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ma,{children:e.jsx(Ft,{className:"h-4 w-4"})})}),t]}));ol.displayName=Pa.displayName;const dl=r.forwardRef(({className:s,children:t,...a},l)=>e.jsxs(La,{ref:l,className:E("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ma,{children:e.jsx(Oa,{className:"h-2 w-2 fill-current"})})}),t]}));dl.displayName=La.displayName;const Yt=r.forwardRef(({className:s,inset:t,...a},l)=>e.jsx(Fa,{ref:l,className:E("px-2 py-1.5 text-sm font-semibold",t&&"pl-8",s),...a}));Yt.displayName=Fa.displayName;const Ns=r.forwardRef(({className:s,...t},a)=>e.jsx(qa,{ref:a,className:E("-mx-1 my-1 h-px bg-muted",s),...t}));Ns.displayName=qa.displayName;const ml=()=>{const{user:s}=Ke(),t=pi(),{data:a=[],isLoading:l}=fi({queryKey:["agency-mandates",s==null?void 0:s.id],queryFn:async()=>{if(!s)return[];const{data:i,error:d}=await b.from("agency_mandates").select("*").or(`agency_id.eq.${s.id},owner_id.eq.${s.id}`).order("created_at",{ascending:!1});if(d)throw d;return i},enabled:!!s}),o=js({mutationFn:async i=>{const{data:d,error:f}=await b.from("agency_mandates").insert([{...i,owner_id:s==null?void 0:s.id,status:"pending"}]).select().single();if(f)throw f;return d},onSuccess:()=>{t.invalidateQueries({queryKey:["agency-mandates"]}),K({title:"Invitation envoyée",description:"L'agence a été invitée à gérer vos biens"})},onError:i=>{K({title:"Erreur",description:`Impossible d'envoyer l'invitation: ${i.message}`,variant:"destructive"})}}),p=js({mutationFn:async i=>{const{data:d,error:f}=await b.from("agency_mandates").update({status:"active",accepted_at:new Date().toISOString()}).eq("id",i).eq("agency_id",s==null?void 0:s.id).eq("status","pending").select().single();if(f)throw f;return d},onSuccess:()=>{t.invalidateQueries({queryKey:["agency-mandates"]}),t.invalidateQueries({queryKey:["properties"]}),K({title:"Mandat accepté",description:"Vous pouvez maintenant gérer ces biens"})},onError:i=>{K({title:"Erreur",description:`Impossible d'accepter le mandat: ${i.message}`,variant:"destructive"})}}),c=js({mutationFn:async({mandateId:i,reason:d})=>{const{data:f,error:M}=await b.from("agency_mandates").update({status:"terminated",terminated_at:new Date().toISOString(),terminated_by:s==null?void 0:s.id,termination_reason:d||"Refusé par l'agence"}).eq("id",i).eq("agency_id",s==null?void 0:s.id).select().single();if(M)throw M;return f},onSuccess:()=>{t.invalidateQueries({queryKey:["agency-mandates"]}),K({title:"Mandat refusé",description:"Le mandat a été refusé"})},onError:i=>{K({title:"Erreur",description:`Impossible de refuser le mandat: ${i.message}`,variant:"destructive"})}}),x=js({mutationFn:async({mandateId:i,reason:d})=>{const{data:f,error:M}=await b.from("agency_mandates").update({status:"terminated",terminated_at:new Date().toISOString(),terminated_by:s==null?void 0:s.id,termination_reason:d}).eq("id",i).select().single();if(M)throw M;return f},onSuccess:()=>{t.invalidateQueries({queryKey:["agency-mandates"]}),t.invalidateQueries({queryKey:["properties"]}),K({title:"Mandat résilié",description:"Le mandat a été résilié avec succès"})},onError:i=>{K({title:"Erreur",description:`Impossible de résilier le mandat: ${i.message}`,variant:"destructive"})}}),v=js({mutationFn:async({mandateId:i,reason:d})=>{const{data:f,error:M}=await b.from("agency_mandates").update({status:"suspended",notes:d}).eq("id",i).eq("agency_id",s==null?void 0:s.id).eq("status","active").select().single();if(M)throw M;return f},onSuccess:()=>{t.invalidateQueries({queryKey:["agency-mandates"]}),K({title:"Mandat suspendu",description:"Le mandat a été suspendu temporairement"})},onError:i=>{K({title:"Erreur",description:`Impossible de suspendre le mandat: ${i.message}`,variant:"destructive"})}}),S=js({mutationFn:async({mandateId:i,permissions:d})=>{const{data:f,error:M}=await b.from("agency_mandates").update({permissions:d}).eq("id",i).eq("owner_id",s==null?void 0:s.id).select().single();if(M)throw M;return f},onSuccess:()=>{t.invalidateQueries({queryKey:["agency-mandates"]}),K({title:"Permissions mises à jour",description:"Les permissions du mandat ont été modifiées"})},onError:i=>{K({title:"Erreur",description:`Impossible de modifier les permissions: ${i.message}`,variant:"destructive"})}}),g=a.filter(i=>i.status==="active"),y=a.filter(i=>i.status==="pending"),n=a.filter(i=>i.agency_id===(s==null?void 0:s.id)),h=a.filter(i=>i.owner_id===(s==null?void 0:s.id));return{mandates:a,activeMandates:g,pendingMandates:y,asAgency:n,asOwner:h,isLoading:l,createMandate:o.mutate,acceptMandate:p.mutate,refuseMandate:c.mutate,terminateMandate:x.mutate,suspendMandate:v.mutate,updateMandatePermissions:S.mutate}},He=ji,Fe=r.forwardRef(({className:s,...t},a)=>e.jsx(Ua,{ref:a,className:E("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",s),...t}));Fe.displayName=Ua.displayName;const te=r.forwardRef(({className:s,...t},a)=>e.jsx($a,{ref:a,className:E("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",s),...t}));te.displayName=$a.displayName;const re=r.forwardRef(({className:s,...t},a)=>e.jsx(za,{ref:a,className:E("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",s),...t}));re.displayName=za.displayName;const ul=(s,t)=>{if(s==="mandate_invited")return Re;if(s==="mandate_accepted")return he;if(s==="mandate_refused")return de;if(s==="mandate_terminated")return Ne;if(s.startsWith("mandate_"))return Ha;switch(t){case"messages":return Ga;case"applications":return Re;case"properties":return ns;case"payments":return qt;default:return rs}},xl=()=>{const{notifications:s,unreadCount:t,markAsRead:a,markAllAsRead:l,requestPermission:o}=Dn(),{acceptMandate:p,refuseMandate:c}=ml(),x=Va();r.useEffect(()=>{o()},[]);const v=n=>{a(n.id);const h=n.action_url||n.link;h&&x(h)},S=r.useMemo(()=>{const n={all:s,messages:[],applications:[],properties:[],payments:[],system:[]};return s.forEach(h=>{const i=h.category||"system";n[i]&&n[i].push(h)}),n},[s]),g=r.useMemo(()=>{const n={};return Object.keys(S).forEach(h=>{n[h]=S[h].filter(i=>!i.is_read).length}),n},[S]),y=n=>{var d;const h=ul(n.type,n.category||"system"),i=(d=n.metadata)==null?void 0:d.mandate_id;return e.jsx(Ae,{className:`cursor-pointer p-4 ${n.is_read?"":"bg-muted/50"}`,onClick:()=>v(n),onSelect:f=>{f.target.closest("button[data-action]")&&f.preventDefault()},children:e.jsxs("div",{className:"flex gap-3 w-full",children:[e.jsx("div",{className:`p-2 rounded-full ${n.is_read?"bg-muted":n.type==="mandate_accepted"?"bg-green-500/10":n.type==="mandate_refused"||n.type==="mandate_terminated"?"bg-red-500/10":"bg-primary/10"}`,children:e.jsx(h,{className:`h-4 w-4 ${n.is_read?"text-muted-foreground":n.type==="mandate_accepted"?"text-green-500":n.type==="mandate_refused"||n.type==="mandate_terminated"?"text-red-500":"text-primary"}`})}),e.jsxs("div",{className:"flex flex-col gap-1 flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-sm line-clamp-1",children:n.title}),!n.is_read&&e.jsx("div",{className:"h-2 w-2 rounded-full bg-primary flex-shrink-0 mt-1"})]}),n.message&&e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:n.message}),e.jsx("p",{className:"text-xs text-muted-foreground",children:cn(new Date(n.created_at),{addSuffix:!0,locale:be})}),n.type==="mandate_invited"&&i&&e.jsxs("div",{className:"flex gap-2 mt-2",onClick:f=>f.stopPropagation(),children:[e.jsxs(P,{"data-action":"accept",size:"sm",variant:"default",onClick:f=>{f.stopPropagation(),p(i),a(n.id)},className:"h-7 text-xs",children:[e.jsx(he,{className:"h-3 w-3 mr-1"}),"Accepter"]}),e.jsxs(P,{"data-action":"refuse",size:"sm",variant:"outline",onClick:f=>{f.stopPropagation(),c({mandateId:i,reason:"Refusé depuis les notifications"}),a(n.id)},className:"h-7 text-xs",children:[e.jsx(de,{className:"h-3 w-3 mr-1"}),"Refuser"]})]})]})]})},n.id)};return e.jsxs(ht,{children:[e.jsx(pt,{asChild:!0,children:e.jsxs(P,{variant:"ghost",size:"icon",className:"relative",children:[e.jsx(rs,{className:"h-5 w-5"}),t>0&&e.jsx($,{variant:"destructive",className:"absolute -top-1 -right-1 h-5 w-5 flex items-center justify-center p-0 text-xs",children:t>9?"9+":t})]})}),e.jsxs(Gs,{align:"end",className:"w-96",children:[e.jsxs(Yt,{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Notifications"}),e.jsxs("div",{className:"flex gap-2",children:[t>0&&e.jsx(P,{variant:"ghost",size:"sm",className:"h-auto p-0 text-xs",onClick:l,children:"Tout marquer comme lu"}),e.jsx(P,{variant:"ghost",size:"sm",className:"h-auto p-0",onClick:()=>x("/profile"),children:e.jsx(Ba,{className:"h-4 w-4"})})]})]}),e.jsx(Ns,{}),e.jsxs(He,{defaultValue:"all",className:"w-full",children:[e.jsxs(Fe,{className:"grid w-full grid-cols-3 h-auto p-1",children:[e.jsxs(te,{value:"all",className:"text-xs",children:["Tout ",g.all>0&&`(${g.all})`]}),e.jsxs(te,{value:"messages",className:"text-xs",children:["Messages ",g.messages>0&&`(${g.messages})`]}),e.jsxs(te,{value:"system",className:"text-xs",children:["Système ",g.system>0&&`(${g.system})`]})]}),e.jsxs(_r,{className:"h-[400px]",children:[e.jsx(re,{value:"all",className:"m-0",children:S.all.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(rs,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucune notification"})]}):S.all.map(y)}),e.jsx(re,{value:"messages",className:"m-0",children:S.messages.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(Ga,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucun message"})]}):S.messages.map(y)}),e.jsx(re,{value:"system",className:"m-0",children:S.system.length===0?e.jsxs("div",{className:"p-4 text-center text-muted-foreground",children:[e.jsx(rs,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucune notification système"})]}):S.system.map(y)})]})]})]})]})},hl=()=>{const[s,t]=r.useState(0),a=async()=>{const{count:l,error:o}=await b.from("leases").select("*",{count:"exact",head:!0}).eq("certification_status","pending");!o&&l!==null&&t(l)};return r.useEffect(()=>{a();const l=b.channel("certification-notifications").on("postgres_changes",{event:"*",schema:"public",table:"leases",filter:"certification_status=eq.pending"},()=>{a()}).subscribe();return()=>{b.removeChannel(l)}},[]),s===0?null:e.jsx($,{variant:"destructive",className:"ml-2 px-2 py-0.5 text-xs",children:s})},pl=()=>{const{user:s,profile:t,signOut:a}=Ke(),[l,o]=r.useState(!1),p=()=>{o(!1)};return e.jsxs(Cr,{open:l,onOpenChange:o,children:[e.jsx(Pn,{asChild:!0,children:e.jsx(P,{variant:"ghost",size:"icon",className:"md:hidden",children:e.jsx(gi,{className:"h-5 w-5"})})}),e.jsx(Kt,{side:"right",className:"w-[300px] overflow-y-auto bg-background",children:e.jsxs("div",{className:"flex flex-col gap-6 mt-8",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs(ie,{to:"/recherche",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-accent transition-colors",children:[e.jsx(Ka,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Rechercher un bien"})]}),e.jsxs(ie,{to:"/publier",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-accent transition-colors",children:[e.jsx(vi,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Publier une annonce"})]}),e.jsxs(ie,{to:"/certification",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-semibold bg-primary/5 border-l-2 border-primary hover:bg-primary/10 transition-colors",children:[e.jsx(et,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Certification ANSUT"})]}),e.jsxs(ie,{to:"/#comment-ca-marche",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-accent transition-colors",children:[e.jsx(Ni,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Comment ça marche"})]}),e.jsxs(ie,{to:"/tarifs",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-accent transition-colors",children:[e.jsx(qt,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Tarifs"})]})]}),s&&e.jsxs(e.Fragment,{children:[e.jsx(xs,{}),e.jsxs("div",{className:"px-3",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground mb-1",children:t==null?void 0:t.full_name}),e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:s.email}),((t==null?void 0:t.oneci_verified)||(t==null?void 0:t.cnam_verified))&&e.jsx($,{variant:"outline",className:"text-xs border-primary text-primary",children:"✓ Certifié ANSUT"})]}),e.jsx(xs,{}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs(ie,{to:"/dashboard",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-accent transition-colors",children:[e.jsx(Fs,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Tableau de bord"})]}),e.jsxs(ie,{to:"/profil",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-accent transition-colors",children:[e.jsx(Oe,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Mon profil"})]}),e.jsxs(ie,{to:"/verification",onClick:p,className:"flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm font-medium hover:bg-accent transition-colors",children:[e.jsx(et,{className:"h-5 w-5 text-primary"}),e.jsx("span",{children:"Vérification"})]})]}),e.jsx(xs,{}),e.jsxs(P,{variant:"outline",className:"w-full gap-2 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:()=>{a(),o(!1)},children:[e.jsx(Ya,{className:"h-4 w-4"}),"Déconnexion"]})]}),!s&&e.jsxs(e.Fragment,{children:[e.jsx(xs,{}),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx(P,{variant:"outline",className:"w-full border-primary text-primary hover:bg-primary/5",asChild:!0,children:e.jsx(ie,{to:"/auth?type=locataire",onClick:p,children:"Je suis locataire"})}),e.jsx(P,{className:"w-full",asChild:!0,children:e.jsx(ie,{to:"/auth?type=proprietaire",onClick:p,children:"Je suis propriétaire"})})]})]})]})})]})},fl=()=>{const{profile:s}=Ke();if(!(s!=null&&s.user_type))return null;const a={locataire:{icon:Oe,label:"Mode Locataire",className:"bg-blue-500/10 text-blue-600 border-blue-500/20 hover:bg-blue-500/20"},proprietaire:{icon:ns,label:"Mode Propriétaire",className:"bg-green-500/10 text-green-600 border-green-500/20 hover:bg-green-500/20"},agence:{icon:Ha,label:"Mode Agence",className:"bg-purple-500/10 text-purple-600 border-purple-500/20 hover:bg-purple-500/20"}}[s.user_type];if(!a)return null;const l=a.icon;return e.jsxs($,{variant:"outline",className:`gap-1.5 font-medium ${a.className}`,children:[e.jsx(l,{className:"h-3.5 w-3.5"}),e.jsx("span",{className:"hidden lg:inline",children:a.label})]})},Ur=()=>{var p;const{user:s,profile:t,signOut:a}=Ke(),{canAccessAdminDashboard:l}=nl(),o=Ar();return e.jsxs(e.Fragment,{children:[e.jsx("nav",{className:`fixed top-0 left-0 right-0 z-50 bg-background/98 backdrop-blur-md border-b border-border shadow-sm ${o&&s?"mb-16":""}`,children:e.jsx("div",{className:"container mx-auto px-4 sm:px-6",children:e.jsxs("div",{className:"flex items-center justify-between h-14",children:[e.jsxs(ie,{to:"/",className:"flex items-center gap-3 group",children:[e.jsxs("picture",{children:[e.jsx("source",{srcSet:Lt.replace(".png",".webp"),type:"image/webp"}),e.jsx("img",{src:Lt,alt:"Mon Toit - Plateforme Immobilière Certifiée ANSUT",className:"h-16 w-auto group-hover:scale-105 transition-smooth",loading:"eager",fetchPriority:"high",decoding:"async",width:"64",height:"64"})]}),e.jsxs("div",{className:"hidden sm:flex flex-col",children:[e.jsx("span",{className:"text-2xl font-bold text-primary leading-tight",children:"Mon Toit"}),e.jsxs("span",{className:"text-xs text-secondary leading-tight flex items-center gap-1 font-semibold",children:[e.jsx(et,{className:"h-3.5 w-3.5"}),"Certifié ANSUT"]})]})]}),e.jsxs("div",{className:"hidden md:flex items-center gap-6",children:[e.jsx(ie,{to:"/explorer",className:"text-sm font-medium text-foreground/80 hover:text-primary hover:underline decoration-2 underline-offset-4 transition-all duration-150",children:"Explorer"}),e.jsx(ie,{to:"/publier",className:"text-sm font-medium text-foreground/80 hover:text-primary hover:underline decoration-2 underline-offset-4 transition-all duration-150",children:"Publier"}),e.jsx(ie,{to:"/guide",className:"text-sm font-medium text-foreground/80 hover:text-primary hover:underline decoration-2 underline-offset-4 transition-all duration-150",children:"Aide"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[s?e.jsxs(e.Fragment,{children:[e.jsx(fl,{}),e.jsx(xl,{}),e.jsxs(ht,{children:[e.jsx(pt,{asChild:!0,children:e.jsx(P,{variant:"ghost",size:"icon",className:"rounded-full",children:e.jsx(Ge,{children:e.jsx(Qe,{className:"bg-primary text-primary-foreground",children:((p=t==null?void 0:t.full_name)==null?void 0:p.charAt(0).toUpperCase())||"U"})})})}),e.jsxs(Gs,{align:"end",className:"w-64 bg-background border border-border shadow-lg",children:[e.jsx(Yt,{className:"pb-2",children:e.jsxs("div",{className:"flex flex-col space-y-1",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:t==null?void 0:t.full_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.email}),((t==null?void 0:t.oneci_verified)||(t==null?void 0:t.cnam_verified))&&e.jsx($,{variant:"outline",className:"w-fit mt-1 text-xs border-primary text-primary",children:"✓ Certifié ANSUT"})]})}),e.jsx(Ns,{}),e.jsxs(pa,{children:[e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/dashboard",className:"cursor-pointer flex items-center",children:[e.jsx(Fs,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Tableau de bord"})]})}),(t==null?void 0:t.user_type)==="locataire"&&e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/dashboard/tenant",className:"cursor-pointer flex items-center",children:[e.jsx(Fs,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Dashboard Locataire"})]})}),(t==null?void 0:t.user_type)==="agence"&&e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/dashboard/agence",className:"cursor-pointer flex items-center",children:[e.jsx(Fs,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Dashboard Agence"})]})}),((t==null?void 0:t.user_type)==="proprietaire"||(t==null?void 0:t.user_type)==="agence")&&e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/my-mandates",className:"cursor-pointer flex items-center",children:[e.jsx(Re,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Mes Mandats"})]})}),e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/profil",className:"cursor-pointer flex items-center",children:[e.jsx(Oe,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Mon profil"})]})}),e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/verification",className:"cursor-pointer flex items-center",children:[e.jsx(et,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Vérification"})]})})]}),l&&e.jsxs(e.Fragment,{children:[e.jsx(Ns,{}),e.jsxs(pa,{children:[e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/admin",className:"cursor-pointer flex items-center",children:[e.jsx(pe,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Admin Dashboard"})]})}),e.jsx(Ae,{asChild:!0,children:e.jsxs(ie,{to:"/admin/certifications",className:"cursor-pointer flex items-center",children:[e.jsx(pe,{className:"mr-3 h-4 w-4 text-primary"}),e.jsx("span",{children:"Certifications ANSUT"}),e.jsx(hl,{})]})})]})]}),e.jsx(Ns,{}),e.jsxs(Ae,{onClick:a,className:"cursor-pointer text-destructive focus:text-destructive",children:[e.jsx(Ya,{className:"mr-3 h-4 w-4"}),e.jsx("span",{children:"Déconnexion"})]})]})]})]}):e.jsx(P,{size:"sm",variant:"default",className:"font-semibold",asChild:!0,children:e.jsxs(ie,{to:"/auth",children:[e.jsx(Oe,{className:"h-4 w-4 md:mr-2"}),e.jsx("span",{className:"hidden md:inline",children:"Connexion"})]})}),e.jsx(pl,{})]})]})})}),e.jsx("div",{className:"fixed top-14 left-0 right-0 h-1 bg-gradient-to-r from-primary via-secondary to-primary z-40"})]})},jl=()=>e.jsx("footer",{className:"py-8 bg-gray-900 text-white",children:e.jsx("div",{className:"container mx-auto px-4 max-w-7xl",children:e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-center gap-6 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("img",{src:Lt,alt:"Mon Toit",className:"h-6 w-auto brightness-0 invert"}),e.jsx("span",{className:"text-gray-300",children:"© 2025 Mon Toit"}),e.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-primary/20 border border-primary/30 rounded",children:[e.jsx(pe,{className:"h-3 w-3 text-primary"}),e.jsx("span",{className:"text-xs",children:"ANSUT"})]})]}),e.jsxs("nav",{className:"flex gap-6","aria-label":"Footer navigation",children:[e.jsx(ie,{to:"/mentions-legales",className:"text-gray-300 hover:text-white transition-colors",children:"Mentions légales"}),e.jsx(ie,{to:"/confidentialite",className:"text-gray-300 hover:text-white transition-colors",children:"Confidentialité"}),e.jsx(ie,{to:"/aide",className:"text-gray-300 hover:text-white transition-colors",children:"Aide"}),e.jsx(ie,{to:"/contact",className:"text-gray-300 hover:text-white transition-colors",children:"Contact"})]}),e.jsxs("div",{className:"flex gap-4","aria-label":"Réseaux sociaux",children:[e.jsx("a",{href:"https://facebook.com/montoit",target:"_blank",rel:"noopener noreferrer",className:"text-gray-300 hover:text-white transition-colors","aria-label":"Facebook",children:e.jsx(yi,{className:"h-5 w-5"})}),e.jsx("a",{href:"https://twitter.com/montoit",target:"_blank",rel:"noopener noreferrer",className:"text-gray-300 hover:text-white transition-colors","aria-label":"Twitter",children:e.jsx(bi,{className:"h-5 w-5"})}),e.jsx("a",{href:"https://linkedin.com/company/montoit",target:"_blank",rel:"noopener noreferrer",className:"text-gray-300 hover:text-white transition-colors","aria-label":"LinkedIn",children:e.jsx(wi,{className:"h-5 w-5"})})]})]})})}),we=Di,_e=Ti,ge=r.forwardRef(({className:s,children:t,...a},l)=>e.jsxs(Xa,{ref:l,className:E("flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1",s),...a,children:[t,e.jsx(_i,{asChild:!0,children:e.jsx(Ut,{className:"h-4 w-4 opacity-50"})})]}));ge.displayName=Xa.displayName;const $r=r.forwardRef(({className:s,...t},a)=>e.jsx(Wa,{ref:a,className:E("flex cursor-default items-center justify-center py-1",s),...t,children:e.jsx(Si,{className:"h-4 w-4"})}));$r.displayName=Wa.displayName;const zr=r.forwardRef(({className:s,...t},a)=>e.jsx(Ja,{ref:a,className:E("flex cursor-default items-center justify-center py-1",s),...t,children:e.jsx(Ut,{className:"h-4 w-4"})}));zr.displayName=Ja.displayName;const ve=r.forwardRef(({className:s,children:t,position:a="popper",...l},o)=>e.jsx(Ai,{children:e.jsxs(Qa,{ref:o,className:E("relative z-50 max-h-96 min-w-[8rem] overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",s),position:a,...l,children:[e.jsx($r,{}),e.jsx(Ci,{className:E("p-1",a==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:t}),e.jsx(zr,{})]})}));ve.displayName=Qa.displayName;const gl=r.forwardRef(({className:s,...t},a)=>e.jsx(Za,{ref:a,className:E("py-1.5 pl-8 pr-2 text-sm font-semibold",s),...t}));gl.displayName=Za.displayName;const B=r.forwardRef(({className:s,children:t,...a},l)=>e.jsxs(er,{ref:l,className:E("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Ei,{children:e.jsx(Ft,{className:"h-4 w-4"})})}),e.jsx(Ri,{children:t})]}));B.displayName=er.displayName;const vl=r.forwardRef(({className:s,...t},a)=>e.jsx(sr,{ref:a,className:E("-mx-1 my-1 h-px bg-muted",s),...t}));vl.displayName=sr.displayName;const ze=Ea,Nl=Ra,yl=Aa,Vr=r.forwardRef(({className:s,...t},a)=>e.jsx(lt,{ref:a,className:E("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t}));Vr.displayName=lt.displayName;const Le=r.forwardRef(({className:s,children:t,...a},l)=>e.jsxs(yl,{children:[e.jsx(Vr,{}),e.jsxs(ct,{ref:l,className:E("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...a,children:[t,e.jsxs(Ca,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-accent data-[state=open]:text-muted-foreground hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(Zs,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Le.displayName=ct.displayName;const Ve=({className:s,...t})=>e.jsx("div",{className:E("flex flex-col space-y-1.5 text-center sm:text-left",s),...t});Ve.displayName="DialogHeader";const is=({className:s,...t})=>e.jsx("div",{className:E("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...t});is.displayName="DialogFooter";const Be=r.forwardRef(({className:s,...t},a)=>e.jsx(ot,{ref:a,className:E("text-lg font-semibold leading-none tracking-tight",s),...t}));Be.displayName=ot.displayName;const We=r.forwardRef(({className:s,...t},a)=>e.jsx(dt,{ref:a,className:E("text-sm text-muted-foreground",s),...t}));We.displayName=dt.displayName;const Ms={disponible:"Disponible",loué:"Loué",loue:"Loué",en_attente:"En attente",retiré:"Retiré",retire:"Retiré",refuse:"Refusé"},fc={disponible:"bg-green-500",loué:"bg-blue-500",loue:"bg-blue-500",en_attente:"bg-yellow-500",retiré:"bg-gray-500",retire:"bg-gray-500",refuse:"bg-red-500"},jc={disponible:"success",loué:"info",loue:"info",en_attente:"warning",retiré:"neutral",retire:"neutral",refuse:"danger"},gc={disponible:he,loué:st,loue:st,en_attente:xe,retiré:de,retire:de,refuse:Ne},vc=["Appartement","Villa","Studio","Maison"],Rt={MAX_IMAGE_SIZE:5*1024*1024,MAX_VIDEO_SIZE:100*1024*1024,MAX_DOCUMENT_SIZE:10*1024*1024,MAX_PANORAMA_SIZE:8*1024*1024,MAX_FLOOR_PLAN_SIZE:5*1024*1024,MAX_IMAGES_PER_PROPERTY:10,MAX_PANORAMAS_PER_PROPERTY:5,MAX_FLOOR_PLANS_PER_PROPERTY:3},Ps={MIN_PASSWORD_LENGTH:8,MIN_TITLE_LENGTH:5,MAX_TITLE_LENGTH:100,MIN_DESCRIPTION_LENGTH:20,MAX_DESCRIPTION_LENGTH:2e3,MIN_NAME_LENGTH:2,MAX_NAME_LENGTH:100,MIN_ADDRESS_LENGTH:5,MAX_ADDRESS_LENGTH:200},Nc={MIN_RENT:1e4,MAX_RENT:1e7,MIN_SURFACE:10,MAX_SURFACE:1e3,MIN_BEDROOMS:0,MAX_BEDROOMS:20,MIN_BATHROOMS:0,MAX_BATHROOMS:10},Ls={AUTH_REQUIRED:"Vous devez être connecté pour effectuer cette action",AUTH_INVALID_CREDENTIALS:"Email ou mot de passe incorrect",AUTH_EMAIL_EXISTS:"Cette adresse email est déjà utilisée",AUTH_WEAK_PASSWORD:"Le mot de passe est trop faible",AUTH_SESSION_EXPIRED:"Votre session a expiré. Veuillez vous reconnecter.",FIELD_REQUIRED:"Ce champ est requis",EMAIL_INVALID:"Adresse email invalide",PHONE_INVALID:"Numéro de téléphone invalide",PASSWORD_TOO_SHORT:`Le mot de passe doit contenir au moins ${Ps.MIN_PASSWORD_LENGTH} caractères`,TITLE_TOO_SHORT:`Le titre doit contenir au moins ${Ps.MIN_TITLE_LENGTH} caractères`,TITLE_TOO_LONG:`Le titre ne peut pas dépasser ${Ps.MAX_TITLE_LENGTH} caractères`,DESCRIPTION_TOO_SHORT:`La description doit contenir au moins ${Ps.MIN_DESCRIPTION_LENGTH} caractères`,DESCRIPTION_TOO_LONG:`La description ne peut pas dépasser ${Ps.MAX_DESCRIPTION_LENGTH} caractères`,FILE_TOO_LARGE:"Le fichier est trop volumineux",FILE_TYPE_INVALID:"Type de fichier non autorisé",MAX_FILES_EXCEEDED:"Nombre maximum de fichiers dépassé",IMAGE_TOO_LARGE:`L'image ne doit pas dépasser ${Rt.MAX_IMAGE_SIZE/1024/1024}MB`,VIDEO_TOO_LARGE:`La vidéo ne doit pas dépasser ${Rt.MAX_VIDEO_SIZE/1024/1024}MB`,DOCUMENT_TOO_LARGE:`Le document ne doit pas dépasser ${Rt.MAX_DOCUMENT_SIZE/1024/1024}MB`,NETWORK_ERROR:"Erreur de connexion. Veuillez réessayer.",SERVER_ERROR:"Erreur serveur. Veuillez réessayer plus tard.",UNAUTHORIZED:"Vous n'avez pas les permissions nécessaires",FORBIDDEN:"Accès interdit",NOT_FOUND:"Ressource introuvable",PROPERTY_NOT_FOUND:"Propriété introuvable",APPLICATION_ALREADY_EXISTS:"Vous avez déjà postulé pour cette propriété",APPLICATION_NOT_FOUND:"Candidature introuvable",LEASE_NOT_FOUND:"Bail introuvable",PAYMENT_FAILED:"Le paiement a échoué",VERIFICATION_FAILED:"La vérification a échoué",GEOCODING_FAILED:"Impossible de localiser l'adresse",UPLOAD_FAILED:"Échec du téléchargement du fichier",FILE_REQUIRED:"Au moins une image est requise",INVALID_FILE_TYPE:"Type de fichier non autorisé",DELETE_FAILED:"Échec de la suppression",MEDIA_LOAD_FAILED:"Impossible de charger les médias",PROPERTY_LOAD_FAILED:"Impossible de charger la propriété",PROPERTY_CREATE_FAILED:"Échec de la création de la propriété",PROPERTY_UPDATE_FAILED:"Échec de la mise à jour",PROPERTY_DELETE_FAILED:"Échec de la suppression",PERMISSION_DENIED:"Vous n'avez pas la permission d'effectuer cette action",OWNER_ONLY:"Seul le propriétaire peut modifier ce bien",CONNECTION_LOST:"Connexion perdue. Veuillez vérifier votre connexion internet.",TIMEOUT:"La requête a expiré. Veuillez réessayer."},bl={LOGIN_SUCCESS:"Connexion réussie",LOGOUT_SUCCESS:"Déconnexion réussie",SIGNUP_SUCCESS:"Compte créé avec succès",PASSWORD_RESET_SENT:"Email de réinitialisation envoyé",PASSWORD_UPDATED:"Mot de passe mis à jour",PROFILE_UPDATED:"Profil mis à jour avec succès",AVATAR_UPDATED:"Photo de profil mise à jour",PROPERTY_CREATED:"Propriété créée avec succès",PROPERTY_UPDATED:"Propriété mise à jour avec succès",PROPERTY_DELETED:"Propriété supprimée avec succès",PROPERTY_FAVORITED:"Ajouté aux favoris",PROPERTY_UNFAVORITED:"Retiré des favoris",APPLICATION_SUBMITTED:"Candidature envoyée avec succès",APPLICATION_APPROVED:"Candidature approuvée",APPLICATION_REJECTED:"Candidature rejetée",APPLICATION_WITHDRAWN:"Candidature retirée",PAYMENT_SUCCESS:"Paiement effectué avec succès",PAYMENT_INITIATED:"Paiement initié. Veuillez suivre les instructions.",REVIEW_SUBMITTED:"Avis publié avec succès",REVIEW_UPDATED:"Avis mis à jour avec succès",REVIEW_DELETED:"Avis supprimé avec succès",VERIFICATION_SUCCESS:"Vérification réussie",ONECI_VERIFIED:"Identité ONECI vérifiée",CNAM_VERIFIED:"CNAM vérifié",FACE_VERIFIED:"Visage vérifié",LEASE_CREATED:"Bail créé avec succès",LEASE_SIGNED:"Bail signé avec succès",LEASE_CERTIFIED:"Bail certifié par ANSUT",MESSAGE_SENT:"Message envoyé",DOCUMENT_UPLOADED:"Document téléchargé avec succès",DOCUMENT_DELETED:"Document supprimé",MEDIA_UPLOADED:"Médias téléchargés avec succès",MEDIA_DELETED:"Médias supprimés avec succès",PROPERTY_SAVED:"Propriété enregistrée"},yc=["Abidjan","Yamoussoukro","Bouaké","Daloa","San-Pedro","Korhogo","Man","Gagnoa","Divo","Abengourou"],bc=s=>`${s.toLocaleString("fr-FR")} FCFA`,wc=s=>["image/jpeg","image/jpg","image/png","image/webp"].includes(s.type),_c=s=>["video/mp4","video/webm","video/quicktime"].includes(s.type);function Sc(s){return Ms[s]||s}const wl=_s("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),W=r.forwardRef(({className:s,...t},a)=>e.jsx(tr,{ref:a,className:E(wl(),s),...t}));W.displayName=tr.displayName;const gs=r.forwardRef(({className:s,...t},a)=>e.jsx(ar,{ref:a,className:E("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx(Ii,{className:E("flex items-center justify-center text-current"),children:e.jsx(Ft,{className:"h-4 w-4"})})}));gs.displayName=ar.displayName;const ps=r.forwardRef(({className:s,...t},a)=>e.jsx("textarea",{className:E("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),ref:a,...t}));ps.displayName="Textarea";const Br=r.forwardRef(({className:s,...t},a)=>e.jsx(rr,{className:E("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",s),...t,ref:a,children:e.jsx(ki,{className:E("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));Br.displayName=rr.displayName;const Xt=r.forwardRef(({className:s,value:t,...a},l)=>e.jsx(ir,{ref:l,className:E("relative h-4 w-full overflow-hidden rounded-full bg-secondary",s),...a,children:e.jsx(Pi,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(t||0)}%)`}})}));Xt.displayName=ir.displayName;const Gr=Li,_l=Oi,Sl=Mi,Hr=r.forwardRef(({className:s,...t},a)=>e.jsx(nr,{className:E("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",s),...t,ref:a}));Hr.displayName=nr.displayName;const Wt=r.forwardRef(({className:s,...t},a)=>e.jsxs(Sl,{children:[e.jsx(Hr,{}),e.jsx(lr,{ref:a,className:E("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",s),...t})]}));Wt.displayName=lr.displayName;const Jt=({className:s,...t})=>e.jsx("div",{className:E("flex flex-col space-y-2 text-center sm:text-left",s),...t});Jt.displayName="AlertDialogHeader";const Qt=({className:s,...t})=>e.jsx("div",{className:E("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",s),...t});Qt.displayName="AlertDialogFooter";const Zt=r.forwardRef(({className:s,...t},a)=>e.jsx(cr,{ref:a,className:E("text-lg font-semibold",s),...t}));Zt.displayName=cr.displayName;const ea=r.forwardRef(({className:s,...t},a)=>e.jsx(or,{ref:a,className:E("text-sm text-muted-foreground",s),...t}));ea.displayName=or.displayName;const sa=r.forwardRef(({className:s,...t},a)=>e.jsx(dr,{ref:a,className:E(ys(),s),...t}));sa.displayName=dr.displayName;const ta=r.forwardRef(({className:s,...t},a)=>e.jsx(mr,{ref:a,className:E(ys({variant:"outline"}),"mt-2 sm:mt-0",s),...t}));ta.displayName=mr.displayName;class aa extends Error{constructor(t,a){super(Ls[t]),this.code=t,this.context=a,this.name="AppError",Object.setPrototypeOf(this,aa.prototype)}}const Al=s=>{var t,a;return s&&(s.code||((t=s.message)==null?void 0:t.includes("PostgrestError"))||((a=s.message)==null?void 0:a.includes("FunctionsHttpError")))},fs=(s,t)=>{G.logError(s,{fallback:t,timestamp:new Date().toISOString()});let a=t||Ls.SERVER_ERROR;if(s instanceof aa)a=s.message;else if(s instanceof Error){if(s.message.includes("auth"))a=Ls.AUTH_REQUIRED;else if(s.message.includes("network")||s.message.includes("fetch"))a=Ls.NETWORK_ERROR;else if(Al(s)){const l=s;l.code==="23505"?a="Cette ressource existe déjà":l.code==="23503"?a="Ressource liée introuvable":l.code==="PGRST116"&&(a=Ls.NOT_FOUND)}}K({title:"Erreur",description:a,variant:"destructive"})},Ac=(s,t)=>{const a=bl[s];K({title:"Succès",description:a}),G.info(`Success: ${s}`,{message:a})},Kr=r.forwardRef(({children:s,offsetTop:t="top-16",blur:a=!0,className:l,...o},p)=>e.jsx("div",{ref:p,className:E("sticky z-20 border-b bg-background transition-all duration-200",t,a&&"backdrop-blur-sm bg-background/95",l),...o,children:e.jsx("div",{className:"container mx-auto px-4 py-3",children:s})}));Kr.displayName="StickyHeader";const Cl=({activeTab:s,onTabChange:t,badges:a})=>{const l=[{label:"Principal",items:[{id:"overview",label:"Vue d'ensemble",icon:Fs}]},{label:"Sécurité",items:[{id:"certifications",label:"Certifications",icon:pe,badge:a.certifications},{id:"verifications",label:"Vérifications",icon:he},{id:"mfa",label:"Sécurité 2FA",icon:st},{id:"audit",label:"Audit",icon:Re},{id:"security",label:"Accès sensibles",icon:st}]},{label:"Gestion",items:[{id:"properties",label:"Biens",icon:ns,badge:a.properties},{id:"users",label:"Utilisateurs",icon:hs},{id:"leases",label:"Baux",icon:Re}]},{label:"Outils",items:[{id:"processing",label:"Traitement",icon:xe,badge:a.overdueApplications},{id:"analytics",label:"Analytics",icon:ur},{id:"alerts",label:"Alertes Propriétés",icon:rs},{id:"disputes",label:"Litiges",icon:Ne,badge:a.disputes},{id:"moderation",label:"Modération",icon:Fi},{id:"reporting",label:"Rapports",icon:qi},{id:"electronic-signatures",label:"Signatures Élec.",icon:Ui},{id:"illustrations",label:"Illustrations",icon:Pt}]}];return e.jsx(Tr,{className:"border-r",children:e.jsx(kr,{children:l.map(o=>e.jsxs(Pr,{children:[e.jsx(Mr,{children:o.label}),e.jsx(Lr,{children:e.jsx(Or,{children:o.items.map(p=>e.jsx(Fr,{children:e.jsxs(qr,{onClick:()=>t(p.id),isActive:s===p.id,className:"w-full",children:[e.jsx(p.icon,{className:"h-4 w-4"}),e.jsx("span",{children:p.label}),p.badge!==void 0&&p.badge>0&&e.jsx($,{variant:"destructive",className:"ml-auto",children:p.badge})]})},p.id))})})]},o.label))})})},El=()=>{const[s,t]=r.useState({totalProperties:0,pendingProperties:0,totalUsers:0,totalLeases:0,certifiedLeases:0}),[a,l]=r.useState({failedLogins:0,massActions:0,lastSuspiciousAction:null}),[o,p]=r.useState(!0);r.useEffect(()=>{c()},[]);const c=async()=>{try{const[x,v,S,g]=await Promise.all([b.from("properties").select("id",{count:"exact",head:!0}),b.from("profiles").select("id",{count:"exact",head:!0}),b.from("leases").select("id",{count:"exact",head:!0}),b.from("leases").select("id",{count:"exact",head:!0}).not("ansut_certified_at","is",null)]),y=await b.from("properties").select("id",{count:"exact",head:!0}).eq("status","en_attente");t({totalProperties:x.count||0,pendingProperties:y.count||0,totalUsers:v.count||0,totalLeases:S.count||0,certifiedLeases:g.count||0});const n=new Date(Date.now()-24*60*60*1e3).toISOString(),{count:h}=await b.from("login_attempts").select("*",{count:"exact",head:!0}).eq("success",!1).gte("created_at",n),{data:i}=await b.rpc("detect_mass_actions"),{data:d}=await b.from("admin_audit_logs").select("action_type, created_at").in("action_type",["role_assigned","role_revoked","dispute_resolved"]).gte("created_at",n).order("created_at",{ascending:!1}).limit(1);l({failedLogins:h||0,massActions:(i==null?void 0:i.length)||0,lastSuspiciousAction:d!=null&&d[0]?`${d[0].action_type} (${new Date(d[0].created_at).toLocaleTimeString("fr-FR")})`:null})}catch(x){fs(x,"Impossible de charger les statistiques")}finally{p(!1)}};return o?e.jsx("div",{className:"animate-pulse space-y-4",children:e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[...Array(4)].map((x,v)=>e.jsxs(_,{children:[e.jsx(D,{className:"h-20 bg-muted/50"}),e.jsx(C,{className:"h-16 bg-muted/30"})]},v))})}):e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Biens immobiliers"}),e.jsx(ns,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalProperties}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.pendingProperties," en attente de validation"]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Utilisateurs"}),e.jsx(hs,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalUsers}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Inscrits sur la plateforme"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Baux"}),e.jsx(Re,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalLeases}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Total des baux"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Baux certifiés"}),e.jsx(he,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.certifiedLeases}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.totalLeases>0?Math.round(s.certifiedLeases/s.totalLeases*100):0,"% du total"]})]})]}),e.jsxs(_,{className:a.failedLogins>=3||a.massActions>0?"border-destructive":"",children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Sécurité (24h)"}),a.failedLogins>=3||a.massActions>0?e.jsx(Ne,{className:"h-4 w-4 text-destructive"}):e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Échecs connexion"}),e.jsx("span",{className:`text-sm font-medium ${a.failedLogins>=3?"text-destructive":""}`,children:a.failedLogins})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Actions massives"}),e.jsx("span",{className:`text-sm font-medium ${a.massActions>0?"text-destructive":""}`,children:a.massActions})]}),a.lastSuspiciousAction&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:["Dernière: ",a.lastSuspiciousAction]})]})})]})]})},Ss=r.forwardRef(({className:s,...t},a)=>e.jsx("div",{className:"relative w-full overflow-auto",children:e.jsx("table",{ref:a,className:E("w-full caption-bottom text-sm",s),...t})}));Ss.displayName="Table";const As=r.forwardRef(({className:s,...t},a)=>e.jsx("thead",{ref:a,className:E("[&_tr]:border-b",s),...t}));As.displayName="TableHeader";const Cs=r.forwardRef(({className:s,...t},a)=>e.jsx("tbody",{ref:a,className:E("[&_tr:last-child]:border-0",s),...t}));Cs.displayName="TableBody";const Rl=r.forwardRef(({className:s,...t},a)=>e.jsx("tfoot",{ref:a,className:E("border-t bg-muted/50 font-medium [&>tr]:last:border-b-0",s),...t}));Rl.displayName="TableFooter";const Se=r.forwardRef(({className:s,...t},a)=>e.jsx("tr",{ref:a,className:E("border-b transition-colors data-[state=selected]:bg-muted hover:bg-muted/50",s),...t}));Se.displayName="TableRow";const ae=r.forwardRef(({className:s,...t},a)=>e.jsx("th",{ref:a,className:E("h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0",s),...t}));ae.displayName="TableHead";const se=r.forwardRef(({className:s,...t},a)=>e.jsx("td",{ref:a,className:E("p-4 align-middle [&:has([role=checkbox])]:pr-0",s),...t}));se.displayName="TableCell";const Dl=r.forwardRef(({className:s,...t},a)=>e.jsx("caption",{ref:a,className:E("mt-4 text-sm text-muted-foreground",s),...t}));Dl.displayName="TableCaption";const Yr=r.forwardRef(({className:s,...t},a)=>e.jsx(xr,{className:E("grid gap-2",s),...t,ref:a}));Yr.displayName=xr.displayName;const Ot=r.forwardRef(({className:s,...t},a)=>e.jsx(hr,{ref:a,className:E("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",s),...t,children:e.jsx($i,{className:"flex items-center justify-center",children:e.jsx(Oa,{className:"h-2.5 w-2.5 fill-current text-current"})})}));Ot.displayName=hr.displayName;const Tl=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(!0),[o,p]=r.useState([]),[c,x]=r.useState(!1),[v,S]=r.useState(!1),[g,y]=r.useState(!1),[n,h]=r.useState("disponible"),[i,d]=r.useState("percentage"),[f,M]=r.useState(""),[R,N]=r.useState(!1);r.useEffect(()=>{j()},[]);const j=async()=>{try{const{data:m,error:u}=await b.from("properties").select(`
          id,
          title,
          city,
          monthly_rent,
          status,
          created_at,
          owner_id
        `).order("created_at",{ascending:!1});if(u)throw u;if(m&&m.length>0){const F=[...new Set(m.map(z=>z.owner_id))],{data:V}=await b.from("profiles").select("id, full_name").in("id",F),H=new Map((V==null?void 0:V.map(z=>[z.id,z]))||[]),w=m.map(z=>({...z,profiles:H.get(z.owner_id)||{full_name:"Inconnu"}}));t(w)}else t([])}catch(m){G.error("Failed to fetch properties for admin",{error:m}),K({title:"Erreur",description:"Impossible de charger les biens",variant:"destructive"})}finally{l(!1)}},A=async(m,u)=>{try{const{error:F}=await b.from("properties").update({status:u}).eq("id",m);if(F)throw F;K({title:"Succès",description:`Bien ${u==="disponible"?"approuvé":"rejeté"}`}),j()}catch(F){G.error("Failed to update property status",{error:F,propertyId:m,newStatus:u}),K({title:"Erreur",description:"Impossible de mettre à jour le bien",variant:"destructive"})}},O=()=>{o.length===s.length?p([]):p(s.map(m=>m.id))},q=m=>{p(u=>u.includes(m)?u.filter(F=>F!==m):[...u,m])},L=()=>{p([]),N(!1)},ce=async()=>{if(R)try{const{error:m}=await b.from("properties").update({status:n}).in("id",o);if(m)throw m;const{data:{user:u}}=await b.auth.getUser();u&&await b.from("admin_audit_logs").insert({admin_id:u.id,action_type:"bulk_property_update",target_type:"properties",target_id:o[0],notes:`Statut modifié pour ${o.length} propriétés`,new_values:{status:n,count:o.length}}),K({title:"Succès",description:`${o.length} propriété(s) mise(s) à jour`}),x(!1),L(),j()}catch(m){G.error("Bulk status update failed",{error:m}),K({title:"Erreur",description:"Échec de la modification groupée",variant:"destructive"})}},oe=async()=>{if(!(!R||!f))try{const u=s.filter(V=>o.includes(V.id)).map(V=>{const H=V.monthly_rent,w=i==="percentage"?H*(1+parseFloat(f)/100):H+parseFloat(f);return{id:V.id,monthly_rent:Math.round(w)}});for(const V of u){const{error:H}=await b.from("properties").update({monthly_rent:V.monthly_rent}).eq("id",V.id);if(H)throw H}const{data:{user:F}}=await b.auth.getUser();F&&await b.from("admin_audit_logs").insert({admin_id:F.id,action_type:"bulk_property_update",target_type:"properties",target_id:o[0],notes:`Loyer modifié pour ${o.length} propriétés (${i}: ${f})`,new_values:{type:i,value:f,count:o.length}}),K({title:"Succès",description:`Loyer mis à jour pour ${o.length} propriété(s)`}),S(!1),L(),M(""),j()}catch(m){G.error("Bulk rent update failed",{error:m}),K({title:"Erreur",description:"Échec de la modification des loyers",variant:"destructive"})}},Y=async()=>{if(R)try{const{error:m}=await b.from("properties").update({status:"archivé"}).in("id",o);if(m)throw m;const{data:{user:u}}=await b.auth.getUser();u&&await b.from("admin_audit_logs").insert({admin_id:u.id,action_type:"bulk_property_update",target_type:"properties",target_id:o[0],notes:`${o.length} propriétés archivées`,new_values:{status:"archivé",count:o.length}}),K({title:"Succès",description:`${o.length} propriété(s) archivée(s)`}),y(!1),L(),j()}catch(m){G.error("Bulk archive failed",{error:m}),K({title:"Erreur",description:"Échec de l'archivage groupé",variant:"destructive"})}},T=()=>s.filter(m=>o.includes(m.id)).map(m=>{if(c)return{title:m.title,current:Ms[m.status]||m.status,new:Ms[n]||n};if(v&&f){const u=m.monthly_rent,F=i==="percentage"?u*(1+parseFloat(f)/100):u+parseFloat(f);return{title:m.title,current:`${u.toLocaleString()} FCFA`,new:`${Math.round(F).toLocaleString()} FCFA`}}else if(g)return{title:m.title,current:Ms[m.status]||m.status,new:"Archivé"};return null}).filter(Boolean),k=m=>{const u=m==="disponible"?"default":m==="refuse"?"destructive":"outline";return e.jsx($,{variant:u,children:Ms[m]||m})};return a?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{children:"Gestion des biens immobiliers"})}),e.jsxs(C,{children:[o.length>0&&e.jsx(ls,{className:"mb-4 border-primary",children:e.jsxs(cs,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zi,{className:"h-4 w-4"}),e.jsxs("span",{className:"font-medium",children:[o.length," propriété(s) sélectionnée(s)"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{variant:"outline",size:"sm",onClick:L,children:"Désélectionner tout"}),e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>x(!0),children:[e.jsx(Mt,{className:"h-4 w-4 mr-1"}),"Changer statut"]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>S(!0),children:[e.jsx(Mt,{className:"h-4 w-4 mr-1"}),"Modifier loyer"]}),e.jsxs(P,{variant:"destructive",size:"sm",onClick:()=>y(!0),children:[e.jsx(Vi,{className:"h-4 w-4 mr-1"}),"Archiver"]})]})]})}),e.jsxs(Ss,{children:[e.jsx(As,{children:e.jsxs(Se,{children:[e.jsx(ae,{className:"w-12",children:e.jsx(gs,{checked:o.length===s.length&&s.length>0,onCheckedChange:O})}),e.jsx(ae,{children:"Titre"}),e.jsx(ae,{children:"Propriétaire"}),e.jsx(ae,{children:"Ville"}),e.jsx(ae,{children:"Loyer"}),e.jsx(ae,{children:"Statut"}),e.jsx(ae,{children:"Date"}),e.jsx(ae,{className:"text-right",children:"Actions"})]})}),e.jsx(Cs,{children:s.length===0?e.jsx(Se,{children:e.jsx(se,{colSpan:8,className:"text-center text-muted-foreground",children:"Aucun bien trouvé"})}):s.map(m=>e.jsxs(Se,{children:[e.jsx(se,{children:e.jsx(gs,{checked:o.includes(m.id),onCheckedChange:()=>q(m.id)})}),e.jsx(se,{className:"font-medium",children:m.title}),e.jsx(se,{children:m.profiles.full_name}),e.jsx(se,{children:m.city}),e.jsxs(se,{children:[m.monthly_rent.toLocaleString()," FCFA"]}),e.jsx(se,{children:k(m.status)}),e.jsx(se,{children:new Date(m.created_at).toLocaleDateString("fr-FR")}),e.jsx(se,{className:"text-right",children:e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx(P,{variant:"ghost",size:"sm",asChild:!0,children:e.jsx(ie,{to:`/property/${m.id}`,children:e.jsx($t,{className:"h-4 w-4"})})}),m.status==="en_attente"&&e.jsxs(e.Fragment,{children:[e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>A(m.id,"disponible"),children:e.jsx(he,{className:"h-4 w-4 text-green-600"})}),e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>A(m.id,"refuse"),children:e.jsx(de,{className:"h-4 w-4 text-red-600"})})]})]})})]},m.id))})]})]})]}),e.jsx(ze,{open:c,onOpenChange:x,children:e.jsxs(Le,{children:[e.jsxs(Ve,{children:[e.jsxs(Be,{children:["Modifier le statut de ",o.length," propriété(s)"]}),e.jsx(We,{children:"Sélectionnez le nouveau statut à appliquer aux propriétés sélectionnées"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Nouveau statut"}),e.jsxs(we,{value:n,onValueChange:h,children:[e.jsx(ge,{children:e.jsx(_e,{})}),e.jsxs(ve,{children:[e.jsx(B,{value:"disponible",children:"Disponible"}),e.jsx(B,{value:"loué",children:"Loué"}),e.jsx(B,{value:"en_attente",children:"En attente"}),e.jsx(B,{value:"archivé",children:"Archivé"}),e.jsx(B,{value:"refuse",children:"Refusé"})]})]})]}),T().length>0&&e.jsxs("div",{className:"border rounded-lg p-3 max-h-64 overflow-y-auto",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Aperçu des modifications :"}),e.jsx("div",{className:"space-y-2",children:T().map((m,u)=>e.jsxs("div",{className:"text-xs border-b pb-2 last:border-0",children:[e.jsx("p",{className:"font-medium",children:m.title}),e.jsxs("p",{className:"text-muted-foreground",children:[e.jsx("span",{children:m.current})," → ",e.jsx("span",{className:"text-primary font-medium",children:m.new})]})]},u))})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(gs,{id:"confirm-status",checked:R,onCheckedChange:m=>N(m)}),e.jsx(W,{htmlFor:"confirm-status",className:"text-sm cursor-pointer",children:"Je confirme ces modifications"})]})]}),e.jsxs(is,{children:[e.jsx(P,{variant:"outline",onClick:()=>{x(!1),N(!1)},children:"Annuler"}),e.jsx(P,{onClick:ce,disabled:!R,children:"Confirmer les modifications"})]})]})}),e.jsx(ze,{open:v,onOpenChange:S,children:e.jsxs(Le,{children:[e.jsxs(Ve,{children:[e.jsxs(Be,{children:["Modifier le loyer de ",o.length," propriété(s)"]}),e.jsx(We,{children:"Choisissez le type de modification et la valeur"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Type de modification"}),e.jsxs(Yr,{value:i,onValueChange:m=>d(m),children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ot,{value:"percentage",id:"percentage"}),e.jsx(W,{htmlFor:"percentage",className:"cursor-pointer",children:"Pourcentage (%)"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ot,{value:"fixed",id:"fixed"}),e.jsx(W,{htmlFor:"fixed",className:"cursor-pointer",children:"Montant fixe (FCFA)"})]})]})]}),e.jsxs("div",{children:[e.jsxs(W,{children:["Valeur ",i==="percentage"?"(%)":"(FCFA)"]}),e.jsx(Je,{type:"number",value:f,onChange:m=>M(m.target.value),placeholder:i==="percentage"?"Ex: 10 pour +10%":"Ex: 50000"})]}),f&&T().length>0&&e.jsxs("div",{className:"border rounded-lg p-3 max-h-64 overflow-y-auto",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Aperçu des modifications :"}),e.jsx("div",{className:"space-y-2",children:T().map((m,u)=>e.jsxs("div",{className:"text-xs border-b pb-2 last:border-0",children:[e.jsx("p",{className:"font-medium",children:m.title}),e.jsxs("p",{className:"text-muted-foreground",children:[e.jsx("span",{children:m.current})," → ",e.jsx("span",{className:"text-primary font-medium",children:m.new})]})]},u))})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(gs,{id:"confirm-rent",checked:R,onCheckedChange:m=>N(m)}),e.jsx(W,{htmlFor:"confirm-rent",className:"text-sm cursor-pointer",children:"Je confirme ces modifications"})]})]}),e.jsxs(is,{children:[e.jsx(P,{variant:"outline",onClick:()=>{S(!1),N(!1),M("")},children:"Annuler"}),e.jsx(P,{onClick:oe,disabled:!R||!f,children:"Confirmer les modifications"})]})]})}),e.jsx(ze,{open:g,onOpenChange:y,children:e.jsxs(Le,{children:[e.jsxs(Ve,{children:[e.jsxs(Be,{children:["Archiver ",o.length," propriété(s)"]}),e.jsx(We,{className:"text-destructive",children:"Attention : Cette action marquera les propriétés comme archivées. Elles ne seront plus visibles dans les recherches publiques."})]}),e.jsxs("div",{className:"space-y-4",children:[T().length>0&&e.jsxs("div",{className:"border rounded-lg p-3 max-h-64 overflow-y-auto",children:[e.jsx("p",{className:"text-sm font-medium mb-2",children:"Propriétés concernées :"}),e.jsx("div",{className:"space-y-2",children:T().map((m,u)=>e.jsxs("div",{className:"text-xs border-b pb-2 last:border-0",children:[e.jsx("p",{className:"font-medium",children:m.title}),e.jsxs("p",{className:"text-muted-foreground",children:[e.jsx("span",{children:m.current})," → ",e.jsx("span",{className:"text-destructive font-medium",children:m.new})]})]},u))})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(gs,{id:"confirm-archive",checked:R,onCheckedChange:m=>N(m)}),e.jsx(W,{htmlFor:"confirm-archive",className:"text-sm cursor-pointer",children:"Je confirme vouloir archiver ces propriétés"})]})]}),e.jsxs(is,{children:[e.jsx(P,{variant:"outline",onClick:()=>{y(!1),N(!1)},children:"Annuler"}),e.jsx(P,{variant:"destructive",onClick:Y,disabled:!R,children:"Archiver les propriétés"})]})]})})]})},Il=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(!0);r.useEffect(()=>{o()},[]);const o=async()=>{try{const{data:c,error:x}=await b.from("profiles").select("*").order("created_at",{ascending:!1});if(x)throw x;t(c||[])}catch(c){fs(c,"Impossible de charger les utilisateurs")}finally{l(!1)}},p=c=>{const x={locataire:"Locataire",proprietaire:"Propriétaire",agence:"Agence",admin_ansut:"Admin ANSUT"};return e.jsx($,{variant:"outline",children:x[c]||c})};return a?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{children:"Gestion des utilisateurs"})}),e.jsx(C,{children:e.jsxs(Ss,{children:[e.jsx(As,{children:e.jsxs(Se,{children:[e.jsx(ae,{children:"Nom"}),e.jsx(ae,{children:"Type"}),e.jsx(ae,{children:"Ville"}),e.jsx(ae,{children:"ONECI"}),e.jsx(ae,{children:"CNAM"}),e.jsx(ae,{children:"Vérifié"}),e.jsx(ae,{children:"Date d'inscription"})]})}),e.jsx(Cs,{children:s.length===0?e.jsx(Se,{children:e.jsx(se,{colSpan:7,className:"text-center text-muted-foreground",children:"Aucun utilisateur trouvé"})}):s.map(c=>e.jsxs(Se,{children:[e.jsx(se,{className:"font-medium",children:c.full_name}),e.jsx(se,{children:p(c.user_type)}),e.jsx(se,{children:c.city||"-"}),e.jsx(se,{children:c.oneci_verified?e.jsx(he,{className:"h-5 w-5 text-green-600"}):e.jsx(de,{className:"h-5 w-5 text-muted-foreground"})}),e.jsx(se,{children:c.cnam_verified?e.jsx(he,{className:"h-5 w-5 text-green-600"}):e.jsx(de,{className:"h-5 w-5 text-muted-foreground"})}),e.jsx(se,{children:c.is_verified?e.jsx($,{variant:"default",children:"Vérifié"}):e.jsx($,{variant:"secondary",children:"Non vérifié"})}),e.jsx(se,{children:new Date(c.created_at).toLocaleDateString("fr-FR")})]},c.id))})]})})]})},Xr=({status:s,certifiedAt:t,variant:a="default"})=>{const o=(()=>{switch(s){case"certified":return{icon:he,text:"Certifié ANSUT",color:"bg-green-600 hover:bg-green-700",iconColor:"text-white"};case"pending":return{icon:xe,text:"Certification en cours",color:"bg-yellow-600 hover:bg-yellow-700",iconColor:"text-white"};case"rejected":return{icon:de,text:"Certification refusée",color:"bg-red-600 hover:bg-red-700",iconColor:"text-white"};default:return{icon:pe,text:"Non certifié",color:"bg-muted hover:bg-muted/80",iconColor:"text-muted-foreground"}}})(),p=o.icon;return a==="compact"?e.jsxs($,{className:`${o.color} gap-1.5 text-xs px-2 py-1`,children:[e.jsx(p,{className:"h-3 w-3"}),e.jsx("span",{children:"ANSUT"})]}):a==="detailed"?e.jsxs("div",{className:`inline-flex items-center gap-2 ${o.color} px-4 py-2 rounded-lg text-white transition-smooth`,children:[e.jsx(p,{className:"h-5 w-5"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm font-semibold",children:o.text}),s==="certified"&&t&&e.jsxs("span",{className:"text-xs opacity-90",children:["Le ",new Date(t).toLocaleDateString("fr-FR")]})]})]}):e.jsx(Nr,{children:e.jsxs(yr,{children:[e.jsx(br,{asChild:!0,children:e.jsxs($,{className:`${o.color} cursor-help gap-2`,children:[e.jsx(p,{className:"h-4 w-4"}),o.text]})}),e.jsxs(Ht,{className:"max-w-xs",children:[s==="certified"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Bail validé par ANSUT"}),t&&e.jsxs("p",{className:"text-xs",children:["Certifié le ",new Date(t).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]}),e.jsx("p",{className:"text-xs",children:"Conforme aux normes légales ivoiriennes"})]}),s==="pending"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Certification en cours"}),e.jsx("p",{className:"text-xs",children:"Demande en cours d'examen (2-5 jours)"})]}),s==="rejected"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Certification refusée"}),e.jsx("p",{className:"text-xs",children:"Consultez les notes pour plus de détails"})]}),s==="not_requested"&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-semibold",children:"Pas de certification ANSUT"}),e.jsx("p",{className:"text-xs",children:"Ce bail n'a pas demandé de certification"})]})]})]})})},Wr=({leaseId:s,open:t,onOpenChange:a,onClose:l,onStatusUpdated:o})=>{var R,N,j,A,O,q,L,ce,oe,Y,T;const p=()=>{l&&l(),a&&a(!1)},[c,x]=r.useState(null),[v,S]=r.useState(!0),[g,y]=r.useState(!1),[n,h]=r.useState("");r.useEffect(()=>{t&&s&&i()},[t,s]);const i=async()=>{S(!0);try{const{data:k,error:m}=await b.from("leases").select(`
          *,
          property:properties!leases_property_id_fkey(title, address, city),
          landlord:profiles!leases_landlord_id_fkey(full_name, oneci_verified, cnam_verified),
          tenant:profiles!leases_tenant_id_fkey(full_name, oneci_verified, cnam_verified)
        `).eq("id",s).single();if(m)throw m;x(k),h(k.certification_notes||"")}catch(k){G.error("Error fetching lease",{error:k,leaseId:s}),K({title:"Erreur",description:"Impossible de charger les détails du bail",variant:"destructive"})}finally{S(!1)}},d=async k=>{y(!0);try{let m,u;switch(k){case"approve":m="certified",u="approved";break;case"reject":m="rejected",u="rejected";break;case"request_changes":m="in_review",u="requested_changes";break}const F={certification_status:m,certification_notes:n.trim()||null};k==="approve"&&(F.ansut_certified_at=new Date().toISOString());const{error:V}=await b.from("leases").update(F).eq("id",s);if(V)throw V;const{data:H}=await b.auth.getUser();H.user&&await b.from("lease_certification_history").insert({lease_id:s,admin_id:H.user.id,action:u,status:m,notes:n.trim()||null});try{const w=k==="approve"?"approved":k==="reject"?"rejected":"request_changes";await b.functions.invoke("send-certification-email",{body:{leaseId:s,action:w,notes:n}})}catch(w){G.error("Error sending certification email",{error:w})}K({title:k==="approve"?"✅ Bail certifié avec succès":k==="reject"?"❌ Certification refusée":"⚠️ Modifications demandées",description:k==="approve"?"Le bail a été certifié par l'ANSUT. Les parties ont été notifiées par email.":k==="reject"?"La demande de certification a été refusée. Les parties ont été notifiées.":"Des modifications ont été demandées aux parties."}),a(!1),o==null||o()}catch(m){G.error("Error updating certification",{error:m,leaseId:s,action:k}),K({title:"Erreur",description:m instanceof Error?m.message:"Impossible de mettre à jour la certification",variant:"destructive"})}finally{y(!1)}};if(v)return e.jsx(ze,{open:t,onOpenChange:a||p,children:e.jsx(Le,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})})})});if(!c)return null;const f=c.landlord_signed_at&&c.tenant_signed_at,M=((R=c.landlord)==null?void 0:R.oneci_verified)&&((N=c.tenant)==null?void 0:N.oneci_verified);return e.jsx(ze,{open:t,onOpenChange:a,children:e.jsxs(Le,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ve,{children:[e.jsxs(Be,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-secondary"}),"Examen de Certification ANSUT"]}),e.jsx(We,{children:"Examinez le dossier complet avant de certifier le bail"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{children:e.jsx(Xr,{status:c.certification_status,certifiedAt:c.ansut_certified_at,variant:"detailed"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold",children:[e.jsx(ns,{className:"h-4 w-4"}),"Bien Immobilier"]}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg space-y-2",children:[e.jsx("p",{className:"font-medium",children:((j=c.property)==null?void 0:j.title)||"N/A"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[((A=c.property)==null?void 0:A.address)||"N/A",", ",((O=c.property)==null?void 0:O.city)||"N/A"]}),e.jsxs("div",{className:"flex gap-4 text-sm",children:[e.jsxs("span",{children:["Loyer: ",c.monthly_rent.toLocaleString()," FCFA/mois"]}),c.deposit_amount&&e.jsxs("span",{children:["Caution: ",c.deposit_amount.toLocaleString()," FCFA"]})]})]})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold",children:[e.jsx(Oe,{className:"h-4 w-4"}),"Propriétaire"]}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg space-y-2",children:[e.jsx("p",{className:"font-medium",children:((q=c.landlord)==null?void 0:q.full_name)||"N/A"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx("div",{className:"flex items-center gap-2",children:(L=c.landlord)!=null&&L.oneci_verified?e.jsx($,{className:"bg-green-600",children:"ONECI Vérifié"}):e.jsx($,{variant:"outline",children:"ONECI Non vérifié"})}),e.jsx("div",{className:"flex items-center gap-2",children:(ce=c.landlord)!=null&&ce.cnam_verified?e.jsx($,{className:"bg-green-600",children:"CNAM Vérifié"}):e.jsx($,{variant:"outline",children:"CNAM Non vérifié"})}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:c.landlord_signed_at?e.jsxs($,{className:"bg-blue-600",children:["Signé le ",new Date(c.landlord_signed_at).toLocaleDateString("fr-FR")]}):e.jsx($,{variant:"destructive",children:"Non signé"})})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold",children:[e.jsx(Oe,{className:"h-4 w-4"}),"Locataire"]}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg space-y-2",children:[e.jsx("p",{className:"font-medium",children:((oe=c.tenant)==null?void 0:oe.full_name)||"N/A"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsx("div",{className:"flex items-center gap-2",children:(Y=c.tenant)!=null&&Y.oneci_verified?e.jsx($,{className:"bg-green-600",children:"ONECI Vérifié"}):e.jsx($,{variant:"outline",children:"ONECI Non vérifié"})}),e.jsx("div",{className:"flex items-center gap-2",children:(T=c.tenant)!=null&&T.cnam_verified?e.jsx($,{className:"bg-green-600",children:"CNAM Vérifié"}):e.jsx($,{variant:"outline",children:"CNAM Non vérifié"})}),e.jsx("div",{className:"flex items-center gap-2 mt-2",children:c.tenant_signed_at?e.jsxs($,{className:"bg-blue-600",children:["Signé le ",new Date(c.tenant_signed_at).toLocaleDateString("fr-FR")]}):e.jsx($,{variant:"destructive",children:"Non signé"})})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold",children:[e.jsx(Re,{className:"h-4 w-4"}),"Critères de Certification"]}),e.jsxs("div",{className:"bg-muted p-4 rounded-lg space-y-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Bail signé par les deux parties"}),f?e.jsx(he,{className:"h-4 w-4 text-green-600"}):e.jsx(de,{className:"h-4 w-4 text-red-600"})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:"Identités vérifiées (ONECI)"}),M?e.jsx(he,{className:"h-4 w-4 text-green-600"}):e.jsx(de,{className:"h-4 w-4 text-red-600"})]})]})]}),e.jsx(xs,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"admin-notes",children:"Notes de certification (visibles par les parties)"}),e.jsx(ps,{id:"admin-notes",value:n,onChange:k=>h(k.target.value),placeholder:"Ajoutez vos observations ou commentaires...",rows:4})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(P,{variant:"outline",onClick:()=>a(!1),disabled:g,children:"Fermer"}),e.jsxs(P,{variant:"outline",onClick:()=>d("request_changes"),disabled:g,className:"border-warning text-warning hover:bg-warning/10 gap-2",children:[g&&e.jsx(ke,{className:"h-4 w-4 animate-spin"}),"Demander modifications"]}),e.jsxs(P,{variant:"destructive",onClick:()=>d("reject"),disabled:g,className:"gap-2",children:[g?e.jsx(ke,{className:"h-4 w-4 animate-spin"}):e.jsx(de,{className:"h-4 w-4"}),"Refuser"]}),e.jsxs(P,{onClick:()=>d("approve"),disabled:g||!f,className:"gap-2",children:[g?e.jsx(ke,{className:"h-4 w-4 animate-spin"}):e.jsx(he,{className:"h-4 w-4"}),"Certifier"]})]})]})]})})},kl=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(!0),[o,p]=r.useState(null),[c,x]=r.useState(!1);r.useEffect(()=>{v()},[]);const v=async()=>{try{const{data:y,error:n}=await b.from("leases").select(`
          id,
          property_id,
          monthly_rent,
          status,
          lease_type,
          ansut_certified_at,
          certification_status,
          certification_requested_at,
          created_at,
          properties:property_id (title),
          tenant:tenant_id (full_name),
          landlord:landlord_id (full_name)
        `).order("created_at",{ascending:!1});if(n)throw n;t(y||[])}catch(y){G.error("Error fetching leases",{error:y}),K({title:"Erreur",description:"Impossible de charger les baux",variant:"destructive"})}finally{l(!1)}},S=y=>{p(y),x(!0)},g=y=>{const n={draft:"secondary",pending:"secondary",active:"default",terminated:"outline"},h={draft:"Brouillon",pending:"En attente",active:"Actif",terminated:"Terminé"};return e.jsx($,{variant:n[y]||"outline",children:h[y]||y})};return a?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{children:"Gestion des baux"})}),e.jsx(C,{children:e.jsxs(Ss,{children:[e.jsx(As,{children:e.jsxs(Se,{children:[e.jsx(ae,{children:"Bien"}),e.jsx(ae,{children:"Propriétaire"}),e.jsx(ae,{children:"Locataire"}),e.jsx(ae,{children:"Loyer"}),e.jsx(ae,{children:"Type"}),e.jsx(ae,{children:"Statut"}),e.jsx(ae,{children:"Certification"}),e.jsx(ae,{className:"text-right",children:"Actions"})]})}),e.jsx(Cs,{children:s.length===0?e.jsx(Se,{children:e.jsx(se,{colSpan:8,className:"text-center text-muted-foreground",children:"Aucun bail trouvé"})}):s.map(y=>{var n,h,i;return e.jsxs(Se,{children:[e.jsx(se,{className:"font-medium",children:((n=y.properties)==null?void 0:n.title)||"N/A"}),e.jsx(se,{children:((h=y.landlord)==null?void 0:h.full_name)||"N/A"}),e.jsx(se,{children:((i=y.tenant)==null?void 0:i.full_name)||"N/A"}),e.jsxs(se,{children:[y.monthly_rent.toLocaleString()," FCFA"]}),e.jsx(se,{className:"capitalize",children:y.lease_type}),e.jsx(se,{children:g(y.status)}),e.jsx(se,{children:e.jsx(Xr,{status:y.certification_status,certifiedAt:y.ansut_certified_at})}),e.jsx(se,{className:"text-right",children:y.certification_status==="pending"&&e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>S(y.id),children:[e.jsx($t,{className:"h-4 w-4 mr-2"}),"Examiner"]})})]},y.id)})})]})}),o&&e.jsx(Wr,{leaseId:o,open:c,onOpenChange:x,onStatusUpdated:v})]})},fa=["hsl(var(--chart-1))","hsl(var(--chart-2))","hsl(var(--chart-3))","hsl(var(--chart-4))","hsl(var(--chart-5))"],Pl=()=>{const[s,t]=r.useState({userGrowth:[],applicationsByWeek:[],propertyDistribution:[],topProperties:[]}),[a,l]=r.useState({conversionRate:0,avgResponseTime:0,activeUsersRate:0,certificationRate:0,retentionRate:0}),[o,p]=r.useState([]),[c,x]=r.useState([]),[v,S]=r.useState([]),[g,y]=r.useState("30"),[n,h]=r.useState("all"),[i,d]=r.useState([]),[f,M]=r.useState(!0);r.useEffect(()=>{R()},[g]);const R=async()=>{try{M(!0);const j=parseInt(g),A=new Date;A.setDate(A.getDate()-j);const{data:O,error:q}=await b.from("profiles").select("created_at").gte("created_at",A.toISOString());if(q)throw q;const{data:L,error:ce}=await b.from("rental_applications").select("created_at, status, reviewed_at, applicant_id").gte("created_at",A.toISOString());if(ce)throw ce;let oe=b.from("properties").select("city, view_count, title, monthly_rent, surface_area");n!=="all"&&(oe=oe.eq("city",n));const{data:Y,error:T}=await oe;if(T)throw T;const{data:k,error:m}=await b.from("leases").select("certification_status, created_at, landlord_signed_at, tenant_signed_at").gte("created_at",A.toISOString());if(m)throw m;const{data:u,error:F}=await b.from("search_history").select("created_at, user_id").gte("created_at",A.toISOString());if(F)throw F;const{data:V,error:H}=await b.from("user_favorites").select("created_at, user_id").gte("created_at",A.toISOString());if(H)throw H;const w=Array.from(new Set((Y==null?void 0:Y.map(U=>U.city).filter(Boolean))||[]));d(w);const z=new Map;O==null||O.forEach(U=>{const ee=new Date(U.created_at).toISOString().split("T")[0];z.set(ee,(z.get(ee)||0)+1)});const ne=Array.from(z.entries()).map(([U,ee])=>({date:U,count:ee})).sort((U,ee)=>U.date.localeCompare(ee.date)),ue=new Map;L==null||L.forEach(U=>{const ee=new Date(U.created_at).toISOString().split("T")[0];ue.set(ee,(ue.get(ee)||0)+1)});const ye=Array.from(ue.entries()).map(([U,ee])=>({week:U,count:ee})).sort((U,ee)=>U.week.localeCompare(ee.week)),De=new Map;Y==null||Y.forEach(U=>{De.set(U.city,(De.get(U.city)||0)+1)});const le=Array.from(De.entries()).map(([U,ee])=>({city:U,count:ee})).sort((U,ee)=>ee.count-U.count).slice(0,5),qe=(Y==null?void 0:Y.sort((U,ee)=>(ee.view_count||0)-(U.view_count||0)).slice(0,10).map(U=>({title:U.title,views:U.view_count||0})))||[],Ue=(L==null?void 0:L.length)||0,ds=(L==null?void 0:L.filter(U=>U.status==="accepted").length)||0,Hs=Ue>0?ds/Ue*100:0,Ze=(L==null?void 0:L.filter(U=>U.reviewed_at))||[],Ks=Ze.length>0?Ze.reduce((U,ee)=>{const Nt=new Date(ee.created_at).getTime(),yt=new Date(ee.reviewed_at).getTime();return U+(yt-Nt)/(1e3*60*60)},0)/Ze.length:0,$e=(O==null?void 0:O.length)||0,Q=new Set([...(L==null?void 0:L.map(U=>U.applicant_id))||[],...(u==null?void 0:u.map(U=>U.user_id))||[],...(V==null?void 0:V.map(U=>U.user_id))||[]]),J=$e>0?Q.size/$e*100:0,fe=(k==null?void 0:k.length)||0,Ee=(k==null?void 0:k.filter(U=>U.certification_status==="certified").length)||0,ms=fe>0?Ee/fe*100:0,Es=new Date;Es.setDate(Es.getDate()-30);const Rs=new Set([...u||[],...V||[]].filter(U=>new Date(U.created_at)>Es).map(U=>U.user_id)),gt=$e>0?Rs.size/$e*100:0;l({conversionRate:Hs,avgResponseTime:Ks,activeUsersRate:J,certificationRate:ms,retentionRate:gt});const vt=(O==null?void 0:O.length)||0,Ds=(u==null?void 0:u.length)||0,Ts=(L==null?void 0:L.length)||0,Is=(k==null?void 0:k.filter(U=>U.landlord_signed_at&&U.tenant_signed_at).length)||0;p([{step:"Inscriptions",value:vt,fill:"hsl(var(--chart-1))"},{step:"Recherches",value:Ds,fill:"hsl(var(--chart-2))"},{step:"Candidatures",value:Ts,fill:"hsl(var(--chart-3))"},{step:"Baux signés",value:Is,fill:"hsl(var(--chart-4))"}]);const us=new Map;[...u||[],...L||[]].forEach(U=>{const ee=new Date(U.created_at),Nt=ee.toLocaleDateString("fr-FR",{weekday:"short"}),yt=ee.getHours(),ra=`${Nt}-${yt}`;us.set(ra,(us.get(ra)||0)+1)});const ks=["lun","mar","mer","jeu","ven","sam","dim"],X=[];ks.forEach(U=>{for(let ee=0;ee<24;ee++)X.push({day:U,hour:ee,activity:us.get(`${U}-${ee}`)||0})}),x(X);const Z=(Y==null?void 0:Y.filter(U=>U.monthly_rent&&U.surface_area).map(U=>({title:U.title,rent:Number(U.monthly_rent),surface:Number(U.surface_area)})))||[];S(Z),t({userGrowth:ne,applicationsByWeek:ye,propertyDistribution:le,topProperties:qe})}catch(j){G.error("Error fetching analytics",{error:j,period:g})}finally{M(!1)}},N=()=>{const A=[["Métrique","Valeur"],["Taux de conversion",`${a.conversionRate.toFixed(2)}%`],["Temps de réponse moyen",`${a.avgResponseTime.toFixed(2)}h`],["Taux d'utilisateurs actifs",`${a.activeUsersRate.toFixed(2)}%`],["Taux de certification",`${a.certificationRate.toFixed(2)}%`],["Taux de rétention",`${a.retentionRate.toFixed(2)}%`],[""],["Funnel de conversion"],...o.map(L=>[L.step,L.value.toString()]),[""],["Propriétés par ville"],...s.propertyDistribution.map(L=>[L.city,L.count.toString()])].map(L=>L.join(",")).join(`
`),O=new Blob([A],{type:"text/csv;charset=utf-8;"}),q=document.createElement("a");q.href=URL.createObjectURL(O),q.download=`analytics-${new Date().toISOString().split("T")[0]}.csv`,q.click()};return f?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[1,2,3,4,5].map(j=>e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsx(Ce,{className:"h-4 w-24"})}),e.jsx(C,{children:e.jsx(Ce,{className:"h-8 w-16"})})]},j))}),[1,2,3].map(j=>e.jsx(_,{children:e.jsx(C,{className:"h-[300px] flex items-center justify-center",children:e.jsx(Ce,{className:"h-full w-full"})})},j))]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Analytiques de la plateforme"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(we,{value:n,onValueChange:h,children:[e.jsx(ge,{className:"w-[180px]",children:e.jsx(_e,{placeholder:"Ville"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Toutes les villes"}),i.map(j=>e.jsx(B,{value:j,children:j},j))]})]}),e.jsxs(we,{value:g,onValueChange:y,children:[e.jsx(ge,{className:"w-[180px]",children:e.jsx(_e,{placeholder:"Période"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"7",children:"7 derniers jours"}),e.jsx(B,{value:"30",children:"30 derniers jours"}),e.jsx(B,{value:"90",children:"90 derniers jours"}),e.jsx(B,{value:"365",children:"1 an"})]})]}),e.jsx(P,{onClick:N,variant:"outline",size:"icon",children:e.jsx(Pe,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4",children:[e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(I,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4 text-primary"}),"Taux de conversion"]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.conversionRate.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Candidatures acceptées"})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(I,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4 text-primary"}),"Temps de réponse"]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.avgResponseTime.toFixed(1),"h"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Délai moyen"})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(I,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(tt,{className:"h-4 w-4 text-primary"}),"Utilisateurs actifs"]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.activeUsersRate.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Taux d'engagement"})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(I,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4 text-primary"}),"Certification ANSUT"]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.certificationRate.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Baux certifiés"})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsxs(I,{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(hs,{className:"h-4 w-4 text-primary"}),"Rétention"]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.retentionRate.toFixed(1),"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Utilisateurs revenus"})]})]})]}),e.jsxs(He,{defaultValue:"users",className:"space-y-4",children:[e.jsxs(Fe,{children:[e.jsx(te,{value:"users",children:"Utilisateurs"}),e.jsx(te,{value:"applications",children:"Candidatures"}),e.jsx(te,{value:"properties",children:"Biens"}),e.jsx(te,{value:"funnel",children:"Funnel"}),e.jsx(te,{value:"heatmap",children:"Activité"}),e.jsx(te,{value:"scatter",children:"Loyer/Surface"})]}),e.jsx(re,{value:"users",className:"space-y-4",children:e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(hs,{className:"h-5 w-5"}),"Croissance des inscriptions"]})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:300,children:e.jsxs(at,{data:s.userGrowth,children:[e.jsx(ss,{strokeDasharray:"3 3"}),e.jsx(ts,{dataKey:"date"}),e.jsx(as,{}),e.jsx(Ie,{}),e.jsx(zs,{}),e.jsx(rt,{dataKey:"count",fill:"hsl(var(--primary))",name:"Inscriptions"})]})})})]})}),e.jsx(re,{value:"applications",className:"space-y-4",children:e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-5 w-5"}),"Candidatures par semaine"]})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:300,children:e.jsxs(zt,{data:s.applicationsByWeek,children:[e.jsx(ss,{strokeDasharray:"3 3"}),e.jsx(ts,{dataKey:"week"}),e.jsx(as,{}),e.jsx(Ie,{}),e.jsx(zs,{}),e.jsx(vs,{type:"monotone",dataKey:"count",stroke:"hsl(var(--primary))",name:"Candidatures"})]})})})]})}),e.jsx(re,{value:"properties",className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(ns,{className:"h-5 w-5"}),"Répartition par ville"]})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:300,children:e.jsxs(Vt,{children:[e.jsx(Bt,{data:s.propertyDistribution,cx:"50%",cy:"50%",labelLine:!1,label:({city:j,percent:A})=>`${j}: ${(A*100).toFixed(0)}%`,outerRadius:80,fill:"#8884d8",dataKey:"count",children:s.propertyDistribution.map((j,A)=>e.jsx(Gt,{fill:fa[A%fa.length]},`cell-${A}`))}),e.jsx(Ie,{})]})})})]}),e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5"}),"Top 10 des biens les plus vus"]})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:300,children:e.jsxs(at,{data:s.topProperties,layout:"vertical",children:[e.jsx(ss,{strokeDasharray:"3 3"}),e.jsx(ts,{type:"number"}),e.jsx(as,{dataKey:"title",type:"category",width:150}),e.jsx(Ie,{}),e.jsx(rt,{dataKey:"views",fill:"hsl(var(--primary))"})]})})})]})]})}),e.jsx(re,{value:"funnel",className:"space-y-4",children:e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5"}),"Funnel de conversion"]})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:400,children:e.jsxs(dn,{children:[e.jsx(Ie,{}),e.jsx(mn,{dataKey:"value",data:o,isAnimationActive:!0,children:e.jsx(un,{position:"right",fill:"hsl(var(--foreground))",stroke:"none",dataKey:"step"})})]})})})]})}),e.jsx(re,{value:"heatmap",className:"space-y-4",children:e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(tt,{className:"h-5 w-5"}),"Heatmap d'activité (Jour × Heure)"]})}),e.jsx(C,{children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsx("div",{className:"grid grid-cols-24 gap-1 min-w-[800px]",children:["lun","mar","mer","jeu","ven","sam","dim"].map(j=>e.jsxs("div",{className:"col-span-24 grid grid-cols-24 gap-1",children:[e.jsx("div",{className:"text-xs font-medium flex items-center",children:j}),Array.from({length:24},(A,O)=>{var oe;const q=((oe=c.find(Y=>Y.day===j&&Y.hour===O))==null?void 0:oe.activity)||0,L=Math.max(...c.map(Y=>Y.activity)),ce=L>0?q/L:0;return e.jsx("div",{className:"h-8 rounded",style:{backgroundColor:`hsl(var(--primary) / ${ce})`,border:"1px solid hsl(var(--border))"},title:`${j} ${O}h: ${q} activités`},O)})]},j))}),e.jsx("div",{className:"mt-4 text-xs text-muted-foreground",children:"Plus la couleur est foncée, plus il y a d'activité à ce moment"})]})})]})}),e.jsx(re,{value:"scatter",className:"space-y-4",children:e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(ns,{className:"h-5 w-5"}),"Loyer vs Surface (détection d'anomalies)"]})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:400,children:e.jsxs(xn,{margin:{top:20,right:20,bottom:20,left:20},children:[e.jsx(ss,{strokeDasharray:"3 3"}),e.jsx(ts,{type:"number",dataKey:"surface",name:"Surface",unit:" m²",label:{value:"Surface (m²)",position:"insideBottom",offset:-10}}),e.jsx(as,{type:"number",dataKey:"rent",name:"Loyer",unit:" FCFA",label:{value:"Loyer (FCFA)",angle:-90,position:"insideLeft"}}),e.jsx(hn,{range:[60,400]}),e.jsx(Ie,{cursor:{strokeDasharray:"3 3"},content:({active:j,payload:A})=>{if(j&&A&&A.length){const O=A[0].payload;return e.jsxs("div",{className:"bg-card p-3 border border-border rounded shadow-lg",children:[e.jsx("p",{className:"font-semibold text-sm",children:O.title}),e.jsxs("p",{className:"text-xs",children:["Surface: ",O.surface," m²"]}),e.jsxs("p",{className:"text-xs",children:["Loyer: ",O.rent.toLocaleString()," FCFA"]})]})}return null}}),e.jsx(pn,{name:"Propriétés",data:v,fill:"hsl(var(--primary))"})]})})})]})})]})]})},Ml=({disputeId:s})=>{const[t,a]=r.useState([]),[l,o]=r.useState(!0);r.useEffect(()=>{p()},[s]);const p=async()=>{try{const{data:x,error:v}=await b.from("admin_audit_logs").select(`
          *,
          admin:admin_id(full_name)
        `).eq("target_type","dispute").eq("target_id",s).order("created_at",{ascending:!1});if(v)throw v;a(x||[])}catch(x){G.error("Error fetching dispute timeline",{error:x,disputeId:s})}finally{o(!1)}},c=x=>x.includes("resolved")?e.jsx($,{variant:"default",children:"Résolu"}):x.includes("closed")?e.jsx($,{variant:"outline",children:"Fermé"}):x.includes("in_review")?e.jsx($,{variant:"secondary",children:"En révision"}):e.jsx($,{children:x});return l?e.jsx(_,{children:e.jsx(C,{className:"flex items-center justify-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})}):t.length===0?e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{className:"text-base",children:"Historique des actions"})}),e.jsx(C,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucune action enregistrée"})})]}):e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{className:"text-base",children:"Historique des actions"})}),e.jsx(C,{className:"space-y-4",children:t.map(x=>{var v;return e.jsxs("div",{className:"flex gap-4 pb-4 border-b last:border-0 last:pb-0",children:[e.jsx(Ge,{className:"h-8 w-8",children:e.jsx(Qe,{children:e.jsx(Oe,{className:"h-4 w-4"})})}),e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-medium",children:((v=x.admin)==null?void 0:v.full_name)||"Système"}),c(x.action_type)]}),x.notes&&e.jsx("p",{className:"text-sm text-muted-foreground",children:x.notes}),x.old_values&&x.new_values&&e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[x.old_values.status&&x.new_values.status&&e.jsxs("p",{children:["Statut: ",x.old_values.status," → ",x.new_values.status]}),x.old_values.priority&&x.new_values.priority&&e.jsxs("p",{children:["Priorité: ",x.old_values.priority," → ",x.new_values.priority]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(xe,{className:"h-3 w-3"}),me(new Date(x.created_at),"PPP à HH:mm",{locale:be})]})]})]},x.id)})})]})},Ll=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(null),[o,p]=r.useState("all"),[c,x]=r.useState(!0),[v,S]=r.useState([]),[g,y]=r.useState({open:0,in_review:0,resolved_last_30d:0,avg_resolution_hours:0}),{toast:n}=os();r.useEffect(()=>{h(),i(),d()},[o]);const h=async()=>{try{const{data:N,error:j}=await b.rpc("get_my_disputes");if(j)throw j;let A=N||[];o!=="all"&&(A=A.filter(O=>O.status===o)),t(A)}catch(N){G.error("Error fetching disputes",{error:N,filter:o})}finally{x(!1)}},i=async()=>{try{const{data:N,error:j}=await b.from("user_roles").select(`
          user_id,
          profile:user_id(full_name)
        `).eq("role","admin");if(j)throw j;S(N||[])}catch(N){G.error("Error fetching admins",{error:N})}},d=async()=>{try{const N=new Date;N.setDate(N.getDate()-30);const{data:j,error:A}=await b.rpc("get_my_disputes");if(A)throw A;const O=(j==null?void 0:j.filter(Y=>Y.status==="open").length)||0,q=(j==null?void 0:j.filter(Y=>Y.status==="in_review").length)||0,L=(j==null?void 0:j.filter(Y=>Y.status==="resolved"&&Y.resolved_at&&new Date(Y.resolved_at)>N).length)||0,ce=(j==null?void 0:j.filter(Y=>Y.resolved_at&&Y.created_at))||[],oe=ce.length>0?ce.reduce((Y,T)=>Y+on(new Date(T.resolved_at),new Date(T.created_at)),0)/ce.length:0;y({open:O,in_review:q,resolved_last_30d:L,avg_resolution_hours:oe})}catch(N){G.error("Error fetching dispute stats",{error:N})}},f=async(N,j,A=!1)=>{try{const{error:O}=await b.from("disputes").update(j).eq("id",N);if(O)throw O;if(A&&a&&(j.status==="resolved"||j.status==="closed")){const q=j.status==="resolved"?"Le litige a été résolu par ANSUT.":"Le litige a été fermé par ANSUT.";await Promise.all([b.from("notifications").insert({user_id:a.reporter_id,type:"dispute_update",title:"Mise à jour du litige",message:q,link:"/dashboard",metadata:{dispute_id:N}}),b.from("notifications").insert({user_id:a.reported_id,type:"dispute_update",title:"Mise à jour du litige",message:q,link:"/dashboard",metadata:{dispute_id:N}})])}n({title:"Litige mis à jour",description:"Le litige a été mis à jour avec succès"}),h(),d(),l(null)}catch(O){G.error("Error updating dispute",{error:O,disputeId:N,updates:j}),n({title:"Erreur",description:"Impossible de mettre à jour le litige",variant:"destructive"})}},M=N=>{const j={open:"destructive",in_review:"secondary",resolved:"default",closed:"outline"};return e.jsx($,{variant:j[N]||"default",children:N})},R=N=>{switch(N){case"urgent":return e.jsx(Ne,{className:"h-4 w-4 text-red-500"});case"high":return e.jsx(Ne,{className:"h-4 w-4 text-orange-500"});case"medium":return e.jsx(xe,{className:"h-4 w-4 text-yellow-500"});default:return e.jsx(xe,{className:"h-4 w-4 text-blue-500"})}};return c?e.jsx(_,{children:e.jsx(C,{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Gestion des litiges"}),e.jsxs(we,{value:o,onValueChange:p,children:[e.jsx(ge,{className:"w-[180px]",children:e.jsx(_e,{placeholder:"Filtrer"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Tous"}),e.jsx(B,{value:"open",children:"Ouverts"}),e.jsx(B,{value:"in_review",children:"En révision"}),e.jsx(B,{value:"resolved",children:"Résolus"}),e.jsx(B,{value:"closed",children:"Fermés"})]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Ouverts"}),e.jsx(Ne,{className:"h-4 w-4 text-destructive"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:g.open})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"En révision"}),e.jsx(xe,{className:"h-4 w-4 text-secondary"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:g.in_review})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Résolus (30j)"}),e.jsx(he,{className:"h-4 w-4 text-primary"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:g.resolved_last_30d})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Temps moyen"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(C,{children:e.jsxs("div",{className:"text-2xl font-bold",children:[Math.round(g.avg_resolution_hours),"h"]})})]})]}),e.jsx("div",{className:"grid gap-4",children:s.length===0?e.jsx(_,{children:e.jsx(C,{className:"flex items-center justify-center h-32",children:e.jsx("p",{className:"text-muted-foreground",children:"Aucun litige trouvé"})})}):s.map(N=>{var j,A,O,q,L,ce,oe,Y;return e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[R(N.priority),e.jsx(I,{className:"text-base",children:N.dispute_type})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[M(N.status),e.jsxs(ze,{children:[e.jsx(Nl,{asChild:!0,children:e.jsx(P,{variant:"outline",size:"sm",onClick:()=>l(N),children:"Gérer"})}),e.jsxs(Le,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(Ve,{children:e.jsx(Be,{children:"Détails du litige"})}),a&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-10 w-10",children:e.jsx(Qe,{children:((A=(j=a.reporter)==null?void 0:j.full_name)==null?void 0:A.charAt(0))||"R"})}),e.jsxs("div",{children:[e.jsx(W,{className:"text-xs text-muted-foreground",children:"Rapporteur"}),e.jsx("p",{className:"text-sm font-medium",children:((O=a.reporter)==null?void 0:O.full_name)||"N/A"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-10 w-10",children:e.jsx(Qe,{children:((L=(q=a.reported)==null?void 0:q.full_name)==null?void 0:L.charAt(0))||"R"})}),e.jsxs("div",{children:[e.jsx(W,{className:"text-xs text-muted-foreground",children:"Signalé"}),e.jsx("p",{className:"text-sm font-medium",children:((ce=a.reported)==null?void 0:ce.full_name)||"N/A"})]})]})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Type de litige"}),e.jsx("p",{className:"text-sm mt-1",children:a.dispute_type})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Description"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1 whitespace-pre-wrap",children:a.description})]}),a.lease_id&&e.jsxs("div",{children:[e.jsx(W,{children:"Bail concerné"}),e.jsxs(P,{variant:"link",className:"h-auto p-0 text-sm",onClick:()=>window.open("/leases","_blank"),children:[e.jsx(Re,{className:"h-4 w-4 mr-1"}),"Voir le bail"]})]}),a.attachments&&Array.isArray(a.attachments)&&a.attachments.length>0&&e.jsxs("div",{children:[e.jsx(W,{children:"Pièces jointes"}),e.jsx("div",{className:"mt-2 space-y-2",children:a.attachments.map((T,k)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Re,{className:"h-4 w-4"}),e.jsx("a",{href:T.url,target:"_blank",rel:"noopener noreferrer",className:"text-primary hover:underline",children:T.name||`Document ${k+1}`})]},k))})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Date de création"}),e.jsx("p",{className:"text-sm",children:me(new Date(a.created_at),"PPP à HH:mm",{locale:be})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Assigner à un admin"}),e.jsxs(we,{value:a.assigned_to||"unassigned",onValueChange:T=>{f(a.id,{assigned_to:T==="unassigned"?null:T})},children:[e.jsx(ge,{children:e.jsx(_e,{})}),e.jsxs(ve,{children:[e.jsx(B,{value:"unassigned",children:"Non assigné"}),v.map(T=>{var k;return e.jsx(B,{value:T.user_id,children:((k=T.profile)==null?void 0:k.full_name)||"Admin"},T.user_id)})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Statut"}),e.jsxs(we,{defaultValue:a.status,onValueChange:T=>{f(a.id,{status:T,resolved_at:T==="resolved"||T==="closed"?new Date().toISOString():null},T==="resolved"||T==="closed")},children:[e.jsx(ge,{children:e.jsx(_e,{})}),e.jsxs(ve,{children:[e.jsx(B,{value:"open",children:"Ouvert"}),e.jsx(B,{value:"in_review",children:"En révision"}),e.jsx(B,{value:"resolved",children:"Résolu"}),e.jsx(B,{value:"closed",children:"Fermé"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Priorité"}),e.jsxs(we,{defaultValue:a.priority,onValueChange:T=>{f(a.id,{priority:T})},children:[e.jsx(ge,{children:e.jsx(_e,{})}),e.jsxs(ve,{children:[e.jsx(B,{value:"low",children:"Basse"}),e.jsx(B,{value:"medium",children:"Moyenne"}),e.jsx(B,{value:"high",children:"Haute"}),e.jsx(B,{value:"urgent",children:"Urgente"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Notes de résolution"}),e.jsx(ps,{defaultValue:a.resolution_notes||"",placeholder:"Ajouter des notes...",rows:4,onBlur:T=>{T.target.value!==a.resolution_notes&&f(a.id,{resolution_notes:T.target.value})}})]}),e.jsx(Ml,{disputeId:a.id})]})]})]})]})]}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2",children:N.description}),e.jsxs("div",{className:"flex items-center gap-4 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["De: ",((oe=N.reporter)==null?void 0:oe.full_name)||"N/A"]}),e.jsxs("span",{children:["Contre: ",((Y=N.reported)==null?void 0:Y.full_name)||"N/A"]}),e.jsx("span",{children:me(new Date(N.created_at),"PPP",{locale:be})})]})]})})]},N.id)})})]})},Ol=()=>{const[s,t]=r.useState(null),[a,l]=r.useState(!0);r.useEffect(()=>{o()},[]);const o=async()=>{try{const{data:v,error:S}=await b.rpc("get_verifications_for_admin_review");if(S)throw S;if(!v){t(null);return}const g=v.filter(N=>N.oneci_status==="pending_review"||N.cnam_status==="pending_review").length,y=v.filter(N=>N.oneci_status==="verified").length,n=v.filter(N=>N.cnam_status==="verified").length,h=v.filter(N=>N.oneci_status==="verified"||N.cnam_status==="verified").length,i=v.filter(N=>N.oneci_status==="rejected"||N.cnam_status==="rejected").length,d=v.filter(N=>N.admin_reviewed_at);let f=0;d.length>0&&(f=d.reduce((j,A)=>{const O=new Date(A.created_at).getTime(),q=new Date(A.admin_reviewed_at).getTime();return j+(q-O)},0)/d.length/(1e3*60*60));const M=v.filter(N=>N.tenant_score&&N.tenant_score>0),R=M.length>0?M.reduce((N,j)=>N+(j.tenant_score||0),0)/M.length:0;t({total:v.length,pending:g,verified:h,rejected:i,oneci_verified:y,cnam_verified:n,avg_processing_time_hours:f,avg_tenant_score:R})}catch(v){fs(v,"Impossible de charger les statistiques")}finally{l(!1)}},p=async()=>{try{const{data:v,error:S}=await b.rpc("get_verifications_for_admin_review");if(S)throw S;const y=[["ID Utilisateur","Nom","Type","Statut ONECI","Statut CNAM","Score Locataire","Date Création","Date Révision","Révisé Par"].join(","),...v.map(d=>[d.user_id,d.full_name||"N/A",d.user_type||"N/A",d.oneci_status,d.cnam_status,d.tenant_score||0,new Date(d.created_at).toLocaleDateString("fr-FR"),d.admin_reviewed_at?new Date(d.admin_reviewed_at).toLocaleDateString("fr-FR"):"N/A",d.admin_reviewed_by||"N/A"].join(","))].join(`
`),n=new Blob([y],{type:"text/csv;charset=utf-8;"}),h=document.createElement("a"),i=URL.createObjectURL(n);h.setAttribute("href",i),h.setAttribute("download",`verifications-${new Date().toISOString().split("T")[0]}.csv`),h.style.visibility="hidden",document.body.appendChild(h),h.click(),document.body.removeChild(h),K({title:"Export réussi",description:"Les données ont été exportées en CSV"})}catch(v){fs(v,"Impossible d'exporter les données")}};if(a)return e.jsx("div",{className:"flex items-center justify-center p-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})});if(!s)return e.jsx(_,{children:e.jsx(C,{className:"pt-6",children:e.jsx("p",{className:"text-center text-muted-foreground",children:"Aucune donnée disponible"})})});const c=s.total>0?(s.verified/s.total*100).toFixed(1):"0",x=s.total>0?(s.rejected/s.total*100).toFixed(1):"0";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Statistiques des Vérifications"}),e.jsx("p",{className:"text-muted-foreground",children:"Vue d'ensemble des vérifications d'identité"})]}),e.jsxs(P,{onClick:p,variant:"outline",className:"gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),"Exporter CSV"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(hs,{className:"h-4 w-4"}),"Total Vérifications"]})}),e.jsx(C,{children:e.jsx("div",{className:"text-3xl font-bold",children:s.total})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"En Attente"]})}),e.jsxs(C,{children:[e.jsx("div",{className:"text-3xl font-bold text-orange-600",children:s.pending}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.total>0?(s.pending/s.total*100).toFixed(1):0,"% du total"]})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(Ye,{className:"h-4 w-4"}),"Approuvées"]})}),e.jsxs(C,{children:[e.jsx("div",{className:"text-3xl font-bold text-green-600",children:s.verified}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Taux d'approbation: ",c,"%"]})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4"}),"Rejetées"]})}),e.jsxs(C,{children:[e.jsx("div",{className:"text-3xl font-bold text-red-600",children:s.rejected}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Taux de rejet: ",x,"%"]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-primary"}),"Vérifications par Type"]}),e.jsx(je,{children:"Répartition des vérifications ONECI et CNAM"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted/50 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"ONECI Vérifiées"}),e.jsx($,{variant:"default",className:"text-lg px-3 py-1",children:s.oneci_verified})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted/50 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"CNAM Vérifiées"}),e.jsx($,{variant:"default",className:"text-lg px-3 py-1",children:s.cnam_verified})]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"h-5 w-5 text-primary"}),"Métriques de Performance"]}),e.jsx(je,{children:"Temps de traitement et scores moyens"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted/50 rounded-lg",children:[e.jsx("span",{className:"font-medium",children:"Temps Moyen de Traitement"}),e.jsxs($,{variant:"outline",className:"text-lg px-3 py-1",children:[s.avg_processing_time_hours.toFixed(1),"h"]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 bg-muted/50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Bi,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-medium",children:"Score Locataire Moyen"})]}),e.jsxs($,{variant:"default",className:"text-lg px-3 py-1",children:[s.avg_tenant_score.toFixed(0),"/100"]})]})]})]})]})]})};function Fl(){const[s,t]=r.useState([]),[a,l]=r.useState([]),[o,p]=r.useState(!0),[c,x]=r.useState(null),[v,S]=r.useState(""),[g,y]=r.useState(!1),n=async()=>{try{const{data:d,error:f}=await b.rpc("get_verifications_for_admin_review");if(f)throw f;const M=(d||[]).map(j=>({user_id:j.user_id,oneci_status:j.oneci_status,cnam_status:j.cnam_status,passport_status:"not_submitted",oneci_data:j.oneci_data,cnam_data:j.cnam_data,passport_data:null,oneci_cni_number:j.oneci_cni_number,cnam_employer:j.cnam_employer,passport_number:null,passport_nationality:null,created_at:j.created_at,profiles:{full_name:j.full_name||"N/A",avatar_url:null,email:"user@example.com"}}));t(M);const{data:R,error:N}=await b.rpc("get_passport_verifications_for_admin");!N&&R&&l(R)}catch(d){fs(d,"Impossible de charger les vérifications en attente")}finally{p(!1)}};r.useEffect(()=>{n()},[]);const h=async()=>{if(c){y(!0);try{let d;if(c.type==="passport"){d=c.action==="approve"?"approve_passport_verification":"reject_passport_verification";const{error:f}=await b.rpc(d,{p_user_id:c.userId,p_review_notes:v||null});if(f)throw f}else{d=c.action==="approve"?"approve_verification":"reject_verification";const{error:f}=await b.rpc(d,{p_user_id:c.userId,p_verification_type:c.type,p_review_notes:v||null});if(f)throw f}K({title:c.action==="approve"?"Vérification approuvée":"Vérification rejetée",description:`La vérification ${c.type.toUpperCase()} a été ${c.action==="approve"?"approuvée":"rejetée"} avec succès.`}),x(null),S(""),n()}catch(d){fs(d)}finally{y(!1)}}},i=d=>{switch(d){case"pending_review":return e.jsxs($,{variant:"secondary",className:"flex items-center gap-1",children:[e.jsx(xe,{className:"h-3 w-3"})," En attente"]});case"verified":return e.jsxs($,{variant:"default",className:"flex items-center gap-1",children:[e.jsx(Ye,{className:"h-3 w-3"})," Vérifié"]});case"rejected":return e.jsxs($,{variant:"destructive",className:"flex items-center gap-1",children:[e.jsx(de,{className:"h-3 w-3"})," Rejeté"]});default:return e.jsx($,{variant:"outline",children:d})}};return o?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsx(Ol,{}),e.jsxs(He,{defaultValue:"oneci_cnam",className:"w-full",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs(Fe,{children:[e.jsxs(te,{value:"oneci_cnam",children:["ONECI & CNAM (",s.length,")"]}),e.jsxs(te,{value:"passport",children:["Passeports (",a.length,")"]})]}),e.jsx(P,{onClick:n,variant:"outline",children:"Rafraîchir"})]}),e.jsxs(re,{value:"oneci_cnam",className:"space-y-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Vérifications ONECI & CNAM"}),e.jsxs("p",{className:"text-muted-foreground",children:[s.length," vérification",s.length>1?"s":""," en attente de validation"]})]}),s.length===0?e.jsx(_,{children:e.jsxs(C,{className:"flex flex-col items-center justify-center h-64",children:[e.jsx(Ye,{className:"h-16 w-16 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:"Aucune vérification en attente"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Toutes les vérifications ont été traitées"})]})}):e.jsx("div",{className:"grid gap-4",children:s.map(d=>e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Ge,{children:[e.jsx(ut,{src:d.profiles.avatar_url||void 0}),e.jsx(Qe,{children:e.jsx(Oe,{className:"h-5 w-5"})})]}),e.jsxs("div",{children:[e.jsx(I,{className:"text-lg",children:d.profiles.full_name}),e.jsx(je,{className:"text-sm",children:d.profiles.email})]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:me(new Date(d.created_at),"PPp",{locale:be})})]})}),e.jsxs(C,{className:"space-y-4",children:[d.oneci_status==="pending_review"&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Vérification ONECI"})]}),i(d.oneci_status)]}),d.oneci_data&&e.jsxs("div",{className:"bg-muted/50 rounded p-3 space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"CNI:"})," ",d.oneci_cni_number]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Nom:"})," ",d.oneci_data.lastName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Prénom:"})," ",d.oneci_data.firstName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Date de naissance:"})," ",d.oneci_data.birthDate]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{size:"sm",onClick:()=>x({userId:d.user_id,type:"oneci",action:"approve"}),className:"flex-1",children:[e.jsx(Ye,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(P,{size:"sm",variant:"destructive",onClick:()=>x({userId:d.user_id,type:"oneci",action:"reject"}),className:"flex-1",children:[e.jsx(de,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]}),d.cnam_status==="pending_review"&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Re,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Vérification CNAM"})]}),i(d.cnam_status)]}),d.cnam_data&&e.jsxs("div",{className:"bg-muted/50 rounded p-3 space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Employeur:"})," ",d.cnam_employer]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Type de contrat:"})," ",d.cnam_data.contractType||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Salaire estimé:"})," ",d.cnam_data.estimatedSalary||"N/A"," FCFA"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Statut:"})," ",d.cnam_data.employmentStatus||"N/A"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{size:"sm",onClick:()=>x({userId:d.user_id,type:"cnam",action:"approve"}),className:"flex-1",children:[e.jsx(Ye,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(P,{size:"sm",variant:"destructive",onClick:()=>x({userId:d.user_id,type:"cnam",action:"reject"}),className:"flex-1",children:[e.jsx(de,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]})]})]},d.user_id))})]}),e.jsxs(re,{value:"passport",className:"space-y-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Vérifications Passeport"}),e.jsxs("p",{className:"text-muted-foreground",children:[a.length," vérification",a.length>1?"s":""," passeport en attente"]})]}),a.length===0?e.jsx(_,{children:e.jsxs(C,{className:"flex flex-col items-center justify-center h-64",children:[e.jsx(Ye,{className:"h-16 w-16 text-muted-foreground mb-4"}),e.jsx("p",{className:"text-lg font-medium",children:"Aucune vérification passeport en attente"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Toutes les vérifications passeport ont été traitées"})]})}):e.jsx("div",{className:"grid gap-4",children:a.map(d=>e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ge,{children:e.jsx(Qe,{children:e.jsx(Oe,{className:"h-5 w-5"})})}),e.jsxs("div",{children:[e.jsx(I,{className:"text-lg",children:d.full_name}),e.jsxs(je,{className:"text-sm",children:["Nationalité: ",d.passport_nationality]})]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:me(new Date(d.created_at),"PPp",{locale:be})})]})}),e.jsx(C,{className:"space-y-4",children:e.jsxs("div",{className:"border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gi,{className:"h-5 w-5 text-primary"}),e.jsx("span",{className:"font-semibold",children:"Vérification Passeport"})]}),i(d.passport_status)]}),d.passport_data&&e.jsxs("div",{className:"bg-muted/50 rounded p-3 space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Numéro passeport:"})," ",d.passport_number]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Nationalité:"})," ",d.passport_nationality]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Nom:"})," ",d.passport_data.lastName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Prénom:"})," ",d.passport_data.firstName]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Date de naissance:"})," ",d.passport_data.birthDate]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Date d'émission:"})," ",d.passport_data.issueDate]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Date d'expiration:"})," ",d.passport_data.expiryDate]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{size:"sm",onClick:()=>x({userId:d.user_id,type:"passport",action:"approve"}),className:"flex-1",children:[e.jsx(Ye,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(P,{size:"sm",variant:"destructive",onClick:()=>x({userId:d.user_id,type:"passport",action:"reject"}),className:"flex-1",children:[e.jsx(de,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]})})]},d.user_id))})]})]})]}),e.jsx(ze,{open:!!c,onOpenChange:()=>x(null),children:e.jsxs(Le,{children:[e.jsxs(Ve,{children:[e.jsxs(Be,{children:[(c==null?void 0:c.action)==="approve"?"Approuver":"Rejeter"," la vérification ",c==null?void 0:c.type.toUpperCase()]}),e.jsx(We,{children:(c==null?void 0:c.action)==="approve"?"Confirmez-vous vouloir approuver cette vérification ?":"Veuillez indiquer le motif du rejet (obligatoire)."})]}),e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{children:[e.jsxs(W,{htmlFor:"notes",children:["Notes ",(c==null?void 0:c.action)==="reject"&&e.jsx("span",{className:"text-destructive",children:"*"})]}),e.jsx(ps,{id:"notes",value:v,onChange:d=>S(d.target.value),placeholder:(c==null?void 0:c.action)==="approve"?"Notes optionnelles...":"Motif du rejet (obligatoire)...",rows:4})]})}),e.jsxs(is,{children:[e.jsx(P,{variant:"outline",onClick:()=>x(null),disabled:g,children:"Annuler"}),e.jsx(P,{onClick:h,disabled:g||(c==null?void 0:c.action)==="reject"&&!v.trim(),variant:(c==null?void 0:c.action)==="approve"?"default":"destructive",children:g?"Traitement...":(c==null?void 0:c.action)==="approve"?"Approuver":"Rejeter"})]})]})})]})}const ql=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(null),[o,p]=r.useState(""),[c,x]=r.useState(!0),[v,S]=r.useState(!1),[g,y]=r.useState(null),[n,h]=r.useState("pending"),[i,d]=r.useState("all"),{toast:f}=os(),M=async A=>{try{x(!0);let O=b.from("reviews").select(`
          *,
          reviewer:reviewer_id(full_name, avatar_url),
          reviewee:reviewee_id(full_name)
        `).eq("moderation_status",A).order("created_at",{ascending:!1});i!=="all"&&(O=O.eq("review_type",i));const{data:q,error:L}=await O;if(L)throw L;t(q||[])}catch(O){G.error("Error fetching reviews for moderation",{error:O}),f({title:"Erreur",description:"Impossible de charger les avis",variant:"destructive"})}finally{x(!1)}};r.useEffect(()=>{M(n)},[n,i]);const R=async A=>{if(A.comment){S(!0);try{const{data:O,error:q}=await b.functions.invoke("moderate-review",{body:{reviewId:A.id,reviewText:A.comment}});if(q)throw q;y(O.moderationResult)}catch(O){G.error("Error analyzing review with AI",{error:O}),f({title:"Erreur",description:"Impossible d'analyser l'avis",variant:"destructive"})}finally{S(!1)}}},N=async(A,O)=>{try{const{data:{user:q}}=await b.auth.getUser();if(!q)return;const{error:L}=await b.from("reviews").update({moderation_status:O,moderation_notes:o,moderated_by:q.id,moderated_at:new Date().toISOString()}).eq("id",A);if(L)throw L;f({title:O==="approved"?"Avis approuvé":"Avis rejeté",description:`L'avis a été ${O==="approved"?"approuvé":"rejeté"} avec succès`}),M(n),l(null),p(""),y(null)}catch(q){G.error("Error moderating review",{error:q}),f({title:"Erreur",description:"Impossible de modérer l'avis",variant:"destructive"})}},j=A=>A>=50?e.jsxs($,{variant:"destructive",children:["Toxicité élevée (",A,"%)"]}):A>=20?e.jsxs($,{className:"bg-warning text-warning-foreground",children:["Toxicité modérée (",A,"%)"]}):e.jsxs($,{variant:"secondary",children:["Toxicité faible (",A,"%)"]});return c&&s.length===0?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(ke,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(I,{children:"Modération des Avis"}),e.jsx(je,{children:"Gérez les avis soumis par les utilisateurs"})]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pr,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs(we,{value:i,onValueChange:d,children:[e.jsx(ge,{className:"w-[200px]",children:e.jsx(_e,{placeholder:"Type d'avis"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Tous les types"}),e.jsx(B,{value:"tenant_to_landlord",children:"Locataire → Propriétaire"}),e.jsx(B,{value:"landlord_to_tenant",children:"Propriétaire → Locataire"})]})]})]})})]})}),e.jsx(C,{children:e.jsxs(He,{value:n,onValueChange:A=>h(A),children:[e.jsxs(Fe,{className:"grid w-full grid-cols-3",children:[e.jsx(te,{value:"pending",children:"En attente"}),e.jsx(te,{value:"approved",children:"Approuvés"}),e.jsx(te,{value:"rejected",children:"Rejetés"})]}),e.jsx(re,{value:n,className:"mt-6",children:s.length===0?e.jsx("p",{className:"text-center text-muted-foreground py-8",children:"Aucun avis dans cette catégorie"}):e.jsx("div",{className:"space-y-4",children:s.map(A=>e.jsx(_,{children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start space-x-4 flex-1",children:[e.jsxs(Ge,{children:[e.jsx(ut,{src:A.reviewer.avatar_url||void 0}),e.jsx(Qe,{children:A.reviewer.full_name.charAt(0)})]}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:A.reviewer.full_name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["À propos de ",A.reviewee.full_name]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("div",{className:"flex items-center gap-1",children:[...Array(5)].map((O,q)=>e.jsx(na,{className:`h-4 w-4 ${q<A.rating?"fill-primary text-primary":"text-muted"}`},q))}),e.jsx($,{variant:"outline",children:A.review_type==="tenant_to_landlord"?"Locataire → Propriétaire":"Propriétaire → Locataire"})]})]}),e.jsx("p",{className:"text-sm",children:A.comment}),e.jsx("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:e.jsx("span",{children:me(new Date(A.created_at),"dd MMMM yyyy à HH:mm",{locale:be})})}),A.moderation_notes&&n!=="pending"&&e.jsxs("div",{className:"mt-2 p-2 bg-muted rounded-md",children:[e.jsx("p",{className:"text-xs font-medium",children:"Notes de modération :"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:A.moderation_notes})]})]})]}),n==="pending"&&e.jsx(P,{onClick:()=>{l(A),p(""),y(null),R(A)},children:"Modérer"})]})})},A.id))})})]})})]}),e.jsx(ze,{open:!!a,onOpenChange:A=>!A&&l(null),children:e.jsxs(Le,{className:"max-w-2xl",children:[e.jsxs(Ve,{children:[e.jsx(Be,{children:"Modération de l'avis"}),e.jsx(We,{children:"Analysez et modérez cet avis utilisateur"})]}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(W,{className:"text-sm font-medium",children:"Auteur"}),e.jsx("p",{className:"text-sm mt-1",children:a.reviewer.full_name})]}),e.jsxs("div",{children:[e.jsx(W,{className:"text-sm font-medium",children:"À propos de"}),e.jsx("p",{className:"text-sm mt-1",children:a.reviewee.full_name})]})]}),e.jsxs("div",{children:[e.jsx(W,{className:"text-sm font-medium",children:"Note"}),e.jsx("div",{className:"flex items-center gap-1 mt-1",children:[...Array(5)].map((A,O)=>e.jsx(na,{className:`h-5 w-5 ${O<a.rating?"fill-primary text-primary":"text-muted"}`},O))})]}),e.jsxs("div",{children:[e.jsx(W,{className:"text-sm font-medium",children:"Commentaire"}),e.jsx("p",{className:"text-sm mt-1 p-3 bg-muted rounded-md",children:a.comment||"Aucun commentaire"})]}),e.jsxs("div",{children:[e.jsx(W,{className:"text-sm font-medium",children:"Analyse automatique"}),v?e.jsxs("div",{className:"flex items-center gap-2 mt-2",children:[e.jsx(ke,{className:"h-4 w-4 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Analyse en cours..."})]}):g?e.jsxs("div",{className:"mt-2 space-y-2",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[j(g.confidenceScore),g.inappropriateLanguage&&e.jsxs($,{variant:"destructive",children:[e.jsx(Ne,{className:"h-3 w-3 mr-1"}),"Langage inapproprié"]}),g.personalInfoDetected&&e.jsxs($,{variant:"destructive",children:[e.jsx(Ne,{className:"h-3 w-3 mr-1"}),"Infos personnelles"]}),g.suspiciousContent&&e.jsxs($,{className:"bg-warning text-warning-foreground",children:[e.jsx(Ne,{className:"h-3 w-3 mr-1"}),"Contenu suspect"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:g.aiReason}),e.jsxs("p",{className:"text-sm font-medium",children:["Action suggérée : ",g.suggestedAction==="approve"?"✅ Approuver":g.suggestedAction==="reject"?"❌ Rejeter":"🚩 Marquer pour révision"]})]}):null]}),e.jsxs("div",{children:[e.jsx(W,{htmlFor:"notes",children:"Notes de modération (optionnel)"}),e.jsx(ps,{id:"notes",value:o,onChange:A=>p(A.target.value),placeholder:"Ajoutez des notes expliquant votre décision...",className:"mt-1",rows:3})]}),e.jsxs(is,{className:"gap-2",children:[e.jsx(P,{variant:"outline",onClick:()=>l(null),children:"Annuler"}),e.jsxs(P,{variant:"destructive",onClick:()=>N(a.id,"rejected"),children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Rejeter"]}),e.jsxs(P,{onClick:()=>N(a.id,"approved"),children:[e.jsx(he,{className:"h-4 w-4 mr-2"}),"Approuver"]})]})]})]})})]})},it=Hi,nt=Ki,Bs=r.forwardRef(({className:s,align:t="center",sideOffset:a=4,...l},o)=>e.jsx(Yi,{children:e.jsx(fr,{ref:o,align:t,sideOffset:a,className:E("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",s),...l})}));Bs.displayName=fr.displayName;function bs({className:s,classNames:t,showOutsideDays:a=!0,...l}){return e.jsx(Xi,{showOutsideDays:a,className:E("p-3",s),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium",nav:"space-x-1 flex items-center",nav_button:E(ys({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:E(ys({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"day-outside text-muted-foreground opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"text-muted-foreground opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...t},components:{IconLeft:({...o})=>e.jsx(jr,{className:"h-4 w-4"}),IconRight:({...o})=>e.jsx(mt,{className:"h-4 w-4"})},...l})}bs.displayName="Calendar";const es={primary:"hsl(30 100% 50%)",secondary:"hsl(225 80% 33%)",success:"hsl(142 76% 36%)",warning:"hsl(38 92% 50%)",muted:"hsl(220 15% 62%)"},Ul=()=>{var f,M,R,N,j,A,O,q,L,ce,oe,Y;const[s,t]=r.useState({topLandlords:[],topTenants:[],verificationStats:{oneci:0,cnam:0,face:0,total:0},propertyPerformance:{avgDaysToRent:0,avgViews:0,conversionRate:0},platformActivity:{totalUsers:0,totalProperties:0,totalApplications:0}}),[a,l]=r.useState(!0),[o,p]=r.useState(),[c,x]=r.useState(),[v,S]=r.useState("30d"),{toast:g}=os();r.useEffect(()=>{const T=new Date,k=qs(T,30);p(k),x(T)},[]),r.useEffect(()=>{o&&c&&n()},[o,c]);const y=T=>{if(S(T),T!=="custom"){const k=new Date,m=qs(k,T==="7d"?7:T==="30d"?30:90);p(m),x(k)}},n=async()=>{if(!(!o||!c))try{l(!0);let T=b.from("profiles").select("*");const{data:k}=await T;let m=b.from("properties").select("*");o&&(m=m.gte("created_at",o.toISOString())),c&&(m=m.lte("created_at",c.toISOString()));const{data:u}=await m;let F=b.from("rental_applications").select("*");o&&(F=F.gte("created_at",o.toISOString())),c&&(F=F.lte("created_at",c.toISOString()));const{data:V}=await F,{data:H}=await b.rpc("get_verifications_for_admin_review"),{data:w}=await b.from("leases").select("*, properties(property_type)").eq("status","active"),z=new Map;u==null||u.forEach(X=>{const U=z.get(X.owner_id)||{name:"Propriétaire",count:0};z.set(X.owner_id,{...U,count:U.count+1})});const ne=Array.from(z.values()).map(X=>({name:X.name,propertyCount:X.count,avgRating:4.5})).sort((X,Z)=>Z.propertyCount-X.propertyCount).slice(0,10),ue=new Map;V==null||V.forEach(X=>{const U=ue.get(X.applicant_id)||{name:"Locataire",count:0};ue.set(X.applicant_id,{...U,count:U.count+1})});const ye=Array.from(ue.values()).map(X=>({name:X.name,applicationCount:X.count,score:0})).sort((X,Z)=>Z.applicationCount-X.applicationCount).slice(0,10),De={oneci:(H==null?void 0:H.filter(X=>X.oneci_status==="verified").length)||0,cnam:(H==null?void 0:H.filter(X=>X.cnam_status==="verified").length)||0,face:(H==null?void 0:H.filter(X=>X.face_verification_status==="verified").length)||0,total:(k==null?void 0:k.length)||0},le=(u==null?void 0:u.reduce((X,Z)=>X+(Z.view_count||0),0))||0,qe=u!=null&&u.length?le/u.length:0,Ue=(V==null?void 0:V.length)||0,ds=(u==null?void 0:u.length)||0,Hs=ds>0?Ue/ds*100:0,Ze=(w==null?void 0:w.reduce((X,Z)=>X+Number(Z.monthly_rent||0),0))||0,Ks=Ze*.05,$e={};w==null||w.forEach(X=>{var U;const Z=((U=X.properties)==null?void 0:U.property_type)||"Autre";$e[Z]=($e[Z]||0)+Number(X.monthly_rent||0)});const Q=[],J=Math.ceil((c.getTime()-o.getTime())/(1e3*60*60*24)),fe=J>60?"month":J>14?"week":"day",Ee=new Map;V==null||V.forEach(X=>{const Z=new Date(X.created_at),U=fe==="day"?me(Z,"dd/MM"):fe==="week"?`S${Math.ceil(Z.getDate()/7)}/${me(Z,"MM")}`:me(Z,"MM/yyyy"),ee=Ee.get(U)||{applications:0,properties:0};Ee.set(U,{...ee,applications:ee.applications+1})}),u==null||u.forEach(X=>{const Z=new Date(X.created_at),U=fe==="day"?me(Z,"dd/MM"):fe==="week"?`S${Math.ceil(Z.getDate()/7)}/${me(Z,"MM")}`:me(Z,"MM/yyyy"),ee=Ee.get(U)||{applications:0,properties:0};Ee.set(U,{...ee,properties:ee.properties+1})}),Ee.forEach((X,Z)=>{Q.push({date:Z,...X})});const ms=new Map;u==null||u.forEach(X=>{const Z=X.city||"Non spécifié";ms.set(Z,(ms.get(Z)||0)+1)});const Es=Array.from(ms.entries()).map(([X,Z])=>({city:X,count:Z})).sort((X,Z)=>Z.count-X.count).slice(0,10),Rs=new Map;u==null||u.forEach(X=>{const Z=X.property_type||"Autre";Rs.set(Z,(Rs.get(Z)||0)+1)});const gt=Array.from(Rs.entries()).map(([X,Z])=>({type:X,count:Z})),vt=c.getTime()-o.getTime(),Ds=new Date(o.getTime()-vt),Ts=o,{data:Is}=await b.from("properties").select("id").gte("created_at",Ds.toISOString()).lt("created_at",Ts.toISOString()),{data:us}=await b.from("rental_applications").select("id").gte("created_at",Ds.toISOString()).lt("created_at",Ts.toISOString()),{data:ks}=await b.from("profiles").select("id").gte("created_at",Ds.toISOString()).lt("created_at",Ts.toISOString());t({topLandlords:ne,topTenants:ye,verificationStats:De,propertyPerformance:{avgDaysToRent:15,avgViews:qe,conversionRate:Hs},platformActivity:{totalUsers:(k==null?void 0:k.length)||0,totalProperties:ds,totalApplications:Ue},financialData:{totalRevenue:Ze,ansutCommission:Ks,revenueByType:$e,activeLeases:(w==null?void 0:w.length)||0},chartData:{timeline:Q,citiesData:Es,propertyTypes:gt},previousPeriod:{totalUsers:(ks==null?void 0:ks.length)||0,totalProperties:(Is==null?void 0:Is.length)||0,totalApplications:(us==null?void 0:us.length)||0}})}catch(T){G.error("Error fetching report data",{error:T})}finally{l(!1)}},h=(T,k)=>{if(k===0)return{delta:0,isPositive:!0};const m=(T-k)/k*100;return{delta:Math.abs(m),isPositive:m>=0}},i=(T,k)=>{if(T.length===0)return;const m=Object.keys(T[0]).join(","),u=T.map(z=>Object.values(z).join(",")).join(`
`),F=`${m}
${u}`,V=new Blob([F],{type:"text/csv"}),H=window.URL.createObjectURL(V),w=document.createElement("a");w.href=H,w.download=`${k}.csv`,w.click(),g({title:"Export réussi",description:"Le fichier CSV a été téléchargé"})},d=async T=>{try{const{data:k,error:m}=await b.functions.invoke("generate-report",{body:{reportType:T,startDate:o==null?void 0:o.toISOString(),endDate:c==null?void 0:c.toISOString(),format:"pdf"}});if(m)throw m;const u=new Blob([JSON.stringify(k.pdf,null,2)],{type:"application/json"}),F=window.URL.createObjectURL(u),V=document.createElement("a");V.href=F,V.download=`rapport-${T}-${me(new Date,"yyyy-MM-dd")}.json`,V.click(),g({title:"Export PDF",description:"Les données du rapport ont été exportées"})}catch(k){G.error("Error exporting PDF",{error:k}),g({title:"Erreur",description:"Impossible d'exporter le rapport PDF",variant:"destructive"})}};return a?e.jsx(_,{children:e.jsx(C,{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Rapports avancés"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"flex gap-1",children:[e.jsx(P,{variant:v==="7d"?"default":"outline",size:"sm",onClick:()=>y("7d"),children:"7 jours"}),e.jsx(P,{variant:v==="30d"?"default":"outline",size:"sm",onClick:()=>y("30d"),children:"30 jours"}),e.jsx(P,{variant:v==="90d"?"default":"outline",size:"sm",onClick:()=>y("90d"),children:"90 jours"})]}),e.jsxs(it,{children:[e.jsx(nt,{asChild:!0,children:e.jsxs(P,{variant:v==="custom"?"default":"outline",size:"sm",children:[e.jsx($s,{className:"mr-2 h-4 w-4"}),o&&c?`${me(o,"dd/MM/yyyy",{locale:be})} - ${me(c,"dd/MM/yyyy",{locale:be})}`:"Personnalisé"]})}),e.jsx(Bs,{className:"w-auto p-0",align:"end",children:e.jsxs("div",{className:"p-4 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Date de début"}),e.jsx(bs,{mode:"single",selected:o,onSelect:T=>{p(T),S("custom")},disabled:T=>T>new Date,className:"rounded-md border pointer-events-auto"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Date de fin"}),e.jsx(bs,{mode:"single",selected:c,onSelect:T=>{x(T),S("custom")},disabled:T=>T>new Date||o&&T<o,className:"rounded-md border pointer-events-auto"})]})]})})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Utilisateurs"}),e.jsx(hs,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.platformActivity.totalUsers}),s.previousPeriod&&e.jsx("div",{className:"mt-2 flex items-center gap-1",children:(()=>{const{delta:T,isPositive:k}=h(s.platformActivity.totalUsers,s.previousPeriod.totalUsers);return e.jsxs($,{variant:k?"default":"secondary",className:"text-xs",children:[k?e.jsx(bt,{className:"h-3 w-3 mr-1"}):e.jsx(wt,{className:"h-3 w-3 mr-1"}),T.toFixed(1),"%"]})})()})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Biens"}),e.jsx(ns,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.platformActivity.totalProperties}),s.previousPeriod&&e.jsx("div",{className:"mt-2 flex items-center gap-1",children:(()=>{const{delta:T,isPositive:k}=h(s.platformActivity.totalProperties,s.previousPeriod.totalProperties);return e.jsxs($,{variant:k?"default":"secondary",className:"text-xs",children:[k?e.jsx(bt,{className:"h-3 w-3 mr-1"}):e.jsx(wt,{className:"h-3 w-3 mr-1"}),T.toFixed(1),"%"]})})()})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Candidatures"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.platformActivity.totalApplications}),s.previousPeriod&&e.jsx("div",{className:"mt-2 flex items-center gap-1",children:(()=>{const{delta:T,isPositive:k}=h(s.platformActivity.totalApplications,s.previousPeriod.totalApplications);return e.jsxs($,{variant:k?"default":"secondary",className:"text-xs",children:[k?e.jsx(bt,{className:"h-3 w-3 mr-1"}):e.jsx(wt,{className:"h-3 w-3 mr-1"}),T.toFixed(1),"%"]})})()})]})]})]}),e.jsxs(He,{defaultValue:"performance",children:[e.jsxs(Fe,{className:"grid w-full grid-cols-5",children:[e.jsx(te,{value:"performance",children:"Performance"}),e.jsx(te,{value:"properties",children:"Biens"}),e.jsx(te,{value:"verification",children:"Vérification"}),e.jsx(te,{value:"charts",children:"Graphiques"}),e.jsx(te,{value:"financial",children:"Finances"})]}),e.jsxs(re,{value:"performance",className:"space-y-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between",children:[e.jsx(I,{children:"Top 10 Propriétaires"}),e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>i(s.topLandlords,"top-proprietaires"),children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]}),e.jsx(C,{children:e.jsx("div",{className:"space-y-2",children:s.topLandlords.map((T,k)=>e.jsx("div",{className:"flex items-center justify-between p-2 border rounded",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:T.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[T.propertyCount," bien",T.propertyCount>1?"s":""]})]})},k))})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between",children:[e.jsx(I,{children:"Top 10 Locataires"}),e.jsxs(P,{variant:"outline",size:"sm",onClick:()=>i(s.topTenants,"top-locataires"),children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Export CSV"]})]}),e.jsx(C,{children:e.jsx("div",{className:"space-y-2",children:s.topTenants.map((T,k)=>e.jsx("div",{className:"flex items-center justify-between p-2 border rounded",children:e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:T.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[T.applicationCount," candidature",T.applicationCount>1?"s":""]})]})},k))})})]})]}),e.jsx(re,{value:"properties",children:e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{children:"Métriques des biens"})}),e.jsx(C,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Délai moyen avant location"}),e.jsxs("p",{className:"text-2xl font-bold",children:[s.propertyPerformance.avgDaysToRent," jours"]})]}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Vues moyennes par bien"}),e.jsx("p",{className:"text-2xl font-bold",children:Math.round(s.propertyPerformance.avgViews)})]}),e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Taux de conversion"}),e.jsxs("p",{className:"text-2xl font-bold",children:[s.propertyPerformance.conversionRate.toFixed(1),"%"]})]})]})})]})}),e.jsx(re,{value:"verification",children:e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{children:"Statistiques de vérification"})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsx("span",{children:"ONECI vérifié"}),e.jsxs("span",{className:"font-bold",children:[s.verificationStats.oneci," / ",s.verificationStats.total]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsx("span",{children:"CNAM vérifié"}),e.jsxs("span",{className:"font-bold",children:[s.verificationStats.cnam," / ",s.verificationStats.total]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg",children:[e.jsx("span",{children:"Reconnaissance faciale"}),e.jsxs("span",{className:"font-bold",children:[s.verificationStats.face," / ",s.verificationStats.total]})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 border rounded-lg bg-muted",children:[e.jsx("span",{className:"font-medium",children:"Taux de vérification global"}),e.jsxs("span",{className:"font-bold",children:[s.verificationStats.total>0?Math.round((s.verificationStats.oneci+s.verificationStats.cnam+s.verificationStats.face)/(s.verificationStats.total*3)*100):0,"%"]})]})]})})]})}),e.jsx(re,{value:"charts",className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{className:"text-lg",children:"Évolution dans le temps"})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:300,children:e.jsxs(zt,{data:((f=s.chartData)==null?void 0:f.timeline)||[],children:[e.jsx(ss,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(ts,{dataKey:"date",stroke:"hsl(var(--muted-foreground))"}),e.jsx(as,{stroke:"hsl(var(--muted-foreground))"}),e.jsx(Ie,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px"}}),e.jsx(zs,{}),e.jsx(vs,{type:"monotone",dataKey:"applications",stroke:es.primary,strokeWidth:2,name:"Candidatures"}),e.jsx(vs,{type:"monotone",dataKey:"properties",stroke:es.secondary,strokeWidth:2,name:"Biens"})]})})})]}),e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{className:"text-lg",children:"Biens par ville (Top 10)"})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:300,children:e.jsxs(at,{data:((M=s.chartData)==null?void 0:M.citiesData)||[],children:[e.jsx(ss,{strokeDasharray:"3 3",stroke:"hsl(var(--border))"}),e.jsx(ts,{dataKey:"city",stroke:"hsl(var(--muted-foreground))"}),e.jsx(as,{stroke:"hsl(var(--muted-foreground))"}),e.jsx(Ie,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px"}}),e.jsx(rt,{dataKey:"count",fill:es.secondary,radius:[8,8,0,0],name:"Nombre de biens"})]})})})]}),e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{className:"text-lg",children:"Types de biens"})}),e.jsx(C,{children:e.jsx(Te,{width:"100%",height:300,children:e.jsxs(Vt,{children:[e.jsx(Bt,{data:((R=s.chartData)==null?void 0:R.propertyTypes)||[],dataKey:"count",nameKey:"type",cx:"50%",cy:"50%",outerRadius:100,label:!0,children:(((N=s.chartData)==null?void 0:N.propertyTypes)||[]).map((T,k)=>{const m=[es.primary,es.secondary,es.success,es.warning,es.muted];return e.jsx(Gt,{fill:m[k%m.length]},`cell-${k}`)})}),e.jsx(Ie,{contentStyle:{backgroundColor:"hsl(var(--card))",border:"1px solid hsl(var(--border))",borderRadius:"8px"}}),e.jsx(zs,{})]})})})]}),e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{className:"text-lg",children:"Entonnoir de conversion"})}),e.jsx(C,{children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Vues"}),e.jsx("span",{className:"text-sm font-bold",children:Math.round(s.propertyPerformance.avgViews*s.platformActivity.totalProperties)})]}),e.jsx("div",{className:"h-16 bg-gradient-to-r from-primary to-primary-glow rounded-lg flex items-center justify-center text-primary-foreground font-bold",children:"100%"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Candidatures"}),e.jsx("span",{className:"text-sm font-bold",children:s.platformActivity.totalApplications})]}),e.jsxs("div",{className:"h-14 bg-gradient-to-r from-secondary to-secondary-500 rounded-lg flex items-center justify-center text-secondary-foreground font-bold",style:{width:`${s.propertyPerformance.conversionRate}%`},children:[s.propertyPerformance.conversionRate.toFixed(1),"%"]})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium",children:"Locations conclues"}),e.jsx("span",{className:"text-sm font-bold",children:((j=s.financialData)==null?void 0:j.activeLeases)||0})]}),e.jsxs("div",{className:"h-12 bg-gradient-to-r from-success to-success rounded-lg flex items-center justify-center text-success-foreground font-bold",style:{width:`${s.platformActivity.totalApplications>0?(((A=s.financialData)==null?void 0:A.activeLeases)||0)/s.platformActivity.totalApplications*100:0}%`},children:[s.platformActivity.totalApplications>0?((((O=s.financialData)==null?void 0:O.activeLeases)||0)/s.platformActivity.totalApplications*100).toFixed(1):0,"%"]})]})]})})]})]})}),e.jsxs(re,{value:"financial",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Revenus totaux"}),e.jsx(qt,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[(((q=s.financialData)==null?void 0:q.totalRevenue)||0).toLocaleString("fr-FR")," FCFA"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Loyers actifs"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Commission ANSUT (5%)"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold text-primary",children:[(((L=s.financialData)==null?void 0:L.ansutCommission)||0).toLocaleString("fr-FR")," FCFA"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Par mois"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Baux actifs"}),e.jsx(Re,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:((ce=s.financialData)==null?void 0:ce.activeLeases)||0}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Contrats en cours"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Revenu moyen"}),e.jsx(ur,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[((oe=s.financialData)!=null&&oe.activeLeases&&s.financialData.activeLeases>0?s.financialData.totalRevenue/s.financialData.activeLeases:0).toLocaleString("fr-FR")," FCFA"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Par bail"})]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between",children:[e.jsx(I,{children:"Revenus par type de bien"}),e.jsxs(ht,{children:[e.jsx(pt,{asChild:!0,children:e.jsxs(P,{variant:"outline",size:"sm",children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Exporter"]})}),e.jsxs(Gs,{align:"end",children:[e.jsx(Ae,{onClick:()=>{var k;const T=Object.entries(((k=s.financialData)==null?void 0:k.revenueByType)||{}).map(([m,u])=>({"Type de bien":m,"Revenus (FCFA)":u}));i(T,"revenus-par-type")},children:"Export CSV"}),e.jsx(Ae,{onClick:()=>d("financial"),children:"Export PDF"})]})]})]}),e.jsx(C,{children:e.jsx("div",{className:"space-y-3",children:Object.entries(((Y=s.financialData)==null?void 0:Y.revenueByType)||{}).sort(([,T],[,k])=>k-T).map(([T,k])=>{var m,u;return e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium",children:T}),e.jsx("div",{className:"mt-2 h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-primary",style:{width:`${k/(((m=s.financialData)==null?void 0:m.totalRevenue)||1)*100}%`}})})]}),e.jsxs("div",{className:"ml-4 text-right",children:[e.jsxs("p",{className:"font-bold",children:[k.toLocaleString("fr-FR")," FCFA"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(k/(((u=s.financialData)==null?void 0:u.totalRevenue)||1)*100).toFixed(1),"%"]})]})]},T)})})})]})]})]})]})},Os=({status:s="pending"})=>{const[t,a]=r.useState([]),[l,o]=r.useState(!0),[p,c]=r.useState(null),[x,v]=r.useState(!1),S=async()=>{try{const{data:h,error:i}=await b.from("leases").select(`
          id,
          property_id,
          landlord_id,
          tenant_id,
          monthly_rent,
          start_date,
          certification_requested_at,
          certification_notes,
          property:properties (
            title,
            address,
            city
          ),
          landlord:profiles!leases_landlord_id_fkey (
            full_name
          ),
          tenant:profiles!leases_tenant_id_fkey (
            full_name
          )
        `).eq("certification_status",s).order("certification_requested_at",{ascending:!0});if(i)throw i;a(h||[])}catch(h){G.error("Error fetching leases for certification",{error:h})}finally{o(!1)}};r.useEffect(()=>{S();const h=b.channel(`certification-queue-${s}`).on("postgres_changes",{event:"*",schema:"public",table:"leases",filter:`certification_status=eq.${s}`},()=>{S()}).subscribe();return()=>{b.removeChannel(h)}},[s]);const g=h=>{c(h),v(!0)},y=()=>{v(!1),c(null),S()};if(l)return e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ce,{className:"h-32 w-full"}),e.jsx(Ce,{className:"h-32 w-full"}),e.jsx(Ce,{className:"h-32 w-full"})]});const n=h=>{switch(h){case"pending":return"en attente";case"in_review":return"en révision";case"certified":return"certifié";case"rejected":return"rejeté";default:return h}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground",children:["Baux ",n(s)]}),e.jsxs("p",{className:"text-muted-foreground",children:[t.length," ",t.length===1?"bail":"baux"," ",n(s)]})]}),e.jsx($,{variant:"secondary",className:"text-lg px-4 py-2",children:t.length})]}),t.length===0?e.jsx(_,{children:e.jsxs(C,{className:"py-12 text-center",children:[e.jsx(Re,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Aucun bail en attente de certification"})]})}):e.jsx("div",{className:"grid gap-4",children:t.map(h=>e.jsxs(_,{className:"hover:shadow-md transition-shadow",children:[e.jsx(D,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs(I,{className:"text-lg flex items-center gap-2",children:[e.jsx(Re,{className:"h-5 w-5"}),h.property.title]}),e.jsxs(je,{className:"flex items-center gap-1 mt-1",children:[e.jsx(Wi,{className:"h-4 w-4"}),h.property.address,", ",h.property.city]})]}),e.jsxs($,{variant:"outline",children:[h.monthly_rent.toLocaleString()," FCFA/mois"]})]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Propriétaire"}),e.jsx("p",{className:"font-medium",children:h.landlord.full_name})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(Oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Locataire"}),e.jsx("p",{className:"font-medium",children:h.tenant.full_name})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx($s,{className:"h-4 w-4"}),"Demandé le ",me(new Date(h.certification_requested_at),"dd MMMM yyyy à HH:mm",{locale:be})]}),e.jsx(P,{onClick:()=>g(h.id),children:"Examiner"})]})]})]},h.id))}),p&&e.jsx(Wr,{leaseId:p,open:x,onClose:y})]})};function ft({data:s,columns:t,loading:a=!1,onRowClick:l,emptyMessage:o="Aucune donnée disponible"}){return a?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs(Ss,{children:[e.jsx(As,{children:e.jsx(Se,{children:t.map((p,c)=>e.jsx(ae,{className:p.className,children:p.header},c))})}),e.jsx(Cs,{children:s.length===0?e.jsx(Se,{children:e.jsx(se,{colSpan:t.length,className:"text-center text-muted-foreground",children:o})}):s.map((p,c)=>e.jsx(Se,{onClick:()=>l==null?void 0:l(p),className:l?"cursor-pointer hover:bg-muted/50":"",children:t.map((x,v)=>{const S=typeof x.accessor=="function"?x.accessor(p):p[x.accessor];return e.jsx(se,{className:x.className,children:S},v)})},p.id||c))})]})}const Jr=({className:s,...t})=>e.jsx("nav",{role:"navigation","aria-label":"pagination",className:E("mx-auto flex w-full justify-center",s),...t});Jr.displayName="Pagination";const Qr=r.forwardRef(({className:s,...t},a)=>e.jsx("ul",{ref:a,className:E("flex flex-row items-center gap-1",s),...t}));Qr.displayName="PaginationContent";const Qs=r.forwardRef(({className:s,...t},a)=>e.jsx("li",{ref:a,className:E("",s),...t}));Qs.displayName="PaginationItem";const jt=({className:s,isActive:t,size:a="icon",...l})=>e.jsx("a",{"aria-current":t?"page":void 0,className:E(ys({variant:t?"outline":"ghost",size:a}),s),...l});jt.displayName="PaginationLink";const Zr=({className:s,...t})=>e.jsxs(jt,{"aria-label":"Go to previous page",size:"default",className:E("gap-1 pl-2.5",s),...t,children:[e.jsx(jr,{className:"h-4 w-4"}),e.jsx("span",{children:"Previous"})]});Zr.displayName="PaginationPrevious";const ei=({className:s,...t})=>e.jsxs(jt,{"aria-label":"Go to next page",size:"default",className:E("gap-1 pr-2.5",s),...t,children:[e.jsx("span",{children:"Next"}),e.jsx(mt,{className:"h-4 w-4"})]});ei.displayName="PaginationNext";const si=({className:s,...t})=>e.jsxs("span",{"aria-hidden":!0,className:E("flex h-9 w-9 items-center justify-center",s),...t,children:[e.jsx(Ji,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"More pages"})]});si.displayName="PaginationEllipsis";const Dt={lease_certified:"Bail certifié",lease_rejected:"Bail rejeté",lease_pending:"Bail en attente",role_assigned:"Rôle attribué",role_revoked:"Rôle révoqué",dispute_open:"Litige ouvert",dispute_resolved:"Litige résolu",dispute_in_progress:"Litige en cours",dispute_closed:"Litige fermé"},$l=s=>s.includes("certified")||s.includes("resolved")?"default":s.includes("rejected")||s.includes("revoked")?"destructive":s.includes("assigned")?"secondary":"outline",Tt=50;function zl(){const[s,t]=r.useState([]),[a,l]=r.useState([]),[o,p]=r.useState(!0),[c,x]=r.useState(""),[v,S]=r.useState("all"),[g,y]=r.useState("all"),[n,h]=r.useState(new Set),[i,d]=r.useState(1),[f,M]=r.useState({from:qs(ma(),7),to:Ys(new Date)}),[R,N]=r.useState([]);os();const{hasRole:j}=Ke(),A=j("super_admin");r.useEffect(()=>{O()},[f]),r.useEffect(()=>{ce()},[s,c,v,g]),r.useEffect(()=>{if(a.length>0){const w=q(a);N(w),w.length>0&&A&&L(w)}},[a,A]);const O=async()=>{try{p(!0);const{data:w,error:z}=await b.from("admin_audit_logs").select("*").gte("created_at",f.from.toISOString()).lte("created_at",f.to.toISOString()).order("created_at",{ascending:!1});if(z)throw z;if(w&&w.length>0){const ne=Array.from(new Set(w.map(le=>le.admin_id))),{data:ue}=await b.from("profiles").select("id, full_name, avatar_url").in("id",ne),ye=new Map((ue==null?void 0:ue.map(le=>[le.id,le]))||[]),De=w.map(le=>({...le,admin:ye.get(le.admin_id)?{full_name:ye.get(le.admin_id).full_name,avatar_url:ye.get(le.admin_id).avatar_url}:void 0}));t(De)}else t([])}catch(w){fs(w,"Impossible de charger les logs d'audit")}finally{p(!1)}},q=w=>{const z=[],ne=new Date,ue=new Date(ne.getTime()-60*1e3),ye=8,De=18,qe=w.filter(Q=>new Date(Q.created_at)>ue).reduce((Q,J)=>(Q[J.admin_id]||(Q[J.admin_id]=[]),Q[J.admin_id].push(J),Q),{});Object.entries(qe).forEach(([Q,J])=>{var fe;J.length>10&&z.push({admin_id:Q,admin_name:((fe=J[0].admin)==null?void 0:fe.full_name)||"Inconnu",activity_type:"Actions en masse",details:`${J.length} actions en moins d'une minute`,log_count:J.length,timestamp:J[0].created_at})});const Ue={};w.forEach(Q=>{Q.ip_address&&(Ue[Q.admin_id]||(Ue[Q.admin_id]=new Set),Ue[Q.admin_id].add(Q.ip_address))}),Object.entries(Ue).forEach(([Q,J])=>{var fe;if(J.size>3){const Ee=w.find(ms=>ms.admin_id===Q);z.push({admin_id:Q,admin_name:((fe=Ee==null?void 0:Ee.admin)==null?void 0:fe.full_name)||"Inconnu",activity_type:"IPs multiples",details:`Connexions depuis ${J.size} adresses IP différentes`,log_count:J.size,timestamp:(Ee==null?void 0:Ee.created_at)||new Date().toISOString()})}});const ds=["role_assigned","role_revoked","lease_rejected"],Ze=w.filter(Q=>{const J=new Date(Q.created_at).getHours();return ds.includes(Q.action_type)&&(J<ye||J>=De)}).reduce((Q,J)=>(Q[J.admin_id]||(Q[J.admin_id]=[]),Q[J.admin_id].push(J),Q),{});Object.entries(Ze).forEach(([Q,J])=>{var fe;J.length>0&&z.push({admin_id:Q,admin_name:((fe=J[0].admin)==null?void 0:fe.full_name)||"Inconnu",activity_type:"Actions critiques hors heures",details:`${J.length} action(s) critique(s) hors des heures de bureau`,log_count:J.length,timestamp:J[0].created_at})});const $e=w.filter(Q=>Q.action_type.includes("delete")||Q.action_type.includes("revoke")).reduce((Q,J)=>(Q[J.admin_id]||(Q[J.admin_id]=[]),Q[J.admin_id].push(J),Q),{});return Object.entries($e).forEach(([Q,J])=>{var fe;J.length>5&&z.push({admin_id:Q,admin_name:((fe=J[0].admin)==null?void 0:fe.full_name)||"Inconnu",activity_type:"Suppressions répétées",details:`${J.length} tentative(s) de suppression/révocation`,log_count:J.length,timestamp:J[0].created_at})}),z},L=async w=>{try{const{error:z}=await b.functions.invoke("alert-suspicious-activity",{body:{suspicious_activities:w}});z&&G.error("Error sending suspicious activity alerts",{error:z})}catch(z){G.error("Failed to invoke alert function",{error:z})}},ce=()=>{let w=s;c&&(w=w.filter(z=>{var ne,ue,ye;return z.target_id.toLowerCase().includes(c.toLowerCase())||((ne=z.notes)==null?void 0:ne.toLowerCase().includes(c.toLowerCase()))||((ye=(ue=z.admin)==null?void 0:ue.full_name)==null?void 0:ye.toLowerCase().includes(c.toLowerCase()))})),v!=="all"&&(w=w.filter(z=>z.action_type===v)),g!=="all"&&(w=w.filter(z=>z.target_type===g)),l(w),d(1)},oe=()=>{const w=["Date","Admin","Action","Type Cible","ID Cible","IP","Notes"],z=a.map(le=>{var qe;return[me(new Date(le.created_at),"dd/MM/yyyy HH:mm",{locale:be}),((qe=le.admin)==null?void 0:qe.full_name)||le.admin_id,Dt[le.action_type]||le.action_type,le.target_type,le.target_id,le.ip_address||"-",le.notes||""]}),ne=[w.join(","),...z.map(le=>le.map(qe=>`"${qe}"`).join(","))].join(`
`),ue=new Blob([ne],{type:"text/csv"}),ye=window.URL.createObjectURL(ue),De=document.createElement("a");De.href=ye,De.download=`audit_logs_${me(new Date,"yyyy-MM-dd")}.csv`,De.click()},Y=w=>{h(z=>{const ne=new Set(z);return ne.has(w)?ne.delete(w):ne.add(w),ne})},T=w=>{const z=ma();switch(w){case"today":M({from:St(z),to:Ys(z)});break;case"7days":M({from:qs(z,7),to:Ys(z)});break;case"30days":M({from:qs(z,30),to:Ys(z)});break}},k={totalToday:s.filter(w=>new Date(w.created_at)>=St(new Date)).length,criticalActions:s.filter(w=>["role_assigned","role_revoked","lease_rejected"].includes(w.action_type)).length,uniqueAdmins:new Set(s.map(w=>w.admin_id)).size,lastAction:s.length>0?s[0].created_at:null},m=Math.ceil(a.length/Tt),u=a.slice((i-1)*Tt,i*Tt),F=[{header:"",accessor:w=>e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>Y(w.id),children:n.has(w.id)?e.jsx(Ut,{className:"h-4 w-4"}):e.jsx(mt,{className:"h-4 w-4"})}),className:"w-12"},{header:"Date",accessor:w=>me(new Date(w.created_at),"dd/MM HH:mm",{locale:be}),className:"font-medium"},{header:"Admin",accessor:w=>{var z,ne,ue,ye;return e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ge,{className:"h-6 w-6",children:[e.jsx(ut,{src:((z=w.admin)==null?void 0:z.avatar_url)||""}),e.jsx(Qe,{children:((ue=(ne=w.admin)==null?void 0:ne.full_name)==null?void 0:ue.charAt(0))||"?"})]}),e.jsx("span",{className:"text-sm",children:((ye=w.admin)==null?void 0:ye.full_name)||"Inconnu"})]})}},{header:"Action",accessor:w=>e.jsx($,{variant:$l(w.action_type),children:Dt[w.action_type]||w.action_type})},{header:"Type",accessor:"target_type"},{header:"Notes",accessor:w=>e.jsx("span",{className:"text-sm text-muted-foreground truncate max-w-xs block",children:w.notes||"-"})}],V=Array.from(new Set(s.map(w=>w.action_type))),H=Array.from(new Set(s.map(w=>w.target_type)));return e.jsxs("div",{className:"space-y-4",children:[R.length>0&&e.jsxs(ls,{variant:"destructive",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx(Vs,{children:"⚠️ Activité suspecte détectée"}),e.jsxs(cs,{children:[R.length," activité(s) suspecte(s) détectée(s) dans les logs récents.",e.jsx("ul",{className:"mt-2 space-y-1",children:R.slice(0,3).map((w,z)=>e.jsxs("li",{className:"text-sm",children:[e.jsx("strong",{children:w.admin_name}),": ",w.activity_type," - ",w.details]},z))}),R.length>3&&e.jsxs("p",{className:"text-sm mt-1",children:["... et ",R.length-3," autre(s)"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2 space-y-0",children:[e.jsx(I,{className:"text-sm font-medium",children:"Logs du jour"}),e.jsx(tt,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:k.totalToday})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2 space-y-0",children:[e.jsx(I,{className:"text-sm font-medium",children:"Actions critiques"}),e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:k.criticalActions})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2 space-y-0",children:[e.jsx(I,{className:"text-sm font-medium",children:"Admins actifs"}),e.jsx(Ge,{className:"h-4 w-4"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:k.uniqueAdmins})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between pb-2 space-y-0",children:[e.jsx(I,{className:"text-sm font-medium",children:"Dernière action"}),e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-sm",children:k.lastAction?me(new Date(k.lastAction),"HH:mm",{locale:be}):"-"})})]})]}),e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{children:["Journal d'Audit ",!A&&"(Vos actions uniquement)"]}),e.jsx(je,{children:A?"Historique de toutes les actions administratives (rétention: 1 an)":"Historique de vos actions administratives"})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(P,{variant:"outline",size:"sm",onClick:()=>T("today"),children:"Aujourd'hui"}),e.jsx(P,{variant:"outline",size:"sm",onClick:()=>T("7days"),children:"7 derniers jours"}),e.jsx(P,{variant:"outline",size:"sm",onClick:()=>T("30days"),children:"30 derniers jours"}),e.jsxs(it,{children:[e.jsx(nt,{asChild:!0,children:e.jsxs(P,{variant:"outline",size:"sm",children:[e.jsx($s,{className:"mr-2 h-4 w-4"}),me(f.from,"dd/MM/yy",{locale:be})," - ",me(f.to,"dd/MM/yy",{locale:be})]})}),e.jsx(Bs,{className:"w-auto p-0",align:"start",children:e.jsx(bs,{mode:"single",selected:f.from,onSelect:w=>w&&M({...f,from:St(w)}),initialFocus:!0,className:E("p-3 pointer-events-auto")})})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Ka,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Je,{placeholder:"Rechercher par nom, ID, notes...",value:c,onChange:w=>x(w.target.value),className:"pl-9"})]}),e.jsxs(we,{value:v,onValueChange:S,children:[e.jsx(ge,{className:"w-[200px]",children:e.jsx(_e,{placeholder:"Type d'action"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Toutes les actions"}),V.map(w=>e.jsx(B,{value:w,children:Dt[w]||w},w))]})]}),e.jsxs(we,{value:g,onValueChange:y,children:[e.jsx(ge,{className:"w-[200px]",children:e.jsx(_e,{placeholder:"Type de cible"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Toutes les cibles"}),H.map(w=>e.jsx(B,{value:w,children:w},w))]})]}),e.jsxs(P,{onClick:oe,variant:"outline",children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Exporter"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ft,{data:u,columns:F,loading:o,emptyMessage:"Aucun log d'audit trouvé"}),u.map(w=>n.has(w.id)&&e.jsx(_,{className:"ml-12 bg-muted/50",children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"ID Cible"}),e.jsx("p",{className:"font-mono text-xs",children:w.target_id})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"ID Admin"}),e.jsx("p",{className:"font-mono text-xs",children:w.admin_id})]}),w.ip_address&&e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Adresse IP"}),e.jsx("p",{className:"font-mono text-xs",children:w.ip_address})]}),w.user_agent&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"font-semibold",children:"User Agent"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:w.user_agent})]}),w.old_values&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"font-semibold mb-2",children:"Anciennes valeurs"}),e.jsx("pre",{className:"bg-background p-2 rounded text-xs overflow-x-auto",children:JSON.stringify(w.old_values,null,2)})]}),w.new_values&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("p",{className:"font-semibold mb-2",children:"Nouvelles valeurs"}),e.jsx("pre",{className:"bg-background p-2 rounded text-xs overflow-x-auto",children:JSON.stringify(w.new_values,null,2)})]})]})})},`detail-${w.id}`))]}),m>1&&e.jsx(Jr,{children:e.jsxs(Qr,{children:[e.jsx(Qs,{children:e.jsx(Zr,{onClick:()=>d(w=>Math.max(1,w-1)),className:i===1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:Math.min(5,m)},(w,z)=>{const ne=z+1;return e.jsx(Qs,{children:e.jsx(jt,{onClick:()=>d(ne),isActive:i===ne,className:"cursor-pointer",children:ne})},ne)}),m>5&&e.jsx(si,{}),e.jsx(Qs,{children:e.jsx(ei,{onClick:()=>d(w=>Math.min(m,w+1)),className:i===m?"pointer-events-none opacity-50":"cursor-pointer"})})]})}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[a.length," log(s) affiché(s) sur ",s.length," au total"]})]})]})]})}const ja=["landlord_name","landlord_address","landlord_phone","tenant_name","tenant_address","tenant_phone","property_address","property_type","bedrooms","bathrooms","surface_area","monthly_rent","deposit_amount","charges_amount","start_date","end_date","lease_duration"];function Vl(){var k,m;const[s,t]=r.useState([]),[a,l]=r.useState(!0),[o,p]=r.useState(null),[c,x]=r.useState(null),[v,S]=r.useState(!1),[g,y]=r.useState(!1),[n,h]=r.useState({name:"",description:"",template_type:"residential",sections:[{title:"",content:""}]}),[i,d]=r.useState(0),{toast:f}=os();r.useEffect(()=>{M()},[]);const M=async()=>{try{const{data:u,error:F}=await b.from("lease_templates").select("*").order("is_default",{ascending:!1}).order("created_at",{ascending:!1});if(F)throw F;t(u||[])}catch{f({title:"Erreur",description:"Impossible de charger les modèles",variant:"destructive"})}finally{l(!1)}},R=()=>{p(null),h({name:"",description:"",template_type:"residential",sections:[{title:"Nouvelle section",content:""}]}),d(0),S(!0)},N=u=>{p(u),h({name:u.name,description:u.description||"",template_type:u.template_type,sections:u.content.sections}),d(0),S(!0)},j=async u=>{try{const{error:F}=await b.from("lease_templates").insert({name:`${u.name} (copie)`,description:u.description,template_type:u.template_type,content:u.content,variables:u.variables,is_active:!1,is_default:!1});if(F)throw F;f({title:"Succès",description:"Modèle dupliqué avec succès"}),M()}catch(F){f({title:"Erreur",description:F.message,variant:"destructive"})}},A=async u=>{if(confirm("Êtes-vous sûr de vouloir supprimer ce modèle ?"))try{const{error:F}=await b.from("lease_templates").delete().eq("id",u);if(F)throw F;f({title:"Succès",description:"Modèle supprimé avec succès"}),M()}catch(F){f({title:"Erreur",description:F.message,variant:"destructive"})}},O=async()=>{try{const u={name:n.name,description:n.description,template_type:n.template_type,content:{sections:n.sections},variables:ja};if(o){const{error:F}=await b.from("lease_templates").update(u).eq("id",o.id);if(F)throw F;f({title:"Succès",description:"Modèle mis à jour avec succès"})}else{const{error:F}=await b.from("lease_templates").insert(u);if(F)throw F;f({title:"Succès",description:"Modèle créé avec succès"})}S(!1),M()}catch(u){f({title:"Erreur",description:u.message,variant:"destructive"})}},q=u=>{const F=n.sections[i],V=F.content+`{{${u}}}`,H=[...n.sections];H[i]={...F,content:V},h({...n,sections:H})},L=(u,F,V)=>{const H=[...n.sections];H[u]={...H[u],[F]:V},h({...n,sections:H})},ce=()=>{h({...n,sections:[...n.sections,{title:"Nouvelle section",content:""}]}),d(n.sections.length)},oe=u=>{if(n.sections.length===1){f({title:"Erreur",description:"Un modèle doit avoir au moins une section",variant:"destructive"});return}const F=n.sections.filter((V,H)=>H!==u);h({...n,sections:F}),d(Math.max(0,i-1))},Y=u=>{const F={landlord_name:"Jean DUPONT",landlord_address:"123 Avenue de la République, Abidjan",landlord_phone:"+225 07 12 34 56 78",tenant_name:"Marie KOUASSI",tenant_address:"456 Boulevard Latrille, Abidjan",tenant_phone:"+225 05 98 76 54 32",property_address:"Cocody Riviera Golf, Villa 789",property_type:"Villa",bedrooms:"3",bathrooms:"2",surface_area:"150",monthly_rent:"500 000",deposit_amount:"1 000 000",charges_amount:"50 000",start_date:"01/01/2025",end_date:"31/12/2025",lease_duration:"12 mois"};return u.content.sections.map((V,H)=>{let w=V.content;return Object.entries(F).forEach(([z,ne])=>{w=w.replace(new RegExp(`{{${z}}}`,"g"),ne)}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-bold mb-2",children:V.title}),e.jsx("p",{className:"whitespace-pre-wrap text-sm",children:w})]},H)})},T=[{accessorKey:"name",header:"Nom du modèle",cell:({row:u})=>e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:u.original.name}),u.original.is_default&&e.jsx($,{variant:"secondary",className:"mt-1",children:"Par défaut"})]})},{accessorKey:"template_type",header:"Type",cell:({row:u})=>e.jsx($,{variant:"outline",children:u.original.template_type==="residential"?"Résidentiel":u.original.template_type})},{accessorKey:"is_active",header:"Statut",cell:({row:u})=>e.jsx($,{variant:u.original.is_active?"default":"secondary",children:u.original.is_active?"Actif":"Inactif"})},{id:"actions",header:"Actions",cell:({row:u})=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>{x(u.original),y(!0)},children:e.jsx($t,{className:"h-4 w-4"})}),e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>N(u.original),children:e.jsx(Mt,{className:"h-4 w-4"})}),e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>j(u.original),children:e.jsx(Qi,{className:"h-4 w-4"})}),!u.original.is_default&&e.jsx(P,{variant:"ghost",size:"sm",onClick:()=>A(u.original.id),children:e.jsx(ca,{className:"h-4 w-4"})})]})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Modèles de Baux"}),e.jsx("p",{className:"text-muted-foreground",children:"Gérez les modèles de contrats de location"})]}),e.jsxs(P,{onClick:R,children:[e.jsx(la,{className:"h-4 w-4 mr-2"}),"Nouveau modèle"]})]}),e.jsx(ft,{columns:T,data:s,loading:a}),e.jsx(ze,{open:v,onOpenChange:S,children:e.jsxs(Le,{className:"max-w-6xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ve,{children:[e.jsx(Be,{children:o?"Modifier le modèle":"Nouveau modèle"}),e.jsx(We,{children:"Personnalisez votre modèle de bail en utilisant les variables disponibles"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Nom du modèle"}),e.jsx(Je,{value:n.name,onChange:u=>h({...n,name:u.target.value}),placeholder:"Ex: Bail résidentiel standard"})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Description"}),e.jsx(ps,{value:n.description,onChange:u=>h({...n,description:u.target.value}),placeholder:"Description du modèle",rows:3})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Type"}),e.jsxs(we,{value:n.template_type,onValueChange:u=>h({...n,template_type:u}),children:[e.jsx(ge,{children:e.jsx(_e,{})}),e.jsxs(ve,{children:[e.jsx(B,{value:"residential",children:"Résidentiel"}),e.jsx(B,{value:"commercial",children:"Commercial"})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx(W,{children:"Sections"}),e.jsx(P,{size:"sm",variant:"outline",onClick:ce,children:e.jsx(la,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-2",children:n.sections.map((u,F)=>e.jsxs("div",{className:`p-2 rounded border cursor-pointer flex justify-between items-center ${F===i?"bg-accent":""}`,onClick:()=>d(F),children:[e.jsx("span",{className:"text-sm truncate",children:u.title||"Sans titre"}),n.sections.length>1&&e.jsx(P,{size:"sm",variant:"ghost",onClick:V=>{V.stopPropagation(),oe(F)},children:e.jsx(ca,{className:"h-3 w-3"})})]},F))})]}),e.jsxs("div",{children:[e.jsx(W,{className:"mb-2",children:"Variables disponibles"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:ja.map(u=>e.jsx($,{variant:"outline",className:"cursor-pointer hover:bg-accent",onClick:()=>q(u),children:u},u))})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(W,{children:"Titre de la section"}),e.jsx(Je,{value:((k=n.sections[i])==null?void 0:k.title)||"",onChange:u=>L(i,"title",u.target.value),placeholder:"Ex: Parties au contrat"})]}),e.jsxs("div",{children:[e.jsx(W,{children:"Contenu de la section"}),e.jsx(ps,{value:((m=n.sections[i])==null?void 0:m.content)||"",onChange:u=>L(i,"content",u.target.value),placeholder:"Saisissez le contenu. Cliquez sur une variable pour l'insérer.",rows:20,className:"font-mono text-sm"})]})]}),e.jsxs("div",{className:"border rounded-lg p-4 overflow-y-auto max-h-[600px]",children:[e.jsx("h4",{className:"font-bold mb-4",children:"Aperçu en temps réel"}),Y({...o,content:{sections:n.sections}})]})]}),e.jsxs(is,{children:[e.jsx(P,{variant:"outline",onClick:()=>S(!1),children:"Annuler"}),e.jsx(P,{onClick:O,children:o?"Mettre à jour":"Créer"})]})]})}),e.jsx(ze,{open:g,onOpenChange:y,children:e.jsxs(Le,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(Ve,{children:[e.jsx(Be,{children:c==null?void 0:c.name}),e.jsx(We,{children:c==null?void 0:c.description})]}),e.jsx("div",{className:"border rounded-lg p-6 space-y-4",children:c&&Y(c)}),e.jsx(is,{children:e.jsx(P,{onClick:()=>y(!1),children:"Fermer"})})]})})]})}function Bl(){const{user:s,hasRole:t,refreshProfile:a}=Ke(),[l,o]=r.useState(!1),{toast:p}=os(),c=t("super_admin"),x=async()=>{if(s){o(!0);try{const{error:v}=await b.rpc("promote_to_super_admin",{target_user_id:s.id});if(v)throw v;p({title:"Promotion réussie",description:"Vous êtes maintenant Super Admin. Veuillez rafraîchir la page."}),await a(),setTimeout(()=>{window.location.reload()},2e3)}catch(v){p({title:"Erreur",description:v.message||"Impossible de vous promouvoir",variant:"destructive"})}finally{o(!1)}}};return c?e.jsxs(ls,{children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx(cs,{children:"Vous êtes déjà Super Admin"})]}):e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"Devenir Super Admin"]}),e.jsx(je,{children:"Première connexion ? Promouvez-vous en Super Admin pour accéder à toutes les fonctionnalités d'administration."})]}),e.jsxs(C,{children:[e.jsx(ls,{className:"mb-4",children:e.jsxs(cs,{children:[e.jsx("strong",{children:"Note importante :"})," Cette action est réservée au premier administrateur. Par la suite, seuls les Super Admins pourront promouvoir d'autres utilisateurs."]})}),e.jsx(P,{onClick:x,disabled:l,className:"w-full",children:l?e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"h-4 w-4 mr-2 animate-spin"}),"Promotion en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Me promouvoir en Super Admin"]})})]})]})}const Gl=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(!0),[o,p]=r.useState("all"),[c,x]=r.useState("");r.useEffect(()=>{v()},[o]);const v=async()=>{l(!0);try{let i=b.from("sensitive_data_access_log").select("*").order("accessed_at",{ascending:!1}).limit(100);o!=="all"&&(i=i.eq("data_type",o)),c.trim()&&(i=i.or(`requester_id.eq.${c},target_user_id.eq.${c}`));const{data:d,error:f}=await i;f?(G.error("Error fetching access logs",{error:f}),K({title:"Erreur",description:"Impossible de charger les logs d'accès",variant:"destructive"})):t(d||[])}catch(i){G.error("Exception fetching logs",{error:i})}finally{l(!1)}},S=i=>{switch(i){case"phone":return"📱";case"verification":return"🆔";case"payment":return"💳";case"dispute":return"⚖️";default:return"📄"}},g=i=>i?e.jsxs($,{variant:"default",className:"bg-green-600",children:[e.jsx(he,{className:"w-3 h-3 mr-1"}),"Autorisé"]}):e.jsxs($,{variant:"destructive",children:[e.jsx(de,{className:"w-3 h-3 mr-1"}),"Refusé"]}),y=i=>{const d={self:"bg-primary",admin:"bg-destructive",landlord_to_applicant:"bg-success",applicant_to_landlord:"bg-success",lease_party:"bg-warning",unauthorized:"bg-destructive"};return e.jsx($,{variant:"outline",className:d[i]||"",children:i})},n=s.filter(i=>!i.access_granted),h=n.filter(i=>{const d=new Date(i.accessed_at).getTime(),f=Date.now()-60*60*1e3;return d>f});return e.jsxs("div",{className:"space-y-4",children:[h.length>10&&e.jsx(_,{className:"border-red-500 bg-red-50 dark:bg-red-950",children:e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2 text-red-900 dark:text-red-100",children:[e.jsx(Ne,{className:"h-5 w-5"}),"Activité suspecte détectée"]}),e.jsxs(je,{className:"text-red-800 dark:text-red-200",children:[h.length," tentatives d'accès non autorisées dans la dernière heure"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsx(I,{className:"text-sm font-medium",children:"Total accès"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:s.length})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsx(I,{className:"text-sm font-medium",children:"Autorisés"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold text-green-600",children:s.filter(i=>i.access_granted).length})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsx(I,{className:"text-sm font-medium",children:"Refusés"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold text-red-600",children:n.length})})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-2",children:e.jsx(I,{className:"text-sm font-medium",children:"Dernière heure"})}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:h.length})})]})]}),e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"Logs d'accès aux données sensibles"]}),e.jsx(je,{children:"Surveillance des accès aux numéros de téléphone, vérifications, paiements, etc."})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsxs(we,{value:o,onValueChange:p,children:[e.jsx(ge,{className:"w-[200px]",children:e.jsx(_e,{placeholder:"Type de données"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Tous les types"}),e.jsx(B,{value:"phone",children:"📱 Téléphone"}),e.jsx(B,{value:"verification",children:"🆔 Vérification"}),e.jsx(B,{value:"payment",children:"💳 Paiement"}),e.jsx(B,{value:"dispute",children:"⚖️ Dispute"})]})]}),e.jsx(Je,{placeholder:"Rechercher par User ID...",value:c,onChange:i=>x(i.target.value),onKeyDown:i=>{i.key==="Enter"&&v()}})]}),a?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(ke,{className:"h-8 w-8 animate-spin"})}):s.length===0?e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"Aucun log d'accès trouvé"}):e.jsx("div",{className:"space-y-2",children:s.map(i=>e.jsx("div",{className:"border rounded-lg p-4 hover:bg-accent/50 transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:S(i.data_type)}),e.jsx("span",{className:"font-medium",children:i.data_type}),g(i.access_granted),y(i.relationship_type)]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[e.jsxs("span",{className:"font-mono",children:[i.requester_id.substring(0,8),"..."]})," → ",e.jsxs("span",{className:"font-mono",children:[i.target_user_id.substring(0,8),"..."]})]})]}),e.jsx("div",{className:"text-xs text-muted-foreground text-right",children:new Date(i.accessed_at).toLocaleString("fr-FR",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})]})},i.id))})]})]})]})},Hl=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(!0),[o,p]=r.useState(null),c=n=>{const h=new Date(n.grace_period_expires_at),i=new Date,d=Math.ceil((h.getTime()-i.getTime())/(1e3*60*60*24));let f;return n.has_mfa?f="compliant":d<0?f="critical":d<=3?f="warning":f="compliant",{...n,days_remaining:Math.max(0,d),status:f}},x=r.useCallback(async()=>{try{l(!0),p(null);const{data:n,error:h}=await b.rpc("check_admin_mfa_compliance");if(h)throw h;const i=(n||[]).map(c);t(i)}catch(n){G.logError(n,{context:"useMfaCompliance",action:"fetch"}),p(n)}finally{l(!1)}},[]);r.useEffect(()=>{x();const n=setInterval(x,6e4);return()=>clearInterval(n)},[x]);const v=r.useCallback(()=>{x()},[x]),S=s.filter(n=>n.status==="compliant").length,g=s.filter(n=>n.status==="warning").length,y=s.filter(n=>n.status==="critical").length;return{admins:s,loading:a,error:o,refresh:v,stats:{total:s.length,compliant:S,warning:g,critical:y}}},Kl=()=>{const{admins:s,loading:t,stats:a,refresh:l}=Hl(),{toast:o}=os(),[p,c]=r.useState(null),x=async(g,y)=>{c(g);try{await new Promise(n=>setTimeout(n,1e3)),o({title:"Rappel envoyé",description:`Notification envoyée à ${y}`})}catch{o({title:"Erreur",description:"Impossible d'envoyer la notification",variant:"destructive"})}finally{c(null)}},v=g=>{switch(g){case"compliant":return e.jsx(he,{className:"h-4 w-4 text-green-500"});case"warning":return e.jsx(Ne,{className:"h-4 w-4 text-amber-500"});case"critical":return e.jsx(de,{className:"h-4 w-4 text-destructive"})}},S=g=>g.has_mfa?e.jsxs("span",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(he,{className:"h-3 w-3"}),"Conforme"]}):g.status==="critical"?e.jsxs("span",{className:"flex items-center gap-1 text-destructive font-medium",children:[e.jsx(de,{className:"h-3 w-3"}),"Expiré depuis ",-g.days_remaining," jour",-g.days_remaining>1?"s":""]}):g.status==="warning"?e.jsxs("span",{className:"flex items-center gap-1 text-amber-600 font-medium",children:[e.jsx(xe,{className:"h-3 w-3"}),"Expire dans ",g.days_remaining," jour",g.days_remaining>1?"s":""]}):e.jsxs("span",{className:"flex items-center gap-1 text-muted-foreground",children:[e.jsx(xe,{className:"h-3 w-3"}),g.days_remaining," jours restants"]});return t?e.jsx("div",{className:"space-y-6",children:e.jsx("div",{className:"grid gap-4 md:grid-cols-4",children:[...Array(4)].map((g,y)=>e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(Ce,{className:"h-4 w-24"}),e.jsx(Ce,{className:"h-8 w-8 rounded-full"})]}),e.jsx(C,{children:e.jsx(Ce,{className:"h-8 w-16"})})]},y))})}):e.jsxs("div",{className:"space-y-6",children:[a.critical>0&&e.jsxs(ls,{variant:"destructive",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx(Vs,{children:"🚨 Action Immédiate Requise"}),e.jsxs(cs,{className:"mt-2",children:[a.critical," administrateur",a.critical>1?"s":""," doi",a.critical>1?"vent":"t"," activer la 2FA immédiatement. Leur accès aux fonctions sensibles est bloqué."]})]}),a.warning>0&&a.critical===0&&e.jsxs(ls,{className:"border-amber-500 bg-amber-50",children:[e.jsx(xe,{className:"h-4 w-4 text-amber-600"}),e.jsx(Vs,{className:"text-amber-900",children:"⚠️ Attention"}),e.jsxs(cs,{className:"text-amber-800",children:[a.warning," administrateur",a.warning>1?"s":""," doi",a.warning>1?"vent":"t"," activer la 2FA avant expiration du délai de grâce."]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Total Admins"}),e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsx(C,{children:e.jsx("div",{className:"text-2xl font-bold",children:a.total})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Conformes"}),e.jsx(he,{className:"h-4 w-4 text-green-500"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:a.compliant}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a.total>0?Math.round(a.compliant/a.total*100):0,"% du total"]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"En Attente"}),e.jsx(xe,{className:"h-4 w-4 text-amber-500"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold text-amber-600",children:a.warning}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Grace period actif"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Critiques"}),e.jsx(de,{className:"h-4 w-4 text-destructive"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold text-destructive",children:a.critical}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Grace period expiré"})]})]})]}),e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(I,{children:"État MFA des Administrateurs"}),e.jsx(je,{children:"Suivi de la conformité 2FA en temps réel"})]}),e.jsxs(P,{onClick:l,variant:"outline",size:"sm",children:[e.jsx(gr,{className:"h-4 w-4 mr-2"}),"Actualiser"]})]})}),e.jsx(C,{children:e.jsxs(Ss,{children:[e.jsx(As,{children:e.jsxs(Se,{children:[e.jsx(ae,{children:"Statut"}),e.jsx(ae,{children:"Administrateur"}),e.jsx(ae,{children:"MFA"}),e.jsx(ae,{children:"Grace Period"}),e.jsx(ae,{className:"text-right",children:"Actions"})]})}),e.jsxs(Cs,{children:[s.map(g=>e.jsxs(Se,{children:[e.jsx(se,{children:v(g.status)}),e.jsx(se,{children:e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"font-medium",children:g.full_name}),e.jsx($,{variant:g.role==="super_admin"?"default":"secondary",className:"w-fit mt-1",children:g.role==="super_admin"?"Super Admin":"Admin"})]})}),e.jsx(se,{children:g.has_mfa?e.jsx($,{variant:"outline",className:"bg-green-50 text-green-700 border-green-200",children:"Activée"}):e.jsx($,{variant:"outline",className:"bg-red-50 text-red-700 border-red-200",children:"Désactivée"})}),e.jsx(se,{children:S(g)}),e.jsx(se,{className:"text-right",children:!g.has_mfa&&e.jsxs(P,{size:"sm",variant:"outline",onClick:()=>x(g.user_id,g.full_name),disabled:p===g.user_id,children:[e.jsx(rs,{className:"h-3 w-3 mr-2"}),p===g.user_id?"Envoi...":"Rappel"]})})]},g.user_id)),s.length===0&&e.jsx(Se,{children:e.jsx(se,{colSpan:5,className:"text-center text-muted-foreground py-8",children:"Aucun administrateur trouvé"})})]})]})})]})]})},Yl=()=>{const[s,t]=r.useState(!0),[a,l]=r.useState(!1),[o,p]=r.useState(48),[c,x]=r.useState(!1),[v,S]=r.useState("none");r.useEffect(()=>{g()},[]);const g=async()=>{try{const{data:n,error:h}=await b.from("processing_config").select("*");if(h)throw h;n&&n.forEach(i=>{if(i.config_key==="application_processing_deadline_hours"){const d=i.config_value;p(d.value||48)}if(i.config_key==="auto_action_after_deadline"){const d=i.config_value;x(d.enabled||!1),S(d.action||"none")}})}catch(n){G.error("Error fetching processing config",{error:n}),K({title:"Erreur",description:"Impossible de charger la configuration",variant:"destructive"})}finally{t(!1)}},y=async()=>{l(!0);try{const{data:{user:n}}=await b.auth.getUser();if(!n)throw new Error("Non authentifié");await b.from("processing_config").update({config_value:{value:o,unit:"hours"},updated_by:n.id,updated_at:new Date().toISOString()}).eq("config_key","application_processing_deadline_hours"),await b.from("processing_config").update({config_value:{enabled:c,action:c?v:"none"},updated_by:n.id,updated_at:new Date().toISOString()}).eq("config_key","auto_action_after_deadline"),K({title:"Configuration enregistrée",description:"Les paramètres de traitement ont été mis à jour avec succès."})}catch(n){G.error("Error saving processing config",{error:n}),K({title:"Erreur",description:"Impossible de sauvegarder la configuration",variant:"destructive"})}finally{l(!1)}};return s?e.jsx(_,{children:e.jsx(C,{className:"py-12",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})})}):e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ba,{className:"h-5 w-5 text-primary"}),e.jsx(I,{children:"Configuration du Traitement des Dossiers"})]}),e.jsx(je,{children:"Gérez les délais et actions automatiques pour le traitement des candidatures"})]}),e.jsxs(C,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(W,{className:"text-base font-semibold",children:"Délai de traitement"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{htmlFor:"deadline",children:"Délai en heures"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Je,{id:"deadline",type:"number",min:24,max:168,value:o,onChange:n=>p(Math.max(24,Math.min(168,parseInt(n.target.value)||48))),className:"w-32"}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:["(",Math.round(o/24*10)/10," jours)"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Les candidatures seront marquées comme en retard après ce délai (min: 24h, max: 168h/7 jours)"})]})]}),e.jsx("div",{className:"border-t pt-6 space-y-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(W,{className:"text-base font-semibold",children:"Action automatique après délai"})]}),e.jsxs("div",{className:"flex items-center justify-between p-4 rounded-lg bg-muted/50",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx(W,{htmlFor:"auto-action-toggle",className:"text-base",children:"Activer le traitement automatique"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Les dossiers en retard seront traités automatiquement"})]}),e.jsx(Br,{id:"auto-action-toggle",checked:c,onCheckedChange:x})]}),c&&e.jsxs("div",{className:"space-y-3 ml-4 pl-4 border-l-2 border-primary/20",children:[e.jsx(W,{htmlFor:"auto-action-type",children:"Type d'action"}),e.jsxs(we,{value:v,onValueChange:n=>S(n),children:[e.jsx(ge,{id:"auto-action-type",children:e.jsx(_e,{placeholder:"Sélectionner une action"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"approved",children:"✅ Valider automatiquement"}),e.jsx(B,{value:"rejected",children:"❌ Rejeter automatiquement"}),e.jsx(B,{value:"none",children:"⏸️ Aucune action (marquage seulement)"})]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Cette action sera appliquée aux dossiers dépassant le délai configuré"}),e.jsxs(ls,{variant:"destructive",children:[e.jsx(Ne,{className:"h-4 w-4"}),e.jsx(Vs,{children:"Attention"}),e.jsxs(cs,{className:"text-sm",children:[v==="approved"&&"Les candidatures en retard seront APPROUVÉES automatiquement. Assurez-vous que c'est le comportement souhaité.",v==="rejected"&&"Les candidatures en retard seront REJETÉES automatiquement. Cela peut affecter l'expérience utilisateur.",v==="none"&&"Les candidatures seront seulement marquées comme en retard, sans action automatique."]})]})]})]})}),e.jsx("div",{className:"pt-4 flex justify-end",children:e.jsxs(P,{onClick:y,disabled:a,className:"gap-2",children:[e.jsx(Zi,{className:"h-4 w-4"}),a?"Enregistrement...":"Enregistrer la configuration"]})})]})]})},Xl=()=>{const[s,t]=r.useState(!0),[a,l]=r.useState({totalProcessed:0,avgProcessingTimeHours:0,complianceRate:0,currentOverdue:0,autoProcessed:0});r.useEffect(()=>{o()},[]);const o=async()=>{try{const{count:c}=await b.from("rental_applications").select("*",{count:"exact",head:!0}).in("status",["approved","rejected"]),{data:x}=await b.from("rental_applications").select("created_at, reviewed_at").not("reviewed_at","is",null);let v=0;if(x&&x.length>0){const h=x.reduce((i,d)=>{if(d.reviewed_at&&d.created_at){const f=new Date(d.reviewed_at).getTime()-new Date(d.created_at).getTime();return i+f/36e5}return i},0);v=Math.round(h/x.length)}const{data:S}=await b.from("rental_applications").select("processing_deadline, reviewed_at").not("reviewed_at","is",null);let g=0;if(S&&S.length>0){const h=S.filter(i=>!i.reviewed_at||!i.processing_deadline?!1:new Date(i.reviewed_at)<=new Date(i.processing_deadline)).length;g=Math.round(h/S.length*100)}const{count:y}=await b.from("rental_applications").select("*",{count:"exact",head:!0}).eq("status","pending").eq("is_overdue",!0),{count:n}=await b.from("rental_applications").select("*",{count:"exact",head:!0}).eq("auto_processed",!0);l({totalProcessed:c||0,avgProcessingTimeHours:v,complianceRate:g,currentOverdue:y||0,autoProcessed:n||0})}catch(c){G.error("Error fetching processing analytics",{error:c}),K({title:"Erreur",description:"Impossible de charger les analytics",variant:"destructive"})}finally{t(!1)}},p=async()=>{try{const{data:c,error:x}=await b.from("rental_applications").select(`
          *,
          properties (title, city, monthly_rent),
          profiles!rental_applications_applicant_id_fkey (full_name, phone)
        `).eq("status","pending").eq("is_overdue",!0).order("processing_deadline",{ascending:!0});if(x)throw x;if(!c||c.length===0){K({title:"Aucun dossier en retard",description:"Il n'y a aucun dossier en retard à exporter."});return}const S=[["ID","Candidat","Téléphone","Propriété","Ville","Loyer","Date soumission","Deadline","Score"].join(","),...c.map(n=>{var h,i,d,f,M;return[n.id,((h=n.profiles)==null?void 0:h.full_name)||"N/A",((i=n.profiles)==null?void 0:i.phone)||"N/A",((d=n.properties)==null?void 0:d.title)||"N/A",((f=n.properties)==null?void 0:f.city)||"N/A",((M=n.properties)==null?void 0:M.monthly_rent)||"0",new Date(n.created_at).toLocaleDateString("fr-FR"),n.processing_deadline?new Date(n.processing_deadline).toLocaleDateString("fr-FR"):"N/A",n.application_score||"0"].join(",")})].join(`
`),g=new Blob([S],{type:"text/csv;charset=utf-8;"}),y=document.createElement("a");y.href=URL.createObjectURL(g),y.download=`dossiers-retard-${new Date().toISOString().split("T")[0]}.csv`,y.click(),K({title:"Export réussi",description:`${c.length} dossier(s) exporté(s) avec succès.`})}catch(c){G.error("Error exporting processing analytics",{error:c}),K({title:"Erreur d'export",description:"Impossible d'exporter les dossiers",variant:"destructive"})}};return s?e.jsx(_,{children:e.jsx(C,{className:"py-12",children:e.jsx("div",{className:"flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-5",children:[e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(oa,{className:"h-4 w-4"}),"Total Traités"]})}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a.totalProcessed}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Dossiers approuvés ou rejetés"})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"Temps Moyen"]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.avgProcessingTimeHours,"h"]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["~",Math.round(a.avgProcessingTimeHours/24)," jours"]})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(Me,{className:"h-4 w-4"}),"Taux de Respect"]})}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[a.complianceRate,"%"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Traités dans les délais"})]})]}),e.jsxs(_,{className:"border-orange-200 dark:border-orange-800",children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-orange-600 flex items-center gap-2",children:[e.jsx(vr,{className:"h-4 w-4"}),"En Retard"]})}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold text-orange-600",children:a.currentOverdue}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Nécessitent attention"})]})]}),e.jsxs(_,{children:[e.jsx(D,{className:"pb-3",children:e.jsxs(I,{className:"text-sm font-medium text-muted-foreground flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Auto-traités"]})}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:a.autoProcessed}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Traités automatiquement"})]})]})]}),e.jsx(_,{children:e.jsx(D,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-5 w-5 text-primary"}),"Export des Données"]}),e.jsx(je,{children:"Exportez les dossiers en retard au format CSV"})]}),e.jsxs(P,{onClick:p,variant:"outline",className:"gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),"Exporter les dossiers en retard"]})]})})}),e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(oa,{className:"h-5 w-5 text-primary"}),"Historique des Actions Automatiques"]}),e.jsx(je,{children:"Journal des traitements automatiques effectués par le système"})]}),e.jsx(C,{children:e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:`Pour consulter l'historique complet des actions automatiques, utilisez le filtre "auto_process_overdue_applications" dans l'onglet Audit.`})})]})]})},It={users:0,properties:0,applications:0,leases:0,favorites:0,messages:0,searches:0,reviews:0,overdueApplications:0},Wl=()=>{const[s,t]=r.useState("idle"),[a,l]=r.useState(0),[o,p]=r.useState(It),[c,x]=r.useState(null),v=r.useRef(null),S=r.useRef(!0),[g,y]=r.useState(!1),n=r.useMemo(()=>[{p:10,label:"Initialisation"},{p:35,label:"Préparation des utilisateurs"},{p:60,label:"Création propriétés & candidatures"},{p:85,label:"Baux, favoris, messages"},{p:100,label:"Nettoyage & vérification"}],[]);r.useEffect(()=>()=>{var q;S.current=!1,(q=v.current)==null||q.abort()},[]);const h=r.useCallback(async()=>{for(const q of n){if(await new Promise(L=>setTimeout(L,250)),!S.current)return;l(L=>q.p>L?q.p:L)}},[n]),i=r.useCallback((q,L)=>{S.current&&q(L)},[]),d=r.useCallback(()=>{var q;(q=v.current)==null||q.abort(),v.current=null,t("idle"),l(0),p(It),x(null)},[]),f=r.useCallback(async()=>{v.current=new AbortController;const{data:q,error:L}=await b.functions.invoke("seed-demo-data",{body:{idempotencyKey:crypto.randomUUID()},signal:v.current.signal});if(L)throw new Error(L.message||"Échec de la fonction Edge");return q??{}},[]),M=r.useCallback(async()=>{y(!1),i(x,null),i(t,"seeding"),i(l,5);try{h();const q=await f();if(q.error)throw new Error(q.error);const L={...It,...q.result};r.startTransition(()=>{i(p,L),i(l,100),i(t,"success")}),Xe.success("Données de démo créées avec succès !",{description:`${L.users} utilisateurs, ${L.properties} propriétés, ${L.applications} candidatures, ${L.leases} baux créés.`})}catch(q){G.error("Error seeding demo data",{error:q});const L=q instanceof Error?q.message:typeof q=="string"?q:"Erreur lors de la création des données";i(t,"error"),i(x,L),i(l,0),Xe.error("Erreur lors de la création des données",{description:L})}finally{v.current=null}},[h,f,i]),R=s==="seeding",N=s==="success",j=s==="error",A=()=>R?e.jsx(ke,{className:"h-5 w-5 animate-spin","aria-hidden":!0}):N?e.jsx(Ye,{className:"h-5 w-5 text-green-500","aria-hidden":!0}):j?e.jsx(de,{className:"h-5 w-5 text-destructive","aria-hidden":!0}):e.jsx(_t,{className:"h-5 w-5","aria-hidden":!0}),O=R?"Génération en cours…":N?"Données créées avec succès !":j?"Erreur lors de la génération":"Prêt à générer les données";return e.jsxs(_,{"aria-busy":R,"aria-live":"polite",children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(_t,{className:"h-5 w-5","aria-hidden":!0}),"Générer des données de démonstration"]}),e.jsx(je,{children:"Crée un jeu de données complet pour tester la plateforme : utilisateurs, propriétés, candidatures, baux, etc."})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs(Gr,{open:g,onOpenChange:y,children:[e.jsx(_l,{asChild:!0,children:e.jsx(P,{className:"w-full",disabled:R,onClick:()=>y(!0),children:R?e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"mr-2 h-4 w-4 animate-spin"}),"Génération en cours…"]}):e.jsxs(e.Fragment,{children:[e.jsx(_t,{className:"mr-2 h-4 w-4"}),"Générer les données"]})})}),e.jsxs(Wt,{children:[e.jsxs(Jt,{children:[e.jsx(Zt,{children:"Générer les données de démonstration ?"}),e.jsx(ea,{asChild:!0,children:e.jsxs("div",{children:["Cette action va créer un ensemble complet de données de test incluant :",e.jsxs("ul",{className:"list-disc list-inside mt-2 space-y-1",children:[e.jsx("li",{children:"≈ 17 utilisateurs (propriétaires, agences, locataires, admins)"}),e.jsx("li",{children:"≈ 18 propriétés dans différents quartiers d'Abidjan"}),e.jsx("li",{children:"≈ 25 candidatures (dont 3 en retard)"}),e.jsx("li",{children:"≈ 4 baux (dont 2 certifiés ANSUT)"}),e.jsx("li",{children:"Favoris, messages et avis"})]}),e.jsxs("p",{className:"mt-2 text-sm",children:[e.jsx("strong",{children:"Note :"})," L'opération peut prendre quelques instants."]})]})})]}),e.jsxs(Qt,{children:[e.jsx(ta,{disabled:R,children:"Annuler"}),e.jsx(sa,{disabled:R,onClick:M,children:"Générer"})]})]})]}),s!=="idle"&&e.jsxs("div",{className:"space-y-2",role:"status","aria-label":O,children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{}),e.jsx("span",{className:"text-sm font-medium",children:O})]}),e.jsxs("span",{className:"text-sm text-muted-foreground",children:[a,"%"]})]}),e.jsx(Xt,{value:a})]}),c&&e.jsxs("div",{className:"rounded-lg bg-destructive/10 p-3 text-sm text-destructive",children:[e.jsx("strong",{children:"Erreur :"})," ",c]}),N&&e.jsxs("div",{className:"rounded-lg bg-green-500/10 p-4 space-y-3",children:[e.jsx("h4",{className:"font-semibold text-green-700 dark:text-green-400",children:"Données créées avec succès"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-2 text-sm text-muted-foreground",children:[e.jsxs("div",{children:["• ",o.users," utilisateurs"]}),e.jsxs("div",{children:["• ",o.properties," propriétés"]}),e.jsxs("div",{children:["• ",o.applications," candidatures"]}),e.jsxs("div",{children:["• ",o.leases," baux"]}),e.jsxs("div",{children:["• ",o.favorites," favoris"]}),e.jsxs("div",{children:["• ",o.messages," messages"]}),e.jsxs("div",{children:["• ",o.searches," recherches"]}),e.jsxs("div",{children:["• ",o.reviews," avis"]}),o.overdueApplications>0&&e.jsxs("div",{children:["• ",o.overdueApplications," candidatures en retard traitées"]})]}),e.jsx("div",{className:"pt-2",children:e.jsxs(P,{variant:"outline",size:"sm",onClick:d,children:[e.jsx(en,{className:"mr-2 h-4 w-4"}),"Réinitialiser l'état"]})})]})]})]})},Jl=()=>{const[s,t]=r.useState({totalCertificates:0,activeCertificates:0,expiringSoon:0,totalSignatures:0,successfulSignatures:0,failedSignatures:0,successRate:0,avgProcessingTime:0}),[a,l]=r.useState([]),[o,p]=r.useState(!0);r.useEffect(()=>{c(),x()},[]);const c=async()=>{try{const{count:S}=await b.from("digital_certificates").select("*",{count:"exact",head:!0}),{count:g}=await b.from("digital_certificates").select("*",{count:"exact",head:!0}).eq("certificate_status","active"),y=new Date;y.setDate(y.getDate()+30);const{count:n}=await b.from("digital_certificates").select("*",{count:"exact",head:!0}).eq("certificate_status","active").lt("expires_at",y.toISOString()),{count:h}=await b.from("electronic_signature_logs").select("*",{count:"exact",head:!0}),{count:i}=await b.from("electronic_signature_logs").select("*",{count:"exact",head:!0}).eq("status","completed"),{count:d}=await b.from("electronic_signature_logs").select("*",{count:"exact",head:!0}).eq("status","failed");t({totalCertificates:S||0,activeCertificates:g||0,expiringSoon:n||0,totalSignatures:h||0,successfulSignatures:i||0,failedSignatures:d||0,successRate:h?(i||0)/h*100:0,avgProcessingTime:45})}catch(S){G.error("Error fetching signature metrics",{error:S})}finally{p(!1)}},x=async()=>{const{data:S}=await b.from("electronic_signature_logs").select("*").order("created_at",{ascending:!1}).limit(10);S&&l(S)},v=[{header:"Type",accessorKey:"signature_type",cell:({row:S})=>e.jsx($,{variant:"outline",children:S.original.signature_type==="landlord"?"Propriétaire":"Locataire"})},{header:"Statut",accessorKey:"status",cell:({row:S})=>{const g=S.original.status;return e.jsx($,{variant:g==="completed"?"default":g==="failed"?"destructive":"secondary",children:g==="completed"?"Complété":g==="failed"?"Échoué":g==="in_progress"?"En cours":"Initié"})}},{header:"Date",accessorKey:"created_at",cell:({row:S})=>new Date(S.original.created_at).toLocaleDateString("fr-FR")}];return o?e.jsx("div",{children:"Chargement..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Certificats Actifs"}),e.jsx(pe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.activeCertificates}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["sur ",s.totalCertificates," total"]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Taux de Succès"}),e.jsx(Me,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[s.successRate.toFixed(1),"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.successfulSignatures," / ",s.totalSignatures," signatures"]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Certificats Expirant"}),e.jsx(xe,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.expiringSoon}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"dans les 30 prochains jours"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Échecs"}),e.jsx(de,{className:"h-4 w-4 text-muted-foreground"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.failedSignatures}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"signatures échouées"})]})]})]}),e.jsxs(_,{children:[e.jsx(D,{children:e.jsx(I,{children:"Signatures Récentes"})}),e.jsx(C,{children:e.jsx(ft,{columns:v,data:a})})]})]})},Ql=30,Zl=2e3,kt=10,ec=()=>{const[s,t]=r.useState([]),[a,l]=r.useState(!0),[o,p]=r.useState(!1),[c,x]=r.useState(null),[v,S]=r.useState(""),[g,y]=r.useState("all"),[n,h]=r.useState("all"),[i,d]=r.useState(1);r.useEffect(()=>{f()},[]);const f=async()=>{try{l(!0);const{data:m,error:u}=await b.from("digital_certificates").select("*, user:profiles(full_name)").order("created_at",{ascending:!1});if(u)throw u;m&&t(m)}catch(m){G.error("Error fetching certificates",{error:m}),K({title:"Erreur de chargement",description:"Impossible de charger les certificats.",variant:"destructive"})}finally{l(!1)}},M=r.useCallback(m=>{const F=(new Date(m).getTime()-Date.now())/(1e3*60*60*24);return F<Ql&&F>0},[]),R=r.useMemo(()=>{const m=s.filter(H=>H.certificate_status==="active").length,u=s.filter(H=>H.certificate_status==="expired").length,F=s.filter(H=>H.certificate_status==="revoked").length,V=s.filter(H=>H.certificate_status==="active"&&M(H.expires_at)).length;return{total:s.length,active:m,expired:u,revoked:F,expiringSoon:V}},[s,M]),N=r.useMemo(()=>s.filter(m=>{var H,w;const u=!v||((w=(H=m.user)==null?void 0:H.full_name)==null?void 0:w.toLowerCase().includes(v.toLowerCase()))||m.certificate_id.toLowerCase().includes(v.toLowerCase()),F=g==="all"||m.certificate_status===g;let V=!0;return n==="expiring"?V=m.certificate_status==="active"&&M(m.expires_at):n==="valid"&&(V=m.certificate_status==="active"&&!M(m.expires_at)),u&&F&&V}),[s,v,g,n,M]),j=r.useMemo(()=>{const m=(i-1)*kt;return N.slice(m,m+kt)},[N,i]),A=Math.ceil(N.length/kt);r.useEffect(()=>{d(1)},[v,g,n]);const O=r.useCallback(m=>{x(m),p(!0)},[]),q=async()=>{if(c)try{const{error:m}=await b.from("digital_certificates").update({certificate_status:"revoked"}).eq("id",c);if(m)throw m;K({title:"Certificat révoqué",description:"Le certificat a été révoqué avec succès."}),f()}catch(m){G.error("Error revoking certificate",{error:m}),K({title:"Erreur",description:"Impossible de révoquer le certificat.",variant:"destructive"})}finally{p(!1),x(null)}},L=r.useCallback(async m=>{try{const{error:u}=await b.functions.invoke("cryptoneo-generate-certificate",{body:{userId:m}});if(u)throw u;K({title:"Régénération lancée",description:"Le certificat est en cours de régénération."}),setTimeout(f,Zl)}catch(u){G.error("Error regenerating certificate",{error:u}),K({title:"Erreur de régénération",description:"Impossible de régénérer le certificat.",variant:"destructive"})}},[]),ce=r.useCallback(()=>{try{const u=[["Utilisateur","Certificat ID","Statut","Date expiration","Date création"].join(","),...N.map(w=>{var z;return[`"${((z=w.user)==null?void 0:z.full_name)||"N/A"}"`,`"${w.certificate_id}"`,w.certificate_status,new Date(w.expires_at).toLocaleDateString("fr-FR"),new Date(w.created_at).toLocaleDateString("fr-FR")].join(",")})].join(`
`),F=new Blob([u],{type:"text/csv;charset=utf-8;"}),V=document.createElement("a"),H=URL.createObjectURL(F);V.setAttribute("href",H),V.setAttribute("download",`certificats_${new Date().toISOString().split("T")[0]}.csv`),V.style.visibility="hidden",document.body.appendChild(V),V.click(),document.body.removeChild(V),K({title:"Export réussi",description:`${N.length} certificat(s) exporté(s)`})}catch(m){G.error("Error exporting CSV",{error:m}),K({title:"Erreur export",description:"Impossible d'exporter les données",variant:"destructive"})}},[N]),oe=r.useCallback(()=>{S(""),y("all"),h("all")},[]),Y=v||g!=="all"||n!=="all",T=r.useCallback(m=>{const F={active:{variant:"default",label:"Actif"},expired:{variant:"secondary",label:"Expiré"},revoked:{variant:"destructive",label:"Révoqué"}}[m];return e.jsx($,{variant:F.variant,children:F.label})},[]),k=r.useMemo(()=>[{header:"Utilisateur",accessorKey:"user.full_name",cell:({row:m})=>{var u;return((u=m.original.user)==null?void 0:u.full_name)||"N/A"}},{header:"Certificat ID",accessorKey:"certificate_id",cell:({row:m})=>e.jsxs("code",{className:"text-xs bg-muted px-2 py-0.5 rounded",children:[m.original.certificate_id.substring(0,16),"..."]})},{header:"Statut",accessorKey:"certificate_status",cell:({row:m})=>T(m.original.certificate_status)},{header:"Expire le",accessorKey:"expires_at",cell:({row:m})=>{const u=new Date(m.original.expires_at),F=M(m.original.expires_at);return e.jsxs("div",{className:"flex items-center gap-2",children:[F&&e.jsx(Ne,{className:"h-3 w-3 text-orange-500"}),e.jsx("span",{children:u.toLocaleDateString("fr-FR")})]})}},{header:"Actions",id:"actions",cell:({row:m})=>{const u=m.original.certificate_status==="revoked";return e.jsxs(ht,{children:[e.jsx(pt,{asChild:!0,children:e.jsx(P,{variant:"ghost",size:"sm","aria-label":"Actions",children:e.jsx(sn,{className:"h-4 w-4"})})}),e.jsxs(Gs,{align:"end",children:[e.jsxs(Ae,{onClick:()=>L(m.original.user_id),children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Régénérer"]}),!u&&e.jsxs(e.Fragment,{children:[e.jsx(Ns,{}),e.jsx(Ae,{onClick:()=>O(m.original.id),className:"text-destructive",children:"Révoquer"})]})]})]})}}],[T,M,L,O]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 gap-4",children:[e.jsx(_,{children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total"}),e.jsx("p",{className:"text-2xl font-bold",children:R.total})]}),e.jsx(Me,{className:"h-8 w-8 text-muted-foreground"})]})})}),e.jsx(_,{children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Actifs"}),e.jsx("p",{className:"text-2xl font-bold text-green-600 dark:text-green-500",children:R.active})]}),e.jsx(pe,{className:"h-8 w-8 text-green-600 dark:text-green-500"})]})})}),e.jsx(_,{children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Expire bientôt"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600 dark:text-orange-500",children:R.expiringSoon})]}),e.jsx(Ne,{className:"h-8 w-8 text-orange-600 dark:text-orange-500"})]})})}),e.jsx(_,{children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Expirés"}),e.jsx("p",{className:"text-2xl font-bold",children:R.expired})]}),e.jsx(Ye,{className:"h-8 w-8 text-muted-foreground"})]})})}),e.jsx(_,{children:e.jsx(C,{className:"pt-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Révoqués"}),e.jsx("p",{className:"text-2xl font-bold text-red-600 dark:text-red-500",children:R.revoked})]}),e.jsx(Zs,{className:"h-8 w-8 text-red-600 dark:text-red-500"})]})})})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-4",children:[e.jsx(I,{children:"Gestion des Certificats"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(P,{variant:"outline",size:"sm",onClick:ce,disabled:a||N.length===0,children:[e.jsx(Pe,{className:"h-4 w-4 mr-2"}),"Exporter"]}),e.jsxs(P,{variant:"outline",size:"sm",onClick:f,disabled:a,children:[e.jsx(gr,{className:a?"h-4 w-4 mr-2 animate-spin":"h-4 w-4 mr-2"}),"Actualiser"]})]})]}),e.jsxs(C,{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(Je,{placeholder:"Rechercher par nom ou ID certificat...",value:v,onChange:m=>S(m.target.value),className:"max-w-sm"})}),e.jsxs(we,{value:g,onValueChange:m=>y(m),children:[e.jsx(ge,{className:"w-[180px]",children:e.jsx(_e,{placeholder:"Tous les statuts"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Tous les statuts"}),e.jsx(B,{value:"active",children:"Actif"}),e.jsx(B,{value:"expired",children:"Expiré"}),e.jsx(B,{value:"revoked",children:"Révoqué"})]})]}),e.jsxs(we,{value:n,onValueChange:m=>h(m),children:[e.jsx(ge,{className:"w-[180px]",children:e.jsx(_e,{placeholder:"Expiration"})}),e.jsxs(ve,{children:[e.jsx(B,{value:"all",children:"Toutes expirations"}),e.jsx(B,{value:"valid",children:"Valide (>30j)"}),e.jsx(B,{value:"expiring",children:"Expire bientôt (<30j)"})]})]}),Y&&e.jsxs(P,{variant:"ghost",size:"sm",onClick:oe,children:[e.jsx(Zs,{className:"h-4 w-4 mr-2"}),"Réinitialiser"]})]}),e.jsxs("div",{className:"text-sm text-muted-foreground",children:[N.length," résultat(s) trouvé(s)"]}),a?e.jsx("div",{className:"space-y-3",children:[...Array(5)].map((m,u)=>e.jsx(Ce,{className:"h-12 w-full"},u))}):N.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(pr,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{className:"text-lg font-medium",children:"Aucun certificat trouvé"}),e.jsx("p",{className:"text-sm mt-2",children:Y?"Essayez de modifier vos filtres de recherche":"Commencez par générer des certificats"})]}):e.jsxs(e.Fragment,{children:[e.jsx(ft,{columns:k,data:j}),A>1&&e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Page ",i," sur ",A]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(P,{variant:"outline",size:"sm",onClick:()=>d(m=>Math.max(1,m-1)),disabled:i===1,children:"Précédent"}),e.jsx(P,{variant:"outline",size:"sm",onClick:()=>d(m=>Math.min(A,m+1)),disabled:i===A,children:"Suivant"})]})]})]})]})]}),e.jsx(Gr,{open:o,onOpenChange:p,children:e.jsxs(Wt,{children:[e.jsxs(Jt,{children:[e.jsx(Zt,{children:"Confirmer la révocation"}),e.jsx(ea,{children:"Êtes-vous sûr de vouloir révoquer ce certificat ? Cette action est irréversible et l'utilisateur devra obtenir un nouveau certificat."})]}),e.jsxs(Qt,{children:[e.jsx(ta,{children:"Annuler"}),e.jsx(sa,{onClick:q,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Révoquer"})]})]})})]})},ga=["#8b5cf6","#06b6d4","#10b981","#f59e0b"],sc=()=>{var h;const[s,t]=r.useState(null),[a,l]=r.useState([]),[o,p]=r.useState([]),[c,x]=r.useState(!0),{toast:v}=os();r.useEffect(()=>{S()},[]);const S=async()=>{x(!0);try{const{data:i,error:d}=await b.rpc("get_alert_statistics");if(d)throw d;i&&i.length>0&&t(i[0]);const{data:f,error:M}=await b.from("alert_history").select(`
          id,
          alert_type,
          delivery_method,
          delivery_status,
          created_at,
          opened_at,
          clicked_at,
          user_id,
          property_id
        `).order("created_at",{ascending:!1}).limit(50);if(M)throw M;if(f){const A=await Promise.all(f.map(async O=>{const[q,L]=await Promise.all([O.user_id?b.from("profiles").select("full_name").eq("id",O.user_id).single():Promise.resolve({data:null}),O.property_id?b.from("properties").select("title, city").eq("id",O.property_id).single():Promise.resolve({data:null})]);return{...O,user:q.data||{full_name:"N/A"},property:L.data}}));l(A)}const R=new Date;R.setDate(R.getDate()-7);const{data:N,error:j}=await b.from("property_alerts_analytics").select("*").gte("date",R.toISOString()).order("date",{ascending:!0});if(j)throw j;p(N||[])}catch(i){G.error("Failed to fetch property alerts data",{component:"PropertyAlertsMonitor",error:i.message}),v({title:"Erreur",description:"Impossible de charger les données des alertes",variant:"destructive"})}finally{x(!1)}};if(c)return e.jsx("div",{className:"flex justify-center p-8",children:"Chargement..."});const g=o.reduce((i,d)=>{const f=i.find(M=>M.name===d.alert_type);return f?f.value+=d.total_sent:i.push({name:d.alert_type,value:d.total_sent}),i},[]),y=o.reduce((i,d)=>{const f=i.find(M=>M.name===d.delivery_method);return f?f.value+=d.total_sent:i.push({name:d.delivery_method,value:d.total_sent}),i},[]),n=o.reduce((i,d)=>{const f=new Date(d.date).toLocaleDateString("fr-FR",{month:"short",day:"numeric"}),M=i.find(R=>R.date===f);return M?(M.total+=d.total_sent,M.opened+=d.opened_count,M.clicked+=d.clicked_count):i.push({date:f,total:d.total_sent,opened:d.opened_count,clicked:d.clicked_count}),i},[]);return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs(_,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(rs,{className:"h-4 w-4 text-primary"}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Alertes Actives"})]}),e.jsx("p",{className:"text-2xl font-bold",children:(s==null?void 0:s.total_alerts_active)||0})]}),e.jsxs(_,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(tt,{className:"h-4 w-4 text-primary"}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Envoyées Aujourd'hui"})]}),e.jsx("p",{className:"text-2xl font-bold",children:(s==null?void 0:s.total_alerts_sent_today)||0})]}),e.jsxs(_,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(da,{className:"h-4 w-4 text-primary"}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Taux d'Ouverture"})]}),e.jsxs("p",{className:"text-2xl font-bold",children:[((h=s==null?void 0:s.avg_open_rate)==null?void 0:h.toFixed(1))||0,"%"]})]}),e.jsxs(_,{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(hs,{className:"h-4 w-4 text-primary"}),e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Utilisateurs"})]}),e.jsx("p",{className:"text-2xl font-bold",children:(s==null?void 0:s.users_with_alerts)||0})]})]}),e.jsxs(He,{defaultValue:"trend",children:[e.jsxs(Fe,{children:[e.jsx(te,{value:"trend",children:"Tendance 7j"}),e.jsx(te,{value:"type",children:"Par Type"}),e.jsx(te,{value:"method",children:"Par Canal"}),e.jsx(te,{value:"recent",children:"Récents"})]}),e.jsx(re,{value:"trend",children:e.jsxs(_,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Évolution des Alertes"}),e.jsx(Te,{width:"100%",height:300,children:e.jsxs(zt,{data:n,children:[e.jsx(ss,{strokeDasharray:"3 3"}),e.jsx(ts,{dataKey:"date"}),e.jsx(as,{}),e.jsx(Ie,{}),e.jsx(zs,{}),e.jsx(vs,{type:"monotone",dataKey:"total",stroke:"#8b5cf6",name:"Envoyées"}),e.jsx(vs,{type:"monotone",dataKey:"opened",stroke:"#06b6d4",name:"Ouvertes"}),e.jsx(vs,{type:"monotone",dataKey:"clicked",stroke:"#10b981",name:"Cliquées"})]})})]})}),e.jsx(re,{value:"type",children:e.jsxs(_,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Répartition par Type"}),e.jsx(Te,{width:"100%",height:300,children:e.jsxs(Vt,{children:[e.jsx(Bt,{data:g,cx:"50%",cy:"50%",labelLine:!1,label:i=>`${i.name}: ${i.value}`,outerRadius:80,fill:"#8884d8",dataKey:"value",children:g.map((i,d)=>e.jsx(Gt,{fill:ga[d%ga.length]},`cell-${d}`))}),e.jsx(Ie,{})]})})]})}),e.jsx(re,{value:"method",children:e.jsxs(_,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Répartition par Canal"}),e.jsx(Te,{width:"100%",height:300,children:e.jsxs(at,{data:y,children:[e.jsx(ss,{strokeDasharray:"3 3"}),e.jsx(ts,{dataKey:"name"}),e.jsx(as,{}),e.jsx(Ie,{}),e.jsx(rt,{dataKey:"value",fill:"#8b5cf6"})]})})]})}),e.jsx(re,{value:"recent",children:e.jsxs(_,{className:"p-6",children:[e.jsx("h3",{className:"text-lg font-semibold mb-4",children:"Alertes Récentes (50 dernières)"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2",children:"Date"}),e.jsx("th",{className:"text-left p-2",children:"Type"}),e.jsx("th",{className:"text-left p-2",children:"Canal"}),e.jsx("th",{className:"text-left p-2",children:"Utilisateur"}),e.jsx("th",{className:"text-left p-2",children:"Propriété"}),e.jsx("th",{className:"text-left p-2",children:"Statut"}),e.jsx("th",{className:"text-left p-2",children:"Engagement"})]})}),e.jsx("tbody",{children:a.map(i=>{var d;return e.jsxs("tr",{className:"border-b hover:bg-muted/50",children:[e.jsx("td",{className:"p-2",children:new Date(i.created_at).toLocaleDateString("fr-FR",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}),e.jsx("td",{className:"p-2",children:e.jsx("span",{className:"px-2 py-1 bg-primary/10 text-primary rounded text-xs",children:i.alert_type})}),e.jsxs("td",{className:"p-2",children:[i.delivery_method==="email"&&e.jsx(da,{className:"h-4 w-4 inline"}),i.delivery_method==="push"&&e.jsx(tn,{className:"h-4 w-4 inline"}),i.delivery_method==="in_app"&&e.jsx(rs,{className:"h-4 w-4 inline"})]}),e.jsx("td",{className:"p-2",children:((d=i.user)==null?void 0:d.full_name)||"N/A"}),e.jsx("td",{className:"p-2",children:i.property?`${i.property.title} (${i.property.city})`:"N/A"}),e.jsx("td",{className:"p-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs ${i.delivery_status==="sent"?"bg-green-500/10 text-green-700":i.delivery_status==="failed"?"bg-red-500/10 text-red-700":"bg-yellow-500/10 text-yellow-700"}`,children:i.delivery_status})}),e.jsx("td",{className:"p-2",children:e.jsxs("div",{className:"flex gap-2 text-xs",children:[i.opened_at&&e.jsx("span",{className:"text-green-600",children:"✓ Ouvert"}),i.clicked_at&&e.jsx("span",{className:"text-blue-600",children:"✓ Cliqué"})]})})]},i.id)})})]})})]})})]})]})},tc=()=>{const[s,t]=r.useState(""),[a,l]=r.useState("last_month"),[o,p]=r.useState(),[c,x]=r.useState(),[v,S]=r.useState("monthly"),[g,y]=r.useState(!1),[n,h]=r.useState([]),i=async()=>{const{data:f}=await b.from("properties").select("owner_id, profiles!inner(full_name)").not("owner_id","is",null),M=Array.from(new Map((f==null?void 0:f.map(R=>[R.owner_id,R.profiles]))||[]).entries()).map(([R,N])=>({id:R,full_name:N.full_name,email:N.email||"N/A"}));h(M)},d=async()=>{if(!s){Xe.error("Veuillez sélectionner un propriétaire");return}y(!0);try{const{data:f,error:M}=await b.functions.invoke("generate-report",{body:{mode:"manual",owner_id:s,start_date:a==="custom"?o==null?void 0:o.toISOString():void 0,end_date:a==="custom"?c==null?void 0:c.toISOString():void 0,report_type:v}});if(M)throw M;Xe.success(`Rapport généré et envoyé avec succès ! (${f.successful}/${f.processed})`)}catch(f){G.error("Failed to generate report",{component:"ReportGenerator",reportType:v,error:f.message}),Xe.error(`Erreur: ${f.message}`)}finally{y(!1)}};return e.jsxs(_,{className:"w-full",children:[e.jsx(D,{children:e.jsx(I,{className:"flex items-center gap-2",children:"📊 Générateur de Rapports"})}),e.jsxs(C,{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Propriétaire"}),e.jsxs(we,{value:s,onValueChange:t,children:[e.jsx(ge,{children:e.jsx(_e,{placeholder:"Sélectionner un propriétaire"})}),e.jsx(ve,{children:n.map(f=>e.jsxs(B,{value:f.id,children:[f.full_name," (",f.email,")"]},f.id))})]}),e.jsx(P,{variant:"outline",size:"sm",onClick:i,className:"mt-2",children:"Charger les propriétaires"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Période"}),e.jsx(He,{value:a,onValueChange:f=>l(f),children:e.jsxs(Fe,{className:"grid w-full grid-cols-3",children:[e.jsx(te,{value:"last_month",children:"Mois dernier"}),e.jsx(te,{value:"this_month",children:"Ce mois"}),e.jsx(te,{value:"custom",children:"Personnalisé"})]})}),a==="custom"&&e.jsxs("div",{className:"flex gap-4 mt-4",children:[e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(W,{children:"Du"}),e.jsxs(it,{children:[e.jsx(nt,{asChild:!0,children:e.jsxs(P,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx($s,{className:"mr-2 h-4 w-4"}),o?me(o,"PPP",{locale:be}):"Sélectionner"]})}),e.jsx(Bs,{className:"w-auto p-0",children:e.jsx(bs,{mode:"single",selected:o,onSelect:p})})]})]}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx(W,{children:"Au"}),e.jsxs(it,{children:[e.jsx(nt,{asChild:!0,children:e.jsxs(P,{variant:"outline",className:"w-full justify-start text-left font-normal",children:[e.jsx($s,{className:"mr-2 h-4 w-4"}),c?me(c,"PPP",{locale:be}):"Sélectionner"]})}),e.jsx(Bs,{className:"w-auto p-0",children:e.jsx(bs,{mode:"single",selected:c,onSelect:x})})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(W,{children:"Type de rapport"}),e.jsxs(we,{value:v,onValueChange:f=>S(f),children:[e.jsx(ge,{children:e.jsx(_e,{})}),e.jsxs(ve,{children:[e.jsx(B,{value:"monthly",children:"Mensuel"}),e.jsx(B,{value:"quarterly",children:"Trimestriel"}),e.jsx(B,{value:"annual",children:"Annuel"})]})]})]}),e.jsxs(P,{onClick:d,disabled:!s||g,className:"w-full",children:[g?e.jsx(ke,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(an,{className:"mr-2 h-4 w-4"}),"Générer et envoyer"]})]})]})},Xs=[{filename:"famille-heureuse-cocody",description:"Famille ivoirienne heureuse devant leur maison",prompt:"Flat design vector illustration of a happy Ivorian family standing in front of their modern house in Cocody, Abidjan. Family of 4 people (parents and 2 children) smiling, contemporary West African home with orange and blue accent colors (#E67E22, #2C5F7F). Warm, welcoming atmosphere, clean composition, professional real estate marketing style. Ultra-realistic details, vibrant colors, 16:9 aspect ratio."},{filename:"couple-visite-appartement",description:"Jeune couple visitant un appartement",prompt:"Flat design illustration of a young Ivorian couple visiting an apartment with a real estate agent. Modern interior with large windows, natural light, agent showing the property on a tablet. Contemporary style, orange and blue accent colors (#E67E22, #2C5F7F), professional and trustworthy atmosphere. Clean lines, 16:9 aspect ratio."},{filename:"agent-immobilier-presentation",description:"Agent présentant un dossier sur tablette",prompt:"Flat design illustration of a professional Ivorian real estate agent presenting a property dossier on a digital tablet. Modern office setting, confident posture, orange and blue brand colors (#E67E22, #2C5F7F). Professional, trustworthy, contemporary style. Vector-style, clean composition, 16:9 aspect ratio."},{filename:"quartier-anime-abidjan",description:"Rue animée d'Abidjan",prompt:"Flat design illustration of a vibrant Abidjan neighborhood street scene. Orange taxis, people in colorful wax fabric, local shops, modern buildings mixed with traditional architecture. Lively atmosphere, warm colors with orange and blue accents (#E67E22, #2C5F7F). West African urban life, dynamic composition, 16:9 aspect ratio."},{filename:"interieur-moderne-salon",description:"Salon ivoirien moderne",prompt:"Flat design illustration of a modern Ivorian living room interior. Contemporary furniture, large TV, West African decorative elements (wax patterns, local art), warm and welcoming atmosphere. Natural light from large windows, orange and blue accent colors (#E67E22, #2C5F7F). Cozy, professional real estate photography style, 16:9 aspect ratio."},{filename:"vue-aerienne-abidjan",description:"Skyline stylisé d'Abidjan",prompt:"Minimalist flat design illustration of Abidjan skyline view. Recognizable landmarks including Plateau business district, Henri Konan Bédié Bridge. Stylized, elegant composition with orange and blue color scheme (#E67E22, #2C5F7F). Modern, clean lines, abstract geometric shapes, 16:9 aspect ratio."},{filename:"remise-cles-ceremonie",description:"Propriétaire remettant les clés",prompt:"Flat design illustration of a property owner handing keys to a new tenant. Both people smiling, handshake gesture, keys prominently featured. Joyful and trustworthy atmosphere, orange and blue accent colors (#E67E22, #2C5F7F). Professional, warm, celebratory moment. Clean composition, 16:9 aspect ratio."},{filename:"famille-emmenagement",description:"Famille déballant des cartons",prompt:"Flat design illustration of an Ivorian family unpacking moving boxes in their new home. Happy atmosphere, children helping, cardboard boxes, furniture being arranged. Dynamic, joyful scene with orange and blue accents (#E67E22, #2C5F7F). New beginning, fresh start feeling, 16:9 aspect ratio."},{filename:"reunion-copropriete",description:"Réunion entre propriétaires",prompt:"Flat design illustration of a professional co-ownership meeting. Diverse group of Ivorian property owners and residents sitting around a modern conference table, discussing. Professional, collaborative atmosphere, orange and blue brand colors (#E67E22, #2C5F7F). Contemporary office setting, 16:9 aspect ratio."},{filename:"certification-ansut-illustration",description:"Document de certification ANSUT",prompt:"Flat design illustration of an official ANSUT certification document with official stamp and seal. Professional, institutional style, green ANSUT color (#2ECC71) combined with orange and blue (#E67E22, #2C5F7F). Official government document aesthetic, trust and security, badge with stars, 16:9 aspect ratio."}],ac=()=>{const[s,t]=r.useState(!1),[a,l]=r.useState(0),[o,p]=r.useState(""),[c,x]=r.useState({}),v=async()=>{t(!0),l(0),x({});for(let y=0;y<Xs.length;y++){const n=Xs[y];p(n.description);try{const{data:h,error:i}=await b.functions.invoke("generate-illustration",{body:{prompt:n.prompt,filename:n.filename}});if(i)throw i;h!=null&&h.imageUrl&&(x(d=>({...d,[n.filename]:h.imageUrl})),Xe.success(`Illustration générée : ${n.description}`))}catch{Xe.error(`Erreur pour ${n.description}`)}l((y+1)/Xs.length*100)}t(!1),p(""),Xe.success("Toutes les illustrations ont été générées !")},S=(y,n)=>{const h=document.createElement("a");h.href=n,h.download=`${y}.png`,document.body.appendChild(h),h.click(),document.body.removeChild(h)},g=()=>{Object.entries(c).forEach(([y,n])=>{setTimeout(()=>S(y,n),100)}),Xe.success("Téléchargement de toutes les images lancé !")};return e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Pt,{className:"h-5 w-5"}),"Générateur d'Illustrations Ivoiriennes"]}),e.jsx(je,{children:"Générez automatiquement les 10 illustrations prioritaires avec Lovable AI"})]}),e.jsxs(C,{className:"space-y-6",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx(P,{onClick:v,disabled:s,className:"flex items-center gap-2",children:s?e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"h-4 w-4 animate-spin"}),"Génération en cours..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Pt,{className:"h-4 w-4"}),"Générer les 10 illustrations"]})}),Object.keys(c).length>0&&e.jsxs(P,{onClick:g,variant:"outline",className:"flex items-center gap-2",children:[e.jsx(Pe,{className:"h-4 w-4"}),"Télécharger toutes (",Object.keys(c).length,")"]})]}),s&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(Xt,{value:a}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[o," (",Math.round(a),"%)"]})]}),Object.keys(c).length>0&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:Object.entries(c).map(([y,n])=>e.jsxs("div",{className:"relative group border rounded-lg overflow-hidden bg-muted/20",children:[e.jsx("img",{src:n,alt:y,className:"w-full h-48 object-cover"}),e.jsxs("div",{className:"p-2 space-y-1",children:[e.jsx("p",{className:"text-xs font-medium truncate",children:y}),e.jsxs(P,{size:"sm",variant:"outline",className:"w-full",onClick:()=>S(y,n),children:[e.jsx(Pe,{className:"h-3 w-3 mr-1"}),"Télécharger"]})]})]},y))}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Illustrations à générer :"}),e.jsx("ul",{className:"text-sm text-muted-foreground space-y-1",children:Xs.map((y,n)=>e.jsxs("li",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs bg-primary/10 text-primary px-2 py-0.5 rounded",children:n+1}),y.description,c[y.filename]&&e.jsx("span",{className:"text-xs text-green-600",children:"✓"})]},y.filename))})]})]})]})},rc=()=>{const{hasRole:s,loading:t}=Ke(),[a,l]=r.useState("overview"),[o,p]=r.useState(0),[c,x]=r.useState(0),[v,S]=r.useState(0),[g,y]=r.useState(0);return r.useEffect(()=>{const n=async()=>{const{count:R}=await b.from("leases").select("*",{count:"exact",head:!0}).eq("certification_status","pending");p(R||0)},h=async()=>{const{data:R}=await b.rpc("get_my_disputes"),N=(R==null?void 0:R.filter(j=>j.status==="open").length)||0;x(N)},i=async()=>{const{count:R}=await b.from("properties").select("*",{count:"exact",head:!0}).eq("moderation_status","pending");S(R||0)},d=async()=>{const{count:R}=await b.from("rental_applications").select("*",{count:"exact",head:!0}).eq("status","pending").eq("is_overdue",!0);y(R||0)};n(),h(),i(),d();const f=b.channel("admin-pending-count").on("postgres_changes",{event:"*",schema:"public",table:"leases",filter:"certification_status=eq.pending"},()=>n()).subscribe(),M=b.channel("admin-open-disputes").on("postgres_changes",{event:"*",schema:"public",table:"disputes",filter:"status=eq.open"},()=>h()).subscribe();return()=>{b.removeChannel(f),b.removeChannel(M)}},[]),t?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):s("admin")?e.jsxs("div",{className:"min-h-screen flex flex-col",children:[e.jsx(Ur,{}),e.jsx(Dr,{children:e.jsxs("div",{className:"flex w-full min-h-screen",children:[e.jsx(Cl,{activeTab:a,onTabChange:l,badges:{certifications:o,disputes:c,properties:v,overdueApplications:g}}),e.jsx(Ir,{className:"flex-1",children:e.jsxs("main",{className:"container mx-auto px-6 py-6",children:[e.jsxs(Kr,{children:[e.jsx("h1",{className:"text-2xl font-bold",children:"Administration ANSUT"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gestion et validation de la plateforme Mon Toit"})]}),a==="overview"&&e.jsxs("div",{className:"space-y-6",children:[e.jsx(Wl,{}),e.jsx(El,{})]}),a==="certifications"&&e.jsx(Os,{}),a==="verifications"&&e.jsx(Fl,{}),a==="processing"&&e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsx(Yl,{}),e.jsx(Xl,{})]}),a==="security"&&e.jsx(Gl,{}),a==="mfa"&&e.jsx(Kl,{}),a==="audit"&&e.jsxs("div",{className:"space-y-6",children:[!s("super_admin")&&!s("admin")&&e.jsx(Bl,{}),e.jsx(zl,{})]}),a==="analytics"&&e.jsx(Pl,{}),a==="disputes"&&e.jsx(Ll,{}),a==="moderation"&&e.jsx(ql,{}),a==="reporting"&&e.jsx(Ul,{}),a==="reports"&&e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsx(I,{className:"flex items-center gap-2",children:"📊 Générateur de Rapports Mensuels"}),e.jsx(je,{children:"Générer et envoyer des rapports de performance aux propriétaires"})]}),e.jsx(C,{children:e.jsx(tc,{})})]}),a==="illustrations"&&e.jsx(ac,{}),a==="electronic-signatures"&&e.jsxs(_,{children:[e.jsxs(D,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5"}),"Signatures Électroniques CryptoNeo"]}),e.jsx(je,{children:"Gestion des certificats numériques et signatures électroniques"})]}),e.jsx(C,{children:e.jsxs(He,{defaultValue:"dashboard",className:"w-full",children:[e.jsxs(Fe,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsx(te,{value:"dashboard",children:"Tableau de bord"}),e.jsx(te,{value:"certificates",children:"Gestion des certificats"})]}),e.jsx(re,{value:"dashboard",children:e.jsx(Jl,{})}),e.jsx(re,{value:"certificates",children:e.jsx(ec,{})})]})})]}),a==="properties"&&e.jsx(Tl,{}),a==="users"&&e.jsx(Il,{}),a==="leases"&&e.jsxs(He,{defaultValue:"list",className:"w-full",children:[e.jsxs(Fe,{children:[e.jsx(te,{value:"list",children:"Liste des Baux"}),e.jsx(te,{value:"templates",children:"Modèles de Baux"})]}),e.jsx(re,{value:"list",className:"mt-4",children:e.jsx(kl,{})}),e.jsx(re,{value:"templates",className:"mt-4",children:e.jsx(Vl,{})})]}),a==="alerts"&&e.jsx(sc,{})]})})]})}),e.jsx(jl,{})]}):e.jsx(rn,{to:"/",replace:!0})},Cc=Object.freeze(Object.defineProperty({__proto__:null,default:rc},Symbol.toStringTag,{value:"Module"})),ic=(s,t="/")=>{const{hasRole:a,loading:l}=Ke(),o=Va();return r.useEffect(()=>{!l&&!a(s)&&(K({title:"Accès refusé",description:`Vous devez avoir le rôle '${s}' pour accéder à cette page.`,variant:"destructive"}),o(t))},[a,l,s,o,t]),{hasRole:a(s),loading:l}},nc=()=>{const[s,t]=r.useState(null),[a,l]=r.useState(!0);r.useEffect(()=>{o()},[]);const o=async()=>{try{const{data:p,error:c}=await b.from("leases").select("certification_status, certification_requested_at, ansut_certified_at, certification_notes");if(c)throw c;const x=new Date,v=new Date(x.getTime()-30*24*60*60*1e3),S=p.filter(j=>j.certification_status==="certified").length,g=p.filter(j=>j.certification_status==="rejected").length,y=p.filter(j=>j.certification_status==="pending").length,n=p.filter(j=>j.certification_requested_at&&j.ansut_certified_at).map(j=>{const A=new Date(j.certification_requested_at);return(new Date(j.ansut_certified_at).getTime()-A.getTime())/(1e3*60*60*24)}),h=n.length>0?n.reduce((j,A)=>j+A,0)/n.length:0,i=S+g,d=i>0?S/i*100:0,f=p.filter(j=>j.certification_status==="certified"&&j.ansut_certified_at&&new Date(j.ansut_certified_at)>=v).length,M=p.filter(j=>j.certification_status==="rejected"&&j.certification_notes).map(j=>j.certification_notes),R={};M.forEach(j=>{const A=j.substring(0,50);R[A]=(R[A]||0)+1});const N=Object.entries(R).map(([j,A])=>({reason:j,count:A})).sort((j,A)=>A.count-j.count).slice(0,3);t({totalCertified:S,totalRejected:g,totalPending:y,avgProcessingDays:h,approvalRate:d,topRejectionReasons:N,thisMonthCertified:f})}catch(p){G.error("Error fetching certification metrics",{error:p})}finally{l(!1)}};return a?e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[...Array(4)].map((p,c)=>e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(Ce,{className:"h-4 w-24"}),e.jsx(Ce,{className:"h-4 w-4 rounded-full"})]}),e.jsx(C,{children:e.jsx(Ce,{className:"h-8 w-16"})})]},c))}):s?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Certifications (30j)"}),e.jsx(pe,{className:"h-4 w-4 text-secondary"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.thisMonthCertified}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Total: ",s.totalCertified]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Taux d'approbation"}),e.jsx(Me,{className:"h-4 w-4 text-green-600"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[s.approvalRate.toFixed(1),"%"]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.totalCertified," approuvés / ",s.totalRejected," rejetés"]})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"Temps moyen"}),e.jsx(xe,{className:"h-4 w-4 text-primary"})]}),e.jsxs(C,{children:[e.jsxs("div",{className:"text-2xl font-bold",children:[s.avgProcessingDays.toFixed(1)," jours"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"De la demande à l'approbation"})]})]}),e.jsxs(_,{children:[e.jsxs(D,{className:"flex flex-row items-center justify-between space-y-0 pb-2",children:[e.jsx(I,{className:"text-sm font-medium",children:"En attente"}),e.jsx(xe,{className:"h-4 w-4 text-yellow-600"})]}),e.jsxs(C,{children:[e.jsx("div",{className:"text-2xl font-bold",children:s.totalPending}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Demandes à traiter"})]})]})]}),s.topRejectionReasons.length>0&&e.jsxs(_,{children:[e.jsx(D,{children:e.jsxs(I,{className:"text-base flex items-center gap-2",children:[e.jsx(de,{className:"h-5 w-5 text-destructive"}),"Top 3 des raisons de rejet"]})}),e.jsx(C,{children:e.jsx("div",{className:"space-y-3",children:s.topRejectionReasons.map((p,c)=>e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs($,{variant:"outline",className:"text-xs",children:[p.count,"x"]}),e.jsx("span",{className:"text-sm text-muted-foreground line-clamp-1",children:p.reason})]})},c))})})]})]}):null},lc=()=>{ic("admin");const[s,t]=r.useState("pending");return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Ur,{}),e.jsxs("div",{className:"container mx-auto px-4 py-6",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-2 flex items-center gap-3",children:"Certifications ANSUT"}),e.jsx("p",{className:"text-muted-foreground",children:"Gérez les demandes de certification des baux et suivez leur statut"})]}),e.jsxs("div",{className:"space-y-8",children:[e.jsx(nc,{}),e.jsxs(He,{value:s,onValueChange:t,className:"w-full",children:[e.jsxs(Fe,{className:"grid w-full grid-cols-4",children:[e.jsxs(te,{value:"pending",className:"flex items-center gap-2",children:[e.jsx(xe,{className:"h-4 w-4"}),"En attente"]}),e.jsxs(te,{value:"in_review",className:"flex items-center gap-2",children:[e.jsx(vr,{className:"h-4 w-4"}),"En révision"]}),e.jsxs(te,{value:"certified",className:"flex items-center gap-2",children:[e.jsx(he,{className:"h-4 w-4"}),"Certifiés"]}),e.jsxs(te,{value:"rejected",className:"flex items-center gap-2",children:[e.jsx(de,{className:"h-4 w-4"}),"Rejetés"]})]}),e.jsx(re,{value:"pending",className:"mt-6",children:e.jsx(Os,{status:"pending"})}),e.jsx(re,{value:"in_review",className:"mt-6",children:e.jsx(Os,{status:"in_review"})}),e.jsx(re,{value:"certified",className:"mt-6",children:e.jsx(Os,{status:"certified"})}),e.jsx(re,{value:"rejected",className:"mt-6",children:e.jsx(Os,{status:"rejected"})})]})]})]})]})},Ec=Object.freeze(Object.defineProperty({__proto__:null,default:lc},Symbol.toStringTag,{value:"Module"}));export{gs as $,Gr as A,P as B,_ as C,ze as D,re as E,Nr as F,yr as G,br as H,jc as I,Ht as J,Ve as K,Be as L,We as M,Ss as N,As as O,Ms as P,Se as Q,ae as R,gc as S,He as T,Cs as U,se as V,Ce as W,Ur as X,Kr as Y,jl as Z,Je as _,$ as a,wc as a$,fc as a0,ht as a1,pt as a2,Gs as a3,Ae as a4,Ns as a5,Ls as a6,we as a7,ge as a8,_e as a9,Ir as aA,Br as aB,hc as aC,yn as aD,_r as aE,Dn as aF,yc as aG,vc as aH,kn as aI,Cr as aJ,Pn as aK,Kt as aL,On as aM,Fn as aN,Xt as aO,ut as aP,pc as aQ,it as aR,nt as aS,Bs as aT,bs as aU,aa as aV,Ac as aW,fs as aX,Nc as aY,Ps as aZ,Rt as a_,ve as aa,B as ab,Ge as ac,Qe as ad,ps as ae,is as af,W as ag,Ar as ah,Vs as ai,os as aj,nl as ak,xs as al,Nl as am,xt as an,Tr as ao,Xn as ap,Lt as aq,kr as ar,Pr as as,Mr as at,Lr as au,Or as av,Wn as aw,Fr as ax,qr as ay,Dr as az,D as b,_c as b0,Yr as b1,Ot as b2,Xr as b3,Cc as b4,Ec as b5,E as c,I as d,C as e,bc as f,Sc as g,Le as h,ml as i,je as j,_l as k,G as l,Wt as m,Jt as n,Zt as o,ea as p,Qt as q,ta as r,b as s,K as t,Ke as u,sa as v,ls as w,cs as x,Fe as y,te as z};
//# sourceMappingURL=route-admin-B1Ip8YDE.js.map
